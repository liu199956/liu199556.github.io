<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Admin">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Admin">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Admin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Admin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Admin" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
	
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Admin</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/23/opencv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/23/opencv/" class="post-title-link" itemprop="url">opencv</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-23 15:00:05" itemprop="dateCreated datePublished" datetime="2021-11-23T15:00:05+08:00">2021-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-29 17:40:21" itemprop="dateModified" datetime="2022-04-29T17:40:21+08:00">2022-04-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="rtsp后台视频流搭建"><a href="#rtsp后台视频流搭建" class="headerlink" title="rtsp后台视频流搭建"></a>rtsp后台视频流搭建</h4><img src="/2021/11/23/opencv/image-20211123151226557.png" alt="opencv" style="zoom:150%;">

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget  http://www.live555.com/liveMedia/public/live555-latest.tar.gz</span><br><span class="line">tar xzf live555-latest.tar.gz</span><br><span class="line">cd live</span><br><span class="line">./genMakefiles linux-64bit    #注意后面这个参数是根据当前文件夹下config.&lt;后缀&gt;获取得到的</span><br><span class="line">make</span><br><span class="line">cd mediaServer</span><br><span class="line">./live555MediaServer   # 启动rtsp服务</span><br></pre></td></tr></table></figure>

<h4 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h4><ul>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/67878761">https://zhuanlan.zhihu.com/p/67878761</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43474959/article/details/105366800">https://blog.csdn.net/qq_43474959/article/details/105366800</a></p>
</li>
<li><p>FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xz -d ffmpeg-git-amd64-static.tar.xz</span><br><span class="line">tar -xvf ffmpeg-git-amd64-static.tar</span><br><span class="line">cd ffmpeg-git-<span class="number">20211108</span>-amd64-static/</span><br><span class="line">./ffmpeg</span><br><span class="line"><span class="comment"># 建立软连接</span></span><br><span class="line">ln -s /usr/local/ffmpeg/ffmpeg-git-<span class="number">20211108</span>-amd64-static/ffmpeg /usr/<span class="built_in">bin</span>/ffmpeg</span><br><span class="line">ln -s /usr/local/ffmpeg/ffmpeg-git-<span class="number">20211108</span>-amd64-static/ffprobe /usr/<span class="built_in">bin</span>/ffprobe</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">ffmpeg</span><br></pre></td></tr></table></figure>

<p><strong>常用参数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">主要参数：</span><br><span class="line">i 设定输入流</span><br><span class="line">f 设定输出格式</span><br><span class="line">ss 开始时间</span><br><span class="line">t  持续时间</span><br><span class="line">视频参数：</span><br><span class="line">b 设定视频流量，默认为200Kbit/s-r 设定帧速率，默认为<span class="number">25</span></span><br><span class="line">s 设定画面的宽与高-aspect 设定画面的比例</span><br><span class="line">vn 不处理视频-vcodec 设定视频编解码器，未设定时则使用与输入流相同的编解码器</span><br><span class="line">音频参数：</span><br><span class="line">ar 设定采样率</span><br><span class="line">ac 设定声音的Channel数</span><br><span class="line">acodec 设定声音编解码器，未设定时则使用与输入流相同的编解码器an 不处理音频</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>1.分离视频音频流</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input_file -vcodec copy -an output_file_video　　//分离视频流</span><br><span class="line">ffmpeg -i input_file -acodec copy -vn output_file_audio　　//分离音频流</span><br></pre></td></tr></table></figure>

<p>2.<strong>视频图片剪切</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg –i test.avi –r 1 –f image2 image-%3d.jpeg //提取图片</span><br><span class="line">ffmpeg -ss 0:1:30 -t 0:0:20 -i input.avi -vcodec copy -acodec copy output.avi //剪切视频</span><br></pre></td></tr></table></figure>

<p>3.视频流推流(rtmp)</p>
<ul>
<li>拉取摄像机RTSP流，推送给RTMP服务器 -vcodec copy -acodec copy (限于摄像机提供的就为H.264+AAC的码流)</li>
<li>若不是则-vcodec copy<code>改为</code>-vcodec libx264<code>，</code>-acodec copy<code>改为</code>-acodec aac</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i rtsp://<span class="number">10.21</span><span class="number">.6</span><span class="number">.11</span>/video/<span class="number">2.</span>mkv  -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -acodec copy -f flv  rtmp://<span class="number">10.21</span><span class="number">.6</span><span class="number">.12</span>/live/livestream</span><br></pre></td></tr></table></figure>

<p>4.视频流推流(rtsp)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg <span class="literal">-re</span> <span class="literal">-stream_loop</span> <span class="literal">-1</span> <span class="literal">-i</span> <span class="number">2</span>.mp4 <span class="literal">-c</span> <span class="built_in">copy</span> <span class="operator">-f</span> rtsp rtsp://<span class="number">10.21</span>.<span class="number">6.11</span>/video</span><br></pre></td></tr></table></figure>

<h4 id="srs"><a href="#srs" class="headerlink" title="srs"></a>srs</h4><ul>
<li>(Simple RTMP Server)  是国人写的一款非常优秀的开源流媒体服务器软件，可用于直播/录播/视频客服等多种场景，其定位是运营级的互联网直播服务器集群</li>
</ul>
<p>docker启动</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">eip=<span class="variable">$</span>(ifconfig eth0|grep <span class="string">&#x27;inet &#x27;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [[ ! -<span class="type">z</span> <span class="variable">$eip</span> ]]; then</span><br><span class="line">  docker run <span class="literal">-d</span> -<span class="literal">-rm</span> -<span class="literal">-env</span> CANDIDATE=<span class="variable">$</span>(ifconfig eth0|grep <span class="string">&#x27;inet &#x27;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>) \</span><br><span class="line">      <span class="literal">-p</span> <span class="number">1935</span>:<span class="number">1935</span> <span class="literal">-p</span> <span class="number">8080</span>:<span class="number">8080</span> <span class="literal">-p</span> <span class="number">1985</span>:<span class="number">1985</span> <span class="literal">-p</span> <span class="number">8000</span>:<span class="number">8000</span>/udp \</span><br><span class="line">      registry.cn<span class="literal">-hangzhou</span>.aliyuncs.com/ossrs/srs:v4.<span class="number">0.76</span> \</span><br><span class="line">      objs/srs <span class="literal">-c</span> conf/rtc.conf</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>ffmpeg推流</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://10.21.6.12:8080/live/livestream.flv">http://10.21.6.12:8080/live/livestream.flv</a></li>
<li>webrtc://10.21.6.12/live/livestream</li>
<li>rtmp://10.21.6.12/live/livestream</li>
<li><img src="/2021/11/23/opencv/image-20220309175859987.png" alt="opencv"></li>
</ul>
<p><code>将rtsp视频流推流到srs</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg <span class="literal">-re</span> <span class="literal">-i</span> rtsp://<span class="number">10.21</span>.<span class="number">6.11</span>/video/<span class="number">2</span>.mkv <span class="literal">-vcodec</span> libx264 <span class="literal">-acodec</span> aac <span class="operator">-f</span> flv   rtmp://<span class="number">10.21</span>.<span class="number">6.12</span>/live/livestream</span><br></pre></td></tr></table></figure>

<p><code>循环将本地文件推流到srs</code></p>
<ul>
<li>nohup不挂断的运行，并没有后台运行的功能，就是指，用nohup运行命令可以使命令永久的执行下去</li>
<li>&amp; 后台运行</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi push.sh</span><br><span class="line">chmod +x push.sh</span><br><span class="line"></span><br><span class="line">nohup ffmpeg <span class="literal">-threads</span> <span class="number">2</span> <span class="literal">-re</span> <span class="literal">-fflags</span> +genpts <span class="literal">-stream_loop</span> <span class="literal">-1</span>  <span class="literal">-i</span> ./input.mp4  <span class="literal">-vcodec</span> libx264 <span class="literal">-preset</span>:v ultrafast <span class="literal">-tune</span>:v zerolatency <span class="literal">-acodec</span> <span class="built_in">copy</span> <span class="operator">-f</span>  flv <span class="literal">-y</span>  rtmp://<span class="number">10.21</span>.<span class="number">6.12</span>/live/input &amp;</span><br><span class="line"></span><br><span class="line">nohup ffmpeg <span class="literal">-threads</span> <span class="number">2</span> <span class="literal">-re</span> <span class="literal">-fflags</span> +genpts <span class="literal">-stream_loop</span> <span class="literal">-1</span>  <span class="literal">-i</span> ./output.mp4  <span class="literal">-vcodec</span> libx264 <span class="literal">-preset</span>:v ultrafast <span class="literal">-tune</span>:v zerolatency <span class="literal">-acodec</span> <span class="built_in">copy</span> <span class="operator">-f</span>  flv <span class="literal">-y</span>  rtmp://<span class="number">10.21</span>.<span class="number">6.12</span>/live/output &amp;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>批量杀包含ffmpeg进程</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ps</span> <span class="literal">-ef</span> | grep ffmpeg | grep <span class="literal">-v</span> grep | cut <span class="literal">-c</span> <span class="number">9</span><span class="literal">-15</span> | xargs <span class="built_in">kill</span> <span class="literal">-9</span></span><br></pre></td></tr></table></figure>

<h4 id="nginx-rtmp搭建视频点播"><a href="#nginx-rtmp搭建视频点播" class="headerlink" title="nginx+rtmp搭建视频点播"></a>nginx+rtmp搭建视频点播</h4><ul>
<li>已下载nginx</li>
<li>下载nginx-rtmp-module</li>
<li><img src="/2021/11/23/opencv/image-20211123153836430.png" alt="opencv"></li>
<li>make &amp;&amp; make install</li>
<li>nginx.conf视频点播服务器配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rtmp &#123;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        listen <span class="number">1935</span>;  <span class="comment">#监听的端口</span></span><br><span class="line"></span><br><span class="line">        chunk_size <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line">        application hls &#123;  <span class="comment">#rtmp推流请求路径</span></span><br><span class="line">            live on;</span><br><span class="line">            hls on;</span><br><span class="line">            hls_path /usr/local/nginx/html/hls;</span><br><span class="line">            hls_fragment 1s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ffmpeg推本地摄像头录像到rtmp服务后台"><a href="#ffmpeg推本地摄像头录像到rtmp服务后台" class="headerlink" title="ffmpeg推本地摄像头录像到rtmp服务后台"></a>ffmpeg推本地摄像头录像到rtmp服务后台</h4><p><img src="/2021/11/23/opencv/image-20211123154630135.png" alt="opencv"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.查看摄像头和麦克风信息</span><br><span class="line">ffmpeg -list_devices true -f dshow -i dummy</span><br><span class="line">2.摄像头推流</span><br><span class="line">ffmpeg -f dshow -i video=&quot;HD Camera&quot; -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -f flv rtmp://192.168.17.6:1935/hls/test.mp4</span><br></pre></td></tr></table></figure>

<h4 id="opencv截取rtmp视频流存放mongodb"><a href="#opencv截取rtmp视频流存放mongodb" class="headerlink" title="opencv截取rtmp视频流存放mongodb"></a>opencv截取rtmp视频流存放mongodb</h4><ul>
<li>django+celery</li>
<li><img src="/2021/11/23/opencv/image-20211123154924271.png" alt="opencv"></li>
<li>views.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getVideoStream</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    video_path = request.data.get(<span class="string">&quot;video_path&quot;</span>)</span><br><span class="line">    filename = request.data.get(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line">    end_time = request.data.get(<span class="string">&quot;end_time&quot;</span>)</span><br><span class="line">    filepath = sys.path[<span class="number">0</span>] + <span class="string">&#x27;/model/video/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(filepath):</span><br><span class="line">        os.mkdir(filepath)</span><br><span class="line">    uuid_str = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    name = filename + <span class="string">&quot;_&quot;</span> + uuid_str + <span class="string">&quot;.avi&quot;</span> </span><br><span class="line">    path = filepath + name</span><br><span class="line">    <span class="keyword">if</span> video_path <span class="keyword">and</span> filename <span class="keyword">and</span> end_time:</span><br><span class="line">        result = tasks.detect.delay(video_path, end_time, path)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;/api/service/result/?id=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">    <span class="keyword">return</span> APIResponse(code=<span class="number">1</span>, msg=<span class="string">&quot;缺少参数&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>result接口</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@action(<span class="params">methods=[<span class="string">&#x27;GET&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">result</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = request.GET.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">id</span>:</span><br><span class="line">        res = AsyncResult(<span class="built_in">id</span>=<span class="built_in">id</span>, app=app)</span><br><span class="line">        <span class="keyword">if</span> res.successful():</span><br><span class="line">            result = res.result</span><br><span class="line">            <span class="keyword">return</span> APIResponse(code=<span class="number">0</span>, msg=<span class="string">&#x27;执行完成&#x27;</span>, result=<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">        <span class="keyword">elif</span> res.status == <span class="string">&#x27;STARTED&#x27;</span>:</span><br><span class="line">            result = res.result</span><br><span class="line">            <span class="keyword">return</span> APIResponse(code=<span class="number">2</span>, msg=<span class="string">&#x27;任务已经开始被执行&#x27;</span>, result=<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">        <span class="keyword">elif</span> res.status == <span class="string">&#x27;PENDING&#x27;</span>:</span><br><span class="line">            result = res.result</span><br><span class="line">            <span class="keyword">return</span> APIResponse(code=<span class="number">3</span>, msg=<span class="string">&#x27;任务等待被执行&#x27;</span>, result=<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">        <span class="keyword">elif</span> res.failed():</span><br><span class="line">            result = res.result</span><br><span class="line">            <span class="keyword">return</span> APIResponse(code=<span class="number">4</span>, msg=<span class="string">&#x27;执行失败&#x27;</span>, result=<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">        <span class="keyword">elif</span> res.status == <span class="string">&#x27;RETRY&#x27;</span>:</span><br><span class="line">            result = res.result</span><br><span class="line">            <span class="keyword">return</span> APIResponse(code=<span class="number">5</span>, msg=<span class="string">&#x27;任务异常后正在重试&#x27;</span>, result=<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">    <span class="keyword">return</span> APIResponse(code=<span class="number">1</span>, msg=<span class="string">&#x27;缺少参数&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>celery.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="string">&quot;AlgorithmServer.settings&quot;</span>)</span><br><span class="line"><span class="comment"># broker = &#x27;amqp://foda:foda@2021.@10.21.6.12:5672/myvhost&#x27;</span></span><br><span class="line"><span class="comment"># backend = &#x27;amqp://foda:foda@2021.@10.21.6.12:5672/myvhost&#x27;</span></span><br><span class="line">broker = <span class="string">&#x27;redis://127.0.0.1:6379/1&#x27;</span></span><br><span class="line">backend = <span class="string">&#x27;redis://127.0.0.1:6379/2&#x27;</span></span><br><span class="line">app = Celery(broker=broker, backend=backend,</span><br><span class="line">             include=[<span class="string">&#x27;celery_task.tasks&#x27;</span>])</span><br><span class="line"></span><br><span class="line">app.conf.timezone = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">app.conf.enable_utc = <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>tasks.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> model.db <span class="keyword">import</span> MongoGridFS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detect</span>(<span class="params">video_path, end_time, path</span>):</span></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    fps = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FPS))</span><br><span class="line">    width = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">    height = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">    </span><br><span class="line">    pos = cap.get(cv2.CAP_PROP_POS_FRAMES)</span><br><span class="line">    end_pos = <span class="built_in">int</span>(end_time) * fps</span><br><span class="line">    fourcc = cv2.VideoWriter_fourcc(<span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">    outfile = cv2.VideoWriter(path, fourcc, fps, (width, height))</span><br><span class="line">    <span class="keyword">while</span> (pos &lt;= end_pos):</span><br><span class="line">        success, frame = cap.read()</span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="comment"># cv2.imshow(&#x27;current frame&#x27;, frame)</span></span><br><span class="line">            outfile.write(frame)</span><br><span class="line">            <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            pos = cap.get(cv2.CAP_PROP_POS_FRAMES)</span><br><span class="line">            <span class="keyword">if</span> pos &gt;= end_pos:</span><br><span class="line">                gfs = MongoGridFS(<span class="string">&#x27;fs&#x27;</span>, <span class="string">&#x27;video&#x27;</span>)</span><br><span class="line">                db = gfs.connect_db()</span><br><span class="line">                name = gfs.upload_file(db, path)</span><br><span class="line">                <span class="keyword">if</span> name:</span><br><span class="line">                    <span class="keyword">return</span> name</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&#123;&#125;已存在&quot;</span>.<span class="built_in">format</span>(name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line">    cap.release()</span><br><span class="line">    outfile.release()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>安装celery pip3 install celery==4.4.7</li>
<li>celery worker -A celery_task -l info -P eventlet</li>
<li>celery worker -A celery_task -l info  -P threads -c 100</li>
<li>若保存 pip install eventlet</li>
<li><img src="/2021/11/23/opencv/image-20211123155436340.png" alt="opencv"></li>
<li>启动django项目</li>
<li>开启摄像头推流</li>
<li>请求<img src="/2021/11/23/opencv/image-20211123155653136.png" alt="opencv"></li>
<li>结果<img src="/2021/11/23/opencv/image-20211123161450930.png" alt="opencv"></li>
</ul>
<h4 id="直播推流"><a href="#直播推流" class="headerlink" title="直播推流"></a>直播推流</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Live</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.frame_queue = queue.Queue()</span><br><span class="line">        self.command = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 自行设置</span></span><br><span class="line">        self.rtmpUrl = <span class="string">&quot;rtmp://192.168.17.6:1935/hls/lll.mp4&quot;</span></span><br><span class="line">        self.camera_path = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_frame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开启推流&quot;</span>)</span><br><span class="line">        cap = cv.VideoCapture(self.camera_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get video information</span></span><br><span class="line">        fps = <span class="built_in">int</span>(cap.get(cv.CAP_PROP_FPS))</span><br><span class="line">        width = <span class="built_in">int</span>(cap.get(cv.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">        height = <span class="built_in">int</span>(cap.get(cv.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ffmpeg command</span></span><br><span class="line">        self.command = [<span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-y&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;rawvideo&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-vcodec&#x27;</span>, <span class="string">&#x27;rawvideo&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-pix_fmt&#x27;</span>, <span class="string">&#x27;bgr24&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-s&#x27;</span>, <span class="string">&quot;&#123;&#125;x&#123;&#125;&quot;</span>.<span class="built_in">format</span>(width, height),</span><br><span class="line">                        <span class="string">&#x27;-r&#x27;</span>, <span class="built_in">str</span>(fps),</span><br><span class="line">                        <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;libx264&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-pix_fmt&#x27;</span>, <span class="string">&#x27;yuv420p&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-preset&#x27;</span>, <span class="string">&#x27;ultrafast&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;flv&#x27;</span>,</span><br><span class="line">                        self.rtmpUrl]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># read webcamera</span></span><br><span class="line">        <span class="keyword">while</span> (cap.isOpened()):</span><br><span class="line">            ret, frame = cap.read()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Opening camera is failed&quot;</span>)</span><br><span class="line">                <span class="comment"># 说实话这里的break应该替换为：</span></span><br><span class="line">                <span class="comment"># cap = cv.VideoCapture(self.camera_path)</span></span><br><span class="line">                <span class="comment"># 因为我这俩天遇到的项目里出现断流的毛病</span></span><br><span class="line">                <span class="comment"># 特别是拉取rtmp流的时候！！！！</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># put frame into queue</span></span><br><span class="line">            self.frame_queue.put(frame)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push_frame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 防止多线程时 command 未被设置</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(self.command) &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 管道配置</span></span><br><span class="line">                p = sp.Popen(self.command, stdin=sp.PIPE)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> self.frame_queue.empty() != <span class="literal">True</span>:</span><br><span class="line">                frame = self.frame_queue.get()</span><br><span class="line">                <span class="comment"># process frame</span></span><br><span class="line">                <span class="comment"># 你处理图片的代码</span></span><br><span class="line">                <span class="comment"># write to pipe</span></span><br><span class="line">                p.stdin.write(frame.tostring())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        threads = [</span><br><span class="line">            threading.Thread(target=Live.read_frame, args=(self,)),</span><br><span class="line">            threading.Thread(target=Live.push_frame, args=(self,))</span><br><span class="line">        ]</span><br><span class="line">        <span class="comment"># [thread.setDaemon(True) for thread in threads]</span></span><br><span class="line">        [thread.start() <span class="keyword">for</span> thread <span class="keyword">in</span> threads]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    l = Live()</span><br><span class="line">    l.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="拉流"><a href="#拉流" class="headerlink" title="拉流"></a>拉流</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;docstring for Producer&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, rtmp_str</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>(Producer, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.rtmp_str = rtmp_str</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通过cv2中的类获取视频流操作对象cap</span></span><br><span class="line">        self.cap = cv2.VideoCapture(self.rtmp_str)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 调用cv2方法获取cap的视频帧（帧：每秒多少张图片）</span></span><br><span class="line">        <span class="comment"># fps = self.cap.get(cv2.CAP_PROP_FPS)</span></span><br><span class="line">        self.fps = self.cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">        <span class="built_in">print</span>(self.fps)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取cap视频流的每帧大小</span></span><br><span class="line">        self.width = <span class="built_in">int</span>(self.cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">        self.height = <span class="built_in">int</span>(self.cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">        self.size = (self.width, self.height)</span><br><span class="line">        <span class="built_in">print</span>(self.size)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义编码格式mpge-4</span></span><br><span class="line">        self.fourcc = cv2.VideoWriter_fourcc(<span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义视频文件输入对象</span></span><br><span class="line">        self.outVideo = cv2.VideoWriter(<span class="string">&#x27;saveDir1.avi&#x27;</span>, self.fourcc, self.fps, self.size)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;in producer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        ret, image = self.cap.read()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ret:</span><br><span class="line">            <span class="comment"># if ret == True:</span></span><br><span class="line"></span><br><span class="line">            self.outVideo.write(image)</span><br><span class="line"></span><br><span class="line">            cv2.imshow(<span class="string">&#x27;video&#x27;</span>, image)</span><br><span class="line"></span><br><span class="line">            cv2.waitKey(<span class="built_in">int</span>(<span class="number">1000</span> / <span class="built_in">int</span>(self.fps)))  <span class="comment"># 延迟</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line"></span><br><span class="line">                self.outVideo.release()</span><br><span class="line"></span><br><span class="line">                self.cap.release()</span><br><span class="line"></span><br><span class="line">                cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            ret, image = self.cap.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;run program&#x27;</span>)</span><br><span class="line">    rtmp_str = <span class="string">&#x27;rtsp://10.21.6.11/video/2.mkv&#x27;</span></span><br><span class="line"></span><br><span class="line">    producer = Producer(rtmp_str)  </span><br><span class="line">    producer.start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="Celery-gt-Flower-gt-Prometheus-gt-Grafana"><a href="#Celery-gt-Flower-gt-Prometheus-gt-Grafana" class="headerlink" title="Celery -&gt; Flower -&gt; Prometheus -&gt; Grafana"></a>Celery -&gt; Flower -&gt; Prometheus -&gt; Grafana</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1.启动redis服务(celery消息中间件)</span><br><span class="line">docker run --name redis -d -p 6379:6379 redis</span><br><span class="line">2.启动celery服务</span><br><span class="line">celery -A celery_task worker -l info</span><br><span class="line">3.启动flower监控</span><br><span class="line">celery -A celery_task flower</span><br><span class="line">4.配置Prometheus</span><br><span class="line">vim /usr/local/prometheus/prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: prometheus</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="line">  - job_name: flower</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#x27;localhost:5555&#x27;]</span><br><span class="line">5.docker启动prometheus</span><br><span class="line">docker run --name prometheus -v /usr/local/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml -p 9090:9090 --network host prom/prometheus</span><br><span class="line">6.docker启动Grafana</span><br><span class="line">docker run --name Grafana -d -v grafana-storage:/var/lib/grafana -p 3000:3000 --network host grafana/grafana</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="linux安装opencv问题解决"><a href="#linux安装opencv问题解决" class="headerlink" title="linux安装opencv问题解决"></a>linux安装opencv问题解决</h4><p>centos</p>
<p><img src="/2021/11/23/opencv/image-20211130174239356.png" alt="image-20211130174239356"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install libSM-1.2.2-2.el7.x86_64 --setopt=protected_multilib=false -y</span><br><span class="line">yum install libXrender-0.9.10-1.el7.x86_64 --setopt=protected_multilib=false -y</span><br><span class="line">yum install libXext-1.3.3-3.el7.x86_64 --setopt=protected_multilib=false -y</span><br></pre></td></tr></table></figure>

<p>ubuntu</p>
<p><img src="/2021/11/23/opencv/image-20211223141710233.png" alt="opencv"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install opencv<span class="literal">-python</span> <span class="literal">-i</span> https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip install opencv<span class="literal">-contrib</span><span class="literal">-python</span> <span class="literal">-i</span> https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line">apt<span class="literal">-get</span> update</span><br><span class="line">apt<span class="literal">-get</span> install <span class="literal">-y</span> libgl1<span class="literal">-mesa</span><span class="literal">-dev</span></span><br><span class="line">apt<span class="literal">-get</span> install libgtk2.<span class="number">0</span><span class="literal">-dev</span> pkg<span class="literal">-config</span></span><br></pre></td></tr></table></figure>

<h4 id="Ubuntu编译opencv支持h264"><a href="#Ubuntu编译opencv支持h264" class="headerlink" title="Ubuntu编译opencv支持h264"></a>Ubuntu编译opencv支持h264</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># https://zhuanlan.zhihu.com/p/113666046（下载conda脚本安装对应python版本）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译opencv遇到的问题</span></span><br><span class="line"><span class="comment"># pip install </span></span><br><span class="line">root@f9469a74f572:/home<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libhdf5_serial.so.<span class="number">100</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://stackoverflow.com/questions/48965309/h5py-import-error-on-libhdf5-serial-so-100 （下载依赖）</span></span><br><span class="line">apt<span class="literal">-get</span> update</span><br><span class="line">apt<span class="literal">-get</span> install libhdf5<span class="literal">-dev</span></span><br><span class="line">apt<span class="literal">-get</span> install libhdf5<span class="literal">-serial</span><span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line">apt<span class="literal">-get</span> install libcblas<span class="literal">-dev</span></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">Package libcblas<span class="literal">-dev</span> is not available, but is referred to by another package.</span><br><span class="line">This may mean that the package is missing, has been obsoleted, or</span><br><span class="line">is only available from another source</span><br><span class="line">However the following packages replace it:</span><br><span class="line">  libatlas<span class="literal">-base</span><span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line">apt<span class="literal">-get</span> install libatlas<span class="literal">-base</span><span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line">apt<span class="literal">-get</span> install libjasper<span class="literal">-dev</span></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">Unable to locate package libjasper<span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">apt<span class="literal">-get</span> install software<span class="literal">-properties</span><span class="literal">-common</span></span><br><span class="line"><span class="built_in">add-apt</span><span class="literal">-repository</span> <span class="string">&quot;deb http://security.ubuntu.com/ubuntu xenial-security main&quot;</span></span><br><span class="line">apt<span class="literal">-get</span> update</span><br><span class="line"></span><br><span class="line">apt<span class="literal">-get</span> install libjasper<span class="literal">-dev</span> </span><br><span class="line">apt<span class="literal">-get</span> install libqtgui4 </span><br><span class="line">apt<span class="literal">-get</span> install libqt4<span class="literal">-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">root@f9469a74f572:/home<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libtesseract.so.<span class="number">4</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 https://askubuntu.com/questions/1108884/ubuntu-18-04-error-install-tesseract</span></span><br><span class="line"></span><br><span class="line">apt install libtesseract<span class="literal">-dev</span> libleptonica<span class="literal">-dev</span> liblept5</span><br><span class="line">apt install tesseract<span class="literal">-ocr</span> <span class="literal">-y</span></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">root@f9469a74f572:/home<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libdc1394.so.<span class="number">22</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 https://blog.csdn.net/u013171226/article/details/122035605</span></span><br><span class="line">apt<span class="literal">-get</span> install libgtk2.<span class="number">0</span><span class="literal">-0</span> </span><br><span class="line">apt<span class="literal">-get</span> install libdc1394<span class="literal">-22</span><span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line">root@f9469a74f572:/home<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libgstbase<span class="literal">-1</span>.<span class="number">0</span>.so.<span class="number">0</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">root@f9469a74f572:/usr/lib/x86_64<span class="literal">-linux</span><span class="literal">-gnu</span><span class="comment"># apt-get install libgstreamer1.0-0</span></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  libcap2 libcap2<span class="literal">-bin</span> libpam<span class="literal">-cap</span></span><br><span class="line">需要先安装 libcap2 libcap2<span class="literal">-bin</span> libpam<span class="literal">-cap</span> 三个包再安装libgstreamer1.<span class="number">0</span><span class="literal">-0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">root@f9469a74f572:/home<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libgstapp<span class="literal">-1</span>.<span class="number">0</span>.so.<span class="number">0</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line"></span><br><span class="line">apt<span class="literal">-get</span> -<span class="literal">-reinstall</span> install libgstreamer<span class="literal">-plugins</span><span class="literal">-base1</span>.<span class="number">0</span><span class="literal">-0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">root@f9469a74f572:/home<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libavcodec.so.<span class="number">57</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line">解决</span><br><span class="line">apt<span class="literal">-get</span> install  libavcodec<span class="literal">-dev</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">root@f9469a74f572:/<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libavformat.so.<span class="number">57</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">apt<span class="literal">-get</span> install libav<span class="built_in">format-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/opt/conda/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libswscale.so.<span class="number">4</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">apt<span class="literal">-get</span> install libswscale<span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: libgtk<span class="literal">-3</span>.so.<span class="number">0</span>: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line">apt install libgtk<span class="literal">-3</span><span class="literal">-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题</span></span><br><span class="line">root@f9469a74f572:~/anaconda3/lib/python3.<span class="number">7</span>/site<span class="literal">-packages</span><span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: /root/anaconda3/bin/../lib/./libharfbuzz.so.<span class="number">0</span>: undefined symbol: FT_Done_MM_Var</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决</span></span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /root/anaconda3/bin/../lib/./libharfbuzz.so.<span class="number">0</span></span><br><span class="line"><span class="built_in">cp</span> /usr/lib/x86_64<span class="literal">-linux</span><span class="literal">-gnu</span>/libharfbuzz.so.<span class="number">0</span>  /root/anaconda3/bin/../lib/./</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题 (解决方案同上)</span></span><br><span class="line">root@f9469a74f572:~/anaconda3/lib<span class="comment"># python -c &#x27;import cv2&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/root/anaconda3/lib/python3.7/site-packages/cv2/__init__.py&quot;</span>, line <span class="number">8</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .cv2 import *</span><br><span class="line">ImportError: /root/anaconda3/bin/../lib/libfontconfig.so.<span class="number">1</span>: undefined symbol: FT_Done_MM_Var</span><br><span class="line"></span><br><span class="line"> <span class="comment"># ubtntu容器pip清华园下载报错</span></span><br><span class="line">pip install <span class="literal">-r</span> requirements.txt <span class="literal">-i</span> http://mirrors.aliyun.com/pypi/simple -<span class="literal">-trusted</span><span class="literal">-host</span> mirrors.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决docker容器内Ubuntu系统语言中文乱码问题</span></span><br><span class="line">locale <span class="comment"># 查看当前系统语言环境</span></span><br><span class="line">root@f9469a74f572:/<span class="comment"># locale</span></span><br><span class="line">LANG=</span><br><span class="line">LANGUAGE=</span><br><span class="line">LC_CTYPE=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_NUMERIC=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_TIME=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_COLLATE=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_MONETARY=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_MESSAGES=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_PAPER=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_NAME=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_ADDRESS=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_TELEPHONE=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_MEASUREMENT=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_IDENTIFICATION=<span class="string">&quot;POSIX&quot;</span></span><br><span class="line">LC_ALL=</span><br><span class="line"></span><br><span class="line">locale <span class="literal">-a</span> <span class="comment"># 查看当前系统可用语言环境</span></span><br><span class="line">root@f9469a74f572:/<span class="comment"># locale -a</span></span><br><span class="line">C</span><br><span class="line">C.UTF<span class="literal">-8</span></span><br><span class="line">POSIX</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加系统语言</span></span><br><span class="line">locale<span class="literal">-gen</span> en_US.UTF<span class="literal">-8</span></span><br><span class="line">bash: locale<span class="literal">-gen</span>: command not found</span><br><span class="line">apt<span class="literal">-get</span> install <span class="literal">-y</span> locales</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export LC_ALL=en_US.UTF-8&quot;</span> &gt;&gt; /root/.bashrc</span><br><span class="line">source /etc/profile</span><br><span class="line">source /root/.bashrc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决（先删除容器内系统语言环境，从宿主机复制语言环境到容器内，建议不要覆盖）</span></span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /usr/share/locale/</span><br><span class="line">docker <span class="built_in">cp</span> /usr/share/locale/ 容器名:/usr/share/locale/</span><br><span class="line">docker <span class="built_in">cp</span> /usr/share/i18n/ 容器名:/usr/share/i18n/</span><br><span class="line"></span><br><span class="line"><span class="comment"># conda</span></span><br><span class="line">/root/anaconda3/lib/python3.<span class="number">7</span>/site<span class="literal">-packages</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/25/restframework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/25/restframework/" class="post-title-link" itemprop="url">restframework</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-25 14:11:22" itemprop="dateCreated datePublished" datetime="2021-10-25T14:11:22+08:00">2021-10-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-11 17:09:13" itemprop="dateModified" datetime="2022-11-11T17:09:13+08:00">2022-11-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="RESTful规范"><a href="#RESTful规范" class="headerlink" title="RESTful规范"></a>RESTful规范</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”</span><br></pre></td></tr></table></figure>

<h4 id="RESTful-API设计"><a href="#RESTful-API设计" class="headerlink" title="RESTful API设计"></a>RESTful API设计</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">	-<span class="number">1</span>  数据的安全保障：url链接一般都采用https协议进行传输</span><br><span class="line">https://api.example.com                         尽量将API部署在专用域名（会存在跨域问题）</span><br><span class="line">https://example.org/api/                        API很简单</span><br><span class="line"></span><br><span class="line">    -<span class="number">2</span>  接口特征表现：api关键字标识</span><br><span class="line">    	-https://api.baidu.com/books/</span><br><span class="line">        -https://www.baidu.com/api/books/</span><br><span class="line">    -<span class="number">3</span> 多版本共存：url链接中标识接口版本</span><br><span class="line">    	-https://api.baidu.com/v1/books/</span><br><span class="line">		-https://api.baidu.com/v2/books/</span><br><span class="line">    -<span class="number">4</span> 数据即是资源，均使用名词（可复数）***********</span><br><span class="line">    	-接口一般都是完成前后台数据的交互，交互的数据我们称之为资源</span><br><span class="line">        -一般提倡用资源的复数形式,不要使用动词</span><br><span class="line">        -查询所有图书</span><br><span class="line">        	-https://api.baidu.com/books/</span><br><span class="line">            -https://api.baidu.com/get_all_books/ <span class="comment"># 错误示范</span></span><br><span class="line">            -https://api.baidu.com/delete-user    <span class="comment"># 错误的示范</span></span><br><span class="line">            -https://api.baidu.com/user           <span class="comment"># 删除用户的示例：疑问：到底是删还是查？</span></span><br><span class="line">                </span><br><span class="line">   -<span class="number">5</span> 资源操作由请求方式决定：</span><br><span class="line">		https://api.baidu.com/books       - get请求：获取所有书</span><br><span class="line">        https://api.baidu.com/books/<span class="number">1</span>     - get请求：获取主键为<span class="number">1</span>的书</span><br><span class="line">        https://api.baidu.com/books       - post请求：新增一本书书</span><br><span class="line">        https://api.baidu.com/books/<span class="number">1</span>     - put请求：整体修改主键为<span class="number">1</span>的书</span><br><span class="line">        https://api.baidu.com/books/<span class="number">1</span>     - patch请求：局部修改主键为<span class="number">1</span>的书</span><br><span class="line">        https://api.baidu.com/books/<span class="number">1</span>     - delete请求：删除主键为<span class="number">1</span>的书</span><br><span class="line">            </span><br><span class="line">   -<span class="number">6</span> 过滤，通过在url上传参的形式传递搜索条件</span><br><span class="line">        https://api.example.com/v1/zoos?limit=<span class="number">10</span>         ：指定返回记录的数量</span><br><span class="line">        https://api.example.com/v1/zoos?offset=<span class="number">10</span>&amp;limit=<span class="number">3</span>：指定返回记录的开始位置</span><br><span class="line">        https://api.example.com/v1/zoos?page=<span class="number">2</span>&amp;per_page=<span class="number">100</span>：指定第几页，以及每页的记录数</span><br><span class="line">        https://api.example.com/v1/zoos?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序</span><br><span class="line">        https://api.example.com/v1/zoos?animal_type_id=<span class="number">1</span>：指定筛选条件</span><br><span class="line">            </span><br><span class="line">   -<span class="number">7</span>  响应状态码</span><br><span class="line">    <span class="number">200</span> OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</span><br><span class="line">    <span class="number">201</span> CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</span><br><span class="line">    <span class="number">202</span> Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">    <span class="number">204</span> NO CONTENT - [DELETE]：用户删除数据成功。</span><br><span class="line">    <span class="number">400</span> INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</span><br><span class="line">    <span class="number">401</span> Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</span><br><span class="line">    <span class="number">403</span> Forbidden - [*] 表示用户得到授权（与<span class="number">401</span>错误相对），但是访问是被禁止的。</span><br><span class="line">    <span class="number">404</span> NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</span><br><span class="line">    <span class="number">406</span> Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">    <span class="number">410</span> Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">    <span class="number">422</span> Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">    <span class="number">500</span> INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。	</span><br><span class="line"></span><br><span class="line">更多看这里：http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</span><br><span class="line">		-返回数据中带状态码</span><br><span class="line">		-&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>&#125;</span><br><span class="line">   -<span class="number">8</span> 返回结果中带错误信息</span><br><span class="line">		-&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;因为xx原因失败&#x27;</span>&#125;</span><br><span class="line">   -<span class="number">9</span> 返回结果，该符合以下规范</span><br><span class="line">		GET /collection：返回资源对象的列表（数组）</span><br><span class="line">        GET /collection/resource：返回单个资源对象（字典）</span><br><span class="line">        POST /collection：返回新生成的资源对象    （新增后的对象字典）</span><br><span class="line">        PUT /collection/resource：返回完整的资源对象 （修改后的对象字典）</span><br><span class="line">        PATCH /collection/resource：返回完整的资源对象 （修改后的对象字典）</span><br><span class="line">        DELETE /collection/resource：返回一个空文档   （）</span><br><span class="line">        </span><br><span class="line">   -<span class="number">10</span> 返回的数据中带链接地址</span><br><span class="line">		-查询<span class="built_in">id</span>为<span class="number">1</span>的图书接口，返回结果示例</span><br><span class="line">    	&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>,</span><br><span class="line">         <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;成功&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;result&#x27;</span>:</span><br><span class="line">             &#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;金瓶梅&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;price&#x27;</span>:<span class="number">12.3</span>,</span><br><span class="line">              <span class="string">&#x27;publish&#x27;</span>:<span class="string">&#x27;https://127.0.0.1/api/v1/publish/3&#x27;</span></span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="APIview源码分析"><a href="#APIview源码分析" class="headerlink" title="APIview源码分析"></a>APIview源码分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> APIview的as_view</span><br><span class="line">	-内部还是执行了View的闭包函数view</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span>(<span class="params">cls, **initkwargs</span>):</span></span><br><span class="line">        view = <span class="built_in">super</span>().as_view(**initkwargs)</span><br><span class="line">        view.cls = cls</span><br><span class="line">        view.initkwargs = initkwargs</span><br><span class="line">        <span class="keyword">return</span> csrf_exempt(view)  -禁用掉了csrf</span><br><span class="line"><span class="number">2</span> 原生View类中过的as_view中的闭包函数view</span><br><span class="line">	-本质执行了self.dispatch(request, *args, **kwargs)，执行的是APIView的dispatch</span><br><span class="line"><span class="number">3</span> APIView的dispatch</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># DRF的Request类的对象，内部有request._request,是原生request</span></span><br><span class="line">        request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line">            <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            #认证，权限，频率</span></span><br><span class="line"><span class="string">            self.perform_authentication(request)</span></span><br><span class="line"><span class="string">        	self.check_permissions(request)</span></span><br><span class="line"><span class="string">        	self.check_throttles(request)</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = <span class="built_in">getattr</span>(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="comment"># 全局的异常捕获</span></span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line">		<span class="comment"># 把视图函数(类)返回的response，又包装了一下</span></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>

<h4 id="请求和响应"><a href="#请求和响应" class="headerlink" title="请求和响应"></a>请求和响应</h4><p><code>请求对象</code></p>
<ul>
<li>REST framework 引入了一个<code>Request</code>扩展常规的对象<code>HttpRequest</code>，并提供更灵活的请求解析。对象的核心功能<code>Request</code>是<code>request.data</code>属性，它类似于<code>request.POST</code>，但对于使用 Web API 更有用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.POST  <span class="comment"># Only handles form data.  Only works for &#x27;POST&#x27; method.</span></span><br><span class="line">request.data  <span class="comment"># Handles arbitrary data.  Works for &#x27;POST&#x27;, &#x27;PUT&#x27; and &#x27;PATCH&#x27; methods.</span></span><br><span class="line">request.FILES</span><br></pre></td></tr></table></figure>

<p><code>响应对象</code></p>
<ul>
<li>REST 框架还引入了一个<code>Response</code>对象，它是一种<code>TemplateResponse</code>接受未渲染内容并使用内容协商来确定返回给客户端的正确内容类型的类型</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Response(data)  <span class="comment"># Renders to content type as requested by the client.</span></span><br></pre></td></tr></table></figure>

<p><code>封装响应</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIResponse</span>(<span class="params">Response</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, code=<span class="number">0</span>, msg=<span class="string">&#x27;&#x27;</span>, status=<span class="literal">None</span>, result=<span class="literal">None</span>, headers=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 content_type=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: code,</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span>: msg</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            data[<span class="string">&#x27;result&#x27;</span>] = result</span><br><span class="line">        data.update(kwargs)</span><br><span class="line">        Response.__init__(self, data=data, status=status, headers=headers, content_type=content_type)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="包装API视图"><a href="#包装API视图" class="headerlink" title="包装API视图"></a>包装API视图</h4><h5 id="api-view"><a href="#api-view" class="headerlink" title="@api_view"></a><code>@api_view</code></h5><ul>
<li>1.<code>@api_view</code>用于处理基于函数的视图的装饰器</li>
<li>2 <code>APIView</code>用于处理基于类的视图的类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all code snippets, or create a new snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        snippets = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = SnippetSerializer(snippets, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve, update or delete a code snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        snippet = Snippet.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(snippet)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(snippet, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">        snippet.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></table></figure>

<ul>
<li>urls.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;snippets/&#x27;</span>, views.snippet_list),</span><br><span class="line">    path(<span class="string">&#x27;snippets/&lt;int:pk&gt;&#x27;</span>, views.snippet_detail),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure>

<h5 id="APIView"><a href="#APIView" class="headerlink" title="APIView"></a><code>APIView</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all snippets, or create a new snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        snippets = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = SnippetSerializer(snippets, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        serializer = SnippetSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve, update or delete a snippet instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self, pk</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> Snippet.objects.get(pk=pk)</span><br><span class="line">        <span class="keyword">except</span> Snippet.DoesNotExist:</span><br><span class="line">            <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        snippet = self.get_object(pk)</span><br><span class="line">        serializer = SnippetSerializer(snippet)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        snippet = self.get_object(pk)</span><br><span class="line">        serializer = SnippetSerializer(snippet, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        snippet = self.get_object(pk)</span><br><span class="line">        snippet.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></table></figure>

<ul>
<li>urls.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;snippets/&#x27;</span>, views.SnippetList.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;snippets/&lt;int:pk&gt;/&#x27;</span>, views.SnippetDetail.as_view()),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure>

<h5 id="GenericAPIView"><a href="#GenericAPIView" class="headerlink" title="GenericAPIView"></a><code>GenericAPIView</code></h5><p>提供的每个具体通用视图都是通过将<code>GenericAPIView</code>, 与一个或多个 mixin 类组合起来的</p>
<ul>
<li><code>queryset</code>- 应该用于从此视图返回对象的查询集。通常，您必须设置此属性或覆盖该<code>get_queryset()</code>方法。如果您要覆盖视图方法，请务必调用<code>get_queryset()</code>而不是直接访问此属性，因为<code>queryset</code>它将被评估一次，并且这些结果将被缓存以供所有后续请求使用。</li>
<li><code>serializer_class</code>- 应该用于验证和反序列化输入以及序列化输出的序列化程序类。通常，您必须设置此属性或覆盖该<code>get_serializer_class()</code>方法。</li>
<li><code>lookup_field</code>- 用于执行单个模型实例的对象查找的模型字段。默认为<code>&#39;pk&#39;</code>. 请注意，在使用超链接 API 时，如果您需要使用自定义值，您需要确保API 视图*和序列化程序类都设置了查找字段。</li>
<li><code>lookup_url_kwarg</code>- 用于对象查找的 URL 关键字参数。URL conf 应包含与此值对应的关键字参数。如果未设置，则默认使用与 相同的值<code>lookup_field</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span>(<span class="params">mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                  mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                  generics.GenericAPIView</span>):</span></span><br><span class="line">    queryset = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = SnippetSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</span><br><span class="line">    </span><br><span class="line">    	</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                    mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                    mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                    generics.GenericAPIView</span>):</span></span><br><span class="line">    queryset = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = SnippetSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>

<h5 id="九个视图类"><a href="#九个视图类" class="headerlink" title="九个视图类"></a><code>九个视图类</code></h5><ul>
<li>使用 mixin 类，我们重写了视图以使用比以前略少的代码，但我们可以更进一步。REST 框架提供了一组已经混合的通用视图，我们可以使用它们来进一步精简我们的<code>views.py</code>模块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = SnippetSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span>(<span class="params">generics.RetrieveUpdateDestroyAPIView</span>):</span></span><br><span class="line">    queryset = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = SnippetSerializer</span><br></pre></td></tr></table></figure>

<h5 id="ViewSet"><a href="#ViewSet" class="headerlink" title="ViewSet"></a><code>ViewSet</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This viewset automatically provides `list`, `create`, `retrieve`,</span></span><br><span class="line"><span class="string">    `update` and `destroy` actions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Additionally we also provide an extra `highlight` action.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = SnippetSerializer</span><br><span class="line">    permission_classes = [permissions.IsAuthenticatedOrReadOnly,</span><br><span class="line">                          IsOwnerOrReadOnly]</span><br></pre></td></tr></table></figure>

<h5 id="自定义通用视图"><a href="#自定义通用视图" class="headerlink" title="自定义通用视图"></a><code>自定义通用视图</code></h5><ul>
<li>例如，如果您需要基于 URL conf 中的多个字段查找对象，您可以创建一个 mixin 类，如下所示</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultipleFieldLookupMixin</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Apply this mixin to any view or viewset to get multiple field filtering</span></span><br><span class="line"><span class="string">    based on a `lookup_fields` attribute, instead of the default single field filtering.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        queryset = self.get_queryset()             <span class="comment"># Get the base queryset</span></span><br><span class="line">        queryset = self.filter_queryset(queryset)  <span class="comment"># Apply any filter backends</span></span><br><span class="line">        <span class="built_in">filter</span> = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> self.lookup_fields:</span><br><span class="line">            <span class="keyword">if</span> self.kwargs[field]: <span class="comment"># Ignore empty fields.</span></span><br><span class="line">                <span class="built_in">filter</span>[field] = self.kwargs[field]</span><br><span class="line">        obj = get_object_or_404(queryset, **<span class="built_in">filter</span>)  <span class="comment"># Lookup the object</span></span><br><span class="line">        self.check_object_permissions(self.request, obj)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure>

<ul>
<li>视图中如下使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveUserView</span>(<span class="params">MultipleFieldLookupMixin, generics.RetrieveAPIView</span>):</span></span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line">    lookup_fields = [<span class="string">&#x27;account&#x27;</span>, <span class="string">&#x27;username&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>全局过滤查询</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> AlgorithmModelSerializer, VideoSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> AlgorithmModel, AlgorithmSliceModel</span><br><span class="line"><span class="keyword">from</span> rest_framework_mongoengine <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultipleFieldLookupMixin</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_kwargs_for_filtering</span>(<span class="params">self</span>):</span></span><br><span class="line">        filtering_kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> self.lookup_fields:</span><br><span class="line">            field_value = self.request.query_params.get(field)</span><br><span class="line">            <span class="keyword">if</span> field_value:</span><br><span class="line">                filtering_kwargs[field] = field_value</span><br><span class="line">        <span class="keyword">return</span> filtering_kwargs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        queryset = self.queryset</span><br><span class="line">        filtering_kwargs = self.get_kwargs_for_filtering()</span><br><span class="line">        <span class="keyword">if</span> filtering_kwargs:</span><br><span class="line">            queryset = queryset.<span class="built_in">filter</span>(**filtering_kwargs)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlgorithmViewSet</span>(<span class="params">MultipleFieldLookupMixin, viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = AlgorithmModel.objects</span><br><span class="line">    serializer_class = AlgorithmModelSerializer</span><br><span class="line">    lookup_fields = [<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoViewSet</span>(<span class="params">MultipleFieldLookupMixin, viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = AlgorithmSliceModel.objects</span><br><span class="line">    serializer_class = VideoSerializer</span><br><span class="line">    lookup_fields = (<span class="string">&#x27;algorithm&#x27;</span>, <span class="string">&#x27;event_name&#x27;</span>, <span class="string">&#x27;event_started__gte&#x27;</span>, <span class="string">&#x27;event_started__lte&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;GET&#x27;</span>], detail=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        video = self.get_object()</span><br><span class="line">        file = video.slice_video.read()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(file, content_type=<span class="string">&#x27;video/mp4&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a router and register our viewsets with it.</span></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;snippets&#x27;</span>, views.SnippetViewSet,basename=<span class="string">&quot;snippets&quot;</span>)</span><br><span class="line">router.register(<span class="string">r&#x27;users&#x27;</span>, views.UserViewSet,basename=<span class="string">&quot;users&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The API URLs are now determined automatically by the router.</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h4 id="序列化器"><a href="#序列化器" class="headerlink" title="序列化器"></a>序列化器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">序列化：序列化器会把模型对象转换成字典，经过response以后变成json字符串</span><br><span class="line">反序列化：把客户端发送过来的数据，经过request以后变成字典，序列化器可以把字典转换成模型</span><br></pre></td></tr></table></figure>

<h5 id="序列化器的字段校验功能"><a href="#序列化器的字段校验功能" class="headerlink" title="序列化器的字段校验功能"></a>序列化器的字段校验功能</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-字段自己的校验规则（max_length...）</span><br><span class="line">   -validators的校验</span><br><span class="line">       publish = serializers.CharField(max_length=<span class="number">32</span>,validators=[check,])</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">data</span>):</span></span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(data)&gt;<span class="number">10</span>:</span><br><span class="line">           <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;最长不能超过10&#x27;</span>)</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">return</span> data</span><br><span class="line">   -局部和全局钩子</span><br><span class="line">       <span class="comment"># 局部钩子,validate_字段名,需要带一个data,data就是该字段的数据</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">validate_title</span>(<span class="params">self, data</span>):</span></span><br><span class="line">       <span class="keyword">if</span> data.startswith(<span class="string">&#x27;sb&#x27;</span>):</span><br><span class="line">           <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;不能以sb开头&#x27;</span>)</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">return</span> data</span><br><span class="line">   <span class="comment"># 全局钩子</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">       title=attrs.get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">       publish=attrs.get(<span class="string">&#x27;publish&#x27;</span>)</span><br><span class="line">       <span class="keyword">if</span> title==publish:</span><br><span class="line">           <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;书名不能跟出版社同名&#x27;</span>)</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">return</span> attrs</span><br></pre></td></tr></table></figure>

<h5 id="高级用法之source"><a href="#高级用法之source" class="headerlink" title="高级用法之source"></a>高级用法之source</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 修改返回到前端的字段名</span><br><span class="line">	<span class="comment"># source=title    返回前端显示的是name</span></span><br><span class="line">	name = serializers.CharField(max_length=<span class="number">32</span>,min_length=<span class="number">2</span>,source=<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line"><span class="number">2</span> 如果表模型中有方法</span><br><span class="line">	<span class="comment"># 执行表模型中的test方法，并且把该方法的返回值赋值给xxx</span></span><br><span class="line">	xxx=serializers.CharField(source=<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"><span class="number">3</span> sourc支持跨表操作</span><br><span class="line">	addr=serializers.CharField(source=<span class="string">&#x27;publish.addr&#x27;</span>)</span><br><span class="line"><span class="number">4</span> 支持choice中文选择</span><br><span class="line">type_choice = serializers.CharField(source=<span class="string">&#x27;get_type_display&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="高级用法之SerializerMethodField"><a href="#高级用法之SerializerMethodField" class="headerlink" title="高级用法之SerializerMethodField"></a>高级用法之SerializerMethodField</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 Serializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(required=<span class="literal">False</span>)</span><br><span class="line">    name = serializers.CharField(max_length=<span class="number">32</span>,min_length=<span class="number">2</span>,source=<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">    price = serializers.DecimalField(max_digits=<span class="number">5</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># SerializerMethodField 必须写一个get_字段名的方法</span></span><br><span class="line">    publish = serializers.SerializerMethodField()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_publish</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">        dic=&#123;<span class="string">&#x27;name&#x27;</span>:obj.publish.name,<span class="string">&#x27;addr&#x27;</span>:obj.publish.addr&#125;</span><br><span class="line">        <span class="keyword">return</span> dic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 ModelSerializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Book</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">    publish = serializers.SerializerMethodField()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_publish</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">        dic=&#123;<span class="string">&#x27;name&#x27;</span>:obj.publish.name,<span class="string">&#x27;addr&#x27;</span>:obj.publish.addr&#125;</span><br><span class="line">        <span class="keyword">return</span> dic</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 3 使用序列化类的嵌套</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Publish</span><br><span class="line">        <span class="comment"># fields = &#x27;__all__&#x27;</span></span><br><span class="line">        fields = [<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;addr&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    publish = PublishModelSerializer()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Book</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        <span class="comment"># read_only_fields 序列化显示该字段不用存库</span></span><br><span class="line">		<span class="comment"># write_only_fields 反序列化 该字段入库需要有值</span></span><br><span class="line">        read_only_fields = [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;author&#x27;</span>]  </span><br><span class="line">        write_only_fields = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;email&#x27;</span>] </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rest_framework_mongoengine 字段选择支持中文选择</span></span><br><span class="line"><span class="keyword">from</span> rest_framework_mongoengine <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> AlgorithmModel, AlgorithmSliceModel</span><br><span class="line"><span class="keyword">from</span> rest_framework_mongoengine <span class="keyword">import</span> fields <span class="keyword">as</span> drfm_fields</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlgorithmModelSerializer</span>(<span class="params">serializers.DocumentSerializer</span>):</span></span><br><span class="line">    <span class="built_in">type</span> = drfm_fields.serializers.CharField(source=<span class="string">&#x27;get_type_display&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = AlgorithmModel</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 经过视图APIview--&gt;执行dispatch方法--&gt;self.initial(request, *args, **kwargs)--&gt;self.perform_authentication(request)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> perform_authentication(self, request)--&gt;需要去Request对象中找user属性或方法</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> Request类中的user方法刚开始来没有_user属性-&gt;self._authenticate()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>dispatch</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    `.dispatch()` is pretty much the same as Django&#x27;s regular dispatch,</span></span><br><span class="line"><span class="string">    but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.args = args</span><br><span class="line">    self.kwargs = kwargs</span><br><span class="line">    request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">    self.request = request</span><br><span class="line">    self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">        <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">            handler = <span class="built_in">getattr</span>(self, request.method.lower(),</span><br><span class="line">                              self.http_method_not_allowed)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">        response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">        response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">    self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>

<ul>
<li>initial</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initial</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Runs anything that needs to occur prior to calling the method handler.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.format_kwarg = self.get_format_suffix(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Perform content negotiation and store the accepted info on the request</span></span><br><span class="line">    neg = self.perform_content_negotiation(request)</span><br><span class="line">    request.accepted_renderer, request.accepted_media_type = neg</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Determine the API version, if versioning is in use.</span></span><br><span class="line">    version, scheme = self.determine_version(request, *args, **kwargs)</span><br><span class="line">    request.version, request.versioning_scheme = version, scheme</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure that the incoming request is permitted</span></span><br><span class="line">    <span class="comment"># 三大组件：认证、权限、频率</span></span><br><span class="line">    self.perform_authentication(request)</span><br><span class="line">    self.check_permissions(request)</span><br><span class="line">    self.check_throttles(request)</span><br></pre></td></tr></table></figure>

<ul>
<li>perform_authentication</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">perform_authentication</span>(<span class="params">self, request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Perform authentication on the incoming request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Note that if you override this and simply &#x27;pass&#x27;, then authentication</span></span><br><span class="line"><span class="string">    will instead be performed lazily, the first time either</span></span><br><span class="line"><span class="string">    `request.user` or `request.auth` is accessed.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    request.user</span><br></pre></td></tr></table></figure>

<ul>
<li>user</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Returns the user associated with the current request, as authenticated</span></span><br><span class="line"><span class="string">    by the authentication classes provided to the request.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;_user&#x27;</span>):</span><br><span class="line">        <span class="keyword">with</span> wrap_attributeerrors():</span><br><span class="line">            self._authenticate()</span><br><span class="line">    <span class="keyword">return</span> self._user</span><br><span class="line"></span><br><span class="line"><span class="meta">@user.setter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">self, value</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Sets the user on the current request. This is necessary to maintain</span></span><br><span class="line"><span class="string">    compatibility with django.contrib.auth where the user property is</span></span><br><span class="line"><span class="string">    set in the login and logout functions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Note that we also set the user on Django&#x27;s underlying `HttpRequest`</span></span><br><span class="line"><span class="string">    instance, ensuring that it is available to any middleware in the stack.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self._user = value</span><br><span class="line">    self._request.user = value</span><br></pre></td></tr></table></figure>

<ul>
<li>self._authenticate()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span>(<span class="params">self</span>):</span></span><br><span class="line">      <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      Attempt to authenticate the request using each authentication instance</span></span><br><span class="line"><span class="string">      in turn.</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">      <span class="comment"># self.authenticators是在视图函数中配置的认证类    authentication_classes = [],循环拿到认证对象</span></span><br><span class="line">      <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">          <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">              user_auth_tuple = authenticator.authenticate(self)</span><br><span class="line">          <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">              self._not_authenticated()</span><br><span class="line">              <span class="keyword">raise</span></span><br><span class="line">	<span class="comment"># 返回值的处理</span></span><br><span class="line">          <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">              self._authenticator = authenticator</span><br><span class="line">              <span class="comment"># 如果有返回值，就将登录用户与登录认证分别保存到request.user, request.auth</span></span><br><span class="line">              self.user, self.auth = user_auth_tuple</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line"><span class="comment"># 如果返回值为空，代表没有登录用户和认证信息，代表游客</span></span><br><span class="line">      self._not_authenticated()</span><br></pre></td></tr></table></figure>

<h4 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 经过视图APIview--&gt;执行dispatch方法--&gt;self.initial(request, *args, **kwargs)--&gt;self.check_permissions(request)</span><br><span class="line">	<span class="comment"># </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_permissions</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Check if the request should be permitted.</span></span><br><span class="line"><span class="string">        Raises an appropriate exception if the request is not permitted.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> permission <span class="keyword">in</span> self.get_permissions():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> permission.has_permission(request, self):</span><br><span class="line">                self.permission_denied(</span><br><span class="line">                    request,</span><br><span class="line">                    message=<span class="built_in">getattr</span>(permission, <span class="string">&#x27;message&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">                    code=<span class="built_in">getattr</span>(permission, <span class="string">&#x27;code&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">                )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <code>内置权限的使用</code></p>
<ul>
<li>权限需要与认证一起使用</li>
<li>python manage.py createsuperuser</li>
<li>视图类加上认证和权限类，即在访问该接口是需要admin登录才可访问，判断的是is_staff字段</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAdminUser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = [SessionAuthentication]</span><br><span class="line">    permission_classes = [IsAdminUser]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="频率"><a href="#频率" class="headerlink" title="频率"></a>频率</h4><p><code>设置限制策略</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;3/m&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;3/m&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;局部配置&quot;&quot;&quot;</span></span><br><span class="line">    queryset = models.Publish.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = PublishModelSerializer</span><br><span class="line">    authentication_classes = (JwtAuthentication,)</span><br><span class="line">    throttle_classes = (UserRateThrottle,)</span><br></pre></td></tr></table></figure>

<p><code>自定义限流</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottles</span>():</span></span><br><span class="line">    VISIT_RECORD = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.history = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="comment"># （1）取出访问者ip</span></span><br><span class="line">        <span class="comment"># print(request.META)</span></span><br><span class="line">        ip = request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="comment"># （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问</span></span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> self.VISIT_RECORD:</span><br><span class="line">            self.VISIT_RECORD[ip] = [ctime, ]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        self.history = self.VISIT_RECORD.get(ip)</span><br><span class="line">        <span class="comment"># （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> ctime - self.history[-<span class="number">1</span>] &gt; <span class="number">60</span>:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="comment"># （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line">        <span class="comment"># （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history) &lt; <span class="number">3</span>:</span><br><span class="line">            self.history.insert(<span class="number">0</span>, ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span> - (ctime - self.history[-<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>views.py</code></p>
<ul>
<li><p><img src="/2021/10/25/restframework/image-20220624153425191.png" alt="restframework"></p>
</li>
<li><p>在运行视图主体之前，检查列表中的每个油门。如果任何节流检查失败，<code>exceptions.Throttled</code>将引发异常，并且视图的主体将不会运行</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.throttle <span class="keyword">import</span> MyThrottles</span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> UserRateThrottle</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> Throttled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;局部配置&quot;&quot;&quot;</span></span><br><span class="line">    queryset = models.Publish.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = PublishModelSerializer</span><br><span class="line">    authentication_classes = (JwtAuthentication,)</span><br><span class="line">    throttle_classes = (MyThrottles,)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">throttled</span>(<span class="params">self, request, wait</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;自定义报错异常&quot;&quot;&quot;</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">MyThrottled</span>(<span class="params">Throttled</span>):</span></span><br><span class="line">            default_detail = <span class="string">&#x27;限流&#x27;</span></span><br><span class="line">            extra_detail_singular = <span class="string">&#x27;还有 &#123;wait&#125; second.&#x27;</span></span><br><span class="line">            extra_detail_plural = <span class="string">&#x27;出了 &#123;wait&#125; seconds.&#x27;</span></span><br><span class="line">            <span class="keyword">raise</span> MyThrottled(wait)</span><br></pre></td></tr></table></figure>

<p><code>SimpleRateThrottle源码分析</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleRateThrottle</span>(<span class="params">BaseThrottle</span>):</span></span><br><span class="line">    <span class="comment"># 咱自己写的放在了全局变量，他的在django的缓存中</span></span><br><span class="line">    cache = default_cache</span><br><span class="line">    <span class="comment"># 获取当前时间，跟咱写的一样</span></span><br><span class="line">    timer = time.time</span><br><span class="line">    <span class="comment"># 做了一个字符串格式化，</span></span><br><span class="line">    cache_format = <span class="string">&#x27;throttle_%(scope)s_%(ident)s&#x27;</span></span><br><span class="line">    scope = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 从配置文件中取DEFAULT_THROTTLE_RATES，所以咱配置文件中应该配置，否则报错</span></span><br><span class="line">    THROTTLE_RATES = api_settings.DEFAULT_THROTTLE_RATES</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(self, <span class="string">&#x27;rate&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            <span class="comment"># 从配置文件中找出scope配置的名字对应的值，比如咱写的‘3/m’,他取出来</span></span><br><span class="line">            self.rate = self.get_rate()</span><br><span class="line">        <span class="comment">#     解析&#x27;3/m&#x27;,解析成 3      m</span></span><br><span class="line">        self.num_requests, self.duration = self.parse_rate(self.rate)</span><br><span class="line">    <span class="comment"># 这个方法需要重写</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Should return a unique cache-key which can be used for throttling.</span></span><br><span class="line"><span class="string">        Must be overridden.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        May return `None` if the request should not be throttled.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&#x27;.get_cache_key() must be overridden&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_rate</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(self, <span class="string">&#x27;scope&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            msg = (<span class="string">&quot;You must set either `.scope` or `.rate` for &#x27;%s&#x27; throttle&quot;</span> %</span><br><span class="line">                   self.__class__.__name__)</span><br><span class="line">            <span class="keyword">raise</span> ImproperlyConfigured(msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取在setting里配置的字典中的之，self.scope是 咱写的luffy</span></span><br><span class="line">            <span class="keyword">return</span> self.THROTTLE_RATES[self.scope]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            msg = <span class="string">&quot;No default throttle rate set for &#x27;%s&#x27; scope&quot;</span> % self.scope</span><br><span class="line">            <span class="keyword">raise</span> ImproperlyConfigured(msg)</span><br><span class="line">    <span class="comment"># 解析 3/m这种传参</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_rate</span>(<span class="params">self, rate</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Given the request rate string, return a two tuple of:</span></span><br><span class="line"><span class="string">        &lt;allowed number of requests&gt;, &lt;period of time in seconds&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> rate <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line">        num, period = rate.split(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        num_requests = <span class="built_in">int</span>(num)</span><br><span class="line">        <span class="comment"># 只取了第一位，也就是 3/mimmmmmmm也是代表一分钟</span></span><br><span class="line">        duration = &#123;<span class="string">&#x27;s&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;m&#x27;</span>: <span class="number">60</span>, <span class="string">&#x27;h&#x27;</span>: <span class="number">3600</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">86400</span>&#125;[period[<span class="number">0</span>]]</span><br><span class="line">        <span class="keyword">return</span> (num_requests, duration)</span><br><span class="line">    <span class="comment"># 逻辑跟咱自定义的相同</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Implement the check to see if the request should be throttled.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        On success calls `throttle_success`.</span></span><br><span class="line"><span class="string">        On failure calls `throttle_failure`.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.rate <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        self.key = self.get_cache_key(request, view)</span><br><span class="line">        <span class="keyword">if</span> self.key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        self.history = self.cache.get(self.key, [])</span><br><span class="line">        self.now = self.timer()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Drop any requests from the history which have now passed the</span></span><br><span class="line">        <span class="comment"># throttle duration</span></span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> self.history[-<span class="number">1</span>] &lt;= self.now - self.duration:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history) &gt;= self.num_requests:</span><br><span class="line">            <span class="keyword">return</span> self.throttle_failure()</span><br><span class="line">        <span class="keyword">return</span> self.throttle_success()</span><br><span class="line">    <span class="comment"># 成功返回true，并且插入到缓存中</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">throttle_success</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Inserts the current request&#x27;s timestamp along with the key</span></span><br><span class="line"><span class="string">        into the cache.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.history.insert(<span class="number">0</span>, self.now)</span><br><span class="line">        self.cache.<span class="built_in">set</span>(self.key, self.history, self.duration)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="comment"># 失败返回false</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">throttle_failure</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Called when a request to the API has failed due to throttling.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns the recommended next request time in seconds.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.history:</span><br><span class="line">            remaining_duration = self.duration - (self.now - self.history[-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            remaining_duration = self.duration</span><br><span class="line"></span><br><span class="line">        available_requests = self.num_requests - <span class="built_in">len</span>(self.history) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> available_requests &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> remaining_duration / <span class="built_in">float</span>(available_requests)</span><br><span class="line">SimpleRateThrottle源码分析</span><br></pre></td></tr></table></figure>

<h4 id="全局异常"><a href="#全局异常" class="headerlink" title="全局异常"></a>全局异常</h4><p><code>exception_handler.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom_exception_handler</span>(<span class="params">exc, context</span>):</span></span><br><span class="line">    <span class="comment"># Call REST framework&#x27;s default exception handler first,</span></span><br><span class="line">    <span class="comment"># to get the standard error response.</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Now add the HTTP status code to the response.</span></span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        message = response.data.get(<span class="string">&#x27;detail&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> message:</span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> response.data.items():</span><br><span class="line">                message = <span class="string">&#x27;&#123;0&#125;: &#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(key, <span class="built_in">str</span>(value[<span class="number">0</span>]))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: response.status_code,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: message,</span><br><span class="line">        &#125;</span><br><span class="line">        response.data = data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/576dbf44b2ae">https://www.jianshu.com/p/576dbf44b2ae</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JWT的构成:第一部分我们称它为头部（header）,第二部分我们称其为载荷（payload, 类似于飞机上承载的物品），第三部分是签证（signature）</span><br><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InN1cGVyIiwiZXhwIjoxNjU2MDQxMDkxLCJlbWFpbCI6IjEyMzQ1NkBxcS5jb20ifQ<span class="number">.0</span>Qex2dytyJGke1Kyl0Dx02XRAjKGlZ8M4OjegdD1bPg</span><br></pre></td></tr></table></figure>

<p><code>自定义JWT认证</code></p>
<p>auth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> BaseJSONWebTokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.utils <span class="keyword">import</span> jwt_decode_handler</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JwtAuthentication</span>(<span class="params">BaseJSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># 认证逻辑()</span></span><br><span class="line">        <span class="comment"># token信息可以放在请求头中,请求地址中</span></span><br><span class="line">        <span class="comment"># key值可以随意叫</span></span><br><span class="line">        <span class="comment"># token = request.GET.get(&#x27;token&#x27;)  # token放到请求地址中</span></span><br><span class="line">        <span class="comment"># token放到请求头中 , key 必须为: Authorization</span></span><br><span class="line">        token = request.META.get(<span class="string">&#x27;HTTP_Authorization&#x27;</span>.upper())</span><br><span class="line">        <span class="comment"># 校验token是否合法</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt_decode_handler(token)</span><br><span class="line">        <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;过期了&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;解码错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;不合法的token&#x27;</span>)</span><br><span class="line">        user = self.authenticate_credentials(payload)</span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> .serializer <span class="keyword">import</span> PublishModelSerializer</span><br><span class="line"><span class="keyword">from</span> utils.authenticate <span class="keyword">import</span> JwtAuthentication</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jwt_response_payload_handler</span>(<span class="params">token, user=<span class="literal">None</span>, request=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;登录成功&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user&quot;</span> : user.username</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;局部配置&quot;&quot;&quot;</span></span><br><span class="line">    queryset = models.Publish.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = PublishModelSerializer</span><br><span class="line">    authentication_classes = (JwtAuthentication,) </span><br><span class="line"> </span><br><span class="line"><span class="comment"># app01/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> obtain_jwt_token</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;test&#x27;</span>, views.TestView, basename=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;login/&#x27;</span>, obtain_jwt_token),</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>settings.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&quot;django_server&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HOST&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PORT&quot;</span>: <span class="number">3306</span>,</span><br><span class="line">        <span class="string">&quot;USER&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PASSWORD&quot;</span>: <span class="string">&quot;1018&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Internationalization</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.2/topics/i18n/</span></span><br><span class="line"></span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_L10N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_TZ = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom settings</span></span><br><span class="line">DATETIME_FORMAT = <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">DATE_FORMAT = <span class="string">&#x27;%Y-%m-%d&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django Rest Framework settings</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># Use Django&#x27;s standard `django.contrib.auth` permissions,</span></span><br><span class="line">    <span class="comment"># or allow read-only access for unauthenticated users.</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="comment"># &#x27;rest_framework.authentication.BasicAuthentication&#x27;,</span></span><br><span class="line">        <span class="string">&#x27;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#x27;</span>, <span class="comment"># </span></span><br><span class="line">        <span class="comment"># &#x27;utils.authenticate.JwtAuthentication&#x27; # 全局配置自定义JWT认证</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_SCHEMA_CLASS&#x27;: &#x27;drf_spectacular.openapi.AutoSchema&#x27;,</span></span><br><span class="line">    <span class="string">&#x27;DATETIME_FORMAT&#x27;</span>: DATETIME_FORMAT,</span><br><span class="line">    <span class="string">&#x27;DATETIME_INPUT_FORMATS&#x27;</span>: [DATETIME_FORMAT],</span><br><span class="line">    <span class="string">&#x27;DATE_FORMAT&#x27;</span>: DATE_FORMAT,</span><br><span class="line">    <span class="string">&#x27;DATE_INPUT_FORMATS&#x27;</span>: [DATE_FORMAT],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: [<span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_RENDERER_CLASSES&#x27;: [&#x27;utils.renderers.MyJSONRender&#x27;],</span></span><br><span class="line">    <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;utils.exception_handler.custom_exception_handler&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># JWT配置过期时间</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="string">&#x27;JWT_RESPONSE_PAYLOAD_HANDLER&#x27;</span>: <span class="string">&#x27;utils.authenticate.jwt_response_payload_handler&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>: datetime.timedelta(seconds=<span class="number">30</span>),<span class="comment">#到期时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>请求测试</code></p>
<ul>
<li>控制JWT登录返回</li>
</ul>
<p><img src="/2021/10/25/restframework/image-20220624160831274.png" alt="restframework"></p>
<ul>
<li>携带authortion 请求接口</li>
</ul>
<p><img src="/2021/10/25/restframework/image-20220624150032412.png" alt="restframework"></p>
<h4 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;lhj&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;129349388&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 编码</span></span><br><span class="line">res = base64.b64encode(json.dumps(data).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="string">&quot;&quot;&quot;b&#x27;eyJ1c2VybmFtZSI6ICJsaGoiLCAicGFzc3dvcmQiOiAiMTI5MzQ5Mzg4IiwgInNleCI6ICJcdTc1MzcifQ==&#x27;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line">ret = base64.b64decode(res)</span><br><span class="line"><span class="built_in">print</span>(json.loads(ret))</span><br><span class="line"><span class="string">&quot;&quot;&quot;&#123;&#x27;username&#x27;: &#x27;lhj&#x27;, &#x27;password&#x27;: &#x27;129349388&#x27;, &#x27;sex&#x27;: &#x27;男&#x27;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="REST-FRAMEWORK配置"><a href="#REST-FRAMEWORK配置" class="headerlink" title="REST_FRAMEWORK配置"></a>REST_FRAMEWORK配置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">AUTH_USER_MODEL = <span class="string">&#x27;user.User&#x27;</span>  <span class="comment"># 应用名.模型类名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Database</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.2/ref/settings/#databases</span></span><br><span class="line"></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&quot;hpd_server&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HOST&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PORT&quot;</span>: <span class="number">3306</span>,</span><br><span class="line">        <span class="string">&quot;USER&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PASSWORD&quot;</span>: <span class="string">&quot;1018&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Internationalization</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.2/topics/i18n/</span></span><br><span class="line"></span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_L10N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_TZ = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Static files (CSS, JavaScript, Images)</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.2/howto/static-files/</span></span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span></span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;static&#x27;</span>)</span><br><span class="line"></span><br><span class="line">MEDIA_URL = <span class="string">&#x27;/media/&#x27;</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;media&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom settings</span></span><br><span class="line">DATETIME_FORMAT = <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">DATE_FORMAT = <span class="string">&#x27;%Y-%m-%d&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django Rest Framework settings</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># Use Django&#x27;s standard `django.contrib.auth` permissions,</span></span><br><span class="line">    <span class="comment"># or allow read-only access for unauthenticated users.</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_SCHEMA_CLASS&#x27;: &#x27;drf_spectacular.openapi.AutoSchema&#x27;,</span></span><br><span class="line">    <span class="string">&#x27;DATETIME_FORMAT&#x27;</span>: DATETIME_FORMAT,</span><br><span class="line">    <span class="string">&#x27;DATETIME_INPUT_FORMATS&#x27;</span>: [DATETIME_FORMAT],</span><br><span class="line">    <span class="string">&#x27;DATE_FORMAT&#x27;</span>: DATE_FORMAT,</span><br><span class="line">    <span class="string">&#x27;DATE_INPUT_FORMATS&#x27;</span>: [DATE_FORMAT],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: [<span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.versioning.URLPathVersioning&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ALLOWED_VERSIONS&#x27;</span>: [<span class="string">&#x27;v1&#x27;</span>, <span class="string">&#x27;v2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_RENDERER_CLASSES&#x27;: [&#x27;utils.renderers.MyJSONRender&#x27;],</span></span><br><span class="line">    <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;utils.exception_handler.custom_exception_handler&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;verbose&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(levelname)s %(asctime)s %(module)s %(lineno)d %(message)s&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;simple&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(levelname)s %(module)s %(lineno)d %(message)s&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;filters&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;require_debug_true&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;()&#x27;</span>: <span class="string">&#x27;django.utils.log.RequireDebugTrue&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment"># 实际开发建议使用WARNING</span></span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filters&#x27;</span>: [<span class="string">&#x27;require_debug_true&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment"># 实际开发建议使用ERROR</span></span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;ERROR&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.RotatingFileHandler&#x27;</span>,</span><br><span class="line">            <span class="comment"># 日志位置,日志文件名,日志保存目录必须手动创建，注：这里的文件路径要注意BASE_DIR代表的是小luffyapi</span></span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: os.path.join(os.path.dirname(BASE_DIR), <span class="string">&quot;logs&quot;</span>, <span class="string">&quot;luffy.log&quot;</span>),</span><br><span class="line">            <span class="comment"># 日志文件的最大值,这里我们设置300M</span></span><br><span class="line">            <span class="string">&#x27;maxBytes&#x27;</span>: <span class="number">300</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">            <span class="comment"># 日志文件的数量,设置最大日志数量为10</span></span><br><span class="line">            <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="comment"># 日志格式:详细格式</span></span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;verbose&#x27;</span>,</span><br><span class="line">            <span class="comment"># 文件内容编码</span></span><br><span class="line">            <span class="string">&#x27;encoding&#x27;</span>: <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 日志对象</span></span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;django&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,  <span class="comment"># 是否让日志信息继续冒泡给其他的日志处理系统</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>版本控制</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;api/&lt;str:version&gt;/algorithm/&#x27;</span>, include(<span class="string">&#x27;algorithm.urls&#x27;</span>)),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> AlgorithmViewSet, VideoViewSet</span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;model&#x27;</span>, AlgorithmViewSet, basename=<span class="string">&#x27;model&#x27;</span>)</span><br><span class="line">router.register(<span class="string">r&#x27;video&#x27;</span>, VideoViewSet, basename=<span class="string">&#x27;video&#x27;</span>)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/29/django+uWSGI+nginx%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/29/django+uWSGI+nginx%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">django+uWSGI+nginx部署</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-29 11:53:00" itemprop="dateCreated datePublished" datetime="2021-09-29T11:53:00+08:00">2021-09-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-25 16:38:22" itemprop="dateModified" datetime="2022-08-25T16:38:22+08:00">2022-08-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="WSGI-uWSGI-uwsgi"><a href="#WSGI-uWSGI-uwsgi" class="headerlink" title="WSGI uWSGI uwsgi"></a>WSGI uWSGI uwsgi</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WSGI:Web服务器网关接口（Python Web Server Gateway Interface，缩写为WSGI）是为Python语言定义的Web服务器和Web应用程序或框架之间的一种简单而通用的接口</span><br><span class="line">uWSGI:它是一个Web服务器（类似的有wsgiref，gunicorn），它实现了WSGI协议、uwsgi、http等协议。用于接收前端服务器转发的动态请求并处理后发给 web 应用程序。</span><br><span class="line">uwsgi:它是uWSGI服务器实现的独有的协议，用于定义传输信息的类型，是用于前端服务器与 uwsgi 的通信规范</span><br></pre></td></tr></table></figure>

<p>WSGI有什么问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">你可能会问“为什么不升级 WSGI”？多年来，这个问题已经被问过很多次，问题通常最终是 WSGI 的单一可调用接口不适合 WebSocket 等更多涉及的 Web 协议。</span><br><span class="line"></span><br><span class="line">WSGI 应用程序是一个单一的、同步的可调用对象，它接受一个请求并返回一个响应；这不允许长期连接，就像您使用长轮询 HTTP 或 WebSocket 连接一样。</span><br><span class="line"></span><br><span class="line">即使我们使这个可调用异步，它仍然只有一个提供请求的路径，因此具有多个传入事件（如接收 WebSocket 帧）的协议无法触发它。</span><br></pre></td></tr></table></figure>

<p>ASGI如何工作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ASGI 被构造为单个异步可调用对象。它需要一个scope，它<span class="built_in">dict</span>包含有关特定连接的详细信息 send，一个异步可调用对象，它允许应用程序向客户端发送事件消息，以及receive一个异步调用对象，它允许应用程序从客户端接收事件消息。</span><br><span class="line"></span><br><span class="line">这不仅允许每个应用程序有多个传入事件和传出事件，还允许后台协程，以便应用程序可以做其他事情（例如侦听外部触发器上的事件，如 Redis 队列）</span><br></pre></td></tr></table></figure>



<h4 id="项目流程"><a href="#项目流程" class="headerlink" title="项目流程"></a>项目流程</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">首先客户端请求服务资源，</span><br><span class="line">nginx作为直接对外的服务接口,接收到客户端发送过来的http请求,会解包、分析，</span><br><span class="line">如果是静态文件请求就根据nginx配置的静态文件目录，返回请求的资源，</span><br><span class="line">如果是动态的请求,nginx就通过配置文件,将请求传递给uWSGI；uWSGI 将接收到的包进行处理，并转发给wsgi，</span><br><span class="line">wsgi根据请求调用django工程的某个文件或函数，处理完后django将返回值交给wsgi，</span><br><span class="line">wsgi将返回值进行打包，转发给uWSGI，</span><br><span class="line">uWSGI接收后转发给nginx,nginx最终将返回值返回给客户端(如浏览器)。</span><br><span class="line"><span class="emphasis">*注:不同的组件之间传递信息涉及到数据格式和协议的转换</span></span><br></pre></td></tr></table></figure>

<h4 id="配置pip源"><a href="#配置pip源" class="headerlink" title="配置pip源"></a>配置pip源</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &amp;&amp; mkdir .pip</span><br><span class="line">cd .pip </span><br><span class="line">vim pip.conf</span><br><span class="line">[<span class="keyword">global</span>]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>

<h4 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装python</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1）前往用户根目录</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: <span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: yum install zlib-devel bzip2-devel ncurses-devel  <span class="comment"># 安装依赖</span></span></span><br><span class="line">2）下载 或 上传 Python3.6.7</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务器终端</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: wget https://www.python.org/ftp/python/3.6.7/Python-3.6.7.tar.xz</span></span><br><span class="line"></span><br><span class="line">3）解压安装包</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: tar -xf Python-3.6.7.tar.xz</span></span><br><span class="line"></span><br><span class="line">4）进入目标文件</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: <span class="built_in">cd</span> Python-3.6.7</span></span><br><span class="line"></span><br><span class="line">5）配置安装路径：mkdir /usr/local/python3</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ./configure --prefix=/usr/<span class="built_in">local</span>/python3 <span class="comment"># 如果报错</span></span></span><br><span class="line">	yum install gcc -y  # 安装gcc编译工具</span><br><span class="line"></span><br><span class="line">6）编译并安装</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: make &amp;&amp; sudo make install</span></span><br><span class="line"></span><br><span class="line">7）建立软连接：终端命令 python3，pip3</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ls -l /usr/bin | grep python <span class="comment">#查看软连接</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ln -s /usr/<span class="built_in">local</span>/python3/bin/python3.6 /usr/bin/python3</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ln -s /usr/<span class="built_in">local</span>/python3/bin/pip3.6 /usr/bin/pip3</span></span><br><span class="line"></span><br><span class="line">8）删除安装包与文件：</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: rm -rf Python-3.6.7</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: rm -rf Python-3.6.7.tar.xz</span></span><br></pre></td></tr></table></figure>

<h4 id="解决linux下pip报错"><a href="#解决linux下pip报错" class="headerlink" title="解决linux下pip报错"></a>解决linux下pip报错</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>安装相关依赖</span><br><span class="line">yum install gcc libffi-devel zlib* openssl-devel</span><br><span class="line"><span class="number">2.</span>安装openssl</span><br><span class="line">wget https://github.com/openssl/openssl/archive/OpenSSL_1_1_1d.tar.gz</span><br><span class="line">tar -zxvf OpenSSL_1_1_1d.tar.gz</span><br><span class="line">mkdir openssl</span><br><span class="line">cd OpenSSL_1_1_1d</span><br><span class="line"><span class="number">3.</span>编译安装</span><br><span class="line">./config --prefix=/usr/local/openssl</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="number">4.</span>替换当前系统旧版本openssl</span><br><span class="line">mv /usr/<span class="built_in">bin</span>/openssl /usr/<span class="built_in">bin</span>/openssl.old</span><br><span class="line">mv /usr/lib64/openssl /usr/lib64/openssl.old</span><br><span class="line">mv /usr/lib64/libssl.so /usr/lib64/libssl.so.old</span><br><span class="line">ln -s /usr/local/openssl/<span class="built_in">bin</span>/openssl /usr/<span class="built_in">bin</span>/openssl</span><br><span class="line">ln -s /usr/local/openssl/include/openssl /usr/include/openssl</span><br><span class="line">ln -s /usr/local/openssl/lib/libssl.so /usr/lib64/libssl.so</span><br><span class="line">echo <span class="string">&quot;/usr/local/openssl/lib&quot;</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line">ldconfig -v </span><br><span class="line"><span class="number">5.</span>查看版本</span><br><span class="line">openssl version</span><br><span class="line">openssl: error <span class="keyword">while</span> loading shared libraries: libcrypto.so<span class="number">.1</span><span class="number">.1</span>: cannot <span class="built_in">open</span> shared <span class="built_in">object</span> file: No such file <span class="keyword">or</span> directory</span><br><span class="line"><span class="comment"># 若查看版本报错加上下面两句      -s软连接 -snf重新指定软链接         </span></span><br><span class="line">ln -s /usr/local/openssl/lib/libcrypto.so<span class="number">.1</span><span class="number">.1</span> /usr/lib64/libcrypto.so<span class="number">.1</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">ln -snf /usr/local/openssl/lib/libcrypto.so<span class="number">.1</span><span class="number">.1</span> /usr/lib64/libcrypto.so<span class="number">.1</span><span class="number">.1</span></span><br><span class="line">[root@FCY-SRV03 openssl-OpenSSL_1_1_1d]<span class="comment"># openssl version</span></span><br><span class="line">OpenSSL <span class="number">1.1</span><span class="number">.1</span>d  <span class="number">10</span> Sep <span class="number">2019</span></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>重新安装python</span><br><span class="line">mkdir python3</span><br><span class="line">cd Python-<span class="number">3.8</span><span class="number">.5</span></span><br><span class="line">./configure --prefix=/usr/local/python3 --<span class="keyword">with</span>-openssl=/usr/local/openssl</span><br><span class="line">make &amp;&amp; sudo make install</span><br><span class="line"><span class="comment"># 如果出现pip警告</span></span><br><span class="line">echo <span class="string">&#x27;export PATH=/usr/local/python3/bin:$PATH&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line"><span class="comment"># 建立软连接</span></span><br><span class="line">ln -s /usr/local/python3/<span class="built_in">bin</span>/python3 /usr/<span class="built_in">bin</span>/python3</span><br><span class="line">ln -s /usr/local/python3/<span class="built_in">bin</span>/pip3 /usr/<span class="built_in">bin</span>/pip3</span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">python3 -v</span><br><span class="line">pip3 -v</span><br></pre></td></tr></table></figure>

<h4 id="配置python虚拟环境"><a href="#配置python虚拟环境" class="headerlink" title="配置python虚拟环境"></a>配置python虚拟环境</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pip3 install virtualenvwrapper</span><br><span class="line">vim ~/.bashrc</span><br><span class="line"><span class="comment"># 增加配置</span></span><br><span class="line">export PATH=/usr/local/python3/<span class="built_in">bin</span>:$PATH</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VIRTUALENVWRAPPER_PYTHON=/usr/local/python3/<span class="built_in">bin</span>/python3    <span class="comment"># 指定virtualenvwrapper执行的python版本</span></span><br><span class="line">export WORKON_HOME=/root/.virtualenv    <span class="comment"># 指定虚拟环境存放目录，.virtualenvs目录名可自拟</span></span><br><span class="line">source /usr/local/python3/<span class="built_in">bin</span>/virtualenvwrapper.sh    <span class="comment"># virtualenvwrapper.sh所在目录</span></span><br><span class="line">source ~/.bashrc <span class="comment"># 激活配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line">mkvirtualenv test</span><br><span class="line"><span class="comment"># 使用虚拟环境</span></span><br><span class="line">workon test</span><br><span class="line"><span class="comment"># 退出虚拟环境</span></span><br><span class="line">deactivate</span><br><span class="line"><span class="comment"># 删除虚拟环境</span></span><br><span class="line">rmvirtualenv test</span><br></pre></td></tr></table></figure>

<h4 id="安装uwsgi"><a href="#安装uwsgi" class="headerlink" title="安装uwsgi"></a>安装uwsgi</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果安装过程中报错</span></span><br><span class="line"><span class="comment"># 1.下载相对对应python版本的python-devel</span></span><br><span class="line"><span class="comment"># 2.openssl版本不对，安装1.1以上，卸载yum安装的openssl-devel</span></span><br><span class="line">yum remove openssl-devel</span><br><span class="line">openssl version</span><br><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure>

<h4 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）前往用户根目录</span><br><span class="line">cd /usr/local/</span><br><span class="line">mkdir nginx</span><br><span class="line">yum -y install gcc pcre-devel zlib-devel openssl openssl-devel </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）下载nginx1<span class="number">.13</span><span class="number">.7</span></span><br><span class="line">wget http://nginx.org/download/nginx-<span class="number">1.13</span><span class="number">.7</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>）解压安装包</span><br><span class="line">tar -xf nginx-<span class="number">1.13</span><span class="number">.7</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>）进入目标文件</span><br><span class="line">cd nginx-<span class="number">1.13</span><span class="number">.7</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>）配置安装路径：</span><br><span class="line">&gt;: ./configure --prefix=/usr/local/nginx</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>）编译并安装</span><br><span class="line">&gt;: make &amp;&amp; sudo make install</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>）建立软连接：终端命令 nginx</span><br><span class="line">&gt;: ln -s /usr/local/nginx/sbin/nginx /usr/<span class="built_in">bin</span>/nginx</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>）删除安装包与文件：</span><br><span class="line">&gt;: cd ~</span><br><span class="line">&gt;: rm -rf nginx-<span class="number">1.13</span><span class="number">.7</span></span><br><span class="line">&gt;: rm -rf nginx-<span class="number">1.13</span><span class="number">.7</span>.tar.xz</span><br><span class="line"></span><br><span class="line"><span class="number">9</span>）测试Nginx环境，服务器运行nginx，本地访问服务器ip</span><br><span class="line">&gt;: nginx</span><br><span class="line">&gt;: 服务器绑定的域名 或 ip:<span class="number">80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Nginx命令</span></span><br><span class="line"><span class="number">1</span>）启动</span><br><span class="line">&gt;: nginx</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）关闭nginx</span><br><span class="line">&gt;: nginx -s stop</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>）重启nginx</span><br><span class="line">&gt;: nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>）查看端口，强行关闭</span><br><span class="line">&gt;: ps -aux|grep nginx</span><br><span class="line">&gt;: kill &lt;pid:进程编号&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h4 id="配置uwsgi-ini"><a href="#配置uwsgi-ini" class="headerlink" title="配置uwsgi.ini"></a>配置uwsgi.ini</h4><ul>
<li>需要在django项目根目录（与manage.py同级目录）下，vim uwsgi.ini，写入相关配置</li>
<li>启动：uwsgi –ini uwsgi.ini<br>停止：uwsgi –stop uwsgi.pid<br>重启：uwsgi –reload uwsgi.pid</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"><span class="comment">#项目目录</span></span><br><span class="line">chdir=/usr/local/project/AlgorithmServer</span><br><span class="line"><span class="comment">#指定项目application</span></span><br><span class="line">module=AlgorithmServer.wsgi:application</span><br><span class="line">home=/root/.virtualenv/AlgorithmServer</span><br><span class="line"><span class="comment">#指定sock的文件路径（nginx使用）</span></span><br><span class="line">socket=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9001</span></span><br><span class="line"><span class="comment">#http=0.0.0.0:8000</span></span><br><span class="line"><span class="comment"># 进程个数（processess一样效果）</span></span><br><span class="line">processes=<span class="number">4</span></span><br><span class="line"><span class="built_in">max</span>-requests=<span class="number">5000</span></span><br><span class="line"><span class="comment">#指定启动时的pid文件路径</span></span><br><span class="line">pidfile=/usr/local/project/AlgorithmServer/uwsgi.pid</span><br><span class="line"><span class="comment">#启用主进程</span></span><br><span class="line">master=<span class="literal">True</span></span><br><span class="line"><span class="comment">#自动移除unix Socket和pid文件当服务停止的时候</span></span><br><span class="line">vacuum=<span class="literal">True</span></span><br><span class="line"><span class="comment">#设置日志目录</span></span><br><span class="line">daemonize=/usr/local/project/AlgorithmServer/uwsgi.log</span><br></pre></td></tr></table></figure>

<h4 id="收集静态资源"><a href="#收集静态资源" class="headerlink" title="收集静态资源"></a>收集静态资源</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/project/AlgorithmServer</span><br><span class="line">mkdir static</span><br><span class="line">chmod 777 static/</span><br><span class="line">python manage.py collectstatic</span><br></pre></td></tr></table></figure>

<h4 id="Django项目配置"><a href="#Django项目配置" class="headerlink" title="Django项目配置"></a>Django项目配置</h4><ul>
<li>settings.py</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">from os import path</span><br><span class="line">from pathlib import Path</span><br><span class="line"></span><br><span class="line"><span class="section"># Build paths inside the project like this: BASE<span class="emphasis">_DIR / &#x27;subdir&#x27;.</span></span></span><br><span class="line"><span class="emphasis"><span class="section">BASE_</span>DIR = Path(<span class="strong">__file__</span>).resolve().parent.parent</span></span><br><span class="line">sys.path.insert(0, path.join(BASE<span class="emphasis">_DIR, &#x27;apps&#x27;))</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># Application definition</span></span><br><span class="line"><span class="emphasis">INSTALLED_</span>APPS = [</span><br><span class="line"><span class="code">    &#x27;rest_framework&#x27;,</span></span><br><span class="line"><span class="code">    &#x27;drf_spectacular&#x27;,</span></span><br><span class="line"><span class="code">    &#x27;django_filters&#x27;,</span></span><br><span class="line"><span class="code"> ]</span></span><br><span class="line"><span class="code"> </span></span><br><span class="line"><span class="code"> </span></span><br><span class="line"><span class="code">TEMPLATES = [</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        &#x27;BACKEND&#x27;: &#x27;django.template.backends.django.DjangoTemplates&#x27;,</span></span><br><span class="line"><span class="code">        &#x27;DIRS&#x27;: [BASE_DIR / &#x27;templates&#x27;]</span></span><br><span class="line"><span class="code">        ,</span></span><br><span class="line"><span class="code">        &#x27;APP_DIRS&#x27;: True,</span></span><br><span class="line"><span class="code">        &#x27;OPTIONS&#x27;: &#123;</span></span><br><span class="line"><span class="code">            &#x27;context_processors&#x27;: [</span></span><br><span class="line"><span class="code">                &#x27;django.template.context_processors.debug&#x27;,</span></span><br><span class="line"><span class="code">                &#x27;django.template.context_processors.request&#x27;,</span></span><br><span class="line"><span class="code">                &#x27;django.contrib.auth.context_processors.auth&#x27;,</span></span><br><span class="line"><span class="code">                &#x27;django.contrib.messages.context_processors.messages&#x27;,</span></span><br><span class="line"><span class="code">            ],</span></span><br><span class="line"><span class="code">        &#125;,</span></span><br><span class="line"><span class="code">    &#125;,</span></span><br><span class="line"><span class="code">]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># Internationalization</span></span><br><span class="line"><span class="section"># https://docs.djangoproject.com/en/3.2/topics/i18n/</span></span><br><span class="line"></span><br><span class="line">LANGUAGE<span class="emphasis">_CODE = &#x27;zh-hans&#x27;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TIME_</span>ZONE = &#x27;Asia/Shanghai&#x27;</span><br><span class="line"></span><br><span class="line">USE<span class="emphasis">_I18N = True</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">USE_</span>L10N = True</span><br><span class="line"></span><br><span class="line">USE<span class="emphasis">_TZ = False</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># Static files (CSS, JavaScript, Images)</span></span><br><span class="line"><span class="emphasis"># https://docs.djangoproject.com/en/3.2/howto/static-files/</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">STATIC_</span>URL = &#x27;/static/&#x27;</span><br><span class="line">STATIC<span class="emphasis">_ROOT = &#x27;static&#x27;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># Default primary key field type</span></span><br><span class="line"><span class="emphasis"># https://docs.djangoproject.com/en/3.2/ref/settings/#default-auto-field</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">DEFAULT_</span>AUTO<span class="emphasis">_FIELD = &#x27;django.db.models.BigAutoField&#x27;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">#MEDIA_</span>ROOT = &#x27;media&#x27;</span><br><span class="line"></span><br><span class="line">MEDIA<span class="emphasis">_URL = &#x27;/media/&#x27;</span></span><br><span class="line"><span class="emphasis">MEDIA_</span>ROOT = &#x27;media&#x27;</span><br><span class="line"></span><br><span class="line"><span class="section"># Custom settings</span></span><br><span class="line">DATETIME<span class="emphasis">_FORMAT = &#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line"><span class="emphasis">DATE_</span>FORMAT = &#x27;%Y-%m-%d&#x27;</span><br><span class="line"></span><br><span class="line"><span class="section"># Django Rest Framework settings</span></span><br><span class="line">REST<span class="emphasis">_FRAMEWORK = &#123;</span></span><br><span class="line"><span class="emphasis">    # Use Django&#x27;s standard `django.contrib.auth` permissions,</span></span><br><span class="line"><span class="emphasis">    # or allow read-only access for unauthenticated users.</span></span><br><span class="line"><span class="emphasis">    &#x27;DEFAULT_</span>PERMISSION<span class="emphasis">_CLASSES&#x27;: [</span></span><br><span class="line"><span class="emphasis">        &#x27;rest_</span>framework.permissions.AllowAny&#x27;,</span><br><span class="line"><span class="code">    ],</span></span><br><span class="line"><span class="code">    &#x27;DEFAULT_SCHEMA_CLASS&#x27;: &#x27;drf_spectacular.openapi.AutoSchema&#x27;,</span></span><br><span class="line"><span class="code">    &#x27;DATETIME_FORMAT&#x27;: DATETIME_FORMAT,</span></span><br><span class="line"><span class="code">    &#x27;DATETIME_INPUT_FORMATS&#x27;: [DATETIME_FORMAT],</span></span><br><span class="line"><span class="code">    &#x27;DATE_FORMAT&#x27;: DATE_FORMAT,</span></span><br><span class="line"><span class="code">    &#x27;DATE_INPUT_FORMATS&#x27;: [DATE_FORMAT],</span></span><br><span class="line"><span class="code">    &#x27;DEFAULT_FILTER_BACKENDS&#x27;: [&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;],</span></span><br><span class="line"><span class="code">    &#x27;DEFAULT_PAGINATION_CLASS&#x27;: &#x27;rest_framework.pagination.PageNumberPagination&#x27;,</span></span><br><span class="line"><span class="code">    &#x27;PAGE_SIZE&#x27;: 10,</span></span><br><span class="line"><span class="code">    # &#x27;DEFAULT_RENDERER_CLASSES&#x27;: [&#x27;utils.renderers.MyJSONRender&#x27;],</span></span><br><span class="line"><span class="code">    &#x27;EXCEPTION_HANDLER&#x27;: &#x27;utils.exception_handler.custom_exception_handler&#x27;</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>urls.py</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from django.urls import path, include</span><br><span class="line">from django.conf import settings</span><br><span class="line">from django.conf.urls.static import static</span><br><span class="line"></span><br><span class="line">from django.views.generic import RedirectView</span><br><span class="line">from drf<span class="emphasis">_spectacular.views import SpectacularAPIView, SpectacularSwaggerView</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">urlpatterns = [</span></span><br><span class="line"><span class="emphasis">    path(&#x27;&#x27;, RedirectView.as_</span>view(url=&#x27;docs/&#x27;)),</span><br><span class="line"><span class="code">    path(&#x27;api/schema/&#x27;, SpectacularAPIView.as_view(), name=&#x27;schema&#x27;),</span></span><br><span class="line"><span class="code">    path(&#x27;docs/&#x27;, SpectacularSwaggerView.as_view(url_name=&#x27;schema&#x27;), name=&#x27;swagger-ui&#x27;),</span></span><br><span class="line"><span class="code">    path(&#x27;admin/&#x27;, admin.site.urls),</span></span><br><span class="line"><span class="code">]</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">if settings.DEBUG:</span><br><span class="line"><span class="code">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT) </span></span><br></pre></td></tr></table></figure>



<h4 id="nginx配置文件"><a href="#nginx配置文件" class="headerlink" title="nginx配置文件"></a>nginx配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet<span class="literal">-stream</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  <span class="number">192.168</span>.<span class="number">17.6</span>;</span><br><span class="line">        charset utf<span class="literal">-8</span>;</span><br><span class="line">        <span class="comment">#access_log  /usr/local/project/AlgorithmServer/nginx_access.log;</span></span><br><span class="line">        <span class="comment">#error_log  /usr/local/project/AlgorithmServer/nginx_error.log;</span></span><br><span class="line">        client_max_body_size <span class="number">75</span>M;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">           include /usr/local/nginx/conf/uwsgi_params;</span><br><span class="line">           uwsgi_pass  <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9001</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	 location /<span class="keyword">static</span> &#123;</span><br><span class="line">           alias  /usr/local/project/AlgorithmServer/<span class="keyword">static</span>;</span><br><span class="line">        &#125;              </span><br><span class="line"></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</span><br><span class="line">        location = /<span class="number">50</span>x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Flask部署"><a href="#Flask部署" class="headerlink" title="Flask部署"></a>Flask部署</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">FROM python:<span class="number">3.9</span></span><br><span class="line">ENV PYTHONDONTWRITEBYTECODE=<span class="number">1</span></span><br><span class="line">ENV PYTHONUNBUFFERED=<span class="number">1</span></span><br><span class="line">WORKDIR /backend</span><br><span class="line"><span class="built_in">COPY</span> ./backend .</span><br><span class="line">RUN pip install  -<span class="literal">-no</span><span class="literal">-cache</span><span class="literal">-dir</span> <span class="literal">-r</span> requirements.txt <span class="literal">-i</span> https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">EXPOSE <span class="number">5000</span></span><br><span class="line"><span class="comment"># 命令启动</span></span><br><span class="line">uwsgi -<span class="literal">-socket</span> <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5000</span> -<span class="literal">-protocol</span>=http <span class="literal">-p</span> <span class="number">3</span> <span class="literal">-w</span> server:app</span><br><span class="line"><span class="comment"># 配置文件</span></span><br><span class="line">[<span class="type">uwsgi</span>]</span><br><span class="line"><span class="comment">#项目目录</span></span><br><span class="line"><span class="built_in">chdir</span>=/backend</span><br><span class="line"><span class="comment">#指定项目application</span></span><br><span class="line"><span class="comment"># server启动脚本:对应里面的app</span></span><br><span class="line">module=server:app</span><br><span class="line"><span class="comment">#指定sock的文件路径（nginx使用）</span></span><br><span class="line"><span class="comment">#socket=0.0.0.0:5000</span></span><br><span class="line">http=<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5000</span></span><br><span class="line"><span class="comment"># 进程个数（processess一样效果）</span></span><br><span class="line">processes=<span class="number">4</span></span><br><span class="line">max<span class="literal">-requests</span>=<span class="number">5000</span></span><br><span class="line"><span class="comment">#指定启动时的pid文件路径</span></span><br><span class="line">pidfile=/backend/uwsgi.pid</span><br><span class="line"><span class="comment">#启用主进程</span></span><br><span class="line">master=True</span><br><span class="line"><span class="comment">#自动移除unix Socket和pid文件当服务停止的时候</span></span><br><span class="line">vacuum=True</span><br><span class="line"><span class="comment">#设置日志目录</span></span><br><span class="line">daemonize=/backend/uwsgi.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/04/RabbitMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/04/RabbitMQ/" class="post-title-link" itemprop="url">RabbitMQ</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-04 18:00:11" itemprop="dateCreated datePublished" datetime="2021-09-04T18:00:11+08:00">2021-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-12 12:58:02" itemprop="dateModified" datetime="2021-11-12T12:58:02+08:00">2021-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li>RabbitMq 是实现了高级消息队列协议（AMQP）的开源消息代理中间件。消息队列是一种应用程序对应用程序的通行方式，应用程序通过写消息，将消息传递于队列，由另一应用程序读取 完成通信。而作为中间件的 RabbitMq 无疑是目前最流行的消息队列之一</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用场景</span></span><br><span class="line">系统的高可用：日常生活当中各种商城秒杀，高流量，高并发的场景。当服务器接收到如此大量请求处理业务时，有宕机的风险。某些业务可能极其复杂，但这部分不是高时效性，不需要立即反馈给用户，我们可以将这部分处理请求抛给队列，让程序后置去处理，减轻服务器在高并发场景下的压力。</span><br><span class="line"></span><br><span class="line">分布式系统，集成系统，子系统之间的对接，以及架构设计中常常需要考虑消息队列的应用</span><br></pre></td></tr></table></figure>

<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Broker：简单来说就是消息队列服务器实体。</span><br><span class="line">Exchange：消息交换机，它指定消息按什么规则，路由到哪个队列。</span><br><span class="line">Queue：消息队列载体，每个消息都会被投入到一个或多个队列。</span><br><span class="line">Binding：绑定，它的作用就是把exchange和queue按照路由规则绑定起来。</span><br><span class="line">Routing Key：路由关键字，exchange根据这个关键字进行消息投递。</span><br><span class="line">vhost：虚拟主机，一个broker里可以开设多个vhost，用作不同用户的权限分离。</span><br><span class="line">producer：消息生产者，就是投递消息的程序。</span><br><span class="line">consumer：消息消费者，就是接受消息的程序。</span><br><span class="line">channel：消息通道，在客户端的每个连接里，可建立多个channel，每个channel代表一个会话任务</span><br></pre></td></tr></table></figure>

<h4 id="轮询模式"><a href="#轮询模式" class="headerlink" title="轮询模式"></a>轮询模式</h4><ul>
<li>此模式下，发送队列的一方把消息存入mq的指定队列后，若有消费者端联入相应队列，即会获取到消息，并且队列中的消息会被消费掉。<br>若有多个消费端同时连接着队列，则会已轮询的方式将队列中的消息消费掉</li>
</ul>
<p><strong>生产者</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">connection = pika.BlockingConnection(pika.ConnectionParameters(</span><br><span class="line">    <span class="string">&#x27;127.0.0.1&#x27;</span>,  <span class="comment"># MQ地址(本机)</span></span><br><span class="line">    <span class="number">5672</span>,  <span class="comment"># 端口号</span></span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>,  <span class="comment"># 虚拟主机</span></span><br><span class="line">    credentials  <span class="comment"># 用户名|密码</span></span><br><span class="line">))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 声明queue</span></span><br><span class="line">channel.queue_declare(</span><br><span class="line">    queue=<span class="string">&#x27;queue_name_test&#x27;</span>,  <span class="comment"># 队列名</span></span><br><span class="line">    durable=<span class="literal">True</span>)  <span class="comment"># 使队列持久化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># n RabbitMQ a message can never be sent directly to the queue, it always needs to go through an exchange.</span></span><br><span class="line">channel.basic_publish(exchange=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                      routing_key=<span class="string">&#x27;queue_name_test&#x27;</span>,</span><br><span class="line">                      body=<span class="string">&#x27;Hello World!&#x27;</span>,</span><br><span class="line">                      properties=pika.BasicProperties(delivery_mode=<span class="number">2</span>, ))  <span class="comment"># 消息持久化</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot; [x] Sent &#x27;Hello World!&#x27;&quot;</span>)</span><br><span class="line">connection.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>消费者</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">auth = pika.PlainCredentials(</span><br><span class="line">    username=&#x27;guest&#x27;,</span><br><span class="line">    password=&#x27;guest&#x27;,</span><br><span class="line">)  # 用户名 / 密码</span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(</span><br><span class="line">        &#x27;127.0.0.1&#x27;,  # RabbitMQ 地址</span><br><span class="line">        5672,  # 端口号</span><br><span class="line">        &#x27;/&#x27;,  # 虚拟主机</span><br><span class="line">        auth,  # 验证</span><br><span class="line">    )</span><br><span class="line">)  # 链接RabbitMQ</span><br><span class="line">channel = connection.channel()  # 创建RabbitMQ通道</span><br><span class="line"></span><br><span class="line">channel.queue_declare(</span><br><span class="line">    queue=&#x27;queue_name_test&#x27;,  # 消费对列名</span><br><span class="line">    durable=True,  # 持久化</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    print(&quot;消费者:  %r&quot; % body)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">channel.basic_consume(  # 消费信息</span><br><span class="line">    queue=&#x27;queue_name_test&#x27;,  # 对列名</span><br><span class="line">    # auto_ack=True,  # 自动回应 ，一般不写，如果机器宕机消息就丢失</span><br><span class="line">    on_message_callback=callback,  # 如果接收到消息，就调用callback回调消息</span><br><span class="line">)</span><br><span class="line">time.sleep(5)  # 模拟消费时间</span><br><span class="line">print(&quot;消费者&quot;)</span><br><span class="line">channel.start_consuming()  # 开始消费</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模拟轮询"><a href="#模拟轮询" class="headerlink" title="模拟轮询"></a>模拟轮询</h4><p><strong>生产者</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">connection = pika.BlockingConnection(pika.ConnectionParameters(</span><br><span class="line">    <span class="string">&#x27;127.0.0.1&#x27;</span>,  <span class="comment"># MQ地址(本机)</span></span><br><span class="line">    <span class="number">5672</span>,  <span class="comment"># 端口号</span></span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>,  <span class="comment"># 虚拟主机</span></span><br><span class="line">    credentials  <span class="comment"># 用户名|密码</span></span><br><span class="line">))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 声明queue</span></span><br><span class="line">channel.queue_declare(</span><br><span class="line">    queue=<span class="string">&#x27;queue_name_test&#x27;</span>,  <span class="comment"># 队列名</span></span><br><span class="line">    durable=<span class="literal">True</span>)  <span class="comment"># 使队列持久化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 轮询模式</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    channel.basic_publish(exchange=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                          routing_key=<span class="string">&#x27;queue_name_test&#x27;</span>,</span><br><span class="line">                          body=<span class="string">&#x27;Hello World &#123;&#125;!&#x27;</span>.<span class="built_in">format</span>(i),</span><br><span class="line">                          properties=pika.BasicProperties(delivery_mode=<span class="number">2</span>, ))  <span class="comment"># 消息持久化</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot; [x] Sent &#x27;Hello World!&#x27;&quot;</span>)</span><br><span class="line">connection.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>新建3个文件消费者（分别启动）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">consumer1打印：消费者:  <span class="string">b&#x27;Hello World 2!&#x27;</span></span><br><span class="line">consumer2打印：消费者:  <span class="string">b&#x27;Hello World 0!&#x27;</span></span><br><span class="line">			  消费者:  <span class="string">b&#x27;Hello World 3!&#x27;</span></span><br><span class="line">consumer3打印：消consumer2打印：费者:  <span class="string">b&#x27;Hello World 1!&#x27;</span></span><br><span class="line">消费者:  <span class="string">b&#x27;Hello World 4!&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>设置权重</strong></p>
<ul>
<li>RabbitMQ给消费者发消息的时候检测下消费者里的消息数量，如果超过指定值（比如1条），就不给你发了。<br>只需要在消费者端，channel.basic_consume前加上就可以了</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">channel.basic_qos(prefetch_count=<span class="number">1</span>)  <span class="comment"># 类似权重，按能力分发，如果有一个消息，就不在给你发</span></span><br><span class="line">channel.basic_consume(  </span><br><span class="line"><span class="comment"># auto_ack=True,  # 自动回应要注释</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>闲置消费</strong></p>
<ul>
<li><p>正常情况如果有多个消费者，是按照顺序第一个消息给第一个消费者，第二个消息给第二个消费者</p>
<p>但是可能第一个消息的消费者处理消息很耗时，一直没结束，就可以让第二个消费者优先获得闲置的消息</p>
</li>
<li><p>consumer</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">auth = pika.PlainCredentials(username=<span class="string">&#x27;guest&#x27;</span>,password=<span class="string">&#x27;guest&#x27;</span>)  </span><br><span class="line">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">5672</span>,  <span class="string">&#x27;/&#x27;</span>, auth,))</span><br><span class="line"> </span><br><span class="line">channel = connection.channel()  </span><br><span class="line"></span><br><span class="line">channel.queue_declare( queue=<span class="string">&#x27;queue_name_test&#x27;</span>, durable=<span class="literal">True</span>, </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    ch.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line">	<span class="built_in">print</span>(body)</span><br><span class="line"></span><br><span class="line">channel.basic_qos(prefetch_count=<span class="number">1</span>) </span><br><span class="line">channel.basic_consume(  </span><br><span class="line">    queue=<span class="string">&#x27;queue_name_test&#x27;</span>,  </span><br><span class="line">    <span class="comment"># auto_ack=True,  # 自动回应 ，一般不写，如果机器宕机消息就丢失</span></span><br><span class="line">    on_message_callback=callback,  </span><br><span class="line">)</span><br><span class="line">time.sleep(<span class="number">5</span>)  <span class="comment"># 模拟消费时间</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;消费者&quot;</span>)</span><br><span class="line">channel.start_consuming()  <span class="comment"># 开始消费</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h4><ul>
<li><strong>每次声明队列的时候，都加上durable</strong>，注意每个队列都得写，客户端、服务端声明的时候都得写，需要重新写一个队列。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.queue_declare(queue=<span class="string">&#x27;hello2&#x27;</span>, durable=<span class="literal">True</span>) <span class="comment"># 队列持久化</span></span><br></pre></td></tr></table></figure>

<ul>
<li>producter</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">properties=pika.BasicProperties(</span><br><span class="line">    delivery_mode=<span class="number">2</span>,  <span class="comment"># 消息持久化，服务器宕机重启消息不会丢失</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h4 id="ack消息确认机制"><a href="#ack消息确认机制" class="headerlink" title="ack消息确认机制"></a>ack消息确认机制</h4><ul>
<li>producer</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&quot;guest&quot;</span>,<span class="string">&quot;guest&quot;</span>)</span><br><span class="line"></span><br><span class="line">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class="string">&#x27;127.0.0.1&#x27;</span>,credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">channel.queue_declare(<span class="string">&#x27;hello&#x27;</span>, durable=<span class="literal">True</span>)</span><br><span class="line">channel.basic_publish(exchange=<span class="string">&#x27;&#x27;</span>, routing_key=<span class="string">&#x27;hello&#x27;</span>, body=<span class="string">&#x27;Hello World!&#x27;</span>, properties=pika.BasicProperties(</span><br><span class="line">    delivery_mode=<span class="number">2</span>, ))   </span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure>

<ul>
<li>consumer</li>
<li>生产者端消息持久后,需要在消费者端加上(ch.basic_ack(delivery_tag =method.delivery_tag)): 保证消息被消费后，消费端发送一个ack，然后服务端从队列删除该消息.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&quot;guest&quot;</span>,<span class="string">&quot;guest&quot;</span>)</span><br><span class="line">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class="string">&#x27;127.0.0.1&#x27;</span>,credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"><span class="comment"># 有可能客户端先启动，hello这个队列可能不存在，它也要声明</span></span><br><span class="line"><span class="comment"># 如果队列存在，就不创建，如果队列不存在，就创建</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">&#x27;hello&#x27;</span>, durable=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    <span class="comment"># 通知服务端，消息取走了，如果auto_ack=False，不加下面，消息会一直存在</span></span><br><span class="line">    ch.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 我从队列中取到了：%s&quot;</span> % body)</span><br><span class="line"></span><br><span class="line">channel.basic_consume(queue=<span class="string">&#x27;hello&#x27;</span>, on_message_callback=callback, auto_ack=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">channel.start_consuming()</span><br></pre></td></tr></table></figure>

<h4 id="广播模式"><a href="#广播模式" class="headerlink" title="广播模式"></a>广播模式</h4><ul>
<li><p>rabbitmq 的发布与订阅要借助交换机（Exchange）的原理实现</p>
</li>
<li><p>Exchange 一共有三种工作模式：<strong>fanout, direct, topicd</strong></p>
</li>
<li><p>需要queue和exchange绑定，因为消费者不是和exchange直连的，消费者是连在queue上，queue绑定在exchange上，消费者只会在queue里拿消息</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">          |------------------------|</span><br><span class="line">          |            /—— queue &lt;—|—&gt; consumer1</span><br><span class="line">producer —|—exchange1 &lt;bind        |                 </span><br><span class="line">       \  |            \—— queue &lt;—|—&gt; consumer2</span><br><span class="line">        \-|-exchange2    ……        |</span><br><span class="line">          |------------------------|</span><br></pre></td></tr></table></figure>

<p><strong>fanout</strong></p>
<p>这种模式下，传递到 exchange 的消息将会<strong>转发到所有</strong>与其绑定的 queue 上。</p>
<ul>
<li>不需要指定 routing_key ，即使指定了也是无效。</li>
<li>需要提前将 exchange 和 queue 绑定，一个 exchange 可以绑定多个 queue，一个queue可以绑定多个exchange。</li>
<li>需要先启动 <strong>订阅者</strong>，此模式下的队列是 consumer 随机生成的，<strong>发布者</strong> 仅仅发布消息到 exchange ，由 exchange 转发消息至 queue。</li>
</ul>
<p><strong>发布者</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>)  <span class="comment"># mq用户名和密码</span></span><br><span class="line"><span class="comment"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span></span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">5672</span>, virtual_host=<span class="string">&#x27;/&#x27;</span>, credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"><span class="comment"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建。durable = True 代表exchange持久化存储，False 非持久化存储</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;python-test&#x27;</span>, durable=<span class="literal">True</span>, exchange_type=<span class="string">&#x27;fanout&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    message = json.dumps(&#123;<span class="string">&#x27;OrderId&#x27;</span>: <span class="string">&quot;1000%s&quot;</span> % i&#125;)</span><br><span class="line">    <span class="comment"># 向队列插入数值 routing_key是队列名。delivery_mode = 2 声明消息在队列中持久化，delivery_mod = 1 消息非持久化。routing_key 不需要配置</span></span><br><span class="line">    channel.basic_publish(exchange=<span class="string">&#x27;python-test&#x27;</span>, routing_key=<span class="string">&#x27;&#x27;</span>, body=message,</span><br><span class="line">                          properties=pika.BasicProperties(delivery_mode=<span class="number">2</span>))</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">connection.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>订阅者</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">connection = pika.BlockingConnection(pika.ConnectionParameters(host = <span class="string">&#x27;127.0.0.1&#x27;</span>,port = <span class="number">5672</span>,virtual_host = <span class="string">&#x27;/&#x27;</span>,credentials = credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"><span class="comment"># 创建临时队列,队列名传空字符，consumer关闭后，队列自动删除</span></span><br><span class="line">result = channel.queue_declare(<span class="string">&#x27;&#x27;</span>,exclusive=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建。durable = True 代表exchange持久化存储，False 非持久化存储</span></span><br><span class="line">channel.exchange_declare(exchange = <span class="string">&#x27;python-test&#x27;</span>,durable = <span class="literal">True</span>, exchange_type=<span class="string">&#x27;fanout&#x27;</span>)</span><br><span class="line"><span class="comment"># 绑定exchange和队列  exchange 使我们能够确切地指定消息应该到哪个队列去</span></span><br><span class="line">channel.queue_bind(exchange = <span class="string">&#x27;python-test&#x27;</span>,queue = result.method.queue)</span><br><span class="line"><span class="comment"># 定义一个回调函数来处理消息队列中的消息，这里是打印出来</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    ch.basic_ack(delivery_tag = method.delivery_tag)</span><br><span class="line">    <span class="built_in">print</span>(body.decode())</span><br><span class="line"></span><br><span class="line">channel.basic_consume(result.method.queue,callback,<span class="comment"># 设置成 False，在调用callback函数时，未收到确认标识，消息会重回队列。True，无论调用callback成功与否，消息都被消费掉</span></span><br><span class="line">                      auto_ack = <span class="literal">False</span>)</span><br><span class="line">channel.start_consuming()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <strong>direct</strong></p>
<p>这种工作模式的原理是 消息发送至 exchange，exchange 根据 <strong>路由键（routing_key）</strong>转发到相对应的 queue 上。</p>
<ul>
<li> 可以使用默认 exchange =’ ‘ ，也可以自定义 exchange</li>
<li>这种模式下不需要将 exchange 和 任何进行绑定，当然绑定也是可以的。可以将 exchange 和 queue ，routing_key 和 queue 进行绑定</li>
<li>传递或接受消息时 需要 <strong>指定 routing_key</strong></li>
<li>需要先启动 <strong>订阅者</strong>，此模式下的队列是 consumer 随机生成的，<strong>发布者</strong> 仅仅发布消息到 exchange ，由 exchange 转发消息至 queue。</li>
</ul>
<p><strong>发布者</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>)  <span class="comment"># mq用户名和密码</span></span><br><span class="line"><span class="comment"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span></span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">5672</span>, virtual_host=<span class="string">&#x27;/&#x27;</span>, credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"><span class="comment"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建。durable = True 代表exchange持久化存储，False 非持久化存储</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;python1-test&#x27;</span>, durable=<span class="literal">True</span>, exchange_type=<span class="string">&#x27;direct&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    message = json.dumps(&#123;<span class="string">&#x27;OrderId&#x27;</span>: <span class="string">&quot;1000%s&quot;</span> % i&#125;)</span><br><span class="line">    <span class="comment"># 指定 routing_key.delivery_mode = 2 声明消息在队列中持久化，delivery_mod = 1 消息非持久化</span></span><br><span class="line">    channel.basic_publish(exchange=<span class="string">&#x27;python1-test&#x27;</span>, routing_key=<span class="string">&#x27;OrderId&#x27;</span>, body=message,</span><br><span class="line">                          properties=pika.BasicProperties(delivery_mode=<span class="number">2</span>))</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure>

<p><strong>订阅者</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">5672</span>, virtual_host=<span class="string">&#x27;/&#x27;</span>, credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line"><span class="comment"># 创建临时队列，队列名传空字符，consumer关闭后，队列自动删除</span></span><br><span class="line">result = channel.queue_declare(<span class="string">&#x27;&#x27;</span>, exclusive=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建。durable = True 代表exchange持久化存储，False 非持久化存储</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;python1-test&#x27;</span>, durable=<span class="literal">True</span>, exchange_type=<span class="string">&#x27;direct&#x27;</span>)</span><br><span class="line"><span class="comment"># 绑定exchange和队列  exchange 使我们能够确切地指定消息应该到哪个队列去</span></span><br><span class="line">channel.queue_bind(exchange=<span class="string">&#x27;python1-test&#x27;</span>, queue=result.method.queue, routing_key=<span class="string">&#x27;OrderId&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个回调函数来处理消息队列中的消息，这里是打印出来</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    ch.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line">    <span class="built_in">print</span>(body.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># channel.basic_qos(prefetch_count=1)</span></span><br><span class="line"><span class="comment"># 告诉rabbitmq，用callback来接受消息</span></span><br><span class="line">channel.basic_consume(result.method.queue, callback,</span><br><span class="line">                      <span class="comment"># 设置成 False，在调用callback函数时，未收到确认标识，消息会重回队列。True，无论调用callback成功与否，消息都被消费掉</span></span><br><span class="line">                      auto_ack=<span class="literal">False</span>)</span><br><span class="line">channel.start_consuming()</span><br></pre></td></tr></table></figure>

<h4 id="RPC实现"><a href="#RPC实现" class="headerlink" title="RPC实现"></a>RPC实现</h4><p><strong>client</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FibonacciRpcClient</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.connection = pika.BlockingConnection(pika.ConnectionParameters(</span><br><span class="line">            host=<span class="string">&#x27;localhost&#x27;</span>))</span><br><span class="line">        self.channel = self.connection.channel()</span><br><span class="line">        result = self.channel.queue_declare(queue=<span class="string">&#x27;&#x27;</span>, exclusive=<span class="literal">True</span>)</span><br><span class="line">        self.callback_queue = result.method.queue</span><br><span class="line"></span><br><span class="line">        self.channel.basic_consume(</span><br><span class="line">            queue=self.callback_queue,</span><br><span class="line">            on_message_callback = self.on_response,  <span class="comment"># 只要一收到消息就调用on_response</span></span><br><span class="line">            auto_ack=<span class="literal">True</span>,</span><br><span class="line">        )  <span class="comment"># 收这个queue的消息</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_response</span>(<span class="params">self, ch, method, props, body</span>):</span>  <span class="comment"># 必须四个参数</span></span><br><span class="line">        <span class="comment"># 如果收到的ID和本机生成的相同，则返回的结果就是我想要的指令返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> self.corr_id == props.correlation_id:</span><br><span class="line">            self.response = body</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        self.response = <span class="literal">None</span>  <span class="comment"># 初始self.response为None</span></span><br><span class="line">        self.corr_id = <span class="built_in">str</span>(uuid.uuid4())  <span class="comment"># 随机唯一字符串</span></span><br><span class="line">        self.channel.basic_publish(</span><br><span class="line">            exchange=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            routing_key=<span class="string">&#x27;rpc_queue&#x27;</span>,  <span class="comment"># 发消息到rpc_queue</span></span><br><span class="line">            properties=pika.BasicProperties(  <span class="comment"># 消息持久化</span></span><br><span class="line">                reply_to=self.callback_queue,  <span class="comment"># 让服务端命令结果返回到callback_queue</span></span><br><span class="line">                correlation_id=self.corr_id,  <span class="comment"># 把随机uuid同时发给服务器</span></span><br><span class="line">            ),</span><br><span class="line">            body=<span class="built_in">str</span>(n)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">while</span> self.response <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># 当没有数据，就一直循环</span></span><br><span class="line">            <span class="comment"># 启动后，on_response函数接到消息，self.response 值就不为空了</span></span><br><span class="line">            self.connection.process_data_events()  <span class="comment"># 非阻塞版的start_consuming()</span></span><br><span class="line">            <span class="comment"># print(&quot;no msg……&quot;)</span></span><br><span class="line">            <span class="comment"># time.sleep(0.5)</span></span><br><span class="line">        <span class="comment"># 收到消息就调用on_response</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(self.response)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    fibonacci_rpc = FibonacciRpcClient()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; [x] Requesting fib(7)&quot;</span>)</span><br><span class="line">    response = fibonacci_rpc.call(<span class="number">7</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; [.] Got %r&quot;</span> % response)</span><br></pre></td></tr></table></figure>

<ul>
<li>server</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">elif</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> fib(n-<span class="number">1</span>) + fib(n-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_request</span>(<span class="params">ch, method, props, body</span>):</span></span><br><span class="line">    n = <span class="built_in">int</span>(body)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; [.] fib(%s)&quot;</span> % n)</span><br><span class="line">    response = fib(n)</span><br><span class="line"></span><br><span class="line">    ch.basic_publish(</span><br><span class="line">            exchange=<span class="string">&#x27;&#x27;</span>,  <span class="comment"># 把执行结果发回给客户端</span></span><br><span class="line">            routing_key=props.reply_to,  <span class="comment"># 客户端要求返回想用的queue</span></span><br><span class="line">            <span class="comment"># 返回客户端发过来的correction_id 为了让客户端验证消息一致性</span></span><br><span class="line">            properties=pika.BasicProperties(correlation_id = props.correlation_id),</span><br><span class="line">            body=<span class="built_in">str</span>(response)</span><br><span class="line">    )</span><br><span class="line">    ch.basic_ack(delivery_tag = method.delivery_tag)  <span class="comment"># 任务完成，告诉客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    connection = pika.BlockingConnection(pika.ConnectionParameters(</span><br><span class="line">            host=<span class="string">&#x27;localhost&#x27;</span>))</span><br><span class="line">    channel = connection.channel()</span><br><span class="line">    channel.queue_declare(queue=<span class="string">&#x27;rpc_queue&#x27;</span>)  <span class="comment"># 声明一个rpc_queue ,</span></span><br><span class="line"></span><br><span class="line">    channel.basic_qos(prefetch_count=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 在rpc_queue里收消息,收到消息就调用on_request</span></span><br><span class="line">    channel.basic_consume(queue=<span class="string">&#x27;rpc_queue&#x27;</span>,on_message_callback = on_request)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; [x] Awaiting RPC requests&quot;</span>)</span><br><span class="line">    channel.start_consuming()</span><br></pre></td></tr></table></figure>

<h4 id="linux安装"><a href="#linux安装" class="headerlink" title="linux安装"></a>linux安装</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.将rabbitmq安装包上传到linux系统中</span></span><br><span class="line">	erlang-<span class="number">22.0</span><span class="number">.7</span>-<span class="number">1.</span>el7.x86_64.rpm  <span class="comment">#l7表示是Centosl7,Centosl8表示Centos8</span></span><br><span class="line">	rabbitmq-server-<span class="number">3.7</span><span class="number">.18</span>-<span class="number">1.</span>el7.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装Erlang依赖包</span></span><br><span class="line">	rpm -ivh erlang-<span class="number">22.0</span><span class="number">.7</span>-<span class="number">1.</span>el7.x86_64.rpm</span><br><span class="line">    rpm -ivh socat-<span class="number">1.7</span><span class="number">.3</span><span class="number">.2</span>-<span class="number">2.</span>el7.x86_64.rpm</span><br><span class="line">	rpm -ivh rabbitmq-server-<span class="number">3.7</span><span class="number">.18</span>-<span class="number">1.</span>el7.noarch.rpm</span><br><span class="line"><span class="comment"># 3.安装RabbitMQ安装包(需要联网)</span></span><br><span class="line">	yum install -y rabbitmq-server-<span class="number">3.7</span><span class="number">.18</span>-<span class="number">1.</span>el7.noarch.rpm</span><br><span class="line">	注意:默认安装完成后配置文件模板在:/usr/share/doc/rabbitmq-server-<span class="number">3.7</span><span class="number">.18</span>/rabbitmq.config.example目录中,需要	</span><br><span class="line">	将配置文件复制到/etc/rabbitmq/目录中,并修改名称为rabbitmq.config</span><br><span class="line"><span class="comment"># 4.复制配置文件</span></span><br><span class="line">	cp /usr/share/doc/rabbitmq-server-<span class="number">3.7</span><span class="number">.18</span>/rabbitmq.config.example /etc/rabbitmq/rabbitmq.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.查看配置文件位置</span></span><br><span class="line">	ls /etc/rabbitmq/rabbitmq.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.修改配置文件(参见下图:)</span></span><br><span class="line">	vim /etc/rabbitmq/rabbitmq.config </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/04/RabbitMQ/image-20210905231220486.png" alt="RabbitMQ"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将上图中配置文件中红色部分去掉`%%`,以及最后的`,`逗号 </span><br><span class="line">修改为下图:</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/04/RabbitMQ/image-20210905231408847.png" alt="RabbitMQ"></p>
<p><img src="/2021/09/04/RabbitMQ/image-20210905231555985.png" alt="RabbitMQ"></p>
<p><img src="/2021/09/04/RabbitMQ/image-20210905231852033.png" alt="RabbitMQ"></p>
<p><img src="/2021/09/04/RabbitMQ/image-20210905232051467.png" alt="RabbitMQ"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 7.执行如下命令,启动rabbitmq中的插件管理</span></span><br><span class="line">	rabbitmq-plugins enable rabbitmq_management</span><br><span class="line">	</span><br><span class="line">	出现如下说明:</span><br><span class="line">		Enabling plugins on node rabbit@localhost:</span><br><span class="line">    rabbitmq_management</span><br><span class="line">    The following plugins have been configured:</span><br><span class="line">      rabbitmq_management</span><br><span class="line">      rabbitmq_management_agent</span><br><span class="line">      rabbitmq_web_dispatch</span><br><span class="line">    Applying plugin configuration to rabbit@localhost...</span><br><span class="line">    The following plugins have been enabled:</span><br><span class="line">      rabbitmq_management</span><br><span class="line">      rabbitmq_management_agent</span><br><span class="line">      rabbitmq_web_dispatch</span><br><span class="line"></span><br><span class="line">    <span class="built_in">set</span> <span class="number">3</span> plugins.</span><br><span class="line">    Offline change; changes will take effect at broker restart.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.启动RabbitMQ的服务</span></span><br><span class="line">	systemctl start rabbitmq-server</span><br><span class="line">	systemctl restart rabbitmq-server</span><br><span class="line">	systemctl stop rabbitmq-server</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.查看服务状态(见下图:)</span></span><br><span class="line">	systemctl status rabbitmq-server</span><br><span class="line">  ● rabbitmq-server.service - RabbitMQ broker</span><br><span class="line">     Loaded: loaded (/usr/lib/systemd/system/rabbitmq-server.service; disabled; vendor preset: disabled)</span><br><span class="line">     Active: active (running) since 三 <span class="number">2019</span>-09-<span class="number">25</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">35</span> CST; 7s ago</span><br><span class="line">   Main PID: <span class="number">2904</span> (beam.smp)</span><br><span class="line">     Status: <span class="string">&quot;Initialized&quot;</span></span><br><span class="line">     CGroup: /system.<span class="built_in">slice</span>/rabbitmq-server.service</span><br><span class="line">             ├─<span class="number">2904</span> /usr/lib64/erlang/erts-<span class="number">10.4</span><span class="number">.4</span>/<span class="built_in">bin</span>/beam.smp -W w -A <span class="number">64</span> -MBas ageffcbf -MHas ageffcbf -</span><br><span class="line">             MBlmbcs...</span><br><span class="line">             ├─<span class="number">3220</span> erl_child_setup <span class="number">32768</span></span><br><span class="line">             ├─<span class="number">3243</span> inet_gethost <span class="number">4</span></span><br><span class="line">             └─<span class="number">3244</span> inet_gethost <span class="number">4</span></span><br><span class="line">      .........</span><br><span class="line"><span class="comment"># 10.关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="rabbitmq命令相关"><a href="#rabbitmq命令相关" class="headerlink" title="rabbitmq命令相关"></a>rabbitmq命令相关</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.服务启动相关</span></span><br><span class="line">	systemctl start|restart|stop|status rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.管理命令行  用来在不使用web管理界面情况下命令操作RabbitMQ</span></span><br><span class="line">	rabbitmqctl  <span class="built_in">help</span>  可以查看更多命令</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.插件管理命令行</span></span><br><span class="line">	rabbitmq-plugins enable|<span class="built_in">list</span>|disable </span><br></pre></td></tr></table></figure>

<h4 id="设置用户名和权限"><a href="#设置用户名和权限" class="headerlink" title="设置用户名和权限"></a>设置用户名和权限</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user xxx <span class="number">123</span></span><br><span class="line"><span class="comment"># 设置用户为administrator角色</span></span><br><span class="line">rabbitmqctl set_user_tags xxx administrator</span><br><span class="line"><span class="comment"># 设置权限</span></span><br><span class="line">rabbitmqctl set_permissions <span class="literal">-p</span> <span class="string">&quot;/&quot;</span> xxx <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后重启rabbiMQ服务</span></span><br><span class="line">systemctl reatart rabbitmq<span class="literal">-server</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 然后可以使用刚才的用户远程连接rabbitmq server了</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="celery使用rabbitmq作为中间件"><a href="#celery使用rabbitmq作为中间件" class="headerlink" title="celery使用rabbitmq作为中间件"></a>celery使用rabbitmq作为中间件</h4><ul>
<li><p><img src="/2021/09/04/RabbitMQ/image-20211112125648863.png" alt="RabbitMQ"></p>
</li>
<li><p>新增mq用户和虚拟主机</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@FCY-SRV02 ~]<span class="comment"># rabbitmqctl add_user foda foda@2021.</span></span><br><span class="line">Adding user <span class="string">&quot;foda&quot;</span> ...</span><br><span class="line">[root@FCY-SRV02 ~]<span class="comment"># rabbitmqctl add_vhost myvhost</span></span><br><span class="line">Adding vhost <span class="string">&quot;myvhost&quot;</span> ...</span><br><span class="line">[root@FCY-SRV02 ~]<span class="comment"># rabbitmqctl set_user_tags foda mytag</span></span><br><span class="line">Setting tags <span class="keyword">for</span> user <span class="string">&quot;foda&quot;</span> to [mytag] ...</span><br><span class="line">[root@FCY-SRV02 ~]<span class="comment"># rabbitmqctl set_permissions -p myvhost foda &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span></span><br><span class="line">Setting permissions <span class="keyword">for</span> user <span class="string">&quot;foda&quot;</span> <span class="keyword">in</span> vhost <span class="string">&quot;myvhost&quot;</span> ...</span><br><span class="line">[root@FCY-SRV02 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>celery.py</li>
<li>启动命令: celery worker -A celery_task -l info -P eventlet</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="string">&quot;AlgorithmServer.settings&quot;</span>)</span><br><span class="line">broker = <span class="string">&#x27;amqp://foda:foda@2021.@10.21.6.12:5672/myvhost&#x27;</span></span><br><span class="line">backend = <span class="string">&#x27;amqp://foda:foda@2021.@10.21.6.12:5672/myvhost&#x27;</span></span><br><span class="line">app = Celery(broker=broker, backend=backend,</span><br><span class="line">             include=[<span class="string">&#x27;celery_task.order_task&#x27;</span>, <span class="string">&#x27;celery_task.user_task&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时区</span></span><br><span class="line">app.conf.timezone = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"><span class="comment"># 是否使用UTC</span></span><br><span class="line">app.conf.enable_utc = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务的定时配置</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> celery.schedules <span class="keyword">import</span> crontab</span><br><span class="line"></span><br><span class="line">app.conf.beat_schedule = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># &#x27;update_banner&#x27;: &#123;</span></span><br><span class="line">    <span class="comment">#     &#x27;task&#x27;: &#x27;&#x27;,</span></span><br><span class="line">    <span class="comment">#     &#x27;schedule&#x27;: timedelta(seconds=10),</span></span><br><span class="line">    <span class="comment">#     # &#x27;schedule&#x27;: crontab(hour=8, day_of_week=1),  # 每周一早八点</span></span><br><span class="line">    <span class="comment">#     # &#x27;schedule&#x27;: crontab(hour=8, day_of_month=1),  # 每月一号早八点</span></span><br><span class="line">    <span class="comment">#     &#x27;args&#x27;: (),</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>django中使用celery异步任务</li>
<li>views.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery_task <span class="keyword">import</span> user_task</span><br><span class="line"><span class="keyword">from</span> celery_task.celery <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> celery.result <span class="keyword">import</span> AsyncResult    </span><br><span class="line">    </span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;GET&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_celery</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="built_in">id</span> = request.GET.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">id</span>:</span><br><span class="line">            res = AsyncResult(<span class="built_in">id</span>=<span class="built_in">id</span>, app=app)</span><br><span class="line">            <span class="keyword">if</span> res.successful():</span><br><span class="line">                result = res.get()</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">return</span> APIResponse(code=<span class="number">1</span>, msg=<span class="string">&#x27;执行完成&#x27;</span>, result=<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">            <span class="keyword">elif</span> res.failed():</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;执行失败&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> res.status == <span class="string">&#x27;PENDING&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;任务等待中被执行&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;PENDING&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> res.status == <span class="string">&#x27;RETRY&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;任务异常后正在重试&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;RETRY&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> res.status == <span class="string">&#x27;STARTED&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;任务已经开始被执行&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;STARTED&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        url = <span class="string">&#x27;http://127.0.0.1:8080/product/getPythonData&#x27;</span></span><br><span class="line">        res = user_task.test.delay(url)</span><br><span class="line">        <span class="keyword">return</span> APIResponse(code=<span class="number">0</span>, result=<span class="string">&#x27;任务号&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(res))</span><br></pre></td></tr></table></figure>

<ul>
<li>user_task.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">url</span>):</span></span><br><span class="line">    response = requests.get(url=url)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h4><ul>
<li>核心解决问题:  当集群中某一时刻master节点宕机,可以对Queue中信息,进行备份</li>
</ul>
<p><img src="/2021/09/04/RabbitMQ/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuaXF1ZV9wZXJmZWN0,size_16,color_FFFFFF,t_70" alt="RabbitMQ"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0.集群规划</span></span><br><span class="line">	node1: <span class="number">10.15</span><span class="number">.0</span><span class="number">.3</span>  mq1  master 主节点</span><br><span class="line">	node2: <span class="number">10.15</span><span class="number">.0</span><span class="number">.4</span>  mq2  repl1  副本节点</span><br><span class="line">	node3: <span class="number">10.15</span><span class="number">.0</span><span class="number">.5</span>  mq3  repl2  副本节点</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.克隆三台机器主机名和ip映射</span></span><br><span class="line">	vim /etc/hosts加入:</span><br><span class="line">        </span><br><span class="line"><span class="number">10.21</span><span class="number">.6</span><span class="number">.11</span>      FCY-SRV01.local FCY-SRV01</span><br><span class="line"><span class="number">10.21</span><span class="number">.6</span><span class="number">.12</span>      FCY-SRV02.local FCY-SRV02</span><br><span class="line"><span class="number">10.21</span><span class="number">.6</span><span class="number">.13</span>      FCY-SRV03.local FCY-SRV03</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.三个机器安装rabbitmq,并同步cookie文件,在node1上执行:</span></span><br><span class="line">	scp /var/lib/rabbitmq/.erlang.cookie root@FCY-SRV02:/var/lib/rabbitmq/</span><br><span class="line">	scp /var/lib/rabbitmq/.erlang.cookie root@FCY-SRV03:/var/lib/rabbitmq/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查看cookie是否一致:</span></span><br><span class="line">	node1: cat /var/lib/rabbitmq/.erlang.cookie </span><br><span class="line">	node2: cat /var/lib/rabbitmq/.erlang.cookie </span><br><span class="line">	node3: cat /var/lib/rabbitmq/.erlang.cookie </span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.后台启动rabbitmq所有节点执行如下命令,启动成功访问管理界面:</span></span><br><span class="line">	rabbitmq-server -detached </span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.在node2和node3执行加入集群命令:</span></span><br><span class="line">	<span class="number">1.</span>关闭       rabbitmqctl stop_app</span><br><span class="line">	<span class="number">2.</span>加入集群    rabbitmqctl join_cluster rabbit@FCY-SRV01</span><br><span class="line">	<span class="number">3.</span>启动服务    rabbitmqctl start_app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.查看集群状态,任意节点执行:</span></span><br><span class="line">	rabbitmqctl cluster_status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.如果出现如下显示,集群搭建成功:</span></span><br><span class="line">[root@FCY-SRV01 rabbitmq]<span class="comment"># rabbitmqctl cluster_status</span></span><br><span class="line">Cluster status of node rabbit@FCY-SRV01 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[<span class="string">&#x27;rabbit@FCY-SRV01&#x27;</span>,<span class="string">&#x27;rabbit@FCY-SRV02&#x27;</span>,<span class="string">&#x27;rabbit@FCY-SRV03&#x27;</span>]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[<span class="string">&#x27;rabbit@FCY-SRV03&#x27;</span>,<span class="string">&#x27;rabbit@FCY-SRV02&#x27;</span>,<span class="string">&#x27;rabbit@FCY-SRV01&#x27;</span>]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;<span class="string">&quot;rabbit@FCY-SRV01.local&quot;</span>&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;<span class="string">&#x27;rabbit@FCY-SRV03&#x27;</span>,[]&#125;,</span><br><span class="line">          &#123;<span class="string">&#x27;rabbit@FCY-SRV02&#x27;</span>,[]&#125;,</span><br><span class="line">          &#123;<span class="string">&#x27;rabbit@FCY-SRV01&#x27;</span>,[]&#125;]&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.登录管理界面,展示如下状态:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/04/RabbitMQ/image-20211106011125448.png" alt="RabbitMQ"></p>
<h4 id="镜像集群"><a href="#镜像集群" class="headerlink" title="镜像集群"></a>镜像集群</h4><p><img src="/2021/09/04/RabbitMQ/20201030230122209.png" alt="RabbitMQ"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">This guide covers mirroring (queue contents replication) </span><br><span class="line">of classic queues  --摘自官网</span><br><span class="line"></span><br><span class="line">By default, contents of a queue within a RabbitMQ </span><br><span class="line">cluster are located on a single node (the node on </span><br><span class="line">which the queue was declared). This <span class="keyword">is</span> <span class="keyword">in</span> contrast </span><br><span class="line">to exchanges <span class="keyword">and</span> bindings, which can always be</span><br><span class="line">considered to be on <span class="built_in">all</span> nodes. Queues can </span><br><span class="line">optionally be made *mirrored* across multiple nodes. </span><br><span class="line">--摘自官网</span><br><span class="line">镜像队列机制就是将队列在三个节点之间设置主从关系，</span><br><span class="line">消息会在三个节点之间进行自动同步，且如果其中一个</span><br><span class="line">节点不可用，并不会导致消息丢失或服务不可用的情况，</span><br><span class="line">提升MQ集群的整体高可用性。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>搭建</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0.策略说明</span></span><br><span class="line">rabbitmqctl set_policy [-<span class="type">p</span> &lt;<span class="type">vhost</span>&gt;] [--<span class="type">priority</span> &lt;<span class="type">priority</span>&gt;] [--<span class="type">apply</span>-<span class="type">to</span> &lt;<span class="type">apply</span>-<span class="type">to</span>&gt;] &lt;name&gt; &lt;pattern&gt;  &lt;definition&gt;</span><br><span class="line"><span class="literal">-p</span> Vhost： 可选参数，针对指定vhost下的queue进行设置</span><br><span class="line">Name:     policy的名称</span><br><span class="line">Pattern: queue的匹配模式(正则表达式)</span><br><span class="line">Definition：镜像定义，包括三个部分ha<span class="literal">-mode</span>, ha<span class="literal">-params</span>, ha<span class="literal">-sync</span><span class="literal">-mode</span></span><br><span class="line">ha<span class="literal">-mode</span>:指明镜像队列的模式，有效值为 all/exactly/nodes</span><br><span class="line">all：表示在集群中所有的节点上进行镜像</span><br><span class="line">exactly：表示在指定个数的节点上进行镜像，节点的个数由ha<span class="literal">-params</span>指定</span><br><span class="line">nodes：表示在指定的节点上进行镜像，节点名称通过ha<span class="literal">-params</span>指定</span><br><span class="line">ha<span class="literal">-params</span>：ha<span class="literal">-mode</span>模式需要用到的参数</span><br><span class="line">ha<span class="literal">-sync</span><span class="literal">-mode</span>：进行队列中消息的同步方式，有效值为automatic和manual</span><br><span class="line">              priority：可选参数，policy的优先级</span><br><span class="line">              </span><br><span class="line">               </span><br><span class="line"><span class="comment"># 1.查看当前策略</span></span><br><span class="line">rabbitmqctl list_policies</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.添加策略</span></span><br><span class="line">rabbitmqctl set_policy ha<span class="literal">-all</span> <span class="string">&#x27;^mongodb&#x27;</span> <span class="string">&#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;,&quot;ha-sync-mode&quot;:&quot;automatic&quot;&#125;&#x27;</span> </span><br><span class="line">说明:策略正则表达式为 “^” 表示所有匹配所有队列名称  ^hello:匹配hello开头队列</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.删除策略</span></span><br><span class="line">rabbitmqctl clear_policy ha<span class="literal">-all</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.测试集群</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/04/RabbitMQ/image-20211106012409207.png" alt="RabbitMQ"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/30/nacos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/30/nacos/" class="post-title-link" itemprop="url">nacos</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-30 09:50:19" itemprop="dateCreated datePublished" datetime="2021-08-30T09:50:19+08:00">2021-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-18 20:36:40" itemprop="dateModified" datetime="2021-10-18T20:36:40+08:00">2021-10-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="nacos服务注册原理"><a href="#nacos服务注册原理" class="headerlink" title="nacos服务注册原理"></a>nacos服务注册原理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nacos 服务注册需要具备的能力：</span></span><br><span class="line">服务提供者把自己的协议地址注册到Nacos server</span><br><span class="line">服务消费者需要从Nacos Server上去查询服务提供者的地址（根据服务名称）</span><br><span class="line">Nacos Server需要感知到服务提供者的上下线的变化</span><br><span class="line">服务消费者需要动态感知到Nacos Server端服务地址的变化</span><br></pre></td></tr></table></figure>



<h4 id="安装nacos"><a href="#安装nacos" class="headerlink" title="安装nacos"></a>安装nacos</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">tar -zxvf nacos-server-1.4.2.tar.gz</span><br><span class="line">tar -zxvf jdk-8u301-linux-x64.tar.gz</span><br><span class="line">vim /etc/profile # 配置java环境</span><br><span class="line">    export JAVA_HOME=/usr/local/jdk1.8.0_301</span><br><span class="line">    export CLASSPATH=$:CLASSPATH:$JAVA_HOME/lib/</span><br><span class="line">    export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">source /etc/profile/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">2）下载mysql57</span><br><span class="line">wget http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line"></span><br><span class="line">3）安装mysql57</span><br><span class="line">yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">yum -y install mysql-community-server</span><br><span class="line"></span><br><span class="line">4）启动mysql57并查看启动状态</span><br><span class="line">systemctl start mysqld.service</span><br><span class="line">systemctl status mysqld.service</span><br><span class="line"></span><br><span class="line">5）查看默认密码并登录</span><br><span class="line">grep &quot;password&quot; /var/log/mysqld.log</span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">6) 修改密码</span><br><span class="line">set password= &#x27;Foda123456?&#x27;;</span><br><span class="line"></span><br><span class="line">7) 创建数据库</span><br><span class="line">create database nacos_config;</span><br><span class="line"></span><br><span class="line">8) 使用数据库</span><br><span class="line">use nacos_config</span><br><span class="line"></span><br><span class="line">9)加载sql脚本</span><br><span class="line">source /usr/local/nacos/conf/nacos-mysql.sql</span><br><span class="line"></span><br><span class="line">10）查看用户权限</span><br><span class="line">SELECT user,host FROM mysql.user;</span><br><span class="line"></span><br><span class="line">GRANT</span><br><span class="line">  [权限] </span><br><span class="line">ON [库.表] </span><br><span class="line">TO [用户名]@[IP] </span><br><span class="line">IDENTIFIED BY [密码] </span><br><span class="line"><span class="meta">#</span><span class="bash"> WITH GRANT OPTION;</span></span><br><span class="line"></span><br><span class="line">- 1 </span><br><span class="line">UPDATE mysql.user SET user.Host=&#x27;%&#x27; where user.User=&#x27;root&#x27;;</span><br><span class="line"></span><br><span class="line">- 2 </span><br><span class="line">GRANT</span><br><span class="line">  ALL PRIVILEGES</span><br><span class="line">ON *.*</span><br><span class="line">TO root@&#x27;192.168.17.210&#x27;</span><br><span class="line">IDENTIFIED BY &#x27;Foda123456?&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10) 加载</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h4><ul>
<li>Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器<br>Apache和Nginx最核心的区别在于 apache 是同步多进程模型，一个连接对应一个进程；而 nginx 是异步的，多个连接（万级别）可以对应一个进程</li>
</ul>
<p>​    http请求转发<br>   反向代理服务器<br>   负载均衡<br>   动静分离</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">1）前往用户根目录</span><br><span class="line">cd /usr/local/</span><br><span class="line">mkdir nginx</span><br><span class="line">yum -y install gcc pcre-devel zlib-devel openssl openssl-devel </span><br><span class="line"></span><br><span class="line">2）下载nginx1.13.7</span><br><span class="line">wget http://nginx.org/download/nginx-1.13.7.tar.gz</span><br><span class="line"></span><br><span class="line">3）解压安装包</span><br><span class="line">tar -xf nginx-1.13.7.tar.gz</span><br><span class="line"></span><br><span class="line">4）进入目标文件</span><br><span class="line">cd nginx-1.13.7</span><br><span class="line"></span><br><span class="line">5）配置安装路径：</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ./configure --prefix=/usr/<span class="built_in">local</span>/nginx</span></span><br><span class="line"></span><br><span class="line">6）编译并安装</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: make &amp;&amp; sudo make install</span></span><br><span class="line"></span><br><span class="line">7）建立软连接：终端命令 nginx</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ln -s /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/bin/nginx</span></span><br><span class="line"></span><br><span class="line">8）删除安装包与文件：</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: <span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: rm -rf nginx-1.13.7</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: rm -rf nginx-1.13.7.tar.xz</span></span><br><span class="line"></span><br><span class="line">9）测试Nginx环境，服务器运行nginx，本地访问服务器ip</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: nginx</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: 服务器绑定的域名 或 ip:80</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">Nginx命令</span></span><br><span class="line">1）启动</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: nginx</span></span><br><span class="line"></span><br><span class="line">2）关闭nginx</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: nginx -s stop</span></span><br><span class="line"></span><br><span class="line">3）重启nginx</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: nginx -s reload</span></span><br><span class="line"></span><br><span class="line">4）查看端口，强行关闭</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: ps -aux|grep nginx</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">: <span class="built_in">kill</span> &lt;pid:进程编号&gt;</span></span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="nacos集群配置"><a href="#nacos集群配置" class="headerlink" title="nacos集群配置"></a>nacos集群配置</h4><p><img src="/2021/08/30/nacos/image-20210830101658816.png" alt="nacos"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nacos/conf</span><br><span class="line">cp application.properties application.properties.bk</span><br><span class="line">cp cluster.conf.example cluster.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改集群配置</span></span><br><span class="line">vim cluster.conf </span><br><span class="line"></span><br><span class="line">192.168.17.1:8848</span><br><span class="line">192.168.17.2:8848</span><br><span class="line">192.168.17.3:8848</span><br><span class="line">192.168.17.4:8848</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改启动脚本，如果遇到内存不足，可以把内存改小点</span></span><br><span class="line">cd ../bin/startup.sh</span><br><span class="line">cp startup.sh startup.sh.bk</span><br><span class="line">vim startup.sh </span><br><span class="line">JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -server -Xms256m -Xmx256m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改nacos配置</span></span><br><span class="line">vim /usr/local/conf/application.properties</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="line">db.user.0=root</span><br><span class="line">db.password.0=&lt;ws7saQZASK2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Connection pool configuration: hikariCP</span></span></span><br><span class="line">db.pool.config.connectionTimeout=30000</span><br><span class="line">db.pool.config.validationTimeout=10000</span><br><span class="line">db.pool.config.maximumPoolSize=20</span><br><span class="line">db.pool.config.minimumIdle=2</span><br><span class="line"></span><br><span class="line">cd /usr/local/nacos/bin</span><br><span class="line">sh startup.sh # 分别启动</span><br><span class="line">sh startup.sh -m standalone # 单机启动</span><br><span class="line">ps -ef|grep nacos|grep -v grep|wc -l # 查看集群个数</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 批量杀掉包含model6.jar的进程</span></span><br><span class="line">for i in `ps -ef|grep model6.jar |awk &#x27;&#123;print $2&#125;&#x27; `; do kill -9 $i ; done;</span><br></pre></td></tr></table></figure>

<h4 id="nginx配置反向代理"><a href="#nginx配置反向代理" class="headerlink" title="nginx配置反向代理"></a>nginx配置反向代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    upstream cluster &#123;</span><br><span class="line">        server  ip1;</span><br><span class="line">        server  ip2;</span><br><span class="line">        server  ip3;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       1111;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">           # root   html;</span><br><span class="line">           # index  index.html index.htm;</span><br><span class="line">           proxy_pass http://cluster;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">nginx -c /usr/local/nginx/conf/nginx.conf # 指定配置文件启动nginx</span><br></pre></td></tr></table></figure>

<h4 id="nacos配置问题"><a href="#nacos配置问题" class="headerlink" title="nacos配置问题"></a>nacos配置问题</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.内存不足，导致启动失败</span></span><br><span class="line">vim startup.sh </span><br><span class="line">JAVA_OPT=<span class="string">&quot;$&#123;JAVA_OPT&#125; -server -Xms256m -Xmx256m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span></span><br><span class="line"><span class="comment"># 2.Caused by: java.lang.IllegalStateException: No DataSource set</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改了数据库url配置参数，解决了问题：</span></span><br><span class="line">vim ../conf/application.properties</span><br><span class="line"></span><br><span class="line">&amp;connectTimeout=<span class="number">10000</span>&amp;socketTimeout=<span class="number">30000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="python连接"><a href="#python连接" class="headerlink" title="python连接"></a>python连接</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nacos</span><br><span class="line"></span><br><span class="line"><span class="comment"># Both HTTP/HTTPS protocols are supported, if not set protocol prefix default is HTTP, and HTTPS with no ssl check(verify=False)</span></span><br><span class="line"><span class="comment"># &quot;192.168.3.4:8848&quot; or &quot;https://192.168.3.4:443&quot; or &quot;http://192.168.3.4:8848,192.168.3.5:8848&quot; or &quot;https://192.168.3.4:443,https://192.168.3.5:443&quot;</span></span><br><span class="line">server_addresses = <span class="string">&quot;http://10.21.6.11:8848&quot;</span></span><br><span class="line">namespace = <span class="string">&quot;public&quot;</span></span><br><span class="line">data_id = <span class="string">&quot;nacos-python&quot;</span></span><br><span class="line">group = <span class="string">&quot;DEFAULT_GROUP&quot;</span></span><br><span class="line"></span><br><span class="line">NacosClient = nacos.NacosClient(server_addresses, namespace=namespace, username=<span class="string">&quot;nacos&quot;</span>, password=<span class="string">&quot;nacos&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># publish_config 发布配置</span></span><br><span class="line"><span class="comment"># ret = NacosClient.publish_config(data_id=data_id, group=group, content=&#x27;public the msg&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_config  获取配置</span></span><br><span class="line"><span class="comment"># print(NacosClient.get_config(data_id, group))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册实例</span></span><br><span class="line">ret = NacosClient.add_naming_instance(<span class="string">&#x27;nacos-python&#x27;</span>, <span class="string">&#x27;10.21.6.21&#x27;</span>, <span class="number">8080</span>, metadata=<span class="literal">None</span>, enable=<span class="literal">True</span>, healthy=<span class="literal">True</span>,</span><br><span class="line">                                      ephemeral=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送心跳</span></span><br><span class="line">NacosClient.send_heartbeat(<span class="string">&#x27;nacos-python&#x27;</span>, <span class="string">&#x27;10.21.6.21&#x27;</span>, <span class="number">8080</span>, metadata=<span class="literal">None</span>, ephemeral=<span class="literal">False</span>,</span><br><span class="line">                           group_name=<span class="string">&#x27;DEFAULT_GROUP&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注销注册实例</span></span><br><span class="line"><span class="comment"># NacosClient.remove_naming_instance(&#x27;nacos-python&#x27;, &#x27;10.21.6.21&#x27;, 8080)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改实例</span></span><br><span class="line"><span class="comment"># NacosClient.modify_naming_instance(&#x27;nacos-python&#x27;, &#x27;10.21.6.11&#x27;, 8848,  weight=None, metadata=None, enable=None)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询实例</span></span><br><span class="line"><span class="comment"># ret = NacosClient.list_naming_instance(&#x27;nacos-python&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询实例详细信息</span></span><br><span class="line"><span class="comment"># NacosClient.get_naming_instance(service_name, ip, port, cluster_name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅服务实例已更改</span></span><br><span class="line"><span class="comment"># NacosClient.subscribe(listener_fn, listener_interval=7, *args, **kwargs)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消订阅服务实例已更改</span></span><br><span class="line"><span class="comment"># NacosClient.unsubscribe(service_name, listener_name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止所有服务订阅</span></span><br><span class="line"><span class="comment"># NacosClient.stop_subscribe()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加观察者</span></span><br><span class="line"><span class="comment"># ret = NacosClient.add_config_watcher(data_id, group, callback())</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>torando</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> nacos</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> tornado.options <span class="keyword">import</span> define, options</span><br><span class="line"><span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop</span><br><span class="line"><span class="keyword">from</span> tornado.httpserver <span class="keyword">import</span> HTTPServer</span><br><span class="line"><span class="keyword">from</span> mongogridfs <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前服务监听的端口</span></span><br><span class="line">define(<span class="string">&quot;port&quot;</span>, default=<span class="number">8080</span>, <span class="built_in">help</span>=<span class="string">&quot;run on the given port&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line"><span class="comment"># 当前在nacos中注册的名称</span></span><br><span class="line">define(<span class="string">&quot;appName&quot;</span>, default=<span class="string">&#x27;nacos-python&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;app name in nacos&quot;</span>, <span class="built_in">type</span>=string)</span><br><span class="line"></span><br><span class="line">server_addresses = <span class="string">&quot;http://192.168.16.1:8848&quot;</span></span><br><span class="line">namespace = <span class="string">&quot;public&quot;</span></span><br><span class="line">data_id = <span class="string">&quot;nacos-python&quot;</span></span><br><span class="line">group = <span class="string">&quot;DEFAULT_GROUP&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        dic = &#123;<span class="string">&#x27;model_id&#x27;</span>: <span class="built_in">str</span>(model_id)&#125;</span><br><span class="line">        self.write(dic)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nacosclient</span>():</span></span><br><span class="line">    tornado.options.parse_command_line()</span><br><span class="line"></span><br><span class="line">    NacosClient = nacos.NacosClient(server_addresses, namespace=namespace, username=<span class="string">&quot;nacos&quot;</span>, password=<span class="string">&quot;nacos&quot;</span>)</span><br><span class="line">    <span class="comment"># 注册实例</span></span><br><span class="line">    NacosClient.add_naming_instance(options.appName, server_addresses, options.port, metadata=<span class="literal">None</span>, enable=<span class="literal">True</span>,</span><br><span class="line">                                    healthy=<span class="literal">True</span>,</span><br><span class="line">                                    ephemeral=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 发送心跳</span></span><br><span class="line">    NacosClient.send_heartbeat(options.appName, server_addresses, options.port, metadata=<span class="literal">None</span>, ephemeral=<span class="literal">False</span>,</span><br><span class="line">                               group_name=<span class="string">&#x27;DEFAULT_GROUP&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    app = tornado.web.Application(handlers=[(<span class="string">r&quot;/&quot;</span>, IndexHandler)])</span><br><span class="line">    http_server = tornado.httpserver.HTTPServer(app)</span><br><span class="line">    http_server.listen(options.port)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;nacos exec&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    nacosclient()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/23/docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/23/docker/" class="post-title-link" itemprop="url">docker</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-23 17:23:37" itemprop="dateCreated datePublished" datetime="2021-08-23T17:23:37+08:00">2021-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-20 16:09:46" itemprop="dateModified" datetime="2022-10-20T16:09:46+08:00">2022-10-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><ul>
<li>简介</li>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/leifengyang/oncloud/kgheaf">https://www.yuque.com/leifengyang/oncloud/kgheaf</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Docker 的基础是 Linux 容器（LXC）等技术。在 LXC 的基础上 Docker</span><br><span class="line">进行了进一步的封装，让用户不需要去关心容器的管理，使得操作更为简便。用户操作 Docker 的容器就像操作一个快速轻量级的虚拟机一样简单。Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不</span><br><span class="line">会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销极低。</span><br></pre></td></tr></table></figure>

<ul>
<li>Docker 虚拟机的比较</li>
</ul>
<table>
<thead>
<tr>
<th>特性</th>
<th align="center">容器</th>
<th align="center">虚拟机</th>
</tr>
</thead>
<tbody><tr>
<td>性能</td>
<td align="center">接近原生</td>
<td align="center">较好</td>
</tr>
<tr>
<td>启动速度</td>
<td align="center">秒级</td>
<td align="center">分钟级</td>
</tr>
<tr>
<td>内存</td>
<td align="center">MB 级</td>
<td align="center">GB 级</td>
</tr>
<tr>
<td>硬盘适应</td>
<td align="center">MB 级</td>
<td align="center">GB 级</td>
</tr>
<tr>
<td>运行密度</td>
<td align="center">单台主机支持上千个</td>
<td align="center">单台主机支持几个</td>
</tr>
<tr>
<td>隔离性</td>
<td align="center">安全隔离</td>
<td align="center">完全隔离</td>
</tr>
<tr>
<td>迁移</td>
<td align="center">优秀</td>
<td align="center">一般</td>
</tr>
</tbody></table>
<p>​            </p>
<ul>
<li>Docker 概念和使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 镜像（Image）</span><br><span class="line">Docker 镜像（Image），就相当于是一个 root 文件系统。比如官方镜像 ubuntu:<span class="number">16.04</span> 就包含了完整的一套 Ubuntu16<span class="number">.04</span> 最小系统的 root 文件系统。</span><br><span class="line"><span class="number">2.</span> 容器（Container）</span><br><span class="line">镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。</span><br><span class="line"><span class="number">3.</span> 仓库（Repository）</span><br><span class="line">用来保存镜像的仓库。当我们构建好自己的镜像之后，需要存放在仓库中，当我们需要启动一个镜像时，可以在仓库中下载下来</span><br></pre></td></tr></table></figure>

<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ul>
<li>更换系统 yum 源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>

<ul>
<li>备份原来的yum源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span><br></pre></td></tr></table></figure>

<ul>
<li>配置阿里源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>

<ul>
<li>刷新yum源缓存</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

<ul>
<li>更新系统</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y --exclud=kernel*</span><br></pre></td></tr></table></figure>

<ul>
<li>安装基础软件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>

<ul>
<li>添加软件源信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<ul>
<li>更新并安装docker-ce</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure>

<ul>
<li>设置开启自启动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now docker</span><br></pre></td></tr></table></figure>

<ul>
<li>测试启动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置镜像加速</p>
</li>
<li><p><img src="/2021/08/23/docker/image-20211011141029612.png" alt="docker"></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">ps -ef|grep docker|grep -v grep</span><br></pre></td></tr></table></figure>

<ul>
<li>卸载</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br><span class="line">yum -y remove docker-ce</span><br><span class="line">rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>

<ul>
<li>docker离线安装</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载离线安装包</span></span><br><span class="line">tar xvf docker<span class="literal">-19</span>.<span class="number">03.3</span>.tgz</span><br><span class="line"><span class="built_in">mv</span> docker/* /usr/bin/</span><br></pre></td></tr></table></figure>

<ul>
<li>vim /etc/systemd/system/docker.service</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">Unit</span>]</span><br><span class="line"></span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line"></span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line"></span><br><span class="line">After=network<span class="literal">-online</span>.target firewalld.service</span><br><span class="line"></span><br><span class="line">Wants=network<span class="literal">-online</span>.target</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">Type</span>=notify</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line"></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> <span class="literal">-s</span> HUP <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line"></span><br><span class="line">LimitNPROC=infinity</span><br><span class="line"></span><br><span class="line">TimeoutStartSec=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">Delegate=yes</span><br><span class="line"></span><br><span class="line">KillMode=<span class="keyword">process</span></span><br><span class="line"></span><br><span class="line">Restart=on<span class="literal">-failure</span></span><br><span class="line"></span><br><span class="line">StartLimitBurst=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">StartLimitInterval=<span class="number">60</span>s</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line"></span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br></pre></td></tr></table></figure>

<ul>
<li>赋执行权限</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">systemctl daemon<span class="literal">-reload</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#开机启动</span></span><br><span class="line"></span><br><span class="line">systemctl enable docker.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动docker</span></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">start</span> docker</span><br></pre></td></tr></table></figure>

<h4 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a><strong>镜像</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker镜像就是要一个只读的模板，用来创建docker容器，一个镜像可以创建多个容器</span><br></pre></td></tr></table></figure>

<p><strong>获取镜像</strong></p>
<ul>
<li>docker pull [image_name]:[image_version]</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull python:3.6</span><br></pre></td></tr></table></figure>

<p><strong>查看镜像</strong> </p>
<ul>
<li><img src="/2021/08/23/docker/image-20210823180134481.png" alt="docker"></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REPOSTITORY：表示镜像的仓库源</span><br><span class="line">TAG：镜像的标签</span><br><span class="line">IMAGE ID：镜像ID</span><br><span class="line">CREATED：镜像创建时间</span><br><span class="line">SIZE：镜像大小</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">-a : 列出所有（包括临时文件）镜像文件</span><br><span class="line">-q : 仅显示 ID 信息</span><br><span class="line">--digests=true|false：列出镜像的数字摘要值</span><br></pre></td></tr></table></figure>



<p><strong>使用镜像启动容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -t -i python:3.6 sh</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><strong>查找镜像</strong></p>
<ul>
<li>Docker Hub 网址为：<em><a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></em></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker search python  </span><br><span class="line">docker search -f is-official=true python # -f : 过滤输出内容</span><br><span class="line">docker search -f stars=8 --limit 3 python  # --limit: 限制输出结果</span><br></pre></td></tr></table></figure>

<p><strong>设置镜像标签</strong></p>
<p><img src="/2021/08/23/docker/image-20210824100949258.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag 镜像ID 源镜像名称/标签</span><br></pre></td></tr></table></figure>

<p><strong>删除镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker rmi 镜像名称:镜像标签</span><br><span class="line">docker rmi 镜像名称:镜像标签 镜像名称:镜像标签 # 删除多个</span><br><span class="line">docker rmi python:pythontag</span><br><span class="line">docker rmi -f python:pythontag  # -f强制删除</span><br><span class="line">docker rmi $(docker images -q)</span><br></pre></td></tr></table></figure>

<p><strong>清理镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker image prune -a  # 删除所有未使用的镜像</span><br><span class="line">docker image prune -a -f  # 强制删除不提示</span><br></pre></td></tr></table></figure>

<p><strong>构建镜像</strong></p>
<ul>
<li>基于容器保存</li>
<li>-a 作者信息 -m 提交信息 -p 提交时，暂停容器运行</li>
</ul>
<p><img src="/2021/08/23/docker/image-20210824104511305.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -it centos /bin/bash  # 启动一个容器、修改并保存</span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p><strong>保存镜像</strong></p>
<ul>
<li><p>export 和 import 的针对点是容器，将本机的容器导出为镜像包</p>
</li>
<li><p>export保存镜像</p>
</li>
</ul>
<p><img src="/2021/08/23/docker/image-20210824105305107.png" alt="docker"></p>
<ul>
<li>import导入镜像</li>
</ul>
<p><img src="/2021/08/23/docker/image-20210824105500458.png" alt="docker"></p>
<p><strong>save和load</strong></p>
<ul>
<li>save 和 load 的针对的点是镜像，将本机的镜像导入、导出为镜像包。</li>
</ul>
<p><strong>save保存镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker save 镜像ID &gt; 压缩包</span><br><span class="line">docker save 4b6c4a2e83f7 &gt; python.tar</span><br><span class="line">docker save -o test.tar centos nginx  # -o 保存多个镜像</span><br></pre></td></tr></table></figure>

<p><strong>load导入镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load  &lt;  python.tar</span><br><span class="line">docker load -i  python.tar</span><br></pre></td></tr></table></figure>

<p><strong>应用场景</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker export 的应用场景：主要用来制作基础镜像，比如我们从一个 ubuntu 镜像启动一个容器，然后安装一些软件和进行一些设置后，使用 docker export 保存为一个基础镜像。然后，把这个镜像分发给其他人使用，比如作为基础的开发环境。</span><br><span class="line"></span><br><span class="line">docker save 的应用场景：如果我们的应用是使用 docker-compose.yml 编排的多个镜像组合，但我们要部署的客户服务器并不能连外网。这时就可以使用docker save 将用到的镜像打个包，然后拷贝到客户服务器上使用docker load 载入</span><br></pre></td></tr></table></figure>

<h4 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h4><p><strong>容器启动参数</strong></p>
<p><img src="/2021/08/23/docker/image-20210824111409641.png" alt="docker"></p>
<p><strong>创建并启动容器</strong></p>
<p><img src="/2021/08/23/docker/image-20210824111834752.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name wantname -e MYSQL_ROOT_PASSWORD=pwd mysql:tag</span><br><span class="line">docker run -d --name nginx -p 80:80 nginx  # 创建并启动容器</span><br><span class="line">docker run -d --name nginx --restart=always -p 80:80  nginx # 开启自启动 </span><br></pre></td></tr></table></figure>

<p><strong>启动容器</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器<span class="built_in">id</span> 或者 容器名</span><br><span class="line">docker start nginx <span class="comment"># 启动容器</span></span><br></pre></td></tr></table></figure>

<p><strong>停止容器</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop 容器<span class="built_in">id</span> 或者 容器名</span><br><span class="line">docker stop nginx  <span class="comment"># 停止容器</span></span><br></pre></td></tr></table></figure>

<p><strong>重启容器</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker restart 容器<span class="built_in">id</span> 或者 容器名</span><br><span class="line">docker restart nginx</span><br></pre></td></tr></table></figure>

<p><strong>进入容器</strong></p>
<p><img src="/2021/08/23/docker/image-20210824113350587.png" alt="docker"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -it python sh <span class="comment"># 创建一个伪终端启动容器</span></span><br><span class="line">exit <span class="comment"># 容器停止退出</span></span><br><span class="line">crtl+P+Q <span class="comment"># 容器不停止退出</span></span><br></pre></td></tr></table></figure>

<p><strong>删除容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器id/名字</span><br><span class="line">docker rm nginx</span><br><span class="line">docker rm -f nginx  # -f强制删除</span><br><span class="line">docker rm -f $(docker ps -a -q) # 删除多个容器</span><br><span class="line">docker ps -a -q|xargs docker rm # 删除多个容器</span><br></pre></td></tr></table></figure>

<p><strong>查看容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect nginx</span><br></pre></td></tr></table></figure>

<p><strong>查看容器日志信息</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f -t --tail</span><br></pre></td></tr></table></figure>

<p><strong>docker启动mongoDB</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name mongodb -p <span class="number">27017</span>:<span class="number">27017</span> mongo:<span class="number">5.0</span><span class="number">.2</span> <span class="comment"># 以守护进程的方式启动mongodb</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mongodb mongo  <span class="comment"># 连接mongodb</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 47eeda0c2c2f  mongo</span><br><span class="line">docker <span class="built_in">exec</span> -it mongodb /<span class="built_in">bin</span>/sh <span class="comment"># 进入docker mongodb容器</span></span><br></pre></td></tr></table></figure>

<p><strong>docker保存容器修改</strong></p>
<p><img src="/2021/08/23/docker/image-20220113160143072.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker commit -m &quot;信息&quot; 容器id 镜像：版本</span></span><br><span class="line">docker commit <span class="literal">-m</span> <span class="string">&quot;install mongoengine&quot;</span> eef33167c716 algorithmserver_web:v2</span><br></pre></td></tr></table></figure>

<h4 id="容器与宿主机文件拷贝"><a href="#容器与宿主机文件拷贝" class="headerlink" title="容器与宿主机文件拷贝"></a>容器与宿主机文件拷贝</h4><p>宿主机-&gt;容器</p>
<p><img src="/2021/08/23/docker/image-20211223165651753.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> 宿主机中要拷贝的文件名及其路径 容器名：要拷贝到容器里面对应的路径</span><br><span class="line">docker <span class="built_in">cp</span> /root/anaconda<span class="literal">-ks</span>.cfg algorithmserver_web_1:/code</span><br></pre></td></tr></table></figure>

<p>容器-&gt;宿主机</p>
<p><img src="/2021/08/23/docker/image-20211223170115929.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> 容器名:文件路径（容器） 宿主机</span><br><span class="line">docker <span class="built_in">cp</span> algorithmserver_web_1:/usr/share/bug/libgl1<span class="literal">-mesa</span><span class="literal">-dev</span> /root</span><br></pre></td></tr></table></figure>



<h4 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h4><ul>
<li>挂载数据卷可实现宿主主机与容器数据共享</li>
</ul>
<p><img src="/2021/08/23/docker/image-20211008172639416.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v /宿主机绝对路径目录:/容器内目录 镜像名</span><br><span class="line">docker run -it -v /宿主机绝对路径目录:/容器内目录:ro 镜像名 #设置权限只读</span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载数据卷</span></span><br><span class="line">docker run -it -v /python/data:/python python:3.9 sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看挂载信息</span></span><br><span class="line">docker inspect 4c27b13aee90</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入容器内部</span></span><br><span class="line">docker attach 4c27b13aee90</span><br><span class="line">docker exec -it 启动的容器别名 sh</span><br></pre></td></tr></table></figure>

<h4 id="数据容器卷"><a href="#数据容器卷" class="headerlink" title="数据容器卷"></a>数据容器卷</h4><ul>
<li>命名的容器挂载数据卷，其它容器通过挂载这个（父容器）实现数据共享，挂载数据卷的容器，称之为数据卷容器</li>
</ul>
<p><img src="/2021/08/23/docker/image-20211009144813551.png" alt="docker"></p>
<p><img src="/2021/08/23/docker/image-20211009145341338.png" alt="docker"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name dc01  lhj/centos </span><br><span class="line">docker run -it --name dc02 --volumes-<span class="keyword">from</span> dc01 lhj/centos</span><br><span class="line">docker run -it --name dc03 --volumes-<span class="keyword">from</span> dc01 lhj/centos</span><br><span class="line">[root@localhost _data]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">163088d46633   lhj/centos   <span class="string">&quot;/bin/sh -c /bin/bash&quot;</span>   <span class="number">18</span> seconds ago   Up <span class="number">17</span> seconds             dc03</span><br><span class="line">90bc58078e62   lhj/centos   <span class="string">&quot;/bin/sh -c /bin/bash&quot;</span>   <span class="number">7</span> minutes ago    Up <span class="number">7</span> minutes              dc02</span><br><span class="line">1654c3f6ad8f   lhj/centos   <span class="string">&quot;/bin/sh -c /bin/bash&quot;</span>   <span class="number">9</span> minutes ago    Up <span class="number">9</span> minutes              dc01</span><br><span class="line">[root@localhost _data]<span class="comment">#</span></span><br><span class="line">[root@localhost _data]<span class="comment"># docker rm -f 1654c3f6ad8f</span></span><br><span class="line">1654c3f6ad8f</span><br><span class="line">[root@localhost _data]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">163088d46633   lhj/centos   <span class="string">&quot;/bin/sh -c /bin/bash&quot;</span>   <span class="number">35</span> seconds ago   Up <span class="number">34</span> seconds             dc03</span><br><span class="line">90bc58078e62   lhj/centos   <span class="string">&quot;/bin/sh -c /bin/bash&quot;</span>   <span class="number">7</span> minutes ago    Up <span class="number">7</span> minutes              dc02</span><br><span class="line">[root@localhost _data]<span class="comment"># docker attach 90bc58078e62</span></span><br><span class="line">[root@90bc58078e62 dataVolumeContainer1]<span class="comment"># ls</span></span><br><span class="line">add01.txt  add02.txt  add03.txt</span><br><span class="line">[root@90bc58078e62 dataVolumeContainer1]<span class="comment"># touch dc02.txt</span></span><br><span class="line">[root@90bc58078e62 dataVolumeContainer1]<span class="comment"># read escape sequence</span></span><br><span class="line">[root@localhost _data]<span class="comment"># docker rm -f 90bc58078e62</span></span><br><span class="line">90bc58078e62</span><br><span class="line">[root@localhost _data]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE        COMMAND                  CREATED              STATUS              PORTS     NAMES</span><br><span class="line">163088d46633   lhj/centos   <span class="string">&quot;/bin/sh -c /bin/bash&quot;</span>   About a minute ago   Up About a minute             dc03</span><br><span class="line">[root@localhost _data]<span class="comment"># docker attach 163088d46633</span></span><br><span class="line">[root@163088d46633 dataVolumeContainer1]<span class="comment"># ls</span></span><br><span class="line">add01.txt  add02.txt  add03.txt  dc02.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="DockerFile解析"><a href="#DockerFile解析" class="headerlink" title="DockerFile解析"></a>DockerFile解析</h4><ul>
<li>DockerFile是用来构建Docker镜像的构建文件，是由一系列命令和参数构成的脚本</li>
</ul>
<p><img src="/2021/08/23/docker/image-20211009142340469.png" alt="docker"></p>
<p><strong>demo</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/dataVolumeContainer1&quot;</span>,<span class="string">&quot;/dataVolumeContainer1&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;finshed,--------success&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash">	/bin/bash</span></span><br></pre></td></tr></table></figure>

<p><strong>构建</strong></p>
<p><img src="/2021/08/23/docker/image-20211009151136347.png" alt="docker"></p>
<ul>
<li>step1 编写DockerFile文件</li>
<li>step2 docker build</li>
<li>step3 docker run</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -f /mydocker/DockerFile -t lhj/centos . #构建DockerFile</span><br><span class="line">docker run -it lhj/centos  #进入容器</span><br><span class="line">docker inspect e0575ea51593 </span><br><span class="line">cd /var/lib/docker/volumes/5331cf60580c2a0eb1e59b830f251e3056ae0fc978f9760a88d61b1b681547f3/_data #默认宿主机挂载位置</span><br></pre></td></tr></table></figure>

<p><strong>结构</strong></p>
<p><img src="/2021/08/23/docker/image-20211009151855127.png" alt="docker"></p>
<p><strong>CMD与ENTRYPOINT区别</strong></p>
<ul>
<li>CMD</li>
<li>会被覆盖，后面指令覆盖前面</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y curl</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash">	[<span class="string">&quot;curl&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;http:ip.cn&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ENTRYPOINT</li>
<li>追加组合</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y curl</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash">	[<span class="string">&quot;curl&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;http:ip.cn&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h4 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h4><p><img src="/2021/08/23/docker/image-20211011113800624.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mydocker]# docker pull mysql:5.6</span><br><span class="line">5.6: Pulling from library/mysql</span><br><span class="line">36d925ed8e30: Pull complete</span><br><span class="line">b8766e63cc85: Pull complete</span><br><span class="line">aab9ef03e185: Pull complete</span><br><span class="line">d9ae834f6554: Pull complete</span><br><span class="line">1f38cd4db895: Pull complete</span><br><span class="line">ed9900fd3414: Pull complete</span><br><span class="line">364aaef88bbc: Pull complete</span><br><span class="line">505933e6336f: Pull complete</span><br><span class="line">f5aa5be6914b: Pull complete</span><br><span class="line">f82ca44b4d49: Pull complete</span><br><span class="line">733552208c91: Pull complete</span><br><span class="line">Digest: sha256:506460490d4f4624f42b820f5a4b07130a8310fafb8cc1f886f1f8da50b3001c</span><br><span class="line">Status: Downloaded newer image for mysql:5.6</span><br><span class="line">docker.io/library/mysql:5.6</span><br><span class="line">[root@localhost mydocker]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">myip1        latest    0f7c2f675ae2   45 minutes ago   231MB</span><br><span class="line">lhj/centos   latest    bebd2d7ea52d   45 hours ago     231MB</span><br><span class="line">mongo        latest    c1a14d3979c5   9 days ago       691MB</span><br><span class="line">python       3.9       6beb0d435def   12 days ago      911MB</span><br><span class="line">nginx        latest    f8f4ffc8092c   12 days ago      133MB</span><br><span class="line">mysql        5.6       8d06d2d16232   12 days ago      303MB</span><br><span class="line">centos       latest    5d0da3dc9764   3 weeks ago      231MB</span><br><span class="line">mongo        5.0.2     0bcbeb494bed   5 weeks ago      684MB</span><br><span class="line">[root@localhost mydocker]# docker run  --name mysql -p 3306:3306 -v /mysql/conf:/etc/mysql/conf.d -v /mysql/logs:/logs -v /mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6</span><br><span class="line">56c038e44ef05235de1b6299483741709fe694720cce3bbfdfc81847453fc6aa</span><br><span class="line">[root@localhost mydocker]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS          PORTS                                           NAMES</span><br><span class="line">56c038e44ef0   mysql:5.6   &quot;docker-entrypoint.s…&quot;   5 seconds ago    Up 4 seconds    0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp       mysql</span><br><span class="line">ed6a14933b20   mongo       &quot;docker-entrypoint.s…&quot;   54 minutes ago   Up 54 minutes   0.0.0.0:21017-&gt;27017/tcp, :::21017-&gt;27017/tcp   loving_sammet</span><br><span class="line"></span><br><span class="line">[root@localhost mydocker]# docker exec -it 56c038e44ef0 /bin/bash</span><br><span class="line">root@56c038e44ef0:/# mysql -u root -p</span><br><span class="line">Enter password: 123456</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.6.51 MySQL Community Server (GPL)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h4><p><img src="/2021/08/23/docker/image-20211011151730237.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.拉取redis镜像</span><br><span class="line">docker pull redis:6.0</span><br><span class="line">2.启动镜像</span><br><span class="line">docker run -p 6379:6379 --name redis -v /myredis/data:/data -v /myredis/conf/redis.conf:/usr/local/etc/redis/redis.conf -d redis:6.0 redis-server /usr/local/etc/redis/redis.conf --appendonly yes</span><br><span class="line">3.在/myredis/conf/redis.conf目录下编辑redis.conf配置文件</span><br><span class="line">4.进入容器连接redis客户端</span><br><span class="line">docker exec -it 运行的容器id redis-cli</span><br></pre></td></tr></table></figure>

<h4 id="单机安装mongodb集群"><a href="#单机安装mongodb集群" class="headerlink" title="单机安装mongodb集群"></a>单机安装mongodb集群</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/compatibility/deploying-a-mongodb-cluster-with-docker">https://www.mongodb.com/compatibility/deploying-a-mongodb-cluster-with-docker</a></li>
<li>第一步是创建一个 Docker 网络。这个网络会让你在这个网络中运行的每个容器都能看到彼此。要创建网络，请运行docker network create命令。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create mongoCluster</span><br></pre></td></tr></table></figure>

<ul>
<li>启动mongodb实例</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-rm</span> <span class="literal">-p</span> <span class="number">27017</span>:<span class="number">27017</span> -<span class="literal">-name</span> mongo1 -<span class="literal">-network</span> mongoCluster mongo:<span class="number">5</span> mongod -<span class="literal">-replSet</span> myReplicaSet -<span class="literal">-bind_ip</span> localhost,mongo1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>启动另外两台实例</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-rm</span> <span class="literal">-p</span> <span class="number">27018</span>:<span class="number">27017</span> -<span class="literal">-name</span> mongo2 -<span class="literal">-network</span> mongoCluster mongo:<span class="number">5</span> mongod -<span class="literal">-replSet</span> myReplicaSet -<span class="literal">-bind_ip</span> localhost,mongo2</span><br><span class="line"> </span><br><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-rm</span> <span class="literal">-p</span> <span class="number">27019</span>:<span class="number">27017</span> -<span class="literal">-name</span> mongo3 -<span class="literal">-network</span> mongoCluster mongo:<span class="number">5</span> mongod -<span class="literal">-replSet</span> myReplicaSet -<span class="literal">-bind_ip</span> localhost,mongo3</span><br></pre></td></tr></table></figure>

<ul>
<li>启动副本集</li>
<li><img src="/2021/08/23/docker/image-20211210175449895.png" alt="image-20211210175449895"></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">docker exec <span class="literal">-it</span> <span class="number">4</span>a9c0d70936d sh</span><br><span class="line"></span><br><span class="line">&gt; show dbs;</span><br><span class="line">uncaught exception: Error: listDatabases failed:&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;61b31e32956a165bacc691c8&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : <span class="number">0</span>,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master and slaveOk=false&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : <span class="number">13435</span>,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotPrimaryNoSecondaryOk&quot;</span></span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:<span class="number">25</span>:<span class="number">13</span></span><br><span class="line">Mongo.prototype.getDBs/&lt;@src/mongo/shell/mongo.js:<span class="number">145</span>:<span class="number">19</span></span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:<span class="number">97</span>:<span class="number">12</span></span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:<span class="number">956</span>:<span class="number">13</span></span><br><span class="line">shellHelper@src/mongo/shell/utils.js:<span class="number">838</span>:<span class="number">15</span></span><br><span class="line"><span class="selector-tag">@</span>(shellhelp2):<span class="number">1</span>:<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; rs.initiate(&#123;</span><br><span class="line">...  _id: <span class="string">&quot;myReplicaSet&quot;</span>,</span><br><span class="line">...  members: [</span><br><span class="line"><span class="type">...</span>    &#123;<span class="type">_id</span>: <span class="number">0</span>, <span class="type">host</span>: <span class="string">&quot;mongo1&quot;</span>&#125;,</span><br><span class="line"><span class="type">...</span>    &#123;<span class="type">_id</span>: <span class="number">1</span>, <span class="type">host</span>: <span class="string">&quot;mongo2&quot;</span>&#125;,</span><br><span class="line"><span class="type">...</span>    &#123;<span class="type">_id</span>: <span class="number">2</span>, <span class="type">host</span>: <span class="string">&quot;mongo3&quot;</span>&#125;</span><br><span class="line"><span class="type">...</span>  ]</span><br><span class="line">... &#125;)</span><br><span class="line">&#123; <span class="string">&quot;ok&quot;</span> : <span class="number">1</span> &#125;</span><br><span class="line">myReplicaSet:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;set&quot;</span> : <span class="string">&quot;myReplicaSet&quot;</span>,</span><br><span class="line">	<span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2021-12-10T09:38:38.497Z&quot;</span>),</span><br><span class="line">	<span class="string">&quot;myState&quot;</span> : <span class="number">2</span>,</span><br><span class="line">	<span class="string">&quot;term&quot;</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>两个从节点</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.secondaryOk();</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主</span></span><br><span class="line">myReplicaSet:PRIMARY&gt; db.test.insert(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lhj&quot;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : <span class="number">1</span> &#125;)</span><br><span class="line">myReplicaSet:PRIMARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">test    <span class="number">0.000</span>GB</span><br><span class="line">myReplicaSet:PRIMARY&gt; db.test.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;61b32306dc11cfcf586c0ff6&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;lhj&quot;</span> &#125;</span><br><span class="line"><span class="comment"># 从</span></span><br><span class="line">myReplicaSet:SECONDARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">test    <span class="number">0.000</span>GB</span><br><span class="line">myReplicaSet:SECONDARY&gt; db.test.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;61b32306dc11cfcf586c0ff6&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;lhj&quot;</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="多机安装mongodb集群"><a href="#多机安装mongodb集群" class="headerlink" title="多机安装mongodb集群"></a>多机安装mongodb集群</h4><p><img src="/2021/08/23/docker/image-20211211033910600.png" alt="image-20211211033910600"></p>
<ul>
<li><code>-d</code> 指示此容器应以分离模式（在后台）运行。</li>
<li><code>-p</code>表示端口映射。您机器上端口 27017 上的任何传入请求都将重定向到容器中的端口 27017。</li>
<li><code>--name</code>表示容器的名称。这将成为这台机器的主机名。</li>
<li><code>mongo:4</code>是 Docker 将使用的映像。此镜像是 MongoDB 社区服务器版本 5</li>
<li>该指令的其余部分是容器启动后将执行的命令。此命令<code>mongod</code>为副本集创建一个新实例</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.17.50</span></span><br><span class="line"><span class="comment"># 启动一个mongo实例</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">-p</span> <span class="number">27017</span>:<span class="number">27017</span> -<span class="literal">-name</span> mongo1 <span class="literal">-v</span> /home/mongodb/<span class="keyword">data</span>/mongo1:/<span class="keyword">data</span>/db mongo:<span class="number">4</span> mongod -<span class="literal">-replSet</span> myReplicaSet  -<span class="literal">-bind_ip_all</span></span><br><span class="line"><span class="comment"># 进入该容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> mongo1 sh </span><br><span class="line"><span class="comment"># 初始化副本集</span></span><br><span class="line">use admin</span><br><span class="line">rs.initiate(&#123;</span><br><span class="line"> _id: <span class="string">&quot;myReplicaSet&quot;</span>,</span><br><span class="line"> members: [</span><br><span class="line">   &#123;<span class="type">_id</span>: <span class="number">0</span>, <span class="type">host</span>: <span class="string">&quot;192.168.17.50&quot;</span>,<span class="type">priority</span>:<span class="number">2</span>&#125;,</span><br><span class="line">   &#123;<span class="type">_id</span>: <span class="number">1</span>, <span class="type">host</span>: <span class="string">&quot;192.168.17.53&quot;</span>,<span class="type">priority</span>:<span class="number">1</span>&#125;,</span><br><span class="line">   &#123;<span class="type">_id</span>: <span class="number">2</span>, <span class="type">host</span>: <span class="string">&quot;192.168.17.54&quot;</span>,<span class="type">arbiterOnly</span>:<span class="type">true</span>&#125;</span><br><span class="line"> ]</span><br><span class="line">&#125;)</span><br><span class="line">myReplicaSet:PRIMARY&gt; use test;</span><br><span class="line">switched to db test</span><br><span class="line">myReplicaSet:PRIMARY&gt; db.test.insert(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lhj&quot;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : <span class="number">1</span> &#125;)</span><br><span class="line">myReplicaSet:PRIMARY&gt; db.test.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;61b3aab264d9a9b602a0bb8f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;lhj&quot;</span> &#125;</span><br><span class="line"><span class="comment"># 增加节点</span></span><br><span class="line">myReplicaSet:PRIMARY&gt; rs.add(<span class="string">&quot;192.168.17.55:27000&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.17.53</span></span><br><span class="line"><span class="comment"># 启动一个mongo实例</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">-p</span> <span class="number">27017</span>:<span class="number">27017</span> -<span class="literal">-name</span> mongo2 <span class="literal">-v</span> /home/mongodb/<span class="keyword">data</span>/mongo2:/<span class="keyword">data</span>/db mongo:<span class="number">4</span> mongod -<span class="literal">-replSet</span> myReplicaSet  -<span class="literal">-bind_ip_all</span></span><br><span class="line"><span class="comment"># 进入该容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> mongo2 sh </span><br><span class="line"><span class="comment"># 初始化从库</span></span><br><span class="line">&gt; rs.secondaryOk();</span><br><span class="line">myReplicaSet:SECONDARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">myReplicaSet:SECONDARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">test    <span class="number">0.000</span>GB</span><br><span class="line">myReplicaSet:SECONDARY&gt; db.test.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;61b3aab264d9a9b602a0bb8f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;lhj&quot;</span> &#125;</span><br><span class="line">myReplicaSet:SECONDARY&gt; db.test.insert(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;cong&quot;</span>&#125;)</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;61b3a7f336b78718740a6c5a&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(<span class="number">4</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(<span class="number">1639164645</span>, <span class="number">1</span>),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : <span class="number">0</span>,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : <span class="number">10107</span>,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotWritablePrimary&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(<span class="number">1639164645</span>, <span class="number">1</span>),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(<span class="number">0</span>,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.17.54</span></span><br><span class="line"><span class="comment"># 启动一个mongo实例</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">-p</span> <span class="number">27017</span>:<span class="number">27017</span> -<span class="literal">-name</span> mongo3 <span class="literal">-v</span> /home/mongodb/<span class="keyword">data</span>/mongo3:/<span class="keyword">data</span>/db mongo:<span class="number">4</span> mongod -<span class="literal">-replSet</span> myReplicaSet  -<span class="literal">-bind_ip_all</span> </span><br><span class="line"><span class="comment"># 进入该容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> mongo3 sh </span><br><span class="line"><span class="comment"># 初始化从库</span></span><br><span class="line">&gt; rs.secondaryOk();</span><br><span class="line">myReplicaSet:SECONDARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">myReplicaSet:SECONDARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">test    <span class="number">0.000</span>GB</span><br><span class="line">myReplicaSet:SECONDARY&gt; db.test.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;61b3aab264d9a9b602a0bb8f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;lhj&quot;</span> &#125;</span><br><span class="line">myReplicaSet:SECONDARY&gt; db.test.insert(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;cong&quot;</span>&#125;)</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">	<span class="string">&quot;topologyVersion&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;processId&quot;</span> : ObjectId(<span class="string">&quot;61b3a8c499baddf2687229e1&quot;</span>),</span><br><span class="line">		<span class="string">&quot;counter&quot;</span> : NumberLong(<span class="number">4</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;operationTime&quot;</span> : Timestamp(<span class="number">1639164685</span>, <span class="number">1</span>),</span><br><span class="line">	<span class="string">&quot;ok&quot;</span> : <span class="number">0</span>,</span><br><span class="line">	<span class="string">&quot;errmsg&quot;</span> : <span class="string">&quot;not master&quot;</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span> : <span class="number">10107</span>,</span><br><span class="line">	<span class="string">&quot;codeName&quot;</span> : <span class="string">&quot;NotWritablePrimary&quot;</span>,</span><br><span class="line">	<span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">		<span class="string">&quot;clusterTime&quot;</span> : Timestamp(<span class="number">1639164685</span>, <span class="number">1</span>),</span><br><span class="line">		<span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">			<span class="string">&quot;hash&quot;</span> : BinData(<span class="number">0</span>,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">			<span class="string">&quot;keyId&quot;</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)s</span><br></pre></td></tr></table></figure>

<h4 id="本地镜像推送到阿里云服务器"><a href="#本地镜像推送到阿里云服务器" class="headerlink" title="本地镜像推送到阿里云服务器"></a>本地镜像推送到阿里云服务器</h4><p><img src="/2021/08/23/docker/image-20211011142539982.png" alt="docker"></p>
<p><img src="/2021/08/23/docker/image-20211011142607874.png" alt="docker"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 登录阿里云Docker Registry</span><br><span class="line">docker login --username=liuhaojie1995 registry.cn-shanghai.aliyuncs.com</span><br><span class="line"><span class="number">2.</span> 从Registry中拉取镜像</span><br><span class="line">docker tag [ImageId] registry.cn-shanghai.aliyuncs.com/lhaojie/mydocker:[镜像版本号]</span><br><span class="line"><span class="number">3.</span> 将镜像推送到Registry</span><br><span class="line">docker push registry.cn-shanghai.aliyuncs.com/lhaojie/mydocker:[镜像版本号]</span><br><span class="line"><span class="number">4.</span> 从Registry中拉取镜像</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/lhaojie/mydocker:[镜像版本号]</span><br></pre></td></tr></table></figure>

<h4 id="搭建私有镜像仓库harbor"><a href="#搭建私有镜像仓库harbor" class="headerlink" title="搭建私有镜像仓库harbor"></a>搭建私有镜像仓库harbor</h4><p><code>安装docker-compose</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> docker<span class="literal">-compose</span> /usr/bin/ &amp;&amp; <span class="built_in">cd</span> /usr/bin/</span><br><span class="line">chmod +x docker<span class="literal">-compose</span></span><br></pre></td></tr></table></figure>

<p><code>部署harbor</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tar xvf harbor<span class="literal">-offline</span><span class="literal">-installer</span><span class="literal">-v1</span>.<span class="number">10.10</span>.tgz <span class="literal">-C</span> /usr/local</span><br><span class="line"><span class="built_in">cd</span> /usr/local/harbor</span><br><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> harbor.yml harbor.yml.bk</span><br><span class="line">vim harbor.yml</span><br><span class="line">hostname: harbor.wuvikr.top</span><br><span class="line">harbor_admin_password: pass1234</span><br><span class="line"><span class="comment">#https:</span></span><br><span class="line">  <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line"><span class="comment">#  port: 443</span></span><br><span class="line">  <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line"><span class="comment">#  certificate: /your/certificate/path</span></span><br><span class="line"><span class="comment">#  private_key: /your/private/key/path</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/hosts配置文件增加</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">17.57</span> harbor.wuvikr.top</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行安装脚本（/usr/local/harbor目录）</span></span><br><span class="line">./install.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>报错排查</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1 ERROR:root:Please specify hostname</span></span><br><span class="line">修改配置文件hostname: reg.mydomain.com （错误）</span><br><span class="line">hostname: harbor.wuvikr.top （正确）</span><br><span class="line"><span class="comment">#2 ERROR:root:Error: The protocol is https but attribute ssl_cert is not set</span></span><br><span class="line">需要配置证书认证</span><br></pre></td></tr></table></figure>

<p><code>harbor官网证书认证</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://goharbor.io/docs/2.4.0/install-config/configure-https/">https://goharbor.io/docs/2.4.0/install-config/configure-https/</a></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.生成 CA 证书私钥</span></span><br><span class="line">openssl genrsa <span class="literal">-out</span> ca.key <span class="number">4096</span></span><br><span class="line"><span class="comment">#2.生成 CA 证书</span></span><br><span class="line">openssl req <span class="literal">-x509</span> <span class="literal">-new</span> <span class="literal">-nodes</span> <span class="literal">-sha512</span> <span class="literal">-days</span> <span class="number">3650</span> \</span><br><span class="line"> <span class="literal">-subj</span> <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.wuvikr.top&quot;</span> \</span><br><span class="line"> <span class="literal">-key</span> ca.key \</span><br><span class="line"> <span class="literal">-out</span> ca.crt</span><br><span class="line"><span class="comment">#3.生成服务器证书（证书通常包含一个.crt文件和一个.key文件）</span></span><br><span class="line"><span class="comment">#3.1生成私钥</span></span><br><span class="line">openssl genrsa <span class="literal">-out</span> harbor.wuvikr.top.key <span class="number">4096</span></span><br><span class="line"><span class="comment">#3.2生成证书签名请求 (CSR)</span></span><br><span class="line">openssl req <span class="literal">-sha512</span> <span class="literal">-new</span> \</span><br><span class="line">    <span class="literal">-subj</span> <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.wuvikr.top&quot;</span> \</span><br><span class="line">    <span class="literal">-key</span> harbor.wuvikr.top.key \</span><br><span class="line">    <span class="literal">-out</span> harbor.wuvikr.top.csr</span><br><span class="line"><span class="comment">#3.3生成 x509 v3 扩展文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; v3.ext &lt;&lt;<span class="literal">-EOF</span></span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[<span class="type">alt_names</span>]</span><br><span class="line">DNS.<span class="number">1</span>=harbor.wuvikr.top</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#3.4使用该v3.ext文件为您的 Harbor 主机生成证书</span></span><br><span class="line">openssl x509 <span class="literal">-req</span> <span class="literal">-sha512</span> <span class="literal">-days</span> <span class="number">3650</span> \</span><br><span class="line">    <span class="literal">-extfile</span> v3.ext \</span><br><span class="line">    <span class="literal">-CA</span> ca.crt <span class="literal">-CAkey</span> ca.key <span class="literal">-CAcreateserial</span> \</span><br><span class="line">    <span class="operator">-in</span> harbor.wuvikr.top.csr \</span><br><span class="line">    <span class="literal">-out</span> harbor.wuvikr.top.crt</span><br><span class="line"><span class="comment">#4.Docker 守护进程将.crt文件解释为 CA 证书，将.cert文件解释为客户端证书</span></span><br><span class="line">openssl x509 <span class="literal">-inform</span> PEM <span class="operator">-in</span> harbor.wuvikr.top.crt <span class="literal">-out</span> harbor.wuvikr.top.cert</span><br><span class="line"><span class="comment">#5.将服务器证书、密钥和 CA 文件复制到 Harbor 主机上的 Docker 证书文件夹中。您必须先创建适当的文件夹</span></span><br><span class="line"><span class="built_in">cp</span> harbor.wuvikr.top.cert /etc/docker/certs.d/harbor.wuvikr.top/</span><br><span class="line"><span class="built_in">cp</span> harbor.wuvikr.top.key /etc/docker/certs.d/harbor.wuvikr.top/</span><br><span class="line"><span class="built_in">cp</span> ca.crt /etc/docker/certs.d/harbor.wuvikr.top/</span><br></pre></td></tr></table></figure>



<p><code>证书认证</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/harbor/certs</span><br><span class="line"><span class="built_in">cd</span> /usr/local/harbor/certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成CA证书</span></span><br><span class="line">openssl req <span class="literal">-newkey</span> rsa:<span class="number">2048</span> <span class="literal">-nodes</span> <span class="literal">-x509</span> <span class="literal">-subj</span> <span class="string">&quot;/C=CN/ST=Shanghai/L=Shanghai/O=wuvikr/OU=IT/CN=harbor.wuvikr.top/emailAddress=ca.wuvikr.top&quot;</span> <span class="literal">-set_serial</span> <span class="number">01</span> <span class="literal">-keyout</span> ca.key <span class="literal">-days</span> <span class="number">3650</span> <span class="literal">-out</span> ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 成harbor证书申请</span></span><br><span class="line">openssl req <span class="literal">-newkey</span> rsa:<span class="number">2048</span> <span class="literal">-nodes</span> <span class="literal">-subj</span> <span class="string">&quot;/C=CN/ST=Shanghai/L=Shanghai/O=wuvikr/OU=devops/CN=harbor.wuvikr.top     &quot;</span> <span class="literal">-set_serial</span> <span class="number">02</span> <span class="literal">-keyout</span> harbor.key <span class="literal">-out</span> harbor.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为harbor颁发证书</span></span><br><span class="line">openssl x509 <span class="literal">-req</span> <span class="operator">-in</span> harbor.csr <span class="literal">-CA</span> ca.crt <span class="literal">-CAkey</span> ca.key <span class="literal">-CAcreateserial</span> <span class="literal">-out</span> harbor.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">certs</span>]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/harbor/certs</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">certs</span>]<span class="comment"># ls</span></span><br><span class="line">ca.crt  ca.key  ca.srl  harbor.crt  harbor.csr  harbor.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置harbor.yml</span></span><br><span class="line">vim harbor.yml</span><br><span class="line"><span class="comment"># 修改如下图</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/23/docker/image-20220225144001422.png" alt="docker"></p>
<p><code>启动</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用prepare脚本重新加载harbor.yml中的配置</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">harbor</span>]<span class="comment"># ./prepare</span></span><br><span class="line">prepare base <span class="built_in">dir</span> is <span class="built_in">set</span> to /usr/local/harbor</span><br><span class="line">/usr/src/app/utils/configs.py:<span class="number">100</span>: YAMLLoadWarning: calling yaml.load() without Loader=... is deprecated, as the default Loader is unsa     fe. Please read https://msg.pyyaml.org/load <span class="keyword">for</span> full details.</span><br><span class="line">  configs = yaml.load(f)</span><br><span class="line">/usr/src/app/utils/configs.py:<span class="number">90</span>: YAMLLoadWarning: calling yaml.load() without Loader=... is deprecated, as the default Loader is unsaf     e. Please read https://msg.pyyaml.org/load <span class="keyword">for</span> full details.</span><br><span class="line">  versions = yaml.load(f)</span><br><span class="line">Clearing the configuration file: /config/log/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/log/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/log/logrotate.conf</span><br><span class="line">Generated configuration file: /config/log/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /secret/keys/secretkey</span><br><span class="line">Generated certificate, key file: /secret/core/private_key.pem, cert file: /secret/registry/root.crt</span><br><span class="line">Generated configuration file: /compose_location/docker<span class="literal">-compose</span>.yml</span><br><span class="line">Clean up the input <span class="built_in">dir</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>查看运行中的容器</code></p>
<p><img src="/2021/08/23/docker/image-20220225144254489.png" alt="docker"></p>
<p><code>web界面</code></p>
<ul>
<li>ip地址</li>
</ul>
<p><img src="/2021/08/23/docker/image-20220225144337888.png" alt="docker"></p>
<p><code>解决https下登录证书问题</code></p>
<p><img src="/2021/08/23/docker/image-20220225145249557.png" alt="docker"></p>
<p><code>上传镜像到harbor仓库</code></p>
<ul>
<li><p>harbor界面点击新建项目为 lhj</p>
</li>
<li><p><img src="/2021/08/23/docker/image-20220225160024962.png" alt="docker"></p>
</li>
<li><p><img src="/2021/08/23/docker/image-20220225160149144.png" alt="docker"></p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在项目中标记镜像：</span></span><br><span class="line">docker tag SOURCE_IMAGE[:<span class="type">TAG</span>] harbor.wuvikr.top/lhj/IMAGE[:<span class="type">TAG</span>]</span><br><span class="line"><span class="comment"># 推送镜像到当前项目：</span></span><br><span class="line">docker push harbor.wuvikr.top/lhj/IMAGE[:<span class="type">TAG</span>]</span><br></pre></td></tr></table></figure>

<h4 id="kubesphere配置http的harbor仓库"><a href="#kubesphere配置http的harbor仓库" class="headerlink" title="kubesphere配置http的harbor仓库"></a>kubesphere配置http的harbor仓库</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">registry:</span><br><span class="line">    <span class="built_in">type</span>: harbor</span><br><span class="line">    auths:</span><br><span class="line">      <span class="string">&quot;http://192.168.72.15&quot;</span>:</span><br><span class="line">        username: admin</span><br><span class="line">        password: Harbor12345</span><br><span class="line">        skipTLSVerify: true</span><br><span class="line">        plainHTTP: true</span><br><span class="line">    privateRegistry: <span class="string">&quot;http://192.168.72.15&quot;</span></span><br><span class="line">    namespaceOverride: <span class="string">&quot;kubesphereio&quot;</span></span><br><span class="line">    registryMirrors: []</span><br><span class="line">    insecureRegistries: []</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="搭建sentry"><a href="#搭建sentry" class="headerlink" title="搭建sentry"></a>搭建sentry</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#启动redis容器</span></span><br><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-name</span> sentry<span class="literal">-redis</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动postgres容器</span></span><br><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-name</span> sentry<span class="literal">-postgres</span> <span class="literal">-e</span> POSTGRES_PASSWORD=Foda2022 <span class="literal">-e</span> POSTGRES_USER=admin postgres</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成秘钥 key 供所有 sentry 容器共享（该值作用于环境变量：SENTRY_SECRET_KEY）</span></span><br><span class="line">docker run -<span class="literal">-rm</span> sentry config generate<span class="literal">-secret</span><span class="literal">-key</span></span><br><span class="line"></span><br><span class="line">密钥:q%<span class="number">1</span>)<span class="number">8</span>k6hbnnkp6kof5po)*jcx<span class="comment">#63bp37-3b*m=o^rv7rmzyqce</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库更新</span></span><br><span class="line">docker run <span class="literal">-it</span> -<span class="literal">-rm</span> <span class="literal">-e</span> SENTRY_SECRET_KEY=<span class="string">&#x27;q%1)8k6hbnnkp6kof5po)*jcx#63bp37-3b*m=o^rv7rmzyqce&#x27;</span> -<span class="literal">-link</span> sentry<span class="literal">-postgres</span>:postgres -<span class="literal">-link</span> sentry<span class="literal">-redis</span>:redis sentry upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment">#会创建一个账号</span></span><br><span class="line">Email: foda@ai.com</span><br><span class="line">Password: Foda2022</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动sentry服务</span></span><br><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-name</span> sentry<span class="literal">-luffy</span> <span class="literal">-p</span> <span class="number">8888</span>:<span class="number">9000</span> <span class="literal">-e</span> SENTRY_SECRET_KEY=<span class="string">&#x27;q%1)8k6hbnnkp6kof5po)*jcx#63bp37-3b*m=o^rv7rmzyqce&#x27;</span> -<span class="literal">-link</span> sentry<span class="literal">-redis</span>:redis -<span class="literal">-link</span> sentry<span class="literal">-postgres</span>:postgres sentry</span><br><span class="line"></span><br><span class="line"><span class="comment">#额外需要启动 celery beat 和 celery worker</span></span><br><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-name</span> sentry<span class="literal">-cron</span> <span class="literal">-e</span> SENTRY_SECRET_KEY=<span class="string">&#x27;q%1)8k6hbnnkp6kof5po)*jcx#63bp37-3b*m=o^rv7rmzyqce&#x27;</span> -<span class="literal">-link</span> sentry<span class="literal">-postgres</span>:postgres -<span class="literal">-link</span> sentry<span class="literal">-redis</span>:redis sentry run cron</span><br><span class="line"></span><br><span class="line">docker run <span class="literal">-d</span> -<span class="literal">-name</span> sentry<span class="literal">-worker</span><span class="literal">-1</span> <span class="literal">-e</span> SENTRY_SECRET_KEY=<span class="string">&#x27;q%1)8k6hbnnkp6kof5po)*jcx#63bp37-3b*m=o^rv7rmzyqce&#x27;</span> -<span class="literal">-link</span> sentry<span class="literal">-postgres</span>:postgres -<span class="literal">-link</span> sentry<span class="literal">-redis</span>:redis sentry run worker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">docker run <span class="literal">-it</span> -<span class="literal">-rm</span> <span class="literal">-e</span> SENTRY_SECRET_KEY=<span class="string">&#x27;q%1)8k6hbnnkp6kof5po)*jcx#63bp37-3b*m=o^rv7rmzyqce&#x27;</span> -<span class="literal">-link</span> sentry<span class="literal">-redis</span>:redis -<span class="literal">-link</span> sentry<span class="literal">-postgres</span>:postgres sentry createuser</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/23/docker/image-20220816141727251.png" alt="docker"></p>
<p><img src="/2021/08/23/docker/image-20220816141953908.png" alt="docker"></p>
<h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><p><img src="/2021/08/23/docker/image-20211214173116426.png" alt="docker"></p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/compose/gettingstarted/#where-to-go-next">https://docs.docker.com/compose/gettingstarted/#where-to-go-next</a></p>
<p><code>安装compose</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.运行此命令以下载 Docker Compose 的当前稳定版本：</span></span><br><span class="line">curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.对二进制文件应用可执行权限</span></span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.测试安装</span></span><br><span class="line">docker-compose --version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 出现版本成功</span></span><br><span class="line">docker-compose version 1.29.2, build 5becea4c</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.0&quot;</span></span><br><span class="line">   </span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="comment">#build: .</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">algorithmserver_web:v1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_network</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx_network</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_network</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongod_network</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">stdin_open:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span>  <span class="string">mysql:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="comment">#command: --default-authentication-plugin=mysql_native_password</span></span><br><span class="line">    <span class="comment">#command: --disable-partition-engine-check</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/mysql:/var/lib/mysql:rw</span></span><br><span class="line">      <span class="comment">#- ./compose/mysql/conf/my.conf:/etc/mysql/my.cnf</span></span><br><span class="line">      <span class="comment">#- ./compose/mysql/init:/docker-entrypoint-initdb.d/</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3307&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3307:3306&quot;</span></span><br><span class="line">    <span class="attr">restart:</span>  <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=Foda.ai2021</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=algorithm</span></span><br><span class="line">    <span class="attr">command:</span>  [</span><br><span class="line">      <span class="string">&#x27;--character-set-server=utf8&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--collation-server=utf8_general_ci&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_network</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span>  <span class="string">/etc/redis/redis.conf</span>  <span class="string">--requirepass</span> <span class="string">Foda.ai2021</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_network</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/redis/:/data</span> <span class="comment"># 通过挂载给redis数据备份</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/redis/redis.conf:/etc/redis/redis.conf</span> <span class="comment"># 挂载redis配置文件</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span> </span><br><span class="line">    </span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;mongo:4&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment">#- ./compose/mongo/configdb:/data/configdb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/mongo/db:/data/db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/mongo/mongod.conf:/etc/mongod.conf.orig</span></span><br><span class="line">    <span class="comment">#command:</span></span><br><span class="line">      <span class="comment">#- mongod </span></span><br><span class="line">      <span class="comment">#- &quot;--replSet&quot;</span></span><br><span class="line">      <span class="comment">#- rs0</span></span><br><span class="line">      <span class="comment">#- &quot;--bind_ip&quot;</span></span><br><span class="line">      <span class="comment">#- 0.0.0.0</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span>   </span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongod_network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./compose/nginx</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/nginx/nginx.conf:/etc/nginx/conf.d/nginx.conf</span> <span class="comment"># 挂载nginx配置文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/nginx/ssl:/usr/share/nginx/ssl</span> <span class="comment"># 挂载ssl证书目录</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./compose/nginx/log:/var/log/nginx</span> <span class="comment"># 挂载日志</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./static:/usr/share/nginx/html/static</span> <span class="comment"># 挂载静态文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./media:/usr/share/nginx/html/media</span> <span class="comment"># 挂载用户上传媒体文件</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx_network</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">db_network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">  <span class="attr">nginx_network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">  <span class="attr">redis_network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">  <span class="attr">mongod_network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="从-Docker-Compose-到-Kubernetes-的转换工具"><a href="#从-Docker-Compose-到-Kubernetes-的转换工具" class="headerlink" title="从 Docker Compose 到 Kubernetes 的转换工具"></a>从 Docker Compose 到 Kubernetes 的转换工具</h4><ul>
<li><p><a target="_blank" rel="noopener" href="https://kompose.io/">https://kompose.io/</a></p>
</li>
<li><p><code>Kompose 是 Docker Compose 到 Kubernetes（或 OpenShift）等容器编排器的转换工具</code></p>
</li>
</ul>
<p><strong><code>Kubernetes + Compose = Kompose</code></strong></p>
<ul>
<li>使用 Docker Compose 简化开发过程，然后将容器部署到生产集群</li>
<li><code>docker-compose.yaml</code>用一个简单的命令转换你的<code>kompose convert</code></li>
</ul>
<p><code>安装</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum -y install kompose</span><br></pre></td></tr></table></figure>

<h4 id="k8s基础概念"><a href="#k8s基础概念" class="headerlink" title="k8s基础概念"></a>k8s基础概念</h4><h5 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a><strong>安装docker</strong></h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker*</span><br><span class="line">sudo yum install <span class="literal">-y</span> yum<span class="literal">-utils</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置docker的yum地址</span></span><br><span class="line">sudo yum<span class="literal">-config</span><span class="literal">-manager</span> \</span><br><span class="line">-<span class="literal">-add</span><span class="literal">-repo</span> \</span><br><span class="line">http://mirrors.aliyun.com/docker<span class="literal">-ce</span>/linux/centos/docker<span class="literal">-ce</span>.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装指定版本</span></span><br><span class="line">sudo yum install <span class="literal">-y</span> docker<span class="literal">-ce</span><span class="literal">-20</span>.<span class="number">10.7</span> docker<span class="literal">-ce</span><span class="literal">-cli</span><span class="literal">-20</span>.<span class="number">10.7</span> containerd.io<span class="literal">-1</span>.<span class="number">4.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#	启动&amp;开机启动docker</span></span><br><span class="line">systemctl enable docker -<span class="literal">-now</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker加速配置</span></span><br><span class="line">sudo mkdir <span class="literal">-p</span> /etc/docker</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://82m9ar63.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon<span class="literal">-reload</span></span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>



<h5 id="kubeadm创建集群"><a href="#kubeadm创建集群" class="headerlink" title="kubeadm创建集群"></a><strong>kubeadm创建集群</strong></h5><p><code>基础环境</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">各个机器设置自己的域名</span></span><br><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span></span><br><span class="line">sudo setenforce 0</span><br><span class="line">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">关闭swap</span></span><br><span class="line">swapoff -a  </span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">允许 iptables 检查桥接流量</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sudo sysctl --system</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>安装kubelet、kubeadm、kubectl</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;EOF | sudo <span class="built_in">tee</span> /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[<span class="type">kubernetes</span>]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes<span class="literal">-el7</span><span class="literal">-x86_64</span></span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgcheck=<span class="number">0</span></span><br><span class="line">repo_gpgcheck=<span class="number">0</span></span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum<span class="literal">-key</span>.gpg</span><br><span class="line">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm<span class="literal">-package</span><span class="literal">-key</span>.gpg</span><br><span class="line">exclude=kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo yum install <span class="literal">-y</span> kubelet<span class="literal">-1</span>.<span class="number">20.9</span> kubeadm<span class="literal">-1</span>.<span class="number">20.9</span> kubectl<span class="literal">-1</span>.<span class="number">20.9</span> -<span class="literal">-disableexcludes</span>=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl enable -<span class="literal">-now</span> kubelet</span><br></pre></td></tr></table></figure>

<h5 id="使用kubeadm引导集群"><a href="#使用kubeadm引导集群" class="headerlink" title="使用kubeadm引导集群"></a><strong>使用kubeadm引导集群</strong></h5><p><code>下载各个机器需要的镜像</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> ./images.sh &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">images=(</span><br><span class="line">kube<span class="literal">-apiserver</span>:v1.<span class="number">20.9</span></span><br><span class="line">kube<span class="literal">-proxy</span>:v1.<span class="number">20.9</span></span><br><span class="line">kube<span class="literal">-controller</span><span class="literal">-manager</span>:v1.<span class="number">20.9</span></span><br><span class="line">kube<span class="literal">-scheduler</span>:v1.<span class="number">20.9</span></span><br><span class="line">coredns:<span class="number">1.7</span>.<span class="number">0</span></span><br><span class="line">etcd:<span class="number">3.4</span>.<span class="number">13</span><span class="literal">-0</span></span><br><span class="line">pause:<span class="number">3.2</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$</span>&#123;images[<span class="selector-tag">@</span>]&#125; ; <span class="keyword">do</span></span><br><span class="line">docker pull registry.cn<span class="literal">-hangzhou</span>.aliyuncs.com/lfy_k8s_images/<span class="variable">$imageName</span></span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line">   </span><br><span class="line">chmod +x ./images.sh &amp;&amp; ./images.sh</span><br></pre></td></tr></table></figure>

<p><code>初始化主节点</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有机器添加master域名映射，以下需要修改为自己的</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10.21.6.11  cluster-endpoint&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主节点初始化(在主节点上执行)</span></span><br><span class="line">kubeadm init \</span><br><span class="line">-<span class="literal">-apiserver</span><span class="literal">-advertise</span><span class="literal">-address</span>=<span class="number">10.21</span>.<span class="number">6.11</span> \</span><br><span class="line">-<span class="literal">-control</span><span class="literal">-plane</span><span class="literal">-endpoint</span>=cluster<span class="literal">-endpoint</span> \</span><br><span class="line">-<span class="literal">-image</span><span class="literal">-repository</span> registry.cn<span class="literal">-hangzhou</span>.aliyuncs.com/lfy_k8s_images \</span><br><span class="line">-<span class="literal">-kubernetes</span><span class="literal">-version</span> v1.<span class="number">20.9</span> \</span><br><span class="line">-<span class="literal">-service</span><span class="literal">-cidr</span>=<span class="number">10.96</span>.<span class="number">0.0</span>/<span class="number">16</span> \</span><br><span class="line">-<span class="literal">-pod</span><span class="literal">-network</span><span class="literal">-cidr</span>=<span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#所有网络范围不重叠</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control<span class="literal">-plane</span> has initialized successfully!</span><br><span class="line"></span><br><span class="line">To <span class="built_in">start</span> <span class="keyword">using</span> your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir <span class="literal">-p</span> <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> <span class="literal">-i</span> /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown <span class="variable">$</span>(id <span class="literal">-u</span>):<span class="variable">$</span>(id <span class="literal">-g</span>) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster<span class="literal">-administration</span>/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of control<span class="literal">-plane</span> nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and then running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join cluster<span class="literal">-endpoint</span>:<span class="number">6443</span> -<span class="literal">-token</span> uz1po9.pcefpry1k8wv7pwm \</span><br><span class="line">    -<span class="literal">-discovery</span><span class="literal">-token</span><span class="literal">-ca</span><span class="literal">-cert</span><span class="literal">-hash</span> sha256:b33b78aabccd27809616bb740c73316dfaf03fba61f80e429ba480c1f07dbcc5 \</span><br><span class="line">    -<span class="literal">-control</span><span class="literal">-plane</span></span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join cluster<span class="literal">-endpoint</span>:<span class="number">6443</span> -<span class="literal">-token</span> uz1po9.pcefpry1k8wv7pwm \</span><br><span class="line">    -<span class="literal">-discovery</span><span class="literal">-token</span><span class="literal">-ca</span><span class="literal">-cert</span><span class="literal">-hash</span> sha256:b33b78aabccd27809616bb740c73316dfaf03fba61f80e429ba480c1f07dbcc5</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>根据提示继续</code></p>
<p><img src="/2021/08/23/docker/image-20211214150314359.png" alt="docker"></p>
<p><code>设置.kube/config</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="literal">-p</span> <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> <span class="literal">-i</span> /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown <span class="variable">$</span>(id <span class="literal">-u</span>):<span class="variable">$</span>(id <span class="literal">-g</span>) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p><code>安装网络组件</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-more-than-50-nodes">https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-more-than-50-nodes</a></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主节点</span></span><br><span class="line"><span class="built_in">curl</span> https://docs.projectcalico.org/manifests/calico.yaml <span class="literal">-O</span></span><br><span class="line"></span><br><span class="line">kubectl apply <span class="operator">-f</span> calico.yaml</span><br></pre></td></tr></table></figure>

<p><code>加入node节点</code></p>
<p><img src="/2021/08/23/docker/image-20211214151244970.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从节点执行</span></span><br><span class="line"></span><br><span class="line">kubeadm join cluster<span class="literal">-endpoint</span>:<span class="number">6443</span> -<span class="literal">-token</span> uz1po9.pcefpry1k8wv7pwm \</span><br><span class="line">    -<span class="literal">-discovery</span><span class="literal">-token</span><span class="literal">-ca</span><span class="literal">-cert</span><span class="literal">-hash</span> sha256:b33b78aabccd27809616bb740c73316dfaf03fba61f80e429ba480c1f07dbcc5</span><br></pre></td></tr></table></figure>

<p><code>新令牌</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create -<span class="literal">-print</span><span class="operator">-join</span><span class="literal">-command</span></span><br></pre></td></tr></table></figure>

<p><code>验证集群</code></p>
<p><img src="/2021/08/23/docker/image-20211214153542834.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看集群所有节点</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据配置文件，给集群创建资源</span></span><br><span class="line">kubectl apply <span class="operator">-f</span> xxxx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群部署了哪些应用？</span></span><br><span class="line">docker <span class="built_in">ps</span>   ===   kubectl get pods <span class="literal">-A</span></span><br><span class="line"><span class="comment"># 运行中的应用在docker里面叫容器，在k8s里面叫Pod</span></span><br><span class="line">kubectl get pods <span class="literal">-A</span></span><br></pre></td></tr></table></figure>

<h5 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h5><p>kubernetes官方提供的可视化界面</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a></p>
<p><code>recommended.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-csrf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">csrf:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-key-holder</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-settings</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="string">&quot;kubernetes-dashboard-csrf&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get metrics.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="string">&quot;http:dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Allow Metrics Scraper to get metrics from the Metrics server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;metrics.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kubernetesui/dashboard:v2.3.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=kubernetes-dashboard</span></span><br><span class="line">            <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">            <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">            <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">            <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">              <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="string">&#x27;runtime/default&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kubernetesui/metrics-scraper:v1.0.6</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>设置访问端口</code></p>
<ul>
<li>type: ClusterIP 改为 type: NodePort</li>
<li><img src="/2021/08/23/docker/image-20211217151653245.png" alt="docker"></li>
<li><a target="_blank" rel="noopener" href="https://10.21.6.11:30409/">https://10.21.6.11:30409</a></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc kubernetes<span class="literal">-dashboard</span> <span class="literal">-n</span> kubernetes<span class="literal">-dashboard</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc <span class="literal">-A</span> |grep kubernetes<span class="literal">-dashboard</span></span><br></pre></td></tr></table></figure>

<p><code>创建访问账号</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建访问账号，准备一个yaml文件； vi dash.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin<span class="literal">-user</span></span><br><span class="line">  namespace: kubernetes<span class="literal">-dashboard</span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin<span class="literal">-user</span></span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster<span class="literal">-admin</span></span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin<span class="literal">-user</span></span><br><span class="line">  namespace: kubernetes<span class="literal">-dashboard</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="operator">-f</span> dash.yaml</span><br></pre></td></tr></table></figure>

<p><code>获取令牌访问</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="literal">-n</span> kubernetes<span class="literal">-dashboard</span> get secret <span class="variable">$</span>(kubectl <span class="literal">-n</span> kubernetes<span class="literal">-dashboard</span> get sa/admin<span class="literal">-user</span> <span class="literal">-o</span> jsonpath=<span class="string">&quot;&#123;.secrets[0].name&#125;&quot;</span>) <span class="literal">-o</span> go<span class="literal">-template</span>=<span class="string">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IlV4Y1pZeWdhZl9MdXdoQnp2ZWhYdU1RS0xXbzR0aW5OdC0zZDVydDdSV2MifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWZtOXh4Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI4NGNlMzI0Mi05MTYxLTQyNmUtYWZiYS1mN2EyZjZiMWUzN2UiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.jcz3ApeImGaWxEDXHOGiECOsgRyYXJSglGgHw4iFoOomcDyUS<span class="literal">-KNAYbqqOEAhJJ2paTHFBqaDy8FmFzO</span><span class="literal">-h7qDCcSzL6BNy4WviiGEaPSfFnZYuMmb7NT6SWz9YrKyTjCVhcTc_muG4QEJKd15eCWMqBU83GI3M9LZQULcXKFJ6JpuRBKAgFTvcmOxqjJDZSSW2PxPkAc2eMZXn5wyxmuIm_LvvzSmHlFKjYXUWfqxu104fUZDbsaSed2n6z4DeHDK3NlHOKlzA2cPu1wvesxLSAt_ngeY0qGCOHV6dY86KLWWdNIXsoG1Gnst_EPh46mXvkcH3yDnkDEbFySKHMIyw</span></span><br></pre></td></tr></table></figure>

<p><code>界面</code></p>
<p><img src="/2021/08/23/docker/image-20211217152209810.png" alt="docker"></p>
<h4 id="k8s核心实战"><a href="#k8s核心实战" class="headerlink" title="k8s核心实战"></a>k8s核心实战</h4><h5 id="存储抽象"><a href="#存储抽象" class="headerlink" title="存储抽象"></a>存储抽象</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有机器安装</span></span><br><span class="line">yum install <span class="literal">-y</span> nfs<span class="literal">-utils</span></span><br></pre></td></tr></table></figure>

<p><strong>主节点</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nfs主节点</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class="line"></span><br><span class="line">mkdir <span class="literal">-p</span> /nfs/<span class="keyword">data</span></span><br><span class="line">systemctl enable rpcbind -<span class="literal">-now</span></span><br><span class="line">systemctl enable nfs<span class="literal">-server</span> -<span class="literal">-now</span></span><br><span class="line"><span class="comment">#配置生效</span></span><br><span class="line">exportfs <span class="literal">-r</span></span><br></pre></td></tr></table></figure>

<p><strong>从节点</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">showmount <span class="literal">-e</span> <span class="number">10.21</span>.<span class="number">6.11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行以下命令挂载 nfs 服务器上的共享目录到本机路径 /root/nfsmount</span></span><br><span class="line">mkdir <span class="literal">-p</span> /nfs/<span class="keyword">data</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mount</span> <span class="literal">-t</span> nfs <span class="number">10.21</span>.<span class="number">6.11</span>:/nfs/<span class="keyword">data</span> /nfs/<span class="keyword">data</span></span><br><span class="line"><span class="comment"># 写入一个测试文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello nfs server&quot;</span> &gt; /nfs/<span class="keyword">data</span>/test.txt</span><br></pre></td></tr></table></figure>

<h5 id="metrics-server监控指标"><a href="#metrics-server监控指标" class="headerlink" title="metrics-server监控指标"></a>metrics-server监控指标</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:aggregated-metrics-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/stats</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server-auth-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">extension-apiserver-authentication-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server:system:auth-delegator</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:auth-delegator</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cert-dir=/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--secure-port=4443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-use-node-status-port</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/readyz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">metrics-server</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1beta1.metrics.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>



<h5 id="nfs动态存储"><a href="#nfs动态存储" class="headerlink" title="nfs动态存储"></a><strong>nfs动态存储</strong></h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建了一个存储类</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storage</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;true&quot;</span>  <span class="comment">## 删除pv的时候，pv的内容是否要备份</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class="line">          <span class="comment"># resources:</span></span><br><span class="line">          <span class="comment">#    limits:</span></span><br><span class="line">          <span class="comment">#      cpu: 10m</span></span><br><span class="line">          <span class="comment">#    requests:</span></span><br><span class="line">          <span class="comment">#      cpu: 10m</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.4</span> <span class="comment">## 指定自己nfs服务器地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span>  </span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs/data</span>  <span class="comment">## nfs服务器共享的目录</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.4</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs/data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h5 id="部署kubersphere"><a href="#部署kubersphere" class="headerlink" title="部署kubersphere"></a>部署kubersphere</h5><h6 id="kubesphere-installer-yaml"><a href="#kubesphere-installer-yaml" class="headerlink" title="kubesphere-installer.yaml"></a>kubesphere-installer.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">clusterconfigurations.installer.kubesphere.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">installer.kubesphere.io</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1alpha1</span></span><br><span class="line">      <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">spec:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">x-kubernetes-preserve-unknown-fields:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">status:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">x-kubernetes-preserve-unknown-fields:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">clusterconfigurations</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">clusterconfiguration</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubesphere-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiregistration.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiextensions.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tenant.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">certificates.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">devops.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">logging.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jaegertracing.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">storage.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.istio.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">config.istio.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">iam.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">notification.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">auditing.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">core.kubefed.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">installer.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">storage.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">security.istio.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.kiali.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kiali.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubeedge.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">types.kubefed.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">application.kubesphere.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ks-install</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ks-install</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ks-install</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">ks-installer</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">installer</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubesphere/ks-installer:v3.2.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">&quot;Always&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">20m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-time</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/localtime</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-time</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="cluster-configuration-yaml"><a href="#cluster-configuration-yaml" class="headerlink" title="cluster-configuration.yaml"></a>cluster-configuration.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">installer.kubesphere.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v3.2.1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">persistence:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;&quot;</span>        <span class="comment"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span></span><br><span class="line">  <span class="attr">authentication:</span></span><br><span class="line">    <span class="attr">jwtSecret:</span> <span class="string">&quot;&quot;</span>           <span class="comment"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &quot;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &quot;apiVersion&quot; | grep jwtSecret&quot; on the Host Cluster.</span></span><br><span class="line">  <span class="attr">local_registry:</span> <span class="string">&quot;&quot;</span>        <span class="comment"># Add your private registry address if it is needed.</span></span><br><span class="line">  <span class="comment"># dev_tag: &quot;&quot;               # Add your kubesphere image tag you want to install, by default it&#x27;s same as ks-install release version.</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">monitoring:</span> <span class="literal">true</span>       <span class="comment"># Enable or disable etcd monitoring dashboard installation. You have to create a Secret for etcd before you enable it.</span></span><br><span class="line">    <span class="attr">endpointIps:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.11</span>  <span class="comment"># etcd cluster EndpointIps. It can be a bunch of IPs here.</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">2379</span>              <span class="comment"># etcd port.</span></span><br><span class="line">    <span class="attr">tlsEnable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">common:</span></span><br><span class="line">    <span class="attr">core:</span></span><br><span class="line">      <span class="attr">console:</span></span><br><span class="line">        <span class="attr">enableMultiLogin:</span> <span class="literal">true</span>  <span class="comment"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">30880</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">    <span class="comment"># apiserver:            # Enlarge the apiserver and controller manager&#x27;s resource requests and limits for the large cluster</span></span><br><span class="line">    <span class="comment">#  resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># controllerManager:</span></span><br><span class="line">    <span class="comment">#  resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">2Gi</span> <span class="comment"># Redis PVC size.</span></span><br><span class="line">    <span class="attr">openldap:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">2Gi</span>   <span class="comment"># openldap PVC size.</span></span><br><span class="line">    <span class="attr">minio:</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">20Gi</span> <span class="comment"># Minio PVC size.</span></span><br><span class="line">    <span class="attr">monitoring:</span></span><br><span class="line">      <span class="comment"># type: external   # Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span></span><br><span class="line">      <span class="attr">endpoint:</span> <span class="string">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span> <span class="comment"># Prometheus endpoint to get metrics data.</span></span><br><span class="line">      <span class="attr">GPUMonitoring:</span>     <span class="comment"># Enable or disable the GPU-related metrics. If you enable this switch but have no GPU resources, Kubesphere will set it to zero. </span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">gpu:</span>                 <span class="comment"># Install GPUKinds. The default GPU kind is nvidia.com/gpu. Other GPU kinds can be added here according to your needs. </span></span><br><span class="line">      <span class="attr">kinds:</span>         </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">resourceName:</span> <span class="string">&quot;nvidia.com/gpu&quot;</span></span><br><span class="line">        <span class="attr">resourceType:</span> <span class="string">&quot;GPU&quot;</span></span><br><span class="line">        <span class="attr">default:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">es:</span>   <span class="comment"># Storage backend for logging, events and auditing.</span></span><br><span class="line">      <span class="comment"># master:</span></span><br><span class="line">      <span class="comment">#   volumeSize: 4Gi  # The volume size of Elasticsearch master nodes.</span></span><br><span class="line">      <span class="comment">#   replicas: 1      # The total number of master nodes. Even numbers are not allowed.</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">      <span class="comment"># data:</span></span><br><span class="line">      <span class="comment">#   volumeSize: 20Gi  # The volume size of Elasticsearch data nodes.</span></span><br><span class="line">      <span class="comment">#   replicas: 1       # The total number of data nodes.</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">      <span class="attr">logMaxAge:</span> <span class="number">7</span>             <span class="comment"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span></span><br><span class="line">      <span class="attr">elkPrefix:</span> <span class="string">logstash</span>      <span class="comment"># The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span></span><br><span class="line">      <span class="attr">basicAuth:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">externalElasticsearchUrl:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">externalElasticsearchPort:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">alerting:</span>                <span class="comment"># (CPU: 0.1 Core, Memory: 100 MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Alerting System.</span></span><br><span class="line">    <span class="comment"># thanosruler:</span></span><br><span class="line">    <span class="comment">#   replicas: 1</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">auditing:</span>                <span class="comment"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Auditing Log System.</span></span><br><span class="line">    <span class="comment"># operator:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># webhook:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">devops:</span>                  <span class="comment"># (CPU: 0.47 Core, Memory: 8.6 G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>             <span class="comment"># Enable or disable the KubeSphere DevOps System.</span></span><br><span class="line">    <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">jenkinsMemoryLim:</span> <span class="string">2Gi</span>      <span class="comment"># Jenkins memory limit.</span></span><br><span class="line">    <span class="attr">jenkinsMemoryReq:</span> <span class="string">1500Mi</span>   <span class="comment"># Jenkins memory request.</span></span><br><span class="line">    <span class="attr">jenkinsVolumeSize:</span> <span class="string">8Gi</span>     <span class="comment"># Jenkins volume size.</span></span><br><span class="line">    <span class="attr">jenkinsJavaOpts_Xms:</span> <span class="string">512m</span>  <span class="comment"># The following three fields are JVM parameters.</span></span><br><span class="line">    <span class="attr">jenkinsJavaOpts_Xmx:</span> <span class="string">512m</span></span><br><span class="line">    <span class="attr">jenkinsJavaOpts_MaxRAM:</span> <span class="string">2g</span></span><br><span class="line">  <span class="attr">events:</span>                  <span class="comment"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Events System.</span></span><br><span class="line">    <span class="comment"># operator:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># exporter:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># ruler:</span></span><br><span class="line">    <span class="comment">#   enabled: true</span></span><br><span class="line">    <span class="comment">#   replicas: 2</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">logging:</span>                 <span class="comment"># (CPU: 57 m, Memory: 2.76 G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Logging System.</span></span><br><span class="line">    <span class="attr">containerruntime:</span> <span class="string">docker</span></span><br><span class="line">    <span class="attr">logsidecar:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">      <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">metrics_server:</span>                    <span class="comment"># (CPU: 56 m, Memory: 44.35 MiB) It enables HPA (Horizontal Pod Autoscaler).</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>                   <span class="comment"># Enable or disable metrics-server.</span></span><br><span class="line">  <span class="attr">monitoring:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;&quot;</span>                 <span class="comment"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span></span><br><span class="line">    <span class="comment"># kube_rbac_proxy:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># kube_state_metrics:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># prometheus:</span></span><br><span class="line">    <span class="comment">#   replicas: 1  # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span></span><br><span class="line">    <span class="comment">#   volumeSize: 20Gi  # Prometheus PVC size.</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   operator:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   adapter:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># node_exporter:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># alertmanager:</span></span><br><span class="line">    <span class="comment">#   replicas: 1          # AlertManager Replicas.</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># notification_manager:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   operator:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   proxy:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">gpu:</span>                           <span class="comment"># GPU monitoring-related plug-in installation. </span></span><br><span class="line">      <span class="attr">nvidia_dcgm_exporter:</span>        <span class="comment"># Ensure that gpu resources on your hosts can be used normally, otherwise this plug-in will not work properly.</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span>             <span class="comment"># Check whether the labels on the GPU hosts contain &quot;nvidia.com/gpu.present=true&quot; to ensure that the DCGM pod is scheduled to these nodes.</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">multicluster:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">none</span>  <span class="comment"># host | member | none  # You can install a solo cluster, or specify it as the Host or Member Cluster.</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">networkpolicy:</span> <span class="comment"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span></span><br><span class="line">      <span class="comment"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># Enable or disable network policies.</span></span><br><span class="line">    <span class="attr">ippool:</span> <span class="comment"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">calico</span> <span class="comment"># Specify &quot;calico&quot; for this field if Calico is used as your CNI plugin. &quot;none&quot; means that Pod IP Pools are disabled.</span></span><br><span class="line">    <span class="attr">topology:</span> <span class="comment"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">none</span> <span class="comment"># Specify &quot;weave-scope&quot; for this field to enable Service Topology. &quot;none&quot; means that Service Topology is disabled.</span></span><br><span class="line">  <span class="attr">openpitrix:</span> <span class="comment"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span></span><br><span class="line">    <span class="attr">store:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># Enable or disable the KubeSphere App Store.</span></span><br><span class="line">  <span class="attr">servicemesh:</span>         <span class="comment"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>     <span class="comment"># Base component (pilot). Enable or disable KubeSphere Service Mesh (Istio-based).</span></span><br><span class="line">  <span class="attr">kubeedge:</span>          <span class="comment"># Add edge nodes to your cluster and deploy workloads on edge nodes.</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>   <span class="comment"># Enable or disable KubeEdge.</span></span><br><span class="line">    <span class="attr">cloudCore:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span> &#123;<span class="attr">&quot;node-role.kubernetes.io/worker&quot;:</span> <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">      <span class="attr">tolerations:</span> []</span><br><span class="line">      <span class="attr">cloudhubPort:</span> <span class="string">&quot;10000&quot;</span></span><br><span class="line">      <span class="attr">cloudhubQuicPort:</span> <span class="string">&quot;10001&quot;</span></span><br><span class="line">      <span class="attr">cloudhubHttpsPort:</span> <span class="string">&quot;10002&quot;</span></span><br><span class="line">      <span class="attr">cloudstreamPort:</span> <span class="string">&quot;10003&quot;</span></span><br><span class="line">      <span class="attr">tunnelPort:</span> <span class="string">&quot;10004&quot;</span></span><br><span class="line">      <span class="attr">cloudHub:</span></span><br><span class="line">        <span class="attr">advertiseAddress:</span> <span class="comment"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;&quot;</span>            <span class="comment"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span></span><br><span class="line">        <span class="attr">nodeLimit:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">cloudhubNodePort:</span> <span class="string">&quot;30000&quot;</span></span><br><span class="line">        <span class="attr">cloudhubQuicNodePort:</span> <span class="string">&quot;30001&quot;</span></span><br><span class="line">        <span class="attr">cloudhubHttpsNodePort:</span> <span class="string">&quot;30002&quot;</span></span><br><span class="line">        <span class="attr">cloudstreamNodePort:</span> <span class="string">&quot;30003&quot;</span></span><br><span class="line">        <span class="attr">tunnelNodePort:</span> <span class="string">&quot;30004&quot;</span></span><br><span class="line">    <span class="attr">edgeWatcher:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span> &#123;<span class="attr">&quot;node-role.kubernetes.io/worker&quot;:</span> <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">      <span class="attr">tolerations:</span> []</span><br><span class="line">      <span class="attr">edgeWatcherAgent:</span></span><br><span class="line">        <span class="attr">nodeSelector:</span> &#123;<span class="attr">&quot;node-role.kubernetes.io/worker&quot;:</span> <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">        <span class="attr">tolerations:</span> []</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="执行安装"><a href="#执行安装" class="headerlink" title="执行安装"></a>执行安装</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubesphere-installer.yaml</span><br><span class="line"></span><br><span class="line">kubectl apply -f cluster-configuration.yaml</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="查看安装进度"><a href="#查看安装进度" class="headerlink" title="查看安装进度"></a>查看安装进度</h6><p><img src="/2021/08/23/docker/image-20220214220541659.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs <span class="literal">-n</span> kubesphere<span class="literal">-system</span> <span class="variable">$</span>(kubectl get pod <span class="literal">-n</span> kubesphere<span class="literal">-system</span> <span class="literal">-l</span> app=ks<span class="literal">-install</span> <span class="literal">-o</span> jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) <span class="operator">-f</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解决etcd监控证书找不到问题(prometheus监控)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="literal">-n</span> kubesphere<span class="literal">-monitoring</span><span class="literal">-system</span> create secret generic kube<span class="literal">-etcd</span><span class="literal">-client</span><span class="literal">-certs</span>  -<span class="literal">-from</span><span class="operator">-file</span>=etcd<span class="literal">-client</span><span class="literal">-ca</span>.crt=/etc/kubernetes/pki/etcd/ca.crt  -<span class="literal">-from</span><span class="operator">-file</span>=etcd<span class="literal">-client</span>.crt=/etc/kubernetes/pki/apiserver<span class="literal">-etcd</span><span class="literal">-client</span>.crt  -<span class="literal">-from</span><span class="operator">-file</span>=etcd<span class="literal">-client</span>.key=/etc/kubernetes/pki/apiserver<span class="literal">-etcd</span><span class="literal">-client</span>.key</span><br></pre></td></tr></table></figure>

<p>报错问题</p>
<p><img src="/2021/08/23/docker/image-20220221101600008.png" alt="docker"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get validatingwebhookconfigurations.admissionregistration.k8s.io</span><br></pre></td></tr></table></figure>

<h6 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h6><p><img src="/2021/08/23/docker/image-20220214220713791.png" alt="docker"></p>
<h6 id="删除Terminating名称空间"><a href="#删除Terminating名称空间" class="headerlink" title="删除Terminating名称空间"></a>删除Terminating名称空间</h6><ul>
<li><img src="/2021/08/23/docker/image-20220628095140462.png" alt="docker"></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>先把proxy开起来，不然<span class="number">8001</span>端口访问不到：</span><br><span class="line"> kubectl proxy</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>生成json文件</span><br><span class="line"> kubectl get namespace kubesphere-system -o json  &gt;temp.json</span><br><span class="line"><span class="number">3.</span>vim temp.json </span><br><span class="line">	    <span class="string">&quot;spec&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;finalizers&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;kubernetes&quot;</span>  <span class="comment"># 删除</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line"><span class="number">4.</span>执行删除</span><br><span class="line"> curl -k -H <span class="string">&quot;Content-Type: application/json&quot;</span> -X PUT --data-binary @temp.json <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8001</span>/api/v1/namespaces/kubesphere-system/finalize</span><br></pre></td></tr></table></figure>

<h6 id="kubekey安装"><a href="#kubekey安装" class="headerlink" title="kubekey安装"></a>kubekey安装</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先执行以下命令以确保您从正确的区域下载 KubeKey。</span></span><br><span class="line">export KKZONE=cn</span><br><span class="line"><span class="comment">#执行以下命令下载 KubeKey：</span></span><br><span class="line">curl -sfL https://get-kk.kubesphere.io | VERSION=v2<span class="number">.2</span><span class="number">.1</span> sh -</span><br><span class="line">chmod +x kk</span><br><span class="line"><span class="comment">#创建包含默认配置的示例配置文件。这里使用 Kubernetes v1.22.10 作为示例。</span></span><br><span class="line">./kk create config --<span class="keyword">with</span>-kubesphere v3<span class="number">.3</span><span class="number">.0</span> --<span class="keyword">with</span>-kubernetes v1<span class="number">.22</span><span class="number">.10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开启内置高可用模式</span></span><br><span class="line">spec:</span><br><span class="line">  controlPlaneEndpoint:</span><br><span class="line">    <span class="comment">##Internal loadbalancer for apiservers</span></span><br><span class="line">    internalLoadbalancer: haproxy</span><br><span class="line">    </span><br><span class="line">    domain: lb.kubesphere.local</span><br><span class="line">    address: <span class="string">&quot;&quot;</span></span><br><span class="line">    port: <span class="number">6443</span></span><br><span class="line"><span class="comment">#开始安装</span></span><br><span class="line">./kk create cluster -f config-sample.yaml</span><br><span class="line"><span class="comment">#暴露 KubeSphere API 服务</span></span><br><span class="line">kubectl -n kubesphere-system patch service ks-apiserver -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line">kubectl -n kubesphere-system get svc</span><br><span class="line">NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">ks-apiserver            NodePort    <span class="number">10.233</span><span class="number">.11</span><span class="number">.20</span>    &lt;none&gt;        <span class="number">80</span>:<span class="number">30890</span>/TCP   77m</span><br><span class="line">ks-console              NodePort    <span class="number">10.233</span><span class="number">.33</span><span class="number">.167</span>   &lt;none&gt;        <span class="number">80</span>:<span class="number">30880</span>/TCP   77m</span><br><span class="line">ks-controller-manager   ClusterIP   <span class="number">10.233</span><span class="number">.3</span><span class="number">.178</span>    &lt;none&gt;        <span class="number">443</span>/TCP        77m</span><br><span class="line"><span class="comment">#修改服务YAML</span></span><br><span class="line">kubectl edit svc ks-apiserver -n kubesphere-system</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>config-sample.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubekey.kubesphere.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">master</span>, <span class="attr">address:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.11</span>, <span class="attr">internalAddress:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.11</span>, <span class="attr">user:</span> <span class="string">root</span>, <span class="attr">password:</span> <span class="string">FOda@2021</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">fcy-srv03</span>, <span class="attr">address:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.13</span>, <span class="attr">internalAddress:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.13</span>, <span class="attr">user:</span> <span class="string">root</span>, <span class="attr">password:</span> <span class="string">FOda@2021</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">fcy-srv04</span>, <span class="attr">address:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.14</span>, <span class="attr">internalAddress:</span> <span class="number">10.21</span><span class="number">.6</span><span class="number">.14</span>, <span class="attr">user:</span> <span class="string">root</span>, <span class="attr">password:</span> <span class="string">FOda@2021</span>&#125;</span><br><span class="line">  <span class="attr">roleGroups:</span></span><br><span class="line">    <span class="attr">etcd:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">control-plane:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">worker:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">fcy-srv03</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">fcy-srv04</span></span><br><span class="line">  <span class="attr">controlPlaneEndpoint:</span></span><br><span class="line">    <span class="comment">## Internal loadbalancer for apiservers </span></span><br><span class="line">    <span class="comment"># internalLoadbalancer: haproxy</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">domain:</span> <span class="string">lb.kubesphere.local</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">  <span class="attr">kubernetes:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.23.7</span></span><br><span class="line">    <span class="attr">clusterName:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="attr">autoRenewCerts:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">containerManager:</span> <span class="string">docker</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">kubekey</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">plugin:</span> <span class="string">calico</span></span><br><span class="line">    <span class="attr">kubePodsCIDR:</span> <span class="number">10.233</span><span class="number">.64</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line">    <span class="attr">kubeServiceCIDR:</span> <span class="number">10.233</span><span class="number">.0</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line">    <span class="comment">## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span></span><br><span class="line">    <span class="attr">multusCNI:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">privateRegistry:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">namespaceOverride:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">registryMirrors:</span> []</span><br><span class="line">    <span class="attr">insecureRegistries:</span> []</span><br><span class="line">  <span class="attr">addons:</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">installer.kubesphere.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ks-installer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v3.3.0</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">persistence:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">authentication:</span></span><br><span class="line">    <span class="attr">jwtSecret:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">zone:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">local_registry:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">namespace_override:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># dev_tag: &quot;&quot;</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">monitoring:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">endpointIps:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">2379</span></span><br><span class="line">    <span class="attr">tlsEnable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">common:</span></span><br><span class="line">    <span class="attr">core:</span></span><br><span class="line">      <span class="attr">console:</span></span><br><span class="line">        <span class="attr">enableMultiLogin:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">30880</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">    <span class="comment"># apiserver:</span></span><br><span class="line">    <span class="comment">#  resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># controllerManager:</span></span><br><span class="line">    <span class="comment">#  resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">openldap:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">minio:</span></span><br><span class="line">      <span class="attr">volumeSize:</span> <span class="string">20Gi</span></span><br><span class="line">    <span class="attr">monitoring:</span></span><br><span class="line">      <span class="comment"># type: external</span></span><br><span class="line">      <span class="attr">endpoint:</span> <span class="string">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span></span><br><span class="line">      <span class="attr">GPUMonitoring:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">gpu:</span></span><br><span class="line">      <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">resourceName:</span> <span class="string">&quot;nvidia.com/gpu&quot;</span></span><br><span class="line">        <span class="attr">resourceType:</span> <span class="string">&quot;GPU&quot;</span></span><br><span class="line">        <span class="attr">default:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">es:</span></span><br><span class="line">      <span class="comment"># master:</span></span><br><span class="line">      <span class="comment">#   volumeSize: 4Gi</span></span><br><span class="line">      <span class="comment">#   replicas: 1</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">      <span class="comment"># data:</span></span><br><span class="line">      <span class="comment">#   volumeSize: 20Gi</span></span><br><span class="line">      <span class="comment">#   replicas: 1</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">      <span class="attr">logMaxAge:</span> <span class="number">7</span></span><br><span class="line">      <span class="attr">elkPrefix:</span> <span class="string">logstash</span></span><br><span class="line">      <span class="attr">basicAuth:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">externalElasticsearchHost:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">externalElasticsearchPort:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">alerting:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># thanosruler:</span></span><br><span class="line">    <span class="comment">#   replicas: 1</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">auditing:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># operator:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># webhook:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">devops:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">jenkinsMemoryLim:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">jenkinsMemoryReq:</span> <span class="string">1500Mi</span></span><br><span class="line">    <span class="attr">jenkinsVolumeSize:</span> <span class="string">8Gi</span></span><br><span class="line">    <span class="attr">jenkinsJavaOpts_Xms:</span> <span class="string">1200m</span></span><br><span class="line">    <span class="attr">jenkinsJavaOpts_Xmx:</span> <span class="string">1600m</span></span><br><span class="line">    <span class="attr">jenkinsJavaOpts_MaxRAM:</span> <span class="string">2g</span></span><br><span class="line">  <span class="attr">events:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># operator:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># exporter:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># ruler:</span></span><br><span class="line">    <span class="comment">#   enabled: true</span></span><br><span class="line">    <span class="comment">#   replicas: 2</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">logsidecar:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">      <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">metrics_server:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">monitoring:</span></span><br><span class="line">    <span class="attr">storageClass:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node_exporter:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">      <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># kube_rbac_proxy:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># kube_state_metrics:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># prometheus:</span></span><br><span class="line">    <span class="comment">#   replicas: 1</span></span><br><span class="line">    <span class="comment">#   volumeSize: 20Gi</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   operator:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># alertmanager:</span></span><br><span class="line">    <span class="comment">#   replicas: 1</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment"># notification_manager:</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   operator:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="comment">#   proxy:</span></span><br><span class="line">    <span class="comment">#     resources: &#123;&#125;</span></span><br><span class="line">    <span class="attr">gpu:</span></span><br><span class="line">      <span class="attr">nvidia_dcgm_exporter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">multicluster:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">none</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">networkpolicy:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">ippool:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">none</span></span><br><span class="line">    <span class="attr">topology:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">none</span></span><br><span class="line">  <span class="attr">openpitrix:</span></span><br><span class="line">    <span class="attr">store:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">servicemesh:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">istio:</span></span><br><span class="line">      <span class="attr">components:</span></span><br><span class="line">        <span class="attr">ingressGateways:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">cni:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">edgeruntime:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kubeedge:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">cloudCore:</span></span><br><span class="line">        <span class="attr">cloudHub:</span></span><br><span class="line">          <span class="attr">advertiseAddress:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">service:</span></span><br><span class="line">          <span class="attr">cloudhubNodePort:</span> <span class="string">&quot;30000&quot;</span></span><br><span class="line">          <span class="attr">cloudhubQuicNodePort:</span> <span class="string">&quot;30001&quot;</span></span><br><span class="line">          <span class="attr">cloudhubHttpsNodePort:</span> <span class="string">&quot;30002&quot;</span></span><br><span class="line">          <span class="attr">cloudstreamNodePort:</span> <span class="string">&quot;30003&quot;</span></span><br><span class="line">          <span class="attr">tunnelNodePort:</span> <span class="string">&quot;30004&quot;</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">        <span class="comment"># hostNetWork: false</span></span><br><span class="line">      <span class="attr">iptables-manager:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;external&quot;</span></span><br><span class="line">        <span class="comment"># resources: &#123;&#125;</span></span><br><span class="line">      <span class="comment"># edgeService:</span></span><br><span class="line">      <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  <span class="attr">terminal:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="KubeSphere离线安装"><a href="#KubeSphere离线安装" class="headerlink" title="KubeSphere离线安装"></a>KubeSphere离线安装</h6><ul>
<li><a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/2034-kubekey-kubesphere-v300">https://kubesphere.com.cn/forum/d/2034-kubekey-kubesphere-v300</a></li>
<li><img src="/2021/08/23/docker/image-20220303155930559.png" alt="docker"></li>
<li><img src="/2021/08/23/docker/docker" alt="docker"></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.安装包下载</span></span><br><span class="line"><span class="built_in">curl</span> <span class="literal">-Ok</span> https://kubesphere<span class="literal">-installer</span>.pek3b.qingstor.com/offline/v3.<span class="number">0.0</span>/kubesphere<span class="literal">-all</span><span class="literal">-v3</span>.<span class="number">0.0</span><span class="literal">-offline</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br><span class="line"><span class="comment">#2.解压缩并创建集群配置文件</span></span><br><span class="line">tar zxvf kubesphere<span class="literal">-all</span><span class="literal">-v3</span>.<span class="number">0.0</span><span class="literal">-offline</span><span class="literal">-linux</span><span class="literal">-amd64</span>.tar.gz</span><br><span class="line">./kk create config -<span class="literal">-with</span><span class="literal">-kubernetes</span> v1.<span class="number">18.6</span> -<span class="literal">-with</span><span class="literal">-kubesphere</span> v3.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#3.修改集群生成的配置文件</span></span><br><span class="line"><span class="comment">#私有镜像仓库地址可为harbor</span></span><br><span class="line">privateRegistry: dockerhub.kubekey.local</span><br><span class="line"><span class="comment">#4.环境初始化</span></span><br><span class="line"><span class="comment"># 执行如下命令会对配置文件中所有节点安装依赖：</span></span><br><span class="line">./kk init os <span class="operator">-f</span> config<span class="literal">-sample</span>.yaml <span class="literal">-s</span> ./dependencies/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如需使用kk创建自签名镜像仓库，可执行如下命令：</span></span><br><span class="line">./kk init os <span class="operator">-f</span> config<span class="literal">-sample</span>.yaml <span class="literal">-s</span> ./dependencies/ -<span class="literal">-add</span><span class="literal">-images</span><span class="literal">-repo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5.导入镜像(进入kubesphere-images)</span></span><br><span class="line">./<span class="built_in">push-images</span>.sh  dockerhub.kubekey.local</span><br><span class="line"></span><br><span class="line"><span class="comment">#6.执行安装</span></span><br><span class="line">./kk create cluster <span class="operator">-f</span> config<span class="literal">-sample</span>.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.成功显示信息</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="comment">###              Welcome to KubeSphere!           ###</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line">Console: http://<span class="number">192.168</span>.<span class="number">17.17</span>:<span class="number">30880</span></span><br><span class="line">Account: admin</span><br><span class="line">Password: P@<span class="number">88</span>w0<span class="built_in">rd</span></span><br><span class="line"></span><br><span class="line">NOTES：</span><br><span class="line">  <span class="number">1</span>. After logging into the console, please check the</span><br><span class="line">     monitoring status of service components <span class="keyword">in</span></span><br><span class="line">     the <span class="string">&quot;Cluster Management&quot;</span>. <span class="keyword">If</span> any service is not</span><br><span class="line">     ready, please wait patiently <span class="keyword">until</span> all components</span><br><span class="line">     are ready.</span><br><span class="line">  <span class="number">2</span>. Please modify the default password after login.</span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line">https://kubesphere.io             <span class="number">2022</span><span class="literal">-04</span><span class="literal">-01</span> <span class="number">16</span>:<span class="number">30</span>:<span class="number">35</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line">INFO[<span class="number">16</span>:<span class="number">30</span>:<span class="number">44</span> <span class="type">CST</span>] Installation is complete.</span><br><span class="line"></span><br><span class="line">Please check the result <span class="keyword">using</span> the <span class="keyword">command</span>:</span><br><span class="line"></span><br><span class="line">       kubectl logs <span class="literal">-n</span> kubesphere<span class="literal">-system</span> <span class="variable">$</span>(kubectl get pod <span class="literal">-n</span> kubesphere<span class="literal">-system</span> <span class="literal">-l</span> app=ks<span class="literal">-install</span> <span class="literal">-o</span> jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) <span class="operator">-f</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>镜像</code></p>
<ul>
<li><img src="/2021/08/23/docker/image-20220401163648503.png" alt="docker"></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">host</span>-<span class="number">192</span>-<span class="number">168</span>-<span class="number">17</span>-<span class="number">2</span> ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                                                         TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">dockerhub.kubekey.local/kubesphere/ks<span class="literal">-controller</span><span class="literal">-manager</span>           v3.<span class="number">0.0</span>              <span class="number">85</span>bd13080839        <span class="number">19</span> months ago       <span class="number">82</span>MB</span><br><span class="line">dockerhub.kubekey.local/prom/prometheus                            v2.<span class="number">20.1</span>             b205ccdd28d3        <span class="number">20</span> months ago       <span class="number">145</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/notification<span class="literal">-manager</span>            v0.<span class="number">1.0</span>              <span class="number">331</span>a0e6ece23        <span class="number">20</span> months ago       <span class="number">47.5</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/notification<span class="literal">-manager</span><span class="literal">-operator</span>   v0.<span class="number">1.0</span>              c441b79e9606        <span class="number">20</span> months ago       <span class="number">44.4</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/kube<span class="literal">-proxy</span>                      v1.<span class="number">18.6</span>             c3d62d6fe412        <span class="number">20</span> months ago       <span class="number">117</span>MB</span><br><span class="line">dockerhub.kubekey.local/calico/node                                v3.<span class="number">15.1</span>             <span class="number">1470783</span>b1474        <span class="number">21</span> months ago       <span class="number">262</span>MB</span><br><span class="line">dockerhub.kubekey.local/calico/pod2daemon<span class="literal">-flexvol</span>                  v3.<span class="number">15.1</span>             a696ebcb2ac7        <span class="number">21</span> months ago       <span class="number">112</span>MB</span><br><span class="line">dockerhub.kubekey.local/calico/cni                                 v3.<span class="number">15.1</span>             <span class="number">2858353</span>c1d25        <span class="number">21</span> months ago       <span class="number">217</span>MB</span><br><span class="line">dockerhub.kubekey.local/calico/kube<span class="literal">-controllers</span>                    v3.<span class="number">15.1</span>             <span class="number">8</span>ed9dbffe350        <span class="number">21</span> months ago       <span class="number">53.1</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/prometheus<span class="literal">-config</span><span class="literal">-reloader</span>      v0.<span class="number">38.3</span>             <span class="number">8011</span>d6eb5bac        <span class="number">21</span> months ago       <span class="number">10.1</span>MB</span><br><span class="line">dockerhub.kubekey.local/prom/alertmanager                          v0.<span class="number">21.0</span>             c876f5897d7b        <span class="number">21</span> months ago       <span class="number">55.5</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/kube<span class="literal">-state</span><span class="literal">-metrics</span>              v1.<span class="number">9.6</span>              <span class="number">092</span>e8ed1e0b3        <span class="number">22</span> months ago       <span class="number">32.8</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/provisioner<span class="literal">-localpv</span>             <span class="number">1.10</span>.<span class="number">0</span>              <span class="number">6</span>b5529f464f7        <span class="number">22</span> months ago       <span class="number">68.4</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/node<span class="literal">-disk</span><span class="literal">-operator</span>              <span class="number">0.5</span>.<span class="number">0</span>               <span class="number">8741</span>fafb7b21        <span class="number">22</span> months ago       <span class="number">167</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/node<span class="literal">-disk</span><span class="literal">-manager</span>               <span class="number">0.5</span>.<span class="number">0</span>               dbbed43bcbdb        <span class="number">22</span> months ago       <span class="number">168</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/k8s<span class="literal">-dns</span><span class="literal">-node</span><span class="literal">-cache</span>              <span class="number">1.15</span>.<span class="number">12</span>             <span class="number">5340</span>ba194ec9        <span class="number">23</span> months ago       <span class="number">107</span>MB</span><br><span class="line">dockerhub.kubekey.local/coredns/coredns                            <span class="number">1.6</span>.<span class="number">9</span>               faac9e62c0d6        <span class="number">2</span> years ago         <span class="number">43.2</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/pause                           <span class="number">3.2</span>                 <span class="number">80</span>d28bedfe5d        <span class="number">2</span> years ago         <span class="number">683</span>kB</span><br><span class="line">dockerhub.kubekey.local/csiplugin/snapshot<span class="literal">-controller</span>              v2.<span class="number">0.1</span>              <span class="number">525889021849</span>        <span class="number">2</span> years ago         <span class="number">41.4</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/node<span class="literal">-exporter</span>                   ks<span class="literal">-v0</span>.<span class="number">18.1</span>          cfb0175954de        <span class="number">2</span> years ago         <span class="number">23.7</span>MB</span><br><span class="line">dockerhub.kubekey.local/jimmidyson/configmap<span class="literal">-reload</span>                v0.<span class="number">3.0</span>              <span class="number">7</span>ec24a279487        <span class="number">2</span> years ago         <span class="number">9.7</span>MB</span><br><span class="line">dockerhub.kubekey.local/kubesphere/kube<span class="literal">-rbac</span><span class="literal">-proxy</span>                 v0.<span class="number">4.1</span>              <span class="number">70</span>eeaa7791f2        <span class="number">3</span> years ago         <span class="number">41.3</span>MB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="kubesphere错误排查"><a href="#kubesphere错误排查" class="headerlink" title="kubesphere错误排查"></a>kubesphere错误排查</h6><p><img src="/2021/08/23/docker/image-20221018104310600.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable kubelet</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/23/docker/image-20221020160741638.png" alt="docker"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm coredns <span class="literal">-n</span> kube<span class="literal">-system</span></span><br><span class="line">删除 forward . /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<h6 id="集群卸载"><a href="#集群卸载" class="headerlink" title="集群卸载"></a>集群卸载</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">./kk delete cluster <span class="operator">-f</span> config<span class="literal">-sample</span>.yaml</span><br><span class="line">kubeadm reset <span class="operator">-f</span></span><br><span class="line">modprobe <span class="literal">-r</span> ipip</span><br><span class="line">lsmod</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> ~/.kube/</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /etc/kubernetes/</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /etc/systemd/system/kubelet.service.d</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /etc/systemd/system/kubelet.service</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /usr/bin/kube*</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /etc/cni</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /opt/cni</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /var/lib/etcd</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /var/etcd</span><br><span class="line">yum clean all</span><br><span class="line">yum remove kube*</span><br></pre></td></tr></table></figure>



<h6 id="使用-ConfigMap-来配置-Redis"><a href="#使用-ConfigMap-来配置-Redis" class="headerlink" title="使用 ConfigMap 来配置 Redis"></a>使用 ConfigMap 来配置 Redis</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.编写redis.conf配置文件</span></span><br><span class="line">requirepass Foda.ai2021</span><br><span class="line">appendonly yes</span><br><span class="line"><span class="comment">#2.把redis.conf作为配置集</span></span><br><span class="line">kubectl create cm redis.conf --<span class="keyword">from</span>-file=./redis.conf</span><br><span class="line"><span class="comment">#3.查看配置集</span></span><br><span class="line">kubectl get cm</span><br><span class="line"><span class="comment">#4.修改配置集</span></span><br><span class="line">kubectl edit cm redis.conf</span><br></pre></td></tr></table></figure>

<h6 id="redis-yaml"><a href="#redis-yaml" class="headerlink" title="redis.yaml"></a>redis.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/etc/redis/redis.conf&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">requirepass</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">Foda.ai2021</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">redis-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/redis/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        </span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-pvc</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">redis-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">redis.conf</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">redis.conf</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">redis.conf</span></span><br></pre></td></tr></table></figure>

<h6 id="redis-pvc持久卷"><a href="#redis-pvc持久卷" class="headerlink" title="redis pvc持久卷"></a>redis pvc持久卷</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<h6 id="mongodb-yaml"><a href="#mongodb-yaml" class="headerlink" title="mongodb.yaml"></a>mongodb.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;mongodb&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mongo:5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">27017</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mongod</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;--replSet&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rs0</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;--bind_ip&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">          <span class="comment">#- &quot;--smallfiles&quot;</span></span><br><span class="line">          <span class="comment">#- &quot;--noprealloc&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/db</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">      <span class="comment">#volumes:</span></span><br><span class="line">        <span class="comment">#- name: mongodb-claim0</span></span><br><span class="line">        <span class="comment">#  persistentVolumeClaim:</span></span><br><span class="line">        <span class="comment">#    claimName: mongodb-claim0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="mysql-yaml"><a href="#mysql-yaml" class="headerlink" title="mysql.yaml"></a>mysql.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--character-set-server=utf8</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collation-server=utf8_general_ci</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">algorithm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">Foda.ai2021</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mysql pvc持久卷</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="nacos-yaml"><a href="#nacos-yaml" class="headerlink" title="nacos.yaml"></a>nacos.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nacos-headless</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">service.alpha.kubernetes.io/tolerate-unready-endpoints:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8848</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30848</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nacos</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nacos-headless</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">pod.alpha.kubernetes.io/initialized:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;app&quot;</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">nacos-headless</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8snacos</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nacos/nacos-server:1.4.2</span></span><br><span class="line">          <span class="comment">#resources:</span></span><br><span class="line">          <span class="comment">#  requests:</span></span><br><span class="line">          <span class="comment">#    memory: &quot;2Gi&quot;</span></span><br><span class="line">          <span class="comment">#    cpu: &quot;500m&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8848</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NACOS_REPLICAS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_HOST</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">nacos-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql.host</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_DB_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">nacos-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql.db.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PORT</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">nacos-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql.port</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_USER</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">nacos-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql.user</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">nacos-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql.password</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MODE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;cluster&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NACOS_SERVER_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;8848&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PREFER_HOST_MODE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;hostname&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NACOS_SERVERS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;nacos-0.nacos-headless.default.svc.cluster.local:8848 nacos-1.nacos-headless.default.svc.cluster.local:8848 nacos-2.nacos-headless.default.svc.cluster.local:8848&quot;</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>nacos-configMap</p>
<ul>
<li>nacos-cm.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nacos-cm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mysql.host:</span> <span class="string">&quot;mysql-0.mysql.default.svc.cluster.local&quot;</span></span><br><span class="line">  <span class="attr">mysql.db.name:</span> <span class="string">&quot;nacos_config&quot;</span></span><br><span class="line">  <span class="attr">mysql.port:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">  <span class="attr">mysql.user:</span> <span class="string">&quot;root&quot;</span></span><br><span class="line">  <span class="attr">mysql.password:</span> <span class="string">&quot;Foda.ai2021&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>nacos初始化sql</li>
<li>进入mysql-&gt; create database nacos_config; </li>
<li>use nacos_config;</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright 1999-2018 Alibaba Group Holding Ltd.</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(255) DEFAULT NULL,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  `c_desc` varchar(256) DEFAULT NULL,</span><br><span class="line">  `c_use` varchar(64) DEFAULT NULL,</span><br><span class="line">  `effect` varchar(64) DEFAULT NULL,</span><br><span class="line">  `type` varchar(64) DEFAULT NULL,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_aggr   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_aggr` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(255) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `datum_id` varchar(255) NOT NULL COMMENT &#x27;datum_id&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;内容&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;增加租户字段&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_beta   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_beta` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `beta_ips` varchar(1024) DEFAULT NULL COMMENT &#x27;betaIps&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_beta&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_tag   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_tag` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `tag_id` varchar(128) NOT NULL COMMENT &#x27;tag_id&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_tag&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_tags_relation   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_tags_relation` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;id&#x27;,</span><br><span class="line">  `tag_name` varchar(128) NOT NULL COMMENT &#x27;tag_name&#x27;,</span><br><span class="line">  `tag_type` varchar(64) DEFAULT NULL COMMENT &#x27;tag_type&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `nid` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_tag_relation&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = group_capacity   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `group_capacity` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Group ID，空字符表示整个集群&#x27;,</span><br><span class="line">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class="line">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class="line">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数，，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;集群、各Group容量信息表&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = his_config_info   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `his_config_info` (</span><br><span class="line">  `id` bigint(64) unsigned NOT NULL,</span><br><span class="line">  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `data_id` varchar(255) NOT NULL,</span><br><span class="line">  `group_id` varchar(128) NOT NULL,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL,</span><br><span class="line">  `op_type` char(10) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;多租户改造&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = tenant_capacity   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `tenant_capacity` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Tenant ID&#x27;,</span><br><span class="line">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class="line">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class="line">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数&#x27;,</span><br><span class="line">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;租户容量信息表&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `tenant_info` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `kp` varchar(128) NOT NULL COMMENT &#x27;kp&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `tenant_name` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_name&#x27;,</span><br><span class="line">  `tenant_desc` varchar(256) DEFAULT NULL COMMENT &#x27;tenant_desc&#x27;,</span><br><span class="line">  `create_source` varchar(32) DEFAULT NULL COMMENT &#x27;create_source&#x27;,</span><br><span class="line">  `gmt_create` bigint(20) NOT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` bigint(20) NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;tenant_info&#x27;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `users` (</span><br><span class="line">	`username` varchar(50) NOT NULL PRIMARY KEY,</span><br><span class="line">	`password` varchar(500) NOT NULL,</span><br><span class="line">	`enabled` boolean NOT NULL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE `roles` (</span><br><span class="line">	`username` varchar(50) NOT NULL,</span><br><span class="line">	`role` varchar(50) NOT NULL,</span><br><span class="line">	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE `permissions` (</span><br><span class="line">    `role` varchar(50) NOT NULL,</span><br><span class="line">    `resource` varchar(255) NOT NULL,</span><br><span class="line">    `action` varchar(8) NOT NULL,</span><br><span class="line">    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO users (username, password, enabled) VALUES (&#x27;nacos&#x27;, &#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;, TRUE);</span><br><span class="line"></span><br><span class="line">INSERT INTO roles (username, role) VALUES (&#x27;nacos&#x27;, &#x27;ROLE_ADMIN&#x27;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="nginx-yaml"><a href="#nginx-yaml" class="headerlink" title="nginx.yaml"></a>nginx.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nacos-headless</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">30080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">30080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30081</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d/</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">default.conf</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">default.conf</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">default.conf</span></span><br></pre></td></tr></table></figure>

<p>ngixn-ConfigMap</p>
<ul>
<li>vim default.conf</li>
<li>kubectl create cm default.conf  –from-file=default.conf</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx配置文件</span></span><br><span class="line"></span><br><span class="line">upstream django &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server web:<span class="number">8000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream cluster &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server  nacos<span class="literal">-0</span>.nacos<span class="literal">-headless</span>.default.svc.cluster.loca:<span class="number">8848</span>;</span><br><span class="line">    server  nacos<span class="literal">-1</span>.nacos<span class="literal">-headless</span>.default.svc.cluster.loca:<span class="number">8848</span>;</span><br><span class="line">    server  nacos<span class="literal">-2</span>.nacos<span class="literal">-headless</span>.default.svc.cluster.loca:<span class="number">8848</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen       <span class="number">8888</span>;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X<span class="literal">-Forwarded</span><span class="literal">-For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header X<span class="literal">-Real</span><span class="literal">-IP</span>  <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_pass http://cluster;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置http请求，80端口</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">8000</span>; <span class="comment"># 监听80端口</span></span><br><span class="line">    server_name <span class="number">127.0</span>.<span class="number">0.1</span>; <span class="comment"># 可以是nginx容器所在ip地址或127.0.0.1，不能写宿主机外网ip地址</span></span><br><span class="line"></span><br><span class="line">    charset utf<span class="literal">-8</span>;</span><br><span class="line">    client_max_body_size <span class="number">10</span>M; <span class="comment"># 限制用户上传文件大小</span></span><br><span class="line"></span><br><span class="line">    access_log /var/log/nginx/access.log main;</span><br><span class="line">    error_log /var/log/nginx/error.log warn;</span><br><span class="line"></span><br><span class="line">    location /<span class="keyword">static</span> &#123;</span><br><span class="line">        alias /usr/share/nginx/html/<span class="keyword">static</span>; <span class="comment"># 静态资源路径</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /media &#123;</span><br><span class="line">        alias /usr/share/nginx/html/media; <span class="comment"># 媒体资源，用户上传文件路径</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        include /etc/nginx/uwsgi_params;</span><br><span class="line">        uwsgi_pass django;</span><br><span class="line">        uwsgi_read_timeout <span class="number">600</span>;</span><br><span class="line">        uwsgi_connect_timeout <span class="number">600</span>;</span><br><span class="line">        uwsgi_send_timeout <span class="number">600</span>;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X<span class="literal">-Forwarded</span><span class="literal">-For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header X<span class="literal">-Real</span><span class="literal">-IP</span>  <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="comment"># proxy_pass http://django;  # 使用uwsgi通信，而不是http，所以不使用proxy_pass。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="web-yaml"><a href="#web-yaml" class="headerlink" title="web.yaml"></a>web.yaml</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">algorithmserver_web:v2</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/code</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">web-claim0</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-claim0</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">web-claim0</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/20/Flask/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/20/Flask/" class="post-title-link" itemprop="url">Flask</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 12:23:37" itemprop="dateCreated datePublished" datetime="2021-08-20T12:23:37+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-17 10:22:24" itemprop="dateModified" datetime="2021-09-17T10:22:24+08:00">2021-09-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h1><h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟中间件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Md</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, old_wsgi_app</span>):</span></span><br><span class="line">        self.old_wsgi_app = old_wsgi_app</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;开始之前&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        ret = self.old_wsgi_app(environ, start_response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;结束之后&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 1我们发现当执行app.run方法的时候，最终执行run_simple，最后执行app(),也就是在执行app.__call__方法</span></span><br><span class="line">    <span class="comment"># 2 在__call__里面，执行的是self.wsgi_app().那我们希望在执行他本身的wsgi之前做点事情。</span></span><br><span class="line">    <span class="comment"># 3 所以我们先用Md类中__init__，保存之前的wsgi,然后我们用将app.wsgi转化成Md的对象。</span></span><br><span class="line">    <span class="comment"># 4 那执行新的的app.wsgi_app，就是执行Md的__call__方法。</span></span><br><span class="line">    <span class="comment"># 把原来的wsgi_app替换为自定义的，</span></span><br><span class="line">    aaa=Md(app.wsgi_app)</span><br><span class="line">    app.wsgi_app = aaa</span><br><span class="line">    app.run()</span><br><span class="line">    <span class="comment"># flask请求来了会执行，执行app()---&gt;触发：类的__call__</span></span><br><span class="line">    <span class="comment"># app.__call__----&gt;self.wsgi_app(environ, start_response)</span></span><br><span class="line">    <span class="comment"># 请求来了以后，会执行Md对象的__call__</span></span><br><span class="line">    <span class="comment"># aaa(environ, start_response)---&gt;Md类的__call__()</span></span><br></pre></td></tr></table></figure>

<h2 id="蓝图"><a href="#蓝图" class="headerlink" title="蓝图"></a>蓝图</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 是一个类的对象，用来划分项目目录，为了避免使用app划分目录的时候出现循环导入问题</span><br><span class="line"><span class="number">2</span> 使用步骤</span><br><span class="line">	-实例化得到一个蓝图对象</span><br><span class="line">        <span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line">        account = Blueprint(<span class="string">&#x27;account&#x27;</span>, __name__)</span><br><span class="line">    -像使用app一样使用蓝图，注册路由</span><br><span class="line"><span class="meta">    	@account.route(<span class="params"><span class="string">&#x27;/login.html&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    -在app中注册蓝图</span><br><span class="line">    	<span class="keyword">from</span> .views.account <span class="keyword">import</span> account</span><br><span class="line">    	app.register_blueprint(account)</span><br><span class="line">        </span><br><span class="line"><span class="number">3</span> 注意点：</span><br><span class="line">	<span class="number">1</span> 蓝图注册进app时，指定前缀（类似于路由分发）</span><br><span class="line">    	app.register_blueprint(admin, url_prefix=<span class="string">&#x27;/admin&#x27;</span>)</span><br><span class="line">    <span class="number">2</span> 蓝图对象在实例化的时候，可以指定当前蓝图使用哪个模板文件夹和静态文件夹</span><br><span class="line">    如果不指定，默认用app的，查找顺序是先从自己里面找，找不到再找app的</span><br><span class="line">    	web = Blueprint(<span class="string">&#x27;web&#x27;</span>,__name__,template_folder=<span class="string">&#x27;templates&#x27;</span>,static_folder=<span class="string">&#x27;static&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="number">3</span> 蓝图对象有自己的请求扩展，请求扩展只属于当前蓝图</span><br><span class="line">    <span class="comment"># 只有访问当前蓝图管理的路径才会触发请求扩展</span></span><br><span class="line">    web = Blueprint(<span class="string">&#x27;web&#x27;</span>, __name__,template_folder=<span class="string">&#x27;templates&#x27;</span>,static_folder=<span class="string">&#x27;static&#x27;</span>)</span><br><span class="line"><span class="meta">    @web.before_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">web_request</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;web request&#x27;</span>)</span><br><span class="line"><span class="meta">    @web.after_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">web_after</span>(<span class="params">response</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<h2 id="flask请求上下文"><a href="#flask请求上下文" class="headerlink" title="flask请求上下文"></a>flask请求上下文</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 当flask启动，等待客户端请求</span><br><span class="line"><span class="number">2</span> 一旦请求来了：app()---&gt;app.__call__()----&gt;app.wsgi_app()</span><br><span class="line"><span class="number">3</span> wsgi_app()源码如下：</span><br><span class="line">    <span class="comment"># environ：http请求字典</span></span><br><span class="line">    <span class="comment"># 返回一个ctx=RequestContext,对象中有Request对象，Session对象。。。</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 把ctx对象放到了全局变量_request_ctx_stack中</span></span><br><span class="line">                <span class="comment"># _request_ctx_stack全局变量是LocalStack的对象</span></span><br><span class="line">                <span class="comment"># LocalStack类的push方法</span></span><br><span class="line">                <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        def push(self, obj):</span></span><br><span class="line"><span class="string">                            rv = getattr(self._local, &quot;stack&quot;, None)</span></span><br><span class="line"><span class="string">                            if rv is None:</span></span><br><span class="line"><span class="string">                                self._local.stack = rv = []</span></span><br><span class="line"><span class="string">                            rv.append(obj)</span></span><br><span class="line"><span class="string">                            return rvbefore_first_request,before_request,after_request</span></span><br><span class="line"><span class="string">                        &#x27;&#x27;&#x27;</span></span><br><span class="line">                ctx.push()</span><br><span class="line">                <span class="comment"># 执行请求扩展的东西（before_first_request,before_request,after_request）</span></span><br><span class="line">                <span class="comment"># 根据路径执行视图函数</span></span><br><span class="line">                response = self.full_dispatch_request()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                error = e</span><br><span class="line">                response = self.handle_exception(e)</span><br><span class="line">                <span class="keyword">except</span>: </span><br><span class="line">                    error = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">                    <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                 <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">                      error = <span class="literal">None</span></span><br><span class="line">                      ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>

<h2 id="requirements-txt"><a href="#requirements-txt" class="headerlink" title="requirements.txt"></a>requirements.txt</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 在虚拟环境中直接导出</span><br><span class="line">	pip3 freeze &gt;requirements.txt</span><br><span class="line"><span class="number">2</span> 系统环境装了很多模块，只导出当前项目依赖的模块</span><br><span class="line">	-pip3 install pipreqs</span><br><span class="line">    -pipreqs ./ --encoding=utf8</span><br></pre></td></tr></table></figure>

<h2 id="方法和函数的区别"><a href="#方法和函数的区别" class="headerlink" title="方法和函数的区别"></a>方法和函数的区别</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> MethodType,FunctionType</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(isinstance(Foo.fetch,MethodType))</span></span><br><span class="line"><span class="comment"># print(isinstance(Foo.fetch,FunctionType)) # True</span></span><br><span class="line"></span><br><span class="line">obj = Foo()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(obj.fetch,MethodType)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(obj.fetch,FunctionType))</span><br><span class="line"></span><br><span class="line">函数和方法的区别是在于传值</span><br></pre></td></tr></table></figure>

<h2 id="threading-local"><a href="#threading-local" class="headerlink" title="threading.local"></a>threading.local</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 不用local,会出现并发安全的问题</span></span><br><span class="line"><span class="comment"># from threading import Thread</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># lqz = -1</span></span><br><span class="line"><span class="comment"># def task(arg):</span></span><br><span class="line"><span class="comment">#     global lqz</span></span><br><span class="line"><span class="comment">#     lqz = arg</span></span><br><span class="line"><span class="comment">#     # time.sleep(2)</span></span><br><span class="line"><span class="comment">#     print(lqz)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     t = Thread(target=task,args=(i,))</span></span><br><span class="line"><span class="comment">#     t.start()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用local</span></span><br><span class="line"><span class="comment"># from threading import Thread</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> local</span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># from threading import get_ident</span></span><br><span class="line"><span class="comment"># # 特殊的对象，不同线程操作它，操作的是线程自己的，不会出现并发安全问题</span></span><br><span class="line"><span class="comment"># lqz = local()</span></span><br><span class="line"><span class="comment"># def task(arg):</span></span><br><span class="line"><span class="comment">#     # 对象.val = 1/2/3/4/5</span></span><br><span class="line"><span class="comment">#     lqz.value = arg</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#     print(lqz.value)</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     t = Thread(target=task,args=(i,))</span></span><br><span class="line"><span class="comment">#     t.start()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己写个local对象（low版本）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># from threading import get_ident,Thread</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># storage = &#123;&#125;</span></span><br><span class="line"><span class="comment"># # &#123;线程id号1:&#123;key:value&#125;,线程id号2:&#123;key:value&#125;,线程id号3:&#123;key:value&#125;&#125;</span></span><br><span class="line"><span class="comment"># def set(k,v):</span></span><br><span class="line"><span class="comment">#     ident = get_ident() # 获取线程id号</span></span><br><span class="line"><span class="comment">#     if ident in storage:</span></span><br><span class="line"><span class="comment">#         storage[ident][k] = v</span></span><br><span class="line"><span class="comment">#     else:</span></span><br><span class="line"><span class="comment">#         storage[ident] = &#123;k:v&#125;</span></span><br><span class="line"><span class="comment"># def get(k):</span></span><br><span class="line"><span class="comment">#     ident = get_ident()</span></span><br><span class="line"><span class="comment">#     return storage[ident][k]</span></span><br><span class="line"><span class="comment"># def task(arg):</span></span><br><span class="line"><span class="comment">#     set(&#x27;val&#x27;,arg)</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#     v = get(&#x27;val&#x27;)</span></span><br><span class="line"><span class="comment">#     print(v)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     t = Thread(target=task,args=(i,))</span></span><br><span class="line"><span class="comment">#     t.start()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 面向对象版本</span></span><br><span class="line"><span class="comment"># from threading import get_ident,Thread</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># class Local(object):</span></span><br><span class="line"><span class="comment">#     storage = &#123;&#125;</span></span><br><span class="line"><span class="comment">#     # &#123;线程id号1: &#123;key: value&#125;, 线程id号2: &#123;key: value&#125;, 线程id号3: &#123;key: value&#125;&#125;</span></span><br><span class="line"><span class="comment">#     def set(self, k, v):</span></span><br><span class="line"><span class="comment">#         ident = get_ident()</span></span><br><span class="line"><span class="comment">#         if ident in Local.storage:</span></span><br><span class="line"><span class="comment">#             Local.storage[ident][k] = v</span></span><br><span class="line"><span class="comment">#         else:</span></span><br><span class="line"><span class="comment">#             Local.storage[ident] = &#123;k: v&#125;</span></span><br><span class="line"><span class="comment">#     def get(self, k):</span></span><br><span class="line"><span class="comment">#         ident = get_ident()</span></span><br><span class="line"><span class="comment">#         return Local.storage[ident][k]</span></span><br><span class="line"><span class="comment"># obj = Local()</span></span><br><span class="line"><span class="comment"># def task(arg):</span></span><br><span class="line"><span class="comment">#     obj.set(&#x27;val&#x27;,arg)</span></span><br><span class="line"><span class="comment">#     v = obj.get(&#x27;val&#x27;)</span></span><br><span class="line"><span class="comment">#     print(v)</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     t = Thread(target=task,args=(i,))</span></span><br><span class="line"><span class="comment">#     t.start()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 面向对象版本，通过.取值，赋值</span></span><br><span class="line"><span class="comment"># from threading import get_ident,Thread</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># class Local(object):</span></span><br><span class="line"><span class="comment">#     storage = &#123;&#125;</span></span><br><span class="line"><span class="comment">#     ## &#123;线程id号1: &#123;key: value&#125;, 线程id号2: &#123;key: value&#125;, 线程id号3: &#123;key: value&#125;&#125;</span></span><br><span class="line"><span class="comment">#     def __setattr__(self, k, v):</span></span><br><span class="line"><span class="comment">#         ident = get_ident()</span></span><br><span class="line"><span class="comment">#         if ident in Local.storage:</span></span><br><span class="line"><span class="comment">#             Local.storage[ident][k] = v</span></span><br><span class="line"><span class="comment">#         else:</span></span><br><span class="line"><span class="comment">#             Local.storage[ident] = &#123;k: v&#125;</span></span><br><span class="line"><span class="comment">#     def __getattr__(self, k):</span></span><br><span class="line"><span class="comment">#         ident = get_ident()</span></span><br><span class="line"><span class="comment">#         return Local.storage[ident][k]</span></span><br><span class="line"><span class="comment"># obj = Local()</span></span><br><span class="line"><span class="comment"># obj2 = Local() # 所有的local对象用的是同一个字典，不好</span></span><br><span class="line"><span class="comment"># def task(arg):</span></span><br><span class="line"><span class="comment">#     obj.val = arg</span></span><br><span class="line"><span class="comment">#     print(obj.val)</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     t = Thread(target=task,args=(i,))</span></span><br><span class="line"><span class="comment">#     t.start()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同local对象，使用自己的字典</span></span><br><span class="line"><span class="comment"># from threading import get_ident,Thread</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># class Local(object):</span></span><br><span class="line"><span class="comment">#     def __init__(self):</span></span><br><span class="line"><span class="comment">#         # self.storage=&#123;&#125;  递归</span></span><br><span class="line"><span class="comment">#         # setattr(self,&#x27;storage&#x27;,&#123;&#125;) 递归</span></span><br><span class="line"><span class="comment">#         #Local.__setattr__(self,&#x27;storage&#x27;,&#123;&#125;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         object.__setattr__(self,&#x27;storage&#x27;,&#123;&#125;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     def __setattr__(self, k, v):</span></span><br><span class="line"><span class="comment">#         ident = get_ident()</span></span><br><span class="line"><span class="comment">#         if ident in self.storage:</span></span><br><span class="line"><span class="comment">#             self.storage[ident][k] = v</span></span><br><span class="line"><span class="comment">#         else:</span></span><br><span class="line"><span class="comment">#             self.storage[ident] = &#123;k: v&#125;</span></span><br><span class="line"><span class="comment">#     def __getattr__(self, k):</span></span><br><span class="line"><span class="comment">#         ident = get_ident()</span></span><br><span class="line"><span class="comment">#         return self.storage[ident][k]</span></span><br><span class="line"><span class="comment"># obj = Local()</span></span><br><span class="line"><span class="comment"># def task(arg):</span></span><br><span class="line"><span class="comment">#     obj.val = arg</span></span><br><span class="line"><span class="comment">#     # obj.xxx = arg</span></span><br><span class="line"><span class="comment">#     time.sleep(1)</span></span><br><span class="line"><span class="comment">#     print(obj.val)</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     t = Thread(target=task,args=(i,))</span></span><br><span class="line"><span class="comment">#     t.start()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多线程下可以使用，一旦加入协程，就不行了</span></span><br><span class="line"><span class="comment"># 自定义一个兼容线程和协程的local对象</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">from</span> threading <span class="keyword">import</span> get_ident</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self,<span class="string">&#x27;storage&#x27;</span>,&#123;&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span>(<span class="params">self, k, v</span>):</span></span><br><span class="line">        ident = get_ident()</span><br><span class="line">        <span class="keyword">if</span> ident <span class="keyword">in</span> self.storage:</span><br><span class="line">            self.storage[ident][k] = v</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.storage[ident] = &#123;k: v&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># try:</span></span><br><span class="line">        <span class="comment">#     storage[ident][name] = value</span></span><br><span class="line">        <span class="comment"># except KeyError:</span></span><br><span class="line">        <span class="comment">#     storage[ident] = &#123;name: value&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, k</span>):</span></span><br><span class="line">        ident = get_ident()</span><br><span class="line">        <span class="keyword">return</span> self.storage[ident][k]</span><br><span class="line">obj = Local()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span>(<span class="params">arg</span>):</span></span><br><span class="line">    obj.val = arg</span><br><span class="line">    <span class="comment"># obj.xxx = arg</span></span><br><span class="line">    <span class="built_in">print</span>(obj.storage)</span><br><span class="line">    <span class="built_in">print</span>(obj.val)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    t = Thread(target=task,args=(i,))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>

<h2 id="偏函数"><a href="#偏函数" class="headerlink" title="偏函数"></a>偏函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial  <span class="comment"># 偏函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a,b,c</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a+b+c</span><br><span class="line"></span><br><span class="line">add=partial(add,<span class="number">2</span>) <span class="comment"># add是一个偏函数了，提前传值</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add)</span><br><span class="line"><span class="comment"># print(add(3,4))</span></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>))</span><br><span class="line"><span class="comment"># print(add(2,3,4))</span></span><br></pre></td></tr></table></figure>

<h2 id="flask上下文源码分析"><a href="#flask上下文源码分析" class="headerlink" title="flask上下文源码分析"></a>flask上下文源码分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">请求上下文执行流程（ctx）：</span><br><span class="line">		-<span class="number">0</span> flask项目一启动，有<span class="number">6</span>个全局变量</span><br><span class="line">			-_request_ctx_stack：LocalStack对象</span><br><span class="line">			-_app_ctx_stack ：LocalStack对象</span><br><span class="line">			-request ： LocalProxy对象</span><br><span class="line">			-session ： LocalProxy对象</span><br><span class="line">		-<span class="number">1</span> 请求来了 app.__call__()----&gt;内部执行：self.wsgi_app(environ, start_response)</span><br><span class="line">		-<span class="number">2</span> wsgi_app()</span><br><span class="line">			-<span class="number">2.1</span> 执行：ctx = self.request_context(environ)：返回一个RequestContext对象，并且封装了request(当次请求的request对象)，session</span><br><span class="line">			-<span class="number">2.2</span> 执行： ctx.push()：RequestContext对象的push方法</span><br><span class="line">				-<span class="number">2.2</span><span class="number">.1</span> push方法中中间位置有：_request_ctx_stack.push(self)，self是ctx对象</span><br><span class="line">				-<span class="number">2.2</span><span class="number">.2</span> 去_request_ctx_stack对象的类中找push方法（LocalStack中找push方法）</span><br><span class="line">				-<span class="number">2.2</span><span class="number">.3</span> push方法源码：</span><br><span class="line">				    <span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">						<span class="comment">#通过反射找self._local,在init实例化的时候生成的：self._local = Local()</span></span><br><span class="line">						<span class="comment">#Local()flask封装的支持线程和协程的local对象</span></span><br><span class="line">						<span class="comment"># 一开始取不到stack，返回None</span></span><br><span class="line">						rv = <span class="built_in">getattr</span>(self._local, <span class="string">&quot;stack&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">						<span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">							<span class="comment">#走到这，self._local.stack=[],rv=self._local.stack</span></span><br><span class="line">							self._local.stack = rv = []</span><br><span class="line">						<span class="comment"># 把ctx放到了列表中</span></span><br><span class="line">						<span class="comment">#self._local=&#123;&#x27;线程id1&#x27;:&#123;&#x27;stack&#x27;:[ctx,]&#125;,&#x27;线程id2&#x27;:&#123;&#x27;stack&#x27;:[ctx,]&#125;,&#x27;线程id3&#x27;:&#123;&#x27;stack&#x27;:[ctx,]&#125;&#125;</span></span><br><span class="line">						rv.append(obj)</span><br><span class="line">						<span class="keyword">return</span> rv</span><br><span class="line">		-<span class="number">3</span> 如果在视图函数中使用request对象，比如：<span class="built_in">print</span>(request)</span><br><span class="line">			-<span class="number">3.1</span> 会调用request对象的__str__方法，request类是：LocalProxy</span><br><span class="line">			-<span class="number">3.2</span> LocalProxy中的__str__方法：<span class="keyword">lambda</span> x: <span class="built_in">str</span>(x._get_current_object())</span><br><span class="line">				-<span class="number">3.2</span><span class="number">.1</span> 内部执行self._get_current_object()</span><br><span class="line">				-<span class="number">3.2</span><span class="number">.2</span> _get_current_object()方法的源码如下：</span><br><span class="line">				    <span class="function"><span class="keyword">def</span> <span class="title">_get_current_object</span>(<span class="params">self</span>):</span></span><br><span class="line">						<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self.__local, <span class="string">&quot;__release_local__&quot;</span>):</span><br><span class="line">							<span class="comment">#self.__local()  在init的时候，实例化的，在init中：object.__setattr__(self, &quot;_LocalProxy__local&quot;, local)</span></span><br><span class="line">							<span class="comment"># 用了隐藏属性</span></span><br><span class="line">							<span class="comment">#self.__local 实例化该类的时候传入的local（偏函数的内存地址：partial(_lookup_req_object, &quot;request&quot;)）</span></span><br><span class="line">							<span class="comment">#加括号返回，就会执行偏函数，也就是执行_lookup_req_object，不需要传参数了</span></span><br><span class="line">							<span class="comment">#这个地方的返回值就是request对象(当此请求的request，没有乱)</span></span><br><span class="line">							<span class="keyword">return</span> self.__local()</span><br><span class="line">						<span class="keyword">try</span>:</span><br><span class="line">							<span class="keyword">return</span> <span class="built_in">getattr</span>(self.__local, self.__name__)</span><br><span class="line">						<span class="keyword">except</span> AttributeError:</span><br><span class="line">							<span class="keyword">raise</span> RuntimeError(<span class="string">&quot;no object bound to %s&quot;</span> % self.__name__)</span><br><span class="line">				-<span class="number">3.2</span><span class="number">.3</span> _lookup_req_object函数源码如下：</span><br><span class="line">					<span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span>(<span class="params">name</span>):</span></span><br><span class="line">						<span class="comment">#name是&#x27;request&#x27;字符串</span></span><br><span class="line">						<span class="comment">#top方法是把第二步中放入的ctx取出来，因为都在一个线程内，当前取到的就是当次请求的ctx对象</span></span><br><span class="line">						top = _request_ctx_stack.top</span><br><span class="line">						<span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">							<span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</span><br><span class="line">						<span class="comment">#通过反射，去ctx中把request对象返回</span></span><br><span class="line">						<span class="keyword">return</span> <span class="built_in">getattr</span>(top, name)</span><br><span class="line">				-<span class="number">3.2</span><span class="number">.4</span> 所以：<span class="built_in">print</span>(request) 实质上是在打印当此请求的request对象的__str__</span><br><span class="line">		-<span class="number">4</span> 如果在视图函数中使用request对象，比如：<span class="built_in">print</span>(request.method):实质上是取到当次请求的reuquest对象的method属性</span><br><span class="line">		</span><br><span class="line">		-<span class="number">5</span> 最终，请求结束执行： ctx.auto_pop(error)，把ctx移除掉</span><br><span class="line">		</span><br><span class="line">	其他的东西：</span><br><span class="line">		-session:</span><br><span class="line">			-请求来了opensession</span><br><span class="line">				-ctx.push()----&gt;也就是RequestContext类的push方法的最后的地方：</span><br><span class="line">					<span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">						<span class="comment">#self是ctx，ctx中有个app就是flask对象，   self.app.session_interface也就是它：SecureCookieSessionInterface()</span></span><br><span class="line">						session_interface = self.app.session_interface</span><br><span class="line">						self.session = session_interface.open_session(self.app, self.request)</span><br><span class="line">						<span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">							<span class="comment">#经过上面还是None的话，生成了个空session</span></span><br><span class="line">							self.session = session_interface.make_null_session(self.app)</span><br><span class="line">			-请求走了savesession</span><br><span class="line">				-response = self.full_dispatch_request() 方法内部：执行了before_first_request，before_request，视图函数，after_request，savesession</span><br><span class="line">				-self.full_dispatch_request()----&gt;执行：self.finalize_request(rv)-----》self.process_response(response)----》最后：self.session_interface.save_session(self, ctx.session, response)</span><br><span class="line">		-请求扩展相关</span><br><span class="line">			before_first_request，before_request，after_request依次执行</span><br><span class="line">		-flask有一个请求上下文，一个应用上下文</span><br><span class="line">			-ctx:</span><br><span class="line">				-是：RequestContext对象:封装了request和session</span><br><span class="line">				-调用了：_request_ctx_stack.push(self)就是把：ctx放到了那个位置</span><br><span class="line">			-app_ctx:</span><br><span class="line">				-是：AppContext(self) 对象：封装了当前的app和g</span><br><span class="line">				-调用 _app_ctx_stack.push(self) 就是把：app_ctx放到了那个位置</span><br><span class="line">	-g是个什么鬼？</span><br><span class="line">		专门用来存储用户信息的g对象，g的全称的为<span class="keyword">global</span> </span><br><span class="line">		g对象在一次请求中的所有的代码的地方，都是可以使用的 </span><br><span class="line">	</span><br><span class="line">    -g对象和session的区别</span><br><span class="line">        g对象只对当次请求有效（当此请求内有效）</span><br><span class="line">        session：可以跨请求，该用户的多次请求中都可以使用</span><br><span class="line">		</span><br><span class="line">	-代理模式</span><br><span class="line">		-request和session就是代理对象，用的就是代理模式</span><br></pre></td></tr></table></figure>

<h2 id="flask-session的使用"><a href="#flask-session的使用" class="headerlink" title="flask-session的使用"></a>flask-session的使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 由于原生的flask中session是加密后放到了cookie中</span><br><span class="line"><span class="number">2</span> 我们想保存到文件中，数据库中，redis（比较多）。。。</span><br><span class="line"><span class="number">3</span> 借助于第三方：flask-session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 第一种使用方式</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> RedisSessionInterface</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不需要指定</span></span><br><span class="line"><span class="comment"># app.secret_key = &#x27;dafasdf&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># conn=Redis(host=&#x27;127.0.0.1&#x27;,port=6379)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># app.session_interface=RedisSessionInterface(conn,key_prefix=&#x27;lqz&#x27;)</span></span><br><span class="line"><span class="comment"># @app.route(&#x27;/set_session&#x27;)</span></span><br><span class="line"><span class="comment"># def set_session():</span></span><br><span class="line"><span class="comment">#     session[&#x27;name&#x27;]=&#x27;lqz&#x27;</span></span><br><span class="line"><span class="comment">#     return &#x27;session写入了，写了name=lqz&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># @app.route(&#x27;/get_session&#x27;)</span></span><br><span class="line"><span class="comment"># def get_session():</span></span><br><span class="line"><span class="comment">#     # s=session[&#x27;name&#x27;]</span></span><br><span class="line"><span class="comment">#     s=session.get(&#x27;name&#x27;,&#x27;取不到&#x27;)</span></span><br><span class="line"><span class="comment">#     return &#x27;获取到的session是&#x27;+s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二</span></span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式一</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_TYPE&#x27;</span>] = <span class="string">&#x27;redis&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_REDIS&#x27;</span>] = Redis(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="string">&#x27;6379&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SESSION_KEY_PREFIX&#x27;</span>] = <span class="string">&#x27;lhj&#x27;</span></span><br><span class="line">app.secret_key = <span class="string">&#x27;dafasdf&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/set_session&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_session</span>():</span></span><br><span class="line">    session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;lhj&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;session写入了，写了name=lhj&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/get_session&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_session</span>():</span></span><br><span class="line">    <span class="comment"># s=session[&#x27;name&#x27;]</span></span><br><span class="line">    s = session.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;取不到&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;获取到的session是&#x27;</span> + s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二</span></span><br><span class="line"><span class="comment"># app.config.from_object(&#x27;settings.Pro&#x27;)</span></span><br><span class="line"><span class="comment"># 使用第三方插件，是一个通用方式</span></span><br><span class="line">Session(app)  <span class="comment"># 本质跟上面一样，只不过通过配置文件来处理，好处是后期只改配置文件，即可完成配置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/liuqingzheng/articles/<span class="number">9006055.</span>html</span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一种方案，全局使用沟通一个curser会存在效率问题，安全性问题</span></span><br><span class="line"><span class="comment"># conn = pymysql.Connect(host=&#x27;127.0.0.1&#x27;, user=&#x27;root&#x27;, password=&quot;1018&quot;, database=&#x27;luffy&#x27;, port=3306)</span></span><br><span class="line"><span class="comment"># cursor = conn.cursor()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/get_data&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    <span class="comment"># 第二种：不限制数据库的连接数，会导致连接数暴增</span></span><br><span class="line">    conn = pymysql.Connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&quot;1018&quot;</span>, database=<span class="string">&#x27;luffy&#x27;</span>, port=<span class="number">3306</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">&#x27;select * from luffy_banner&#x27;</span>)</span><br><span class="line">    res = cursor.fetchall()</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    cursor.close()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;数据查回&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用数据库链接池</span></span><br><span class="line"><span class="number">1.</span> sql_pool.py</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> dbutils.pooled_db <span class="keyword">import</span> PooledDB</span><br><span class="line">POOL = PooledDB(</span><br><span class="line">    creator=pymysql,  <span class="comment"># 使用链接数据库的模块</span></span><br><span class="line">    maxconnections=<span class="number">6</span>,  <span class="comment"># 连接池允许的最大连接数，0和None表示不限制连接数</span></span><br><span class="line">    mincached=<span class="number">2</span>,  <span class="comment"># 初始化时，链接池中至少创建的空闲的链接，0表示不创建</span></span><br><span class="line">    maxcached=<span class="number">5</span>,  <span class="comment"># 链接池中最多闲置的链接，0和None不限制</span></span><br><span class="line">    maxshared=<span class="number">3</span>,  <span class="comment"># 链接池中最多共享的链接数量，0和None表示全部共享。PS: 无用，因为pymysql和MySQLdb等模块的 threadsafety都为1，所有值无论设置为多少，_maxcached永远为0，所以永远是所有链接都共享。</span></span><br><span class="line">    blocking=<span class="literal">True</span>,  <span class="comment"># 连接池中如果没有可用连接后，是否阻塞等待。True，等待；False，不等待然后报错</span></span><br><span class="line">    maxusage=<span class="literal">None</span>,  <span class="comment"># 一个链接最多被重复使用的次数，None表示无限制</span></span><br><span class="line">    setsession=[],  <span class="comment"># 开始会话前执行的命令列表。</span></span><br><span class="line">    ping=<span class="number">0</span>,</span><br><span class="line">    <span class="comment"># ping MySQL服务端，检查是否服务可用。</span></span><br><span class="line">    host=<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    port=<span class="number">3306</span>,</span><br><span class="line">    user=<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    password=<span class="string">&#x27;1018&#x27;</span>,</span><br><span class="line">    database=<span class="string">&#x27;luffy&#x27;</span>,</span><br><span class="line">    charset=<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> </span><br><span class="line"><span class="keyword">from</span> sql_pool <span class="keyword">import</span> POOL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/pool&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pool</span>():</span></span><br><span class="line">    conn = POOL.connection()  <span class="comment"># 从连接池种取一个链接（如果没有，阻塞在这）</span></span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">&#x27;select * from luffy_order&#x27;</span>)</span><br><span class="line">    res = cursor.fetchall()</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    cursor.close()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;数据查回&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="flask-script"><a href="#flask-script" class="headerlink" title="flask-script"></a>flask-script</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> django 运行项目  python manage.py runserver </span><br><span class="line"><span class="number">2</span> 借助于flask-script可以子定制命令</span><br><span class="line">	pip3 install flask-script</span><br><span class="line">    </span><br><span class="line"><span class="number">3</span> 使用</span><br><span class="line">	-自带一个runserver</span><br><span class="line">    -自定制命令</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">manager=Manager(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己定制命令</span></span><br><span class="line"><span class="meta">@manager.command</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom</span>(<span class="params">arg</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义命令</span></span><br><span class="line"><span class="string">    python manage.py custom 123</span></span><br><span class="line"><span class="string">    :param arg:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@manager.option(<span class="params"><span class="string">&#x27;-n&#x27;</span>, <span class="string">&#x27;--name&#x27;</span>, dest=<span class="string">&#x27;name&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@manager.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, dest=<span class="string">&#x27;url&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">name, url</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义命令（-n也可以写成--name）</span></span><br><span class="line"><span class="string">    执行： python manage.py  cmd -n lqz -u http://www.oldboyedu.com</span></span><br><span class="line"><span class="string">    执行： python manage.py  cmd --name lqz --url http://www.oldboyedu.com</span></span><br><span class="line"><span class="string">    :param name:</span></span><br><span class="line"><span class="string">    :param url:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(name, url)</span><br><span class="line"><span class="comment">#有什么用？</span></span><br><span class="line"><span class="comment">#把excel的数据导入数据库，定制个命令，去执行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;首页&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    manager.run()</span><br><span class="line"><span class="comment">#以后在执行，直接：python3 manage.py runserver</span></span><br><span class="line"><span class="comment">#python3 manage.py runserver --help</span></span><br></pre></td></tr></table></figure>

<h2 id="wtforms"><a href="#wtforms" class="headerlink" title="wtforms"></a>wtforms</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 install wtforms </span><br><span class="line">要使用邮箱认证，还需要装一个模块：pip3 install email-validator</span><br><span class="line">等同于django中的forms，做数据验证，模板的渲染</span><br></pre></td></tr></table></figure>

<ul>
<li>基本使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> simple</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> validators</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> widgets</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&#x27;templates&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    <span class="comment"># 字段（内部包含正则表达式）</span></span><br><span class="line">    name = simple.StringField(</span><br><span class="line">        label=<span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">&#x27;用户名不能为空.&#x27;</span>),</span><br><span class="line">            validators.Length(<span class="built_in">min</span>=<span class="number">6</span>, <span class="built_in">max</span>=<span class="number">18</span>, message=<span class="string">&#x27;用户名长度必须大于6且小于18&#x27;</span>)</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.TextInput(), <span class="comment"># 页面上显示的插件</span></span><br><span class="line">        render_kw=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 字段（内部包含正则表达式）</span></span><br><span class="line">    pwd = simple.PasswordField(</span><br><span class="line">        label=<span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">&#x27;密码不能为空.&#x27;</span>),</span><br><span class="line">            validators.Length(<span class="built_in">min</span>=<span class="number">8</span>, message=<span class="string">&#x27;用户名长度必须大于%(min)d&#x27;</span>),</span><br><span class="line">            validators.Regexp(regex=<span class="string">&quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&amp;])[A-Za-z\d$@$!%*?&amp;]&#123;8,&#125;&quot;</span>,</span><br><span class="line">                              message=<span class="string">&#x27;密码至少8个字符，至少1个大写字母，1个小写字母，1个数字和1个特殊字符&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        form = LoginForm()</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, form=form)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = LoginForm(formdata=request.form)</span><br><span class="line">        <span class="keyword">if</span> form.validate():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;用户提交数据通过格式验证，提交的值为：&#x27;</span>, form.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(form.errors)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, form=form)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(port=<span class="number">5555</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;form.name.label&#125;&#125; &#123;&#123;form.name&#125;&#125; &#123;&#123;form.name.errors[0] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;form.pwd.label&#125;&#125; &#123;&#123;form.pwd&#125;&#125; &#123;&#123;form.pwd.errors[0] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>更多使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> core</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> html5</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> simple</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> validators</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> widgets</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&#x27;templates&#x27;</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    name = simple.StringField(</span><br><span class="line">        label=<span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired()</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.TextInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;,</span><br><span class="line">        default=<span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    pwd = simple.PasswordField(</span><br><span class="line">        label=<span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">&#x27;密码不能为空.&#x27;</span>)</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    pwd_confirm = simple.PasswordField(</span><br><span class="line">        label=<span class="string">&#x27;重复密码&#x27;</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">&#x27;重复密码不能为空.&#x27;</span>),</span><br><span class="line">            validators.EqualTo(<span class="string">&#x27;pwd&#x27;</span>, message=<span class="string">&quot;两次密码输入不一致&quot;</span>)</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    email = html5.EmailField(</span><br><span class="line">        label=<span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">&#x27;邮箱不能为空.&#x27;</span>),</span><br><span class="line">            validators.Email(message=<span class="string">&#x27;邮箱格式错误&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.TextInput(input_type=<span class="string">&#x27;email&#x27;</span>),</span><br><span class="line">        render_kw=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    gender = core.RadioField(</span><br><span class="line">        label=<span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="number">1</span>, <span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">        coerce=<span class="built_in">int</span> <span class="comment"># “1” “2”</span></span><br><span class="line">     )</span><br><span class="line">    city = core.SelectField(</span><br><span class="line">        label=<span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="string">&#x27;bj&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>),</span><br><span class="line">            (<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>),</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    hobby = core.SelectMultipleField(</span><br><span class="line">        label=<span class="string">&#x27;爱好&#x27;</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="number">1</span>, <span class="string">&#x27;篮球&#x27;</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">&#x27;足球&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">        coerce=<span class="built_in">int</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    favor = core.SelectMultipleField(</span><br><span class="line">        label=<span class="string">&#x27;喜好&#x27;</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="number">1</span>, <span class="string">&#x27;篮球&#x27;</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">&#x27;足球&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">        widget=widgets.ListWidget(prefix_label=<span class="literal">False</span>),</span><br><span class="line">        option_widget=widgets.CheckboxInput(),</span><br><span class="line">        coerce=<span class="built_in">int</span>,</span><br><span class="line">        default=[<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(RegisterForm, self).__init__(*args, **kwargs)</span><br><span class="line">        self.favor.choices = ((<span class="number">1</span>, <span class="string">&#x27;篮球&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;足球&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;羽毛球&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_pwd_confirm</span>(<span class="params">self, field</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        自定义pwd_confirm字段规则，例：与pwd字段是否一致</span></span><br><span class="line"><span class="string">        :param field:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 最开始初始化时，self.data中已经有所有的值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> field.data != self.data[<span class="string">&#x27;pwd&#x27;</span>]:</span><br><span class="line">            <span class="comment"># raise validators.ValidationError(&quot;密码不一致&quot;) # 继续后续验证</span></span><br><span class="line">            <span class="keyword">raise</span> validators.StopValidation(<span class="string">&quot;密码不一致&quot;</span>)  <span class="comment"># 不再继续后续验证</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        form = RegisterForm(data=&#123;<span class="string">&#x27;gender&#x27;</span>: <span class="number">2</span>,<span class="string">&#x27;hobby&#x27;</span>:[<span class="number">1</span>,<span class="number">2</span>]&#125;) <span class="comment"># initial</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, form=form)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = RegisterForm(formdata=request.form)</span><br><span class="line">        <span class="keyword">if</span> form.validate():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;用户提交数据通过格式验证，提交的值为：&#x27;</span>, form.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(form.errors)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, form=form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(port=<span class="number">3322</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">novalidate</span> <span class="attr">style</span>=<span class="string">&quot;padding:0  50px&quot;</span>&gt;</span></span><br><span class="line">    &#123;% for field in form %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;field.label&#125;&#125;: &#123;&#123;field&#125;&#125; &#123;&#123;field.errors[0] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> pip3 install blinker</span><br><span class="line"><span class="number">1</span> 让开发者可是在请求过程中定制一些用户行为</span><br><span class="line"><span class="number">2</span> 内置信号</span><br><span class="line">内置信号：</span><br><span class="line">request_started = _signals.signal(<span class="string">&#x27;request-started&#x27;</span>)                <span class="comment"># 请求到来前执行</span></span><br><span class="line">request_finished = _signals.signal(<span class="string">&#x27;request-finished&#x27;</span>)              <span class="comment"># 请求结束后执行</span></span><br><span class="line"> </span><br><span class="line">before_render_template = _signals.signal(<span class="string">&#x27;before-render-template&#x27;</span>)  <span class="comment"># 模板渲染前执行</span></span><br><span class="line">template_rendered = _signals.signal(<span class="string">&#x27;template-rendered&#x27;</span>)            <span class="comment"># 模板渲染后执行</span></span><br><span class="line"> </span><br><span class="line">got_request_exception = _signals.signal(<span class="string">&#x27;got-request-exception&#x27;</span>)    <span class="comment"># 请求执行出现异常时执行</span></span><br><span class="line"> </span><br><span class="line">request_tearing_down = _signals.signal(<span class="string">&#x27;request-tearing-down&#x27;</span>)      <span class="comment"># 请求执行完毕后自动执行（无论成功与否）</span></span><br><span class="line">appcontext_tearing_down = _signals.signal(<span class="string">&#x27;appcontext-tearing-down&#x27;</span>)<span class="comment"># 应用上下文执行完毕后自动执行（无论成功与否）</span></span><br><span class="line"> </span><br><span class="line">appcontext_pushed = _signals.signal(<span class="string">&#x27;appcontext-pushed&#x27;</span>)            <span class="comment"># 应用上下文push时执行</span></span><br><span class="line">appcontext_popped = _signals.signal(<span class="string">&#x27;appcontext-popped&#x27;</span>)            <span class="comment"># 应用上下文pop时执行</span></span><br><span class="line">message_flashed = _signals.signal(<span class="string">&#x27;message-flashed&#x27;</span>)                <span class="comment"># 调用flask在其中添加数据时，自动触发</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 信号可以干什么</span><br><span class="line">	<span class="number">1</span> 记录日志（某个表新增了数据，记录日志，某个表删除了数据。。。）</span><br><span class="line">    <span class="number">2</span> 更新缓存（假设给article表数据加了缓存，一旦该表插入数据，一旦触发article表新增数据的信号，删除缓存，重新生成缓存（同步的话速度稍微慢一些，结合celery，异步生成缓存））</span><br><span class="line">    </span><br><span class="line"><span class="number">4</span> 内置信号的使用</span><br><span class="line">	-第一步：定义要给函数</span><br><span class="line">    -第二步：跟信号绑定</span><br><span class="line">    信号.connect(函数内存地址)</span><br><span class="line">    -第三步：触发信号（内置信号自动触发）信号.send(self)</span><br><span class="line">    </span><br><span class="line"><span class="number">5</span> 自定义信号</span><br><span class="line">	-第<span class="number">0</span>步：定义一个信号</span><br><span class="line">    -第一步：定义要给函数</span><br><span class="line">    -第二步：跟信号绑定</span><br><span class="line">    信号.connect(函数内存地址)</span><br><span class="line">    -第三步：触发信号（内置信号自动触发）信号.send(self)</span><br></pre></td></tr></table></figure>

<h3 id="内置信号"><a href="#内置信号" class="headerlink" title="内置信号"></a>内置信号</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, signals,render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内置信号使用</span></span><br><span class="line"><span class="comment"># 内置信号request_started = _signals.signal(&#x27;request-started&#x27;)                # 请求到来前执行</span></span><br><span class="line"><span class="comment"># 给它绑定一个函数执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一步：写好函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request_signal</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">    <span class="comment"># print(&#x27;请求来了，触发了这个信号&#x27;)</span></span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;模板渲染了，触发了这个信号&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：跟信号绑定</span></span><br><span class="line">signals.request_started.connect(before_request_signal)</span><br><span class="line"><span class="comment"># signals.request_finished.connect(before_request_signal)</span></span><br><span class="line"><span class="comment"># 模板渲染后</span></span><br><span class="line"><span class="comment"># signals.template_rendered.connect(before_request_signal)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三步：触发信号（不需要手动触发，请求走到这，就会触发）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="comment"># return &#x27;hello world&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="自定义信号"><a href="#自定义信号" class="headerlink" title="自定义信号"></a>自定义信号</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义信号</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, signals, render_template</span><br><span class="line"><span class="keyword">from</span> flask.signals <span class="keyword">import</span> _signals</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第0步：定义信号（定义了一个叫lqz的信号）</span></span><br><span class="line">lqz = _signals.signal(<span class="string">&#x27;lqz&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一步：写好函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request_signal</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;触发了自定义的lqz信号&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：跟自定义的信号绑定</span></span><br><span class="line">lqz.connect(before_request_signal)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三步：触发信号（自定义信号，要自己触发）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    res = render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    <span class="comment"># 在模板渲染之后，触发自定义的lqz信号</span></span><br><span class="line">    lqz.send(<span class="string">&#x27;sss&#x27;</span>,name=<span class="string">&#x27;lqz&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h2 id="多app应用（了解）"><a href="#多app应用（了解）" class="headerlink" title="多app应用（了解）"></a>多app应用（了解）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多app应用，在一个flask项目中，可以有多个app对象</span></span><br><span class="line"><span class="comment"># werkzeug：0.16.1 及之前版本</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> DispatcherMiddleware</span><br><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, current_app</span><br><span class="line"></span><br><span class="line">app1 = Flask(<span class="string">&#x27;app01&#x27;</span>)</span><br><span class="line">app2 = Flask(<span class="string">&#x27;app02&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app1.route(<span class="params"><span class="string">&#x27;/index&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;app01&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app2.route(<span class="params"><span class="string">&#x27;/index2&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;app2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dm = DispatcherMiddleware(app1, &#123;</span><br><span class="line">    <span class="string">&#x27;/pro&#x27;</span>: app2,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    run_simple(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5000</span>, dm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当请求来了：dm()---&gt;DispatcherMiddleware的__call__</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="SQLAlchemy"><a href="#SQLAlchemy" class="headerlink" title="SQLAlchemy"></a>SQLAlchemy</h2><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SQLAlchemy是一个基于Python实现的ORM框架。该框架建立在 DB API之上，使用关系对象映射进行数据库操作，简言之便是：将类和对象转换成SQL，然后使用数据API执行SQL并获取执行结果</span><br><span class="line"></span><br><span class="line">组成部分</span><br><span class="line">    Engine，框架的引擎</span><br><span class="line">    Connection Pooling ，数据库连接池</span><br><span class="line">    Dialect，选择连接数据库的DB API种类</span><br><span class="line">    Schema/Types，架构和类型</span><br><span class="line">    SQL Exprression Language，SQL表达式语言</span><br></pre></td></tr></table></figure>

<p>models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过类，创建表</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, relationship</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, ForeignKey, DateTime, UniqueConstraint, Index</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Users</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span>  <span class="comment"># 数据库表名称</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)  <span class="comment"># id 主键</span></span><br><span class="line">    name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">False</span>)  <span class="comment"># name列，索引，不可为空</span></span><br><span class="line">    <span class="comment"># email = Column(String(32), unique=True)</span></span><br><span class="line">    <span class="comment"># #datetime.datetime.now不能加括号，加了括号，以后永远是当前时间</span></span><br><span class="line">    <span class="comment"># ctime = Column(DateTime, default=datetime.datetime.now)</span></span><br><span class="line">    <span class="comment"># extra = Column(Text, nullable=True)</span></span><br><span class="line"></span><br><span class="line">    __table_args__ = (</span><br><span class="line">        <span class="comment"># UniqueConstraint(&#x27;id&#x27;, &#x27;name&#x27;, name=&#x27;uix_id_name&#x27;), #联合唯一</span></span><br><span class="line">        <span class="comment"># Index(&#x27;ix_id_name&#x27;, &#x27;name&#x27;, &#x27;email&#x27;), #索引</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一对多，一个爱好，可以有多个人喜欢，关联字段写在多的一方，写在Person中</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hobby</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;hobby&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    caption = Column(String(<span class="number">50</span>), default=<span class="string">&#x27;篮球&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;person&#x27;</span></span><br><span class="line">    nid = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># hobby指的是tablename而不是类名，uselist=False</span></span><br><span class="line">    <span class="comment"># 外键关联</span></span><br><span class="line">    <span class="comment"># hobby_id跟hobby表的id字段关联</span></span><br><span class="line">    hobby_id = Column(Integer, ForeignKey(<span class="string">&quot;hobby.id&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 跟数据库无关，不会新增字段，只用于快速链表操作</span></span><br><span class="line">    <span class="comment"># 类名，backref用于反向查询</span></span><br><span class="line">    hobby = relationship(<span class="string">&#x27;Hobby&#x27;</span>, backref=<span class="string">&#x27;pers&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把表同步到数据库</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据类创建数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">&quot;mysql+pymysql://root:1018@127.0.0.1:3306/aaa?charset=utf8&quot;</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=-<span class="number">1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 把所有别Base管理的表都创建出来</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_db</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据类创建数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">&quot;mysql+pymysql://root:1018@127.0.0.1:3306/aaa?charset=utf8&quot;</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=-<span class="number">1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 把所有别Base管理的表都删除</span></span><br><span class="line">    Base.metadata.drop_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    init_db()</span><br><span class="line">    <span class="comment"># drop_db()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>单表新增</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy_test.models <span class="keyword">import</span> Users</span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;mysql+pymysql://root@127.0.0.1:3306/aaa&quot;</span></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+pymysql://root:1018@127.0.0.1:3306/aaa&quot;</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Connection = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次执行数据库操作时，都需要创建一个Connection</span></span><br><span class="line">con = Connection()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ############# 执行ORM操作 #############</span></span><br><span class="line">obj1 = Users(name=<span class="string">&quot;lqz&quot;</span>)</span><br><span class="line">con.add(obj1)</span><br><span class="line"><span class="comment"># 提交事务</span></span><br><span class="line">con.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭session，其实是将连接放回连接池</span></span><br><span class="line">con.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> orm框，可以独立出来用</span><br><span class="line"><span class="number">2</span> orm执行原生sql</span><br><span class="line">	-生成engine（连接池）</span><br><span class="line">    	engine = create_engine()</span><br><span class="line">     -获取链接</span><br><span class="line">    	conn=engine.raw_connection()</span><br><span class="line">     -后续就一样了</span><br><span class="line">    </span><br><span class="line"><span class="number">3</span> 创建表，删除表和生成字段（不能创建数据库）</span><br><span class="line">	-写一个类</span><br><span class="line">        Base = declarative_base()</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Users</span>(<span class="params">Base</span>):</span></span><br><span class="line">            __tablename__ = <span class="string">&#x27;users&#x27;</span>  <span class="comment"># 数据库表名称</span></span><br><span class="line">            <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)  <span class="comment"># id 主键</span></span><br><span class="line">            name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">False</span>)  <span class="comment"># name列，索引，不可为空</span></span><br><span class="line">    -把被Base管理的所有表创建和删除</span><br><span class="line">    	engine = create_engine()</span><br><span class="line">    	Base.metadata.create_all(engine)</span><br><span class="line">         Base.metadata.drop_all(engine)</span><br><span class="line"><span class="number">4</span> 单表新增</span><br><span class="line">	engine = create_engine()</span><br><span class="line">	Connection = sessionmaker(bind=engine)</span><br><span class="line">    <span class="comment"># 每次执行数据库操作时，都需要创建一个Connection</span></span><br><span class="line">    conn = Connection()</span><br><span class="line">    user=User(name=<span class="string">&#x27;lqz&#x27;</span>)</span><br><span class="line">    conn.add(user)</span><br><span class="line">    conn.add_all([对象<span class="number">1</span>，对象<span class="number">2</span>])</span><br><span class="line">    <span class="comment"># 提交</span></span><br><span class="line">    conn.commit()</span><br><span class="line">    con.close()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">5</span> 一对多关系建立</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Hobby</span>(<span class="params">Base</span>):</span></span><br><span class="line">        __tablename__ = <span class="string">&#x27;hobby&#x27;</span></span><br><span class="line">        <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">        caption = Column(String(<span class="number">50</span>), default=<span class="string">&#x27;篮球&#x27;</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">Base</span>):</span></span><br><span class="line">        __tablename__ = <span class="string">&#x27;person&#x27;</span></span><br><span class="line">        nid = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">        name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># hobby指的是tablename而不是类名，uselist=False</span></span><br><span class="line">        hobby_id = Column(Integer, ForeignKey(<span class="string">&quot;hobby.id&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 跟数据库无关，不会新增字段，只用于快速链表操作</span></span><br><span class="line">        <span class="comment"># 类名，backref用于反向查询</span></span><br><span class="line">        hobby=relationship(<span class="string">&#x27;Hobby&#x27;</span>,backref=<span class="string">&#x27;pers&#x27;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="number">5</span> 一对多新增</span><br><span class="line">		engine = create_engine()</span><br><span class="line">        Connection = sessionmaker(bind=engine)</span><br><span class="line">        <span class="comment"># 每次执行数据库操作时，都需要创建一个Connection</span></span><br><span class="line">        conn = Connection()</span><br><span class="line">        hobby=Hobby(caption=<span class="string">&#x27;美女&#x27;</span>)</span><br><span class="line">        person=Person(name=<span class="string">&#x27;lqz&#x27;</span>,hobby_id=<span class="number">1</span>)</span><br><span class="line">        conn.add_all([hobby，person])</span><br><span class="line">        <span class="comment"># 第二种方式</span></span><br><span class="line">        hobby=Hobby(caption=<span class="string">&#x27;美女&#x27;</span>)</span><br><span class="line">        person=Person(name=<span class="string">&#x27;lqz&#x27;</span>,hobby=hobby) <span class="comment"># 通过对象来匹配hobby_id</span></span><br><span class="line">        conn.add_all([hobby，person])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提交</span></span><br><span class="line">        conn.commit()</span><br><span class="line">        con.close()</span><br></pre></td></tr></table></figure>

<h3 id="scoped-session-线程安全"><a href="#scoped-session-线程安全" class="headerlink" title="scoped_session 线程安全"></a>scoped_session 线程安全</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session</span><br><span class="line"><span class="keyword">from</span> sqlalchemy_test.models <span class="keyword">import</span> Users</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+pymysql://root:1018@127.0.0.1:3306/aaa&quot;</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"><span class="comment"># scoped_session类并没有继承Session,但是却又它的所有方法</span></span><br><span class="line">session = scoped_session(Session)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># 线程安全，基于本地线程实现每个线程用同一个session</span></span><br><span class="line"><span class="string"># 特殊的：scoped_session中有原来方法的Session中的一下方法：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">public_methods = (</span></span><br><span class="line"><span class="string">    &#x27;__contains__&#x27;, &#x27;__iter__&#x27;, &#x27;add&#x27;, &#x27;add_all&#x27;, &#x27;begin&#x27;, &#x27;begin_nested&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;close&#x27;, &#x27;commit&#x27;, &#x27;connection&#x27;, &#x27;delete&#x27;, &#x27;execute&#x27;, &#x27;expire&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;expire_all&#x27;, &#x27;expunge&#x27;, &#x27;expunge_all&#x27;, &#x27;flush&#x27;, &#x27;get_bind&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;is_modified&#x27;, &#x27;bulk_save_objects&#x27;, &#x27;bulk_insert_mappings&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;bulk_update_mappings&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;merge&#x27;, &#x27;query&#x27;, &#x27;refresh&#x27;, &#x27;rollback&#x27;,</span></span><br><span class="line"><span class="string">    &#x27;scalar&#x27;</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ############# 执行ORM操作 #############</span></span><br><span class="line">obj1 = Users(name=<span class="string">&quot;alex1&quot;</span>)</span><br><span class="line">session.add(obj1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交事务</span></span><br><span class="line">session.commit()</span><br><span class="line"><span class="comment"># 关闭session</span></span><br><span class="line">session.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="基本增删查改"><a href="#基本增删查改" class="headerlink" title="基本增删查改"></a>基本增删查改</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/xiaoyuanqujing/protected/articles/<span class="number">11715497.</span>html</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 基本增删查改</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Users,Person,Hobby</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> text</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+pymysql://root:123@127.0.0.1:3306/aaa&quot;</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 从连接池中拿一个链接</span></span><br><span class="line">conn = sessionmaker(bind=engine)</span><br><span class="line">session = scoped_session(conn)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增 add ，add_all</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询Users表中id为1的第一条记录</span></span><br><span class="line"><span class="comment"># filter_by写等式，filter写比较</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter_by(id=1).first()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># res=session.query(Users).filter(Users.id&lt;2)</span></span><br><span class="line"><span class="comment"># for user in res:</span></span><br><span class="line"><span class="comment">#     print(user.name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 影响的条数</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter_by(id=1).delete()</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter(Users.id&gt;1).delete()</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 修改</span></span><br><span class="line"><span class="comment"># res是影响的行数</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter(Users.id &gt; 0).update(&#123;&quot;name&quot; : &quot;lqz&quot;&#125;)</span></span><br><span class="line"><span class="comment">#类似于django的F查询</span></span><br><span class="line"><span class="comment"># synchronize_session=False 表示加字符串</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter(Users.id &gt; 0).update(&#123;&#x27;name&#x27;: Users.name + &quot;099&quot;&#125;, synchronize_session=False)</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter(Users.id &gt; 0).update(&#123;&quot;age&quot;: Users.age + 1&#125;, synchronize_session=&quot;evaluate&quot;)</span></span><br><span class="line"><span class="comment"># res=session.query(Users).filter(Users.id &gt; 0).update(&#123;Users.age: Users.age + 1&#125;, synchronize_session=&quot;evaluate&quot;)</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># res=session.query(Users).all() # 查所有</span></span><br><span class="line"><span class="comment"># res=session.query(Users).all()[0] #取第一个</span></span><br><span class="line"><span class="comment"># res=session.query(Users).first() ##取第一个</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># select name as xx,age form User;</span></span><br><span class="line"><span class="comment"># r2 = session.query(Users.name.label(&#x27;xx&#x27;), Users.age).all()</span></span><br><span class="line"><span class="comment"># # r2 = session.query(Users.name.label(&#x27;xx&#x27;), Users.age)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># # print(r2)</span></span><br><span class="line"><span class="comment"># for user in r2:</span></span><br><span class="line"><span class="comment">#     print(user.xx)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#filter传的是表达式，filter_by传的是参数</span></span><br><span class="line"><span class="comment"># r3 = session.query(Users).filter(Users.name == &quot;lqz099&quot;).all()</span></span><br><span class="line"><span class="comment"># r3 = session.query(Users).filter(Users.id == 1).all()</span></span><br><span class="line"><span class="comment"># r4 = session.query(Users).filter_by(name=&#x27;lqz&#x27;).all()</span></span><br><span class="line"><span class="comment"># r5 = session.query(Users).filter_by(name=&#x27;lqz&#x27;).first()</span></span><br><span class="line"><span class="comment"># print(r3)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#:value 和:name 相当于占位符，用params传参数</span></span><br><span class="line"><span class="comment"># select * from user where id&lt;6 and name=lqz099 order by id;</span></span><br><span class="line"><span class="comment"># r6 = session.query(Users).filter(text(&quot;id&lt;:value and name=:name&quot;)).params(value=6, name=&#x27;lqz099&#x27;).order_by(Users.id).all()</span></span><br><span class="line"><span class="comment">#自定义查询sql</span></span><br><span class="line"><span class="comment"># r7 = session.query(Users).from_statement(text(&quot;SELECT * FROM users where name=:name&quot;)).params(name=&#x27;lqz099&#x27;).all()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for u in r7:</span></span><br><span class="line"><span class="comment">#     print(u.id)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 其它查询操作</span></span><br><span class="line"><span class="comment">#　条件</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter_by(name=&#x27;lqz&#x27;).all()</span></span><br><span class="line"><span class="comment">#表达式，and条件连接</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(Users.id &gt; 1, Users.name == &#x27;lqz099&#x27;).all()</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(Users.id.between(5, 6), Users.name == &#x27;lqz099&#x27;).all()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意下划线</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(Users.id.in_([1,3,4])).all()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#~非，除。。外</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(~Users.id.in_([1,3,4])).all()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#二次筛选</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(Users.id.in_(session.query(Users.id).filter_by(name=&#x27;lqz099&#x27;)))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_, or_</span><br><span class="line"><span class="comment">#or_包裹的都是or条件，and_包裹的都是and条件</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(and_(Users.id &gt; 3, Users.name == &#x27;eric&#x27;)).all()</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(Users.id &gt; 3, Users.name == &#x27;eric&#x27;).all()</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(or_(Users.id &lt; 5, Users.name == &#x27;lqz099&#x27;)).all()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(</span></span><br><span class="line"><span class="comment">#     or_(</span></span><br><span class="line"><span class="comment">#         Users.id &lt; 2,</span></span><br><span class="line"><span class="comment">#         and_(Users.name == &#x27;eric&#x27;, Users.id &gt; 3),</span></span><br><span class="line"><span class="comment">#         Users.age != 8</span></span><br><span class="line"><span class="comment">#     ))</span></span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通配符，以e开头，不以e开头</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(Users.name.like(&#x27;%9%&#x27;)).all()</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).filter(~Users.name.like(&#x27;%9%&#x27;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制，用于分页，区间</span></span><br><span class="line"><span class="comment"># select *from user limit(1:4)</span></span><br><span class="line"><span class="comment"># select * from users limit 1,4;   从第一条数据往后取4条</span></span><br><span class="line"><span class="comment"># ret = session.query(Users)[0:4]</span></span><br><span class="line"><span class="comment"># ret = session.query(Users)[2:6]</span></span><br><span class="line"><span class="comment"># print(ret[0].id)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序，根据name降序排列（从大到小）</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).order_by(Users.name.desc()).all()</span></span><br><span class="line"><span class="comment">#第一个条件重复后，再按第二个条件升序排</span></span><br><span class="line"><span class="comment"># ret = session.query(Users).order_by(Users.name.desc(), Users.id.asc())</span></span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 分组</span></span><br><span class="line"><span class="comment"># 分组</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> func</span><br><span class="line"><span class="comment">#分组之后取最大id，id之和，最小id</span></span><br><span class="line"><span class="comment"># select max(id),sum(id),min(id) from user group by name;</span></span><br><span class="line"><span class="comment"># ret = session.query(</span></span><br><span class="line"><span class="comment">#     func.max(Users.id),</span></span><br><span class="line"><span class="comment">#     func.sum(Users.id),</span></span><br><span class="line"><span class="comment">#     func.min(Users.id)).group_by(Users.name).all()</span></span><br><span class="line"><span class="comment">#haviing筛选</span></span><br><span class="line"><span class="comment"># select max(id),sum(id),min(id) from user group by name having min(id)&gt;2;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Users.objects.value(Users.name).filter().annotate(a=max(User.id),b=min(User.id)).filter(b__gt=2)</span></span><br><span class="line"><span class="comment"># ret = session.query(</span></span><br><span class="line"><span class="comment">#     func.max(Users.id),</span></span><br><span class="line"><span class="comment">#     func.sum(Users.id),</span></span><br><span class="line"><span class="comment">#     func.min(Users.id)).group_by(Users.name).having(func.min(Users.id) &gt;2).all()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 连表（默认用forinkey关联）</span></span><br><span class="line"><span class="comment"># select * from person,hobby where person.hobby_id=hobby.id;</span></span><br><span class="line"><span class="comment"># ret = session.query(Person, Hobby).filter(Person.hobby_id == Hobby.id).all()</span></span><br><span class="line"><span class="comment"># # print(ret)[(person,hobby),(person,hobby)]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for p in ret:</span></span><br><span class="line"><span class="comment">#     print(p[0])</span></span><br><span class="line"><span class="comment">#     print(p[1].caption)</span></span><br><span class="line"><span class="comment">#     print(&#x27;-----&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#join表，默认是inner join,没有指定on的字段，默认用外键关联</span></span><br><span class="line"><span class="comment"># select * from Person inner join Hobby on  person.hobby_id =hobby.id;</span></span><br><span class="line"><span class="comment"># ret = session.query(Person).join(Hobby)</span></span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"><span class="comment"># #isouter=True 外连，表示Person left join Favor，没有右连接，反过来即可</span></span><br><span class="line"><span class="comment"># ret = session.query(Person).join(Hobby, isouter=True)</span></span><br><span class="line">ret = session.query(Hobby).join(Person, isouter=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己指定on条件（连表条件）,第二个参数，支持on多个条件，用and_,同上</span></span><br><span class="line"><span class="comment"># select * from Person left join Hobby on person.id=hobby.id</span></span><br><span class="line"><span class="comment"># ret = session.query(Person).join(Hobby,Person.hobby_id==Hobby.id, isouter=True)</span></span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"><span class="comment"># select * from Person inner join Hobby on Person.hobby_id=Hobby.id where person.id&gt;1 and hobby.caption=&#x27;篮球&#x27;</span></span><br><span class="line"><span class="comment"># ret = session.query(Person).join(Hobby).filter(Person.id&gt;1,Hobby.caption==&#x27;篮球&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 组合（了解）UNION 操作符用于合并两个或多个 SELECT 语句的结果集</span></span><br><span class="line"><span class="comment"># #union和union all的区别？</span></span><br><span class="line">q1 = session.query(Person.name).<span class="built_in">filter</span>(Person.nid &gt; <span class="number">2</span>)</span><br><span class="line"><span class="comment"># q1 = session.query(Person.name).filter(Person.nid &gt; 2).all()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># q2 = session.query(Hobby.caption).filter(Hobby.id &lt; 2)</span></span><br><span class="line"><span class="comment"># ret = q1.union(q2).all()</span></span><br><span class="line"><span class="comment"># print(ret)</span></span><br><span class="line"></span><br><span class="line">q1 = session.query(Person.name).<span class="built_in">filter</span>(Person.nid &gt; <span class="number">2</span>)</span><br><span class="line">q2 = session.query(Hobby.caption).<span class="built_in">filter</span>(Hobby.<span class="built_in">id</span> &lt; <span class="number">2</span>)</span><br><span class="line">ret = q1.union_all(q2).<span class="built_in">all</span>()</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session.commit()</span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>

<h3 id="多对多关系建立和操作"><a href="#多对多关系建立和操作" class="headerlink" title="多对多关系建立和操作"></a>多对多关系建立和操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, ForeignKey, DateTime, UniqueConstraint, Index</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boy2Girl</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;boy2girl&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    girl_id = Column(Integer, ForeignKey(<span class="string">&#x27;girl.id&#x27;</span>))</span><br><span class="line">    boy_id = Column(Integer, ForeignKey(<span class="string">&#x27;boy.id&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Girl</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;girl&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boy</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;boy&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 与生成表结构无关，仅用于查询方便,放在哪个单表中都可以</span></span><br><span class="line">    girls = relationship(<span class="string">&#x27;Girl&#x27;</span>, secondary=<span class="string">&#x27;boy2girl&#x27;</span>, backref=<span class="string">&#x27;boys&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># engine = create_engine(</span></span><br><span class="line"><span class="comment">#         &quot;mysql+pymysql://root:1018@127.0.0.1:3306/aaa?charset=utf8&quot;,</span></span><br><span class="line"><span class="comment">#         max_overflow=0,  # 超过连接池大小外最多创建的连接</span></span><br><span class="line"><span class="comment">#         pool_size=5,  # 连接池大小</span></span><br><span class="line"><span class="comment">#         pool_timeout=30,  # 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line"><span class="comment">#         pool_recycle=-1  # 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line"><span class="comment">#     )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Base.metadata.create_all(engine)</span></span><br></pre></td></tr></table></figure>

<h3 id="多对多基本使用"><a href="#多对多基本使用" class="headerlink" title="多对多基本使用"></a>多对多基本使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本增删查改</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session</span><br><span class="line"><span class="keyword">from</span> sqlalchemy_test.models <span class="keyword">import</span> Boy, Girl, Boy2Girl</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> text</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+pymysql://root:1018@127.0.0.1:3306/aaa&quot;</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 从连接池中拿一个链接</span></span><br><span class="line">conn = sessionmaker(bind=engine)</span><br><span class="line">session = scoped_session(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># boy = Boy(name=&#x27;lqz&#x27;)</span></span><br><span class="line"><span class="comment"># boy2 = Boy(name=&#x27;egon&#x27;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># girl = Girl(name=&#x27;刘亦菲&#x27;)</span></span><br><span class="line"><span class="comment"># girl2 = Girl(name=&#x27;迪丽热巴&#x27;)</span></span><br><span class="line"><span class="comment"># session.add_all([boy,boy2,girl,girl2])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立关系</span></span><br><span class="line"><span class="comment"># b=Boy2Girl(girl_id=1,boy_id=1)</span></span><br><span class="line"><span class="comment"># # b=Boy2Girl(girl=对象,boy=对象)</span></span><br><span class="line"><span class="comment"># session.add(b)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lqz=session.query(Boy).filter(Boy.id==1).first()</span></span><br><span class="line"><span class="comment"># # dlrb=session.query(Girl).filter(Girl.id==2).first()</span></span><br><span class="line"><span class="comment"># lyf=session.query(Girl).filter(Girl.id==1).first()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># # lqz.girls=[dlrb,]</span></span><br><span class="line"><span class="comment"># lqz.girls.append(lyf)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># egon=session.query(Boy).filter(Boy.id==2).first()</span></span><br><span class="line"><span class="comment"># lyf=session.query(Girl).filter(Girl.id==1).first()</span></span><br><span class="line"><span class="comment"># lyf.boys.append(egon)</span></span><br><span class="line"><span class="comment"># session.add(lyf)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lqz=session.query(Boy).filter(Boy.id==1).first()</span></span><br><span class="line"><span class="comment"># lyf=session.query(Girl).filter(Girl.id==1).first()</span></span><br><span class="line"><span class="comment"># print(lyf.boys)</span></span><br><span class="line"></span><br><span class="line">session.commit()</span><br><span class="line">session.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="flask-sqlalchemy的使用"><a href="#flask-sqlalchemy的使用" class="headerlink" title="flask-sqlalchemy的使用"></a>flask-sqlalchemy的使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&quot;SQLALCHEMY_DATABASE_URI&quot;</span>] = <span class="string">&quot;sqlite:///example.sqlite&quot;</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String, unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    email = db.Column(db.String, unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.session.add(User(username=<span class="string">&quot;Flask&quot;</span>, email=<span class="string">&quot;example@example.com&quot;</span>))</span><br><span class="line">db.session.commit()</span><br><span class="line"></span><br><span class="line">users = User.query.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<h3 id="项目分文件使用sqlalchemy-flask-migrate"><a href="#项目分文件使用sqlalchemy-flask-migrate" class="headerlink" title="项目分文件使用sqlalchemy+flask-migrate"></a>项目分文件使用sqlalchemy+flask-migrate</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 详见sansa项目</span></span><br><span class="line"><span class="comment"># flask和SQLAchemy的管理者，通过他把他们做连接</span></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">	- 包含配置</span><br><span class="line">	- 包含ORM基类</span><br><span class="line">	- 包含create_all</span><br><span class="line">	- engine</span><br><span class="line">	- 创建连接</span><br><span class="line"><span class="comment"># flask-migrate</span></span><br><span class="line">python3 manage.py db init 初始化：只执行一次</span><br><span class="line">python3 manage.py db migrate 等同于 makemigartions</span><br><span class="line">python3 manage.py db upgrade 等同于migrate</span><br></pre></td></tr></table></figure>

<h3 id="django多数据库"><a href="#django多数据库" class="headerlink" title="django多数据库"></a>django多数据库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigraions</span><br><span class="line">			</span><br><span class="line">			python manage.py migrate app名称 --databse=配置文件数据名称的别名</span><br><span class="line">			</span><br><span class="line">			手动操作：</span><br><span class="line">				models.UserType.objects.using(<span class="string">&#x27;db1&#x27;</span>).create(title=<span class="string">&#x27;普通用户&#x27;</span>)</span><br><span class="line">				result = models.UserType.objects.<span class="built_in">all</span>().using(<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">				</span><br><span class="line">			自动操作：</span><br><span class="line">				<span class="class"><span class="keyword">class</span> <span class="title">Router1</span>:</span></span><br><span class="line">					<span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">						<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">						Attempts to read auth models go to auth_db.</span></span><br><span class="line"><span class="string">						&quot;&quot;&quot;</span></span><br><span class="line">						<span class="keyword">return</span> <span class="string">&#x27;db1&#x27;</span></span><br><span class="line"></span><br><span class="line">					<span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">						<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">						Attempts to write auth models go to auth_db.</span></span><br><span class="line"><span class="string">						&quot;&quot;&quot;</span></span><br><span class="line">						<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">				配置：</span><br><span class="line">					DATABASES = &#123;</span><br><span class="line">						<span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">							<span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">							<span class="string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;db.sqlite3&#x27;</span>),</span><br><span class="line">						&#125;,</span><br><span class="line">						<span class="string">&#x27;db1&#x27;</span>: &#123;</span><br><span class="line">							<span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">							<span class="string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;db1.sqlite3&#x27;</span>),</span><br><span class="line">						&#125;,</span><br><span class="line">					&#125;</span><br><span class="line">					DATABASE_ROUTERS = [<span class="string">&#x27;db_router.Router1&#x27;</span>,]</span><br><span class="line">					</span><br><span class="line">				使用：</span><br><span class="line">					models.UserType.objects.create(title=<span class="string">&#x27;VVIP&#x27;</span>)</span><br><span class="line"></span><br><span class="line">					result = models.UserType.objects.<span class="built_in">all</span>()</span><br><span class="line">					<span class="built_in">print</span>(result)</span><br><span class="line">										</span><br><span class="line">				补充：粒度更细</span><br><span class="line">					<span class="class"><span class="keyword">class</span> <span class="title">Router1</span>:</span></span><br><span class="line">						<span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">							<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">							Attempts to read auth models go to auth_db.</span></span><br><span class="line"><span class="string">							&quot;&quot;&quot;</span></span><br><span class="line">							<span class="keyword">if</span> model._meta.model_name == <span class="string">&#x27;usertype&#x27;</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&#x27;db1&#x27;</span></span><br><span class="line">							<span class="keyword">else</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">						<span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">							<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">							Attempts to write auth models go to auth_db.</span></span><br><span class="line"><span class="string">							&quot;&quot;&quot;</span></span><br><span class="line">							<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">			问题： </span><br><span class="line">				app01中的表在default数据库创建</span><br><span class="line">				app02中的表在db1数据库创建</span><br><span class="line">				</span><br><span class="line">				<span class="comment"># 第一步：</span></span><br><span class="line">					python manage.py makemigraions </span><br><span class="line">				</span><br><span class="line">				<span class="comment"># 第二步：</span></span><br><span class="line">					app01中的表在default数据库创建</span><br><span class="line">					python manage.py migrate app01 --database=default</span><br><span class="line">				</span><br><span class="line">				<span class="comment"># 第三步：</span></span><br><span class="line">					app02中的表在db1数据库创建</span><br><span class="line">					python manage.py migrate app02 --database=db1</span><br><span class="line">					</span><br><span class="line">				<span class="comment"># 手动操作：</span></span><br><span class="line">					m1.UserType.objects.using(<span class="string">&#x27;default&#x27;</span>).create(title=<span class="string">&#x27;VVIP&#x27;</span>)</span><br><span class="line">					m2.Users.objects.using(<span class="string">&#x27;db1&#x27;</span>).create(name=<span class="string">&#x27;VVIP&#x27;</span>,email=<span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line">				<span class="comment"># 自动操作：</span></span><br><span class="line">					配置： </span><br><span class="line">						<span class="class"><span class="keyword">class</span> <span class="title">Router1</span>:</span></span><br><span class="line">							<span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">								<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">								Attempts to read auth models go to auth_db.</span></span><br><span class="line"><span class="string">								&quot;&quot;&quot;</span></span><br><span class="line">								<span class="keyword">if</span> model._meta.app_label == <span class="string">&#x27;app01&#x27;</span>:</span><br><span class="line">									<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">								<span class="keyword">else</span>:</span><br><span class="line">									<span class="keyword">return</span> <span class="string">&#x27;db1&#x27;</span></span><br><span class="line"></span><br><span class="line">							<span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">								<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">								Attempts to write auth models go to auth_db.</span></span><br><span class="line"><span class="string">								&quot;&quot;&quot;</span></span><br><span class="line">								<span class="keyword">if</span> model._meta.app_label == <span class="string">&#x27;app01&#x27;</span>:</span><br><span class="line">									<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">								<span class="keyword">else</span>:</span><br><span class="line">									<span class="keyword">return</span> <span class="string">&#x27;db1&#x27;</span></span><br><span class="line"></span><br><span class="line">						DATABASE_ROUTERS = [<span class="string">&#x27;db_router.Router1&#x27;</span>,]</span><br><span class="line">					</span><br><span class="line">					使用： </span><br><span class="line">						m1.UserType.objects.using(<span class="string">&#x27;default&#x27;</span>).create(title=<span class="string">&#x27;VVIP&#x27;</span>)</span><br><span class="line">						m2.Users.objects.using(<span class="string">&#x27;db1&#x27;</span>).create(name=<span class="string">&#x27;VVIP&#x27;</span>,email=<span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line">			其他：</span><br><span class="line">				数据库迁移时进行约束：</span><br><span class="line">					<span class="class"><span class="keyword">class</span> <span class="title">Router1</span>:</span></span><br><span class="line">						<span class="function"><span class="keyword">def</span> <span class="title">allow_migrate</span>(<span class="params">self, db, app_label, model_name=<span class="literal">None</span>, **hints</span>):</span></span><br><span class="line">							<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">							All non-auth models end up in this pool.</span></span><br><span class="line"><span class="string">							&quot;&quot;&quot;</span></span><br><span class="line">							<span class="keyword">if</span> db==<span class="string">&#x27;db1&#x27;</span> <span class="keyword">and</span> app_label == <span class="string">&#x27;app02&#x27;</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">							<span class="keyword">elif</span> db == <span class="string">&#x27;default&#x27;</span> <span class="keyword">and</span> app_label == <span class="string">&#x27;app01&#x27;</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">							<span class="keyword">else</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">							</span><br><span class="line">							<span class="comment"># 如果返回None，那么表示交给后续的router，如果后续没有router，则相当于返回True</span></span><br><span class="line">							</span><br><span class="line">						<span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">							<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">							Attempts to read auth models go to auth_db.</span></span><br><span class="line"><span class="string">							&quot;&quot;&quot;</span></span><br><span class="line">							<span class="keyword">if</span> model._meta.app_label == <span class="string">&#x27;app01&#x27;</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">							<span class="keyword">else</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&#x27;db1&#x27;</span></span><br><span class="line"></span><br><span class="line">						<span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span>(<span class="params">self, model, **hints</span>):</span></span><br><span class="line">							<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">							Attempts to write auth models go to auth_db.</span></span><br><span class="line"><span class="string">							&quot;&quot;&quot;</span></span><br><span class="line">							<span class="keyword">if</span> model._meta.app_label == <span class="string">&#x27;app01&#x27;</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">							<span class="keyword">else</span>:</span><br><span class="line">								<span class="keyword">return</span> <span class="string">&#x27;db1&#x27;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/10/redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/10/redis/" class="post-title-link" itemprop="url">redis</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-10 17:35:22" itemprop="dateCreated datePublished" datetime="2021-08-10T17:35:22+08:00">2021-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-27 15:52:52" itemprop="dateModified" datetime="2022-06-27T15:52:52+08:00">2022-06-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir redis</span><br><span class="line">cd redis</span><br><span class="line">wget http://download.redis.io/releases/redis-<span class="number">3.0</span><span class="number">.6</span>.tar.gz</span><br><span class="line">tar xzf redis-<span class="number">3.0</span><span class="number">.6</span>.tar.gz</span><br><span class="line">ln -s redis-<span class="number">3.0</span><span class="number">.6</span> redis </span><br><span class="line">cd redis-<span class="number">3.0</span><span class="number">.6</span></span><br><span class="line">make</span><br><span class="line"><span class="comment">#在src目录下可以看到</span></span><br><span class="line"><span class="comment">#redis-server---&gt;redis服务器</span></span><br><span class="line"><span class="comment">#redis-cli---》redis命令行客户端</span></span><br><span class="line"><span class="comment">#redis-benchmark---》redis性能测试工具</span></span><br><span class="line"><span class="comment">#redis-check-aof---&gt;aof文件修复工具</span></span><br><span class="line"><span class="comment">#redis-check-dump---》rdb文件检查工具</span></span><br><span class="line"><span class="comment">#redis-sentinel---》sentinel服务器，哨兵</span></span><br><span class="line"><span class="comment">#redis作者对windows维护不好，window自己有安装包</span></span><br></pre></td></tr></table></figure>

<h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><p><img src="/2021/08/10/redis/image-20210811120243249.png" alt="redis"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# vim ~/.bash_profile</span><br><span class="line">	- export PATH=$PATH:/root/redis/redis-3.0.6/src</span><br><span class="line">[root@localhost redis]# source ~/.bash_profile</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ln -s a b 中的 a 就是源文件，b是链接文件名,其作用是当进入b目录，实际上是链接进入了a目录</span></span><br><span class="line">[root@localhost redis]# ln -s redis-3.0.6 redis </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 动态参数启动服务</span></span><br><span class="line">redis-server --port 6379</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端链接</span></span><br><span class="line">redis-cli -h ip -p port</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 带密码</span></span><br><span class="line">redis-cli -h 127.0.0.1  -p 6379 -a 123456</span><br></pre></td></tr></table></figure>

<h4 id="启动服务端"><a href="#启动服务端" class="headerlink" title="启动服务端"></a>启动服务端</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-3.0.6]# cd src/</span><br><span class="line">[root@localhost src]# ./redis-server</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]<span class="comment"># ./redis-cli </span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> name ddd</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get name</span><br><span class="line"><span class="string">&quot;ddd&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="关闭服务"><a href="#关闭服务" class="headerlink" title="关闭服务"></a>关闭服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# ./redis-cli shutdown</span><br><span class="line">[root@localhost src]# netstat -lanp | grep &quot;6379&quot;</span><br></pre></td></tr></table></figure>

<h4 id="本地连接"><a href="#本地连接" class="headerlink" title="本地连接"></a>本地连接</h4><ul>
<li>需要放行防火墙端口号</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# firewall-cmd --zone=public --add-port=6379/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost src]# firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line">[root@localhost src]# firewall-cmd --list-ports</span><br><span class="line">27017/tcp 6379/tcp</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="指定配置文件启动服务"><a href="#指定配置文件启动服务" class="headerlink" title="指定配置文件启动服务"></a>指定配置文件启动服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-3.0.6]# cp redis.conf ./redisdemo.conf</span><br><span class="line">[root@localhost redis-3.0.6]# vim redisdemo.conf </span><br><span class="line">- bind 0.0.0.0</span><br><span class="line">[root@localhost redis-3.0.6]# cd src</span><br><span class="line">[root@localhost src]# ./redis-server /root/redis/redis-3.0.6/redisdemo.conf</span><br></pre></td></tr></table></figure>

<h4 id="redis-配置文件详解"><a href="#redis-配置文件详解" class="headerlink" title="redis 配置文件详解"></a>redis 配置文件详解</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis 配置文件示例</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 当你需要为某个配置项指定内存大小的时候，必须要带上单位，</span></span><br><span class="line"><span class="comment"># 通常的格式就是 1k 5gb 4m 等酱紫：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1k  =&gt; 1000 bytes</span></span><br><span class="line"><span class="comment"># 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="comment"># 1m  =&gt; 1000000 bytes</span></span><br><span class="line"><span class="comment"># 1mb =&gt; 1024*1024 bytes</span></span><br><span class="line"><span class="comment"># 1g  =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="comment"># 1gb =&gt; 1024*1024*1024 bytes</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 单位是不区分大小写的，你写 1K 5GB 4M 也行</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################## INCLUDES ###################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 假如说你有一个可用于所有的 redis server 的标准配置模板，</span></span><br><span class="line"><span class="comment"># 但针对某些 server 又需要一些个性化的设置，</span></span><br><span class="line"><span class="comment"># 你可以使用 include 来包含一些其他的配置文件，这对你来说是非常有用的。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 但是要注意哦，include 是不能被 config rewrite 命令改写的</span></span><br><span class="line"><span class="comment"># 由于 redis 总是以最后的加工线作为一个配置指令值，所以你最好是把 include 放在这个文件的最前面，</span></span><br><span class="line"><span class="comment"># 以避免在运行时覆盖配置的改变，相反，你就把它放在后面（外国人真啰嗦）。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include /path/to/local.conf</span></span><br><span class="line"><span class="comment"># include /path/to/other.conf</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################ 常用 #####################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 默认情况下 redis 不是作为守护进程运行的，如果你想让它在后台运行，你就把它改成 yes。</span></span><br><span class="line"><span class="comment"># 当redis作为守护进程运行的时候，它会写一个 pid 到 /var/run/redis.pid 文件里面。</span></span><br><span class="line">daemonize no</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 当redis作为守护进程运行的时候，它会把 pid 默认写到 /var/run/redis.pid 文件里面，</span></span><br><span class="line"><span class="comment"># 但是你可以在这里自己制定它的文件位置。</span></span><br><span class="line">pidfile /var/run/redis.pid</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 监听端口号，默认为 6379，如果你设为 0 ，redis 将不在 socket 上监听任何客户端连接。</span></span><br><span class="line">port <span class="number">6379</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># TCP 监听的最大容纳数量</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 在高并发的环境下，你需要把这个值调高以避免客户端连接缓慢的问题。</span></span><br><span class="line"><span class="comment"># Linux 内核会一声不响的把这个值缩小成 /proc/sys/net/core/somaxconn 对应的值，</span></span><br><span class="line"><span class="comment"># 所以你要修改这两个值才能达到你的预期。</span></span><br><span class="line">tcp<span class="literal">-backlog</span> <span class="number">511</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 默认情况下，redis 在 server 上所有有效的网络接口上监听客户端连接。</span></span><br><span class="line"><span class="comment"># 你如果只想让它在一个网络接口上监听，那你就绑定一个IP或者多个IP。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 示例，多个IP用空格隔开:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># bind 192.168.1.100 10.0.0.1</span></span><br><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定 unix socket 的路径。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># unixsocket /tmp/redis.sock</span></span><br><span class="line"><span class="comment"># unixsocketperm 755</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定在一个 client 空闲多少秒之后关闭连接（0 就是不管它）</span></span><br><span class="line">timeout <span class="number">0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># tcp 心跳包。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果设置为非零，则在与客户端缺乏通讯的时候使用 SO_KEEPALIVE 发送 tcp acks 给客户端。</span></span><br><span class="line"><span class="comment"># 这个之所有有用，主要由两个原因：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) 防止死的 peers</span></span><br><span class="line"><span class="comment"># 2) Take the connection alive from the point of view of network</span></span><br><span class="line"><span class="comment">#    equipment in the middle.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># On Linux, the specified value (in seconds) is the period used to send ACKs.</span></span><br><span class="line"><span class="comment"># Note that to close the connection the double of the time is needed.</span></span><br><span class="line"><span class="comment"># On other kernels the period depends on the kernel configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># A reasonable value for this option is 60 seconds.</span></span><br><span class="line"><span class="comment"># 推荐一个合理的值就是60秒</span></span><br><span class="line">tcp<span class="literal">-keepalive</span> <span class="number">0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义日志级别。</span></span><br><span class="line"><span class="comment"># 可以是下面的这些值：</span></span><br><span class="line"><span class="comment"># debug (适用于开发或测试阶段)</span></span><br><span class="line"><span class="comment"># verbose (many rarely useful info, but not a mess like the debug level)</span></span><br><span class="line"><span class="comment"># notice (适用于生产环境)</span></span><br><span class="line"><span class="comment"># warning (仅仅一些重要的消息被记录)</span></span><br><span class="line">loglevel notice</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定日志文件的位置</span></span><br><span class="line">logfile <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 要想把日志记录到系统日志，就把它改成 yes，</span></span><br><span class="line"><span class="comment"># 也可以可选择性的更新其他的syslog 参数以达到你的要求</span></span><br><span class="line"><span class="comment"># syslog-enabled no</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置 syslog 的 identity。</span></span><br><span class="line"><span class="comment"># syslog-ident redis</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置 syslog 的 facility，必须是 USER 或者是 LOCAL0-LOCAL7 之间的值。</span></span><br><span class="line"><span class="comment"># syslog-facility local0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置数据库的数目。</span></span><br><span class="line"><span class="comment"># 默认数据库是 DB 0，你可以在每个连接上使用 select &lt;dbid&gt; 命令选择一个不同的数据库，</span></span><br><span class="line"><span class="comment"># 但是 dbid 必须是一个介于 0 到 databasees - 1 之间的值</span></span><br><span class="line">databases <span class="number">16</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################ 快照 ################################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 存 DB 到磁盘：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   格式：save &lt;间隔时间（秒）&gt; &lt;写入次数&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   根据给定的时间间隔和写入次数将数据保存到磁盘</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   下面的例子的意思是：</span></span><br><span class="line"><span class="comment">#   900 秒内如果至少有 1 个 key 的值变化，则保存</span></span><br><span class="line"><span class="comment">#   300 秒内如果至少有 10 个 key 的值变化，则保存</span></span><br><span class="line"><span class="comment">#   60 秒内如果至少有 10000 个 key 的值变化，则保存</span></span><br><span class="line"><span class="comment">#　　</span></span><br><span class="line"><span class="comment">#   注意：你可以注释掉所有的 save 行来停用保存功能。</span></span><br><span class="line"><span class="comment">#   也可以直接一个空字符串来实现停用：</span></span><br><span class="line"><span class="comment">#   save &quot;&quot;</span></span><br><span class="line"> </span><br><span class="line">save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 默认情况下，如果 redis 最后一次的后台保存失败，redis 将停止接受写操作，</span></span><br><span class="line"><span class="comment"># 这样以一种强硬的方式让用户知道数据不能正确的持久化到磁盘，</span></span><br><span class="line"><span class="comment"># 否则就会没人注意到灾难的发生。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果后台保存进程重新启动工作了，redis 也将自动的允许写操作。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 然而你要是安装了靠谱的监控，你可能不希望 redis 这样做，那你就改成 no 好了。</span></span><br><span class="line"><span class="built_in">stop-writes</span><span class="literal">-on</span><span class="literal">-bgsave</span><span class="literal">-error</span> yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 是否在 dump .rdb 数据库的时候使用 LZF 压缩字符串</span></span><br><span class="line"><span class="comment"># 默认都设为 yes</span></span><br><span class="line"><span class="comment"># 如果你希望保存子进程节省点 cpu ，你就设置它为 no ，</span></span><br><span class="line"><span class="comment"># 不过这个数据集可能就会比较大</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 是否校验rdb文件</span></span><br><span class="line">rdbchecksum yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置 dump 的文件位置</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="comment"># 例如上面的 dbfilename 只指定了文件名，</span></span><br><span class="line"><span class="comment"># 但是它会写入到这个目录下。这个配置项一定是个目录，而不能是文件名。</span></span><br><span class="line"><span class="built_in">dir</span> ./</span><br><span class="line"> </span><br><span class="line"><span class="comment">################################# 主从复制 #################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 主从复制。使用 slaveof 来让一个 redis 实例成为另一个reids 实例的副本。</span></span><br><span class="line"><span class="comment"># 注意这个只需要在 slave 上配置。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 如果 master 需要密码认证，就在这里设置</span></span><br><span class="line"><span class="comment"># masterauth &lt;master-password&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 当一个 slave 与 master 失去联系，或者复制正在进行的时候，</span></span><br><span class="line"><span class="comment"># slave 可能会有两种表现：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) 如果为 yes ，slave 仍然会应答客户端请求，但返回的数据可能是过时，</span></span><br><span class="line"><span class="comment">#    或者数据可能是空的在第一次同步的时候</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2) 如果为 no ，在你执行除了 info he salveof 之外的其他命令时，</span></span><br><span class="line"><span class="comment">#    slave 都将返回一个 &quot;SYNC with master in progress&quot; 的错误，</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">slave<span class="literal">-serve</span><span class="literal">-stale</span><span class="literal">-data</span> yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 你可以配置一个 slave 实体是否接受写入操作。</span></span><br><span class="line"><span class="comment"># 通过写入操作来存储一些短暂的数据对于一个 slave 实例来说可能是有用的，</span></span><br><span class="line"><span class="comment"># 因为相对从 master 重新同步数而言，据数据写入到 slave 会更容易被删除。</span></span><br><span class="line"><span class="comment"># 但是如果客户端因为一个错误的配置写入，也可能会导致一些问题。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 从 redis 2.6 版起，默认 slaves 都是只读的。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: read only slaves are not designed to be exposed to untrusted clients</span></span><br><span class="line"><span class="comment"># on the internet. It&#x27;s just a protection layer against misuse of the instance.</span></span><br><span class="line"><span class="comment"># Still a read only slave exports by default all the administrative commands</span></span><br><span class="line"><span class="comment"># such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</span></span><br><span class="line"><span class="comment"># security of read only slaves using &#x27;rename-command&#x27; to shadow all the</span></span><br><span class="line"><span class="comment"># administrative / dangerous commands.</span></span><br><span class="line"><span class="comment"># 注意：只读的 slaves 没有被设计成在 internet 上暴露给不受信任的客户端。</span></span><br><span class="line"><span class="comment"># 它仅仅是一个针对误用实例的一个保护层。</span></span><br><span class="line">slave<span class="literal">-read</span><span class="literal">-only</span> yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Slaves 在一个预定义的时间间隔内发送 ping 命令到 server 。</span></span><br><span class="line"><span class="comment"># 你可以改变这个时间间隔。默认为 10 秒。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># repl-ping-slave-period 10</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># The following option sets the replication timeout for:</span></span><br><span class="line"><span class="comment"># 设置主从复制过期时间</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) Bulk transfer I/O during SYNC, from the point of view of slave.</span></span><br><span class="line"><span class="comment"># 2) Master timeout from the point of view of slaves (data, pings).</span></span><br><span class="line"><span class="comment"># 3) Slave timeout from the point of view of masters (REPLCONF ACK pings).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is important to make sure that this value is greater than the value</span></span><br><span class="line"><span class="comment"># specified for repl-ping-slave-period otherwise a timeout will be detected</span></span><br><span class="line"><span class="comment"># every time there is low traffic between the master and the slave.</span></span><br><span class="line"><span class="comment"># 这个值一定要比 repl-ping-slave-period 大</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># repl-timeout 60</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Disable TCP_NODELAY on the slave socket after SYNC?</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you select &quot;yes&quot; Redis will use a smaller number of TCP packets and</span></span><br><span class="line"><span class="comment"># less bandwidth to send data to slaves. But this can add a delay for</span></span><br><span class="line"><span class="comment"># the data to appear on the slave side, up to 40 milliseconds with</span></span><br><span class="line"><span class="comment"># Linux kernels using a default configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you select &quot;no&quot; the delay for data to appear on the slave side will</span></span><br><span class="line"><span class="comment"># be reduced but more bandwidth will be used for replication.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default we optimize for low latency, but in very high traffic conditions</span></span><br><span class="line"><span class="comment"># or when the master and slaves are many hops away, turning this to &quot;yes&quot; may</span></span><br><span class="line"><span class="comment"># be a good idea.</span></span><br><span class="line">repl<span class="literal">-disable</span><span class="literal">-tcp</span><span class="literal">-nodelay</span> no</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置主从复制容量大小。这个 backlog 是一个用来在 slaves 被断开连接时</span></span><br><span class="line"><span class="comment"># 存放 slave 数据的 buffer，所以当一个 slave 想要重新连接，通常不希望全部重新同步，</span></span><br><span class="line"><span class="comment"># 只是部分同步就够了，仅仅传递 slave 在断开连接时丢失的这部分数据。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The biggest the replication backlog, the longer the time the slave can be</span></span><br><span class="line"><span class="comment"># disconnected and later be able to perform a partial resynchronization.</span></span><br><span class="line"><span class="comment"># 这个值越大，salve 可以断开连接的时间就越长。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The backlog is only allocated once there is at least a slave connected.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># repl-backlog-size 1mb</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># After a master has no longer connected slaves for some time, the backlog</span></span><br><span class="line"><span class="comment"># will be freed. The following option configures the amount of seconds that</span></span><br><span class="line"><span class="comment"># need to elapse, starting from the time the last slave disconnected, for</span></span><br><span class="line"><span class="comment"># the backlog buffer to be freed.</span></span><br><span class="line"><span class="comment"># 在某些时候，master 不再连接 slaves，backlog 将被释放。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># A value of 0 means to never release the backlog.</span></span><br><span class="line"><span class="comment"># 如果设置为 0 ，意味着绝不释放 backlog 。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># repl-backlog-ttl 3600</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 当 master 不能正常工作的时候，Redis Sentinel 会从 slaves 中选出一个新的 master，</span></span><br><span class="line"><span class="comment"># 这个值越小，就越会被优先选中，但是如果是 0 ， 那是意味着这个 slave 不可能被选中。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 默认优先级为 100。</span></span><br><span class="line">slave<span class="literal">-priority</span> <span class="number">100</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># It is possible for a master to stop accepting writes if there are less than</span></span><br><span class="line"><span class="comment"># N slaves connected, having a lag less or equal than M seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The N slaves need to be in &quot;online&quot; state.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The lag in seconds, that must be &lt;= the specified value, is calculated from</span></span><br><span class="line"><span class="comment"># the last ping received from the slave, that is usually sent every second.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This option does not GUARANTEES that N replicas will accept the write, but</span></span><br><span class="line"><span class="comment"># will limit the window of exposure for lost writes in case not enough slaves</span></span><br><span class="line"><span class="comment"># are available, to the specified number of seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For example to require at least 3 slaves with a lag &lt;= 10 seconds use:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># min-slaves-to-write 3</span></span><br><span class="line"><span class="comment"># min-slaves-max-lag 10</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Setting one or the other to 0 disables the feature.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default min-slaves-to-write is set to 0 (feature disabled) and</span></span><br><span class="line"><span class="comment"># min-slaves-max-lag is set to 10.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################## 安全 ###################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Require clients to issue AUTH &lt;PASSWORD&gt; before processing any other</span></span><br><span class="line"><span class="comment"># commands.  This might be useful in environments in which you do not trust</span></span><br><span class="line"><span class="comment"># others with access to the host running redis-server.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This should stay commented out for backward compatibility and because most</span></span><br><span class="line"><span class="comment"># people do not need auth (e.g. they run their own servers).</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Warning: since Redis is pretty fast an outside user can try up to</span></span><br><span class="line"><span class="comment"># 150k passwords per second against a good box. This means that you should</span></span><br><span class="line"><span class="comment"># use a very strong password otherwise it will be very easy to break.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 设置认证密码</span></span><br><span class="line"><span class="comment"># requirepass foobared</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Command renaming.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is possible to change the name of dangerous commands in a shared</span></span><br><span class="line"><span class="comment"># environment. For instance the CONFIG command may be renamed into something</span></span><br><span class="line"><span class="comment"># hard to guess so that it will still be available for internal-use tools</span></span><br><span class="line"><span class="comment"># but not available for general clients.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is also possible to completely kill a command by renaming it into</span></span><br><span class="line"><span class="comment"># an empty string:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rename-command CONFIG &quot;&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that changing the name of commands that are logged into the</span></span><br><span class="line"><span class="comment"># AOF file or transmitted to slaves may cause problems.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################### 限制 ####################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Set the max number of connected clients at the same time. By default</span></span><br><span class="line"><span class="comment"># this limit is set to 10000 clients, however if the Redis server is not</span></span><br><span class="line"><span class="comment"># able to configure the process file limit to allow for the specified limit</span></span><br><span class="line"><span class="comment"># the max number of allowed clients is set to the current file limit</span></span><br><span class="line"><span class="comment"># minus 32 (as Redis reserves a few file descriptors for internal uses).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 一旦达到最大限制，redis 将关闭所有的新连接</span></span><br><span class="line"><span class="comment"># 并发送一个‘max number of clients reached’的错误。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxclients 10000</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 如果你设置了这个值，当缓存的数据容量达到这个值， redis 将根据你选择的</span></span><br><span class="line"><span class="comment"># eviction 策略来移除一些 keys。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果 redis 不能根据策略移除 keys ，或者是策略被设置为 ‘noeviction’，</span></span><br><span class="line"><span class="comment"># redis 将开始响应错误给命令，如 set，lpush 等等，</span></span><br><span class="line"><span class="comment"># 并继续响应只读的命令，如 get</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This option is usually useful when using Redis as an LRU cache, or to set</span></span><br><span class="line"><span class="comment"># a hard memory limit for an instance (using the &#x27;noeviction&#x27; policy).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># WARNING: If you have slaves attached to an instance with maxmemory on,</span></span><br><span class="line"><span class="comment"># the size of the output buffers needed to feed the slaves are subtracted</span></span><br><span class="line"><span class="comment"># from the used memory count, so that network problems / resyncs will</span></span><br><span class="line"><span class="comment"># not trigger a loop where keys are evicted, and in turn the output</span></span><br><span class="line"><span class="comment"># buffer of slaves is full with DELs of keys evicted triggering the deletion</span></span><br><span class="line"><span class="comment"># of more keys, and so forth until the database is completely emptied.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In short... if you have slaves attached it is suggested that you set a lower</span></span><br><span class="line"><span class="comment"># limit for maxmemory so that there is some free RAM on the system for slave</span></span><br><span class="line"><span class="comment"># output buffers (but this is not needed if the policy is &#x27;noeviction&#x27;).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 最大使用内存</span></span><br><span class="line"><span class="comment"># maxmemory &lt;bytes&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 最大内存策略，你有 5 个选择。</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># volatile-lru -&gt; remove the key with an expire set using an LRU algorithm</span></span><br><span class="line"><span class="comment"># volatile-lru -&gt; 使用 LRU 算法移除包含过期设置的 key 。</span></span><br><span class="line"><span class="comment"># allkeys-lru -&gt; remove any key accordingly to the LRU algorithm</span></span><br><span class="line"><span class="comment"># allkeys-lru -&gt; 根据 LRU 算法移除所有的 key 。</span></span><br><span class="line"><span class="comment"># volatile-random -&gt; remove a random key with an expire set</span></span><br><span class="line"><span class="comment"># allkeys-random -&gt; remove a random key, any key</span></span><br><span class="line"><span class="comment"># volatile-ttl -&gt; remove the key with the nearest expire time (minor TTL)</span></span><br><span class="line"><span class="comment"># noeviction -&gt; don&#x27;t expire at all, just return an error on write operations</span></span><br><span class="line"><span class="comment"># noeviction -&gt; 不让任何 key 过期，只是给写入操作返回一个错误</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Note: with any of the above policies, Redis will return an error on write</span></span><br><span class="line"><span class="comment">#       operations, when there are not suitable keys for eviction.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       At the date of writing this commands are: set setnx setex append</span></span><br><span class="line"><span class="comment">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span></span><br><span class="line"><span class="comment">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span></span><br><span class="line"><span class="comment">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span></span><br><span class="line"><span class="comment">#       getset mset msetnx exec sort</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The default is:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory-policy noeviction</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># LRU and minimal TTL algorithms are not precise algorithms but approximated</span></span><br><span class="line"><span class="comment"># algorithms (in order to save memory), so you can tune it for speed or</span></span><br><span class="line"><span class="comment"># accuracy. For default Redis will check five keys and pick the one that was</span></span><br><span class="line"><span class="comment"># used less recently, you can change the sample size using the following</span></span><br><span class="line"><span class="comment"># configuration directive.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The default of 5 produces good enough results. 10 Approximates very closely</span></span><br><span class="line"><span class="comment"># true LRU but costs a bit more CPU. 3 is very fast but not very accurate.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory-samples 5</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">############################## APPEND ONLY MODE ###############################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># By default Redis asynchronously dumps the dataset on disk. This mode is</span></span><br><span class="line"><span class="comment"># good enough in many applications, but an issue with the Redis process or</span></span><br><span class="line"><span class="comment"># a power outage may result into a few minutes of writes lost (depending on</span></span><br><span class="line"><span class="comment"># the configured save points).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The Append Only File is an alternative persistence mode that provides</span></span><br><span class="line"><span class="comment"># much better durability. For instance using the default data fsync policy</span></span><br><span class="line"><span class="comment"># (see later in the config file) Redis can lose just one second of writes in a</span></span><br><span class="line"><span class="comment"># dramatic event like a server power outage, or a single write if something</span></span><br><span class="line"><span class="comment"># wrong with the Redis process itself happens, but the operating system is</span></span><br><span class="line"><span class="comment"># still running correctly.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># AOF and RDB persistence can be enabled at the same time without problems.</span></span><br><span class="line"><span class="comment"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span></span><br><span class="line"><span class="comment"># with the better durability guarantees.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please check http://redis.io/topics/persistence for more information.</span></span><br><span class="line"> </span><br><span class="line">appendonly no</span><br><span class="line"> </span><br><span class="line"><span class="comment"># The name of the append only file (default: &quot;appendonly.aof&quot;)</span></span><br><span class="line"> </span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># The fsync() call tells the Operating System to actually write data on disk</span></span><br><span class="line"><span class="comment"># instead to wait for more data in the output buffer. Some OS will really flush </span></span><br><span class="line"><span class="comment"># data on disk, some other OS will just try to do it ASAP.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Redis supports three different modes:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># no: don&#x27;t fsync, just let the OS flush the data when it wants. Faster.</span></span><br><span class="line"><span class="comment"># always: fsync after every write to the append only log . Slow, Safest.</span></span><br><span class="line"><span class="comment"># everysec: fsync only one time every second. Compromise.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The default is &quot;everysec&quot;, as that&#x27;s usually the right compromise between</span></span><br><span class="line"><span class="comment"># speed and data safety. It&#x27;s up to you to understand if you can relax this to</span></span><br><span class="line"><span class="comment"># &quot;no&quot; that will let the operating system flush the output buffer when</span></span><br><span class="line"><span class="comment"># it wants, for better performances (but if you can live with the idea of</span></span><br><span class="line"><span class="comment"># some data loss consider the default persistence mode that&#x27;s snapshotting),</span></span><br><span class="line"><span class="comment"># or on the contrary, use &quot;always&quot; that&#x27;s very slow but a bit safer than</span></span><br><span class="line"><span class="comment"># everysec.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># More details please check the following article:</span></span><br><span class="line"><span class="comment"># http://antirez.com/post/redis-persistence-demystified.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If unsure, use &quot;everysec&quot;.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># appendfsync no</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># When the AOF fsync policy is set to always or everysec, and a background</span></span><br><span class="line"><span class="comment"># saving process (a background save or AOF log background rewriting) is</span></span><br><span class="line"><span class="comment"># performing a lot of I/O against the disk, in some Linux configurations</span></span><br><span class="line"><span class="comment"># Redis may block too long on the fsync() call. Note that there is no fix for</span></span><br><span class="line"><span class="comment"># this currently, as even performing fsync in a different thread will block</span></span><br><span class="line"><span class="comment"># our synchronous write(2) call.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In order to mitigate this problem it&#x27;s possible to use the following option</span></span><br><span class="line"><span class="comment"># that will prevent fsync() from being called in the main process while a</span></span><br><span class="line"><span class="comment"># BGSAVE or BGREWRITEAOF is in progress.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This means that while another child is saving, the durability of Redis is</span></span><br><span class="line"><span class="comment"># the same as &quot;appendfsync none&quot;. In practical terms, this means that it is</span></span><br><span class="line"><span class="comment"># possible to lose up to 30 seconds of log in the worst scenario (with the</span></span><br><span class="line"><span class="comment"># default Linux settings).</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># If you have latency problems turn this to &quot;yes&quot;. Otherwise leave it as</span></span><br><span class="line"><span class="comment"># &quot;no&quot; that is the safest pick from the point of view of durability.</span></span><br><span class="line"> </span><br><span class="line">no<span class="literal">-appendfsync</span><span class="literal">-on</span><span class="literal">-rewrite</span> no</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Automatic rewrite of the append only file.</span></span><br><span class="line"><span class="comment"># Redis is able to automatically rewrite the log file implicitly calling</span></span><br><span class="line"><span class="comment"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># This is how it works: Redis remembers the size of the AOF file after the</span></span><br><span class="line"><span class="comment"># latest rewrite (if no rewrite has happened since the restart, the size of</span></span><br><span class="line"><span class="comment"># the AOF at startup is used).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This base size is compared to the current size. If the current size is</span></span><br><span class="line"><span class="comment"># bigger than the specified percentage, the rewrite is triggered. Also</span></span><br><span class="line"><span class="comment"># you need to specify a minimal size for the AOF file to be rewritten, this</span></span><br><span class="line"><span class="comment"># is useful to avoid rewriting the AOF file even if the percentage increase</span></span><br><span class="line"><span class="comment"># is reached but it is still pretty small.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Specify a percentage of zero in order to disable the automatic AOF</span></span><br><span class="line"><span class="comment"># rewrite feature.</span></span><br><span class="line"> </span><br><span class="line">auto<span class="literal">-aof</span><span class="literal">-rewrite</span><span class="literal">-percentage</span> <span class="number">100</span></span><br><span class="line">auto<span class="literal">-aof</span><span class="literal">-rewrite</span><span class="literal">-min</span><span class="literal">-size</span> <span class="number">64</span>mb</span><br><span class="line"> </span><br><span class="line"><span class="comment">################################ LUA SCRIPTING  ###############################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Max execution time of a Lua script in milliseconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If the maximum execution time is reached Redis will log that a script is</span></span><br><span class="line"><span class="comment"># still in execution after the maximum allowed time and will start to</span></span><br><span class="line"><span class="comment"># reply to queries with an error.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># When a long running script exceed the maximum execution time only the</span></span><br><span class="line"><span class="comment"># SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be</span></span><br><span class="line"><span class="comment"># used to stop a script that did not yet called write commands. The second</span></span><br><span class="line"><span class="comment"># is the only way to shut down the server in the case a write commands was</span></span><br><span class="line"><span class="comment"># already issue by the script but the user don&#x27;t want to wait for the natural</span></span><br><span class="line"><span class="comment"># termination of the script.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set it to 0 or a negative value for unlimited execution without warnings.</span></span><br><span class="line">lua<span class="literal">-time</span><span class="literal">-limit</span> <span class="number">5000</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################ REDIS 集群  ###############################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 启用或停用集群</span></span><br><span class="line"><span class="comment"># cluster-enabled yes</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Every cluster node has a cluster configuration file. This file is not</span></span><br><span class="line"><span class="comment"># intended to be edited by hand. It is created and updated by Redis nodes.</span></span><br><span class="line"><span class="comment"># Every Redis Cluster node requires a different cluster configuration file.</span></span><br><span class="line"><span class="comment"># Make sure that instances running in the same system does not have</span></span><br><span class="line"><span class="comment"># overlapping cluster configuration file names.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># cluster-config-file nodes-6379.conf</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Cluster node timeout is the amount of milliseconds a node must be unreachable </span></span><br><span class="line"><span class="comment"># for it to be considered in failure state.</span></span><br><span class="line"><span class="comment"># Most other internal time limits are multiple of the node timeout.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># cluster-node-timeout 15000</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># A slave of a failing master will avoid to start a failover if its data</span></span><br><span class="line"><span class="comment"># looks too old.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is no simple way for a slave to actually have a exact measure of</span></span><br><span class="line"><span class="comment"># its &quot;data age&quot;, so the following two checks are performed:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) If there are multiple slaves able to failover, they exchange messages</span></span><br><span class="line"><span class="comment">#    in order to try to give an advantage to the slave with the best</span></span><br><span class="line"><span class="comment">#    replication offset (more data from the master processed).</span></span><br><span class="line"><span class="comment">#    Slaves will try to get their rank by offset, and apply to the start</span></span><br><span class="line"><span class="comment">#    of the failover a delay proportional to their rank.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2) Every single slave computes the time of the last interaction with</span></span><br><span class="line"><span class="comment">#    its master. This can be the last ping or command received (if the master</span></span><br><span class="line"><span class="comment">#    is still in the &quot;connected&quot; state), or the time that elapsed since the</span></span><br><span class="line"><span class="comment">#    disconnection with the master (if the replication link is currently down).</span></span><br><span class="line"><span class="comment">#    If the last interaction is too old, the slave will not try to failover</span></span><br><span class="line"><span class="comment">#    at all.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The point &quot;2&quot; can be tuned by user. Specifically a slave will not perform</span></span><br><span class="line"><span class="comment"># the failover if, since the last interaction with the master, the time</span></span><br><span class="line"><span class="comment"># elapsed is greater than:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   (node-timeout * slave-validity-factor) + repl-ping-slave-period</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># So for example if node-timeout is 30 seconds, and the slave-validity-factor</span></span><br><span class="line"><span class="comment"># is 10, and assuming a default repl-ping-slave-period of 10 seconds, the</span></span><br><span class="line"><span class="comment"># slave will not try to failover if it was not able to talk with the master</span></span><br><span class="line"><span class="comment"># for longer than 310 seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># A large slave-validity-factor may allow slaves with too old data to failover</span></span><br><span class="line"><span class="comment"># a master, while a too small value may prevent the cluster from being able to</span></span><br><span class="line"><span class="comment"># elect a slave at all.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For maximum availability, it is possible to set the slave-validity-factor</span></span><br><span class="line"><span class="comment"># to a value of 0, which means, that slaves will always try to failover the</span></span><br><span class="line"><span class="comment"># master regardless of the last time they interacted with the master.</span></span><br><span class="line"><span class="comment"># (However they&#x27;ll always try to apply a delay proportional to their</span></span><br><span class="line"><span class="comment"># offset rank).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Zero is the only value able to guarantee that when all the partitions heal</span></span><br><span class="line"><span class="comment"># the cluster will always be able to continue.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># cluster-slave-validity-factor 10</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Cluster slaves are able to migrate to orphaned masters, that are masters</span></span><br><span class="line"><span class="comment"># that are left without working slaves. This improves the cluster ability</span></span><br><span class="line"><span class="comment"># to resist to failures as otherwise an orphaned master can&#x27;t be failed over</span></span><br><span class="line"><span class="comment"># in case of failure if it has no working slaves.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Slaves migrate to orphaned masters only if there are still at least a</span></span><br><span class="line"><span class="comment"># given number of other working slaves for their old master. This number</span></span><br><span class="line"><span class="comment"># is the &quot;migration barrier&quot;. A migration barrier of 1 means that a slave</span></span><br><span class="line"><span class="comment"># will migrate only if there is at least 1 other working slave for its master</span></span><br><span class="line"><span class="comment"># and so forth. It usually reflects the number of slaves you want for every</span></span><br><span class="line"><span class="comment"># master in your cluster.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Default is 1 (slaves migrate only if their masters remain with at least</span></span><br><span class="line"><span class="comment"># one slave). To disable migration just set it to a very large value.</span></span><br><span class="line"><span class="comment"># A value of 0 can be set but is useful only for debugging and dangerous</span></span><br><span class="line"><span class="comment"># in production.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># cluster-migration-barrier 1</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># In order to setup your cluster make sure to read the documentation</span></span><br><span class="line"><span class="comment"># available at http://redis.io web site.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################################## SLOW LOG ###################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># The Redis Slow Log is a system to log queries that exceeded a specified</span></span><br><span class="line"><span class="comment"># execution time. The execution time does not include the I/O operations</span></span><br><span class="line"><span class="comment"># like talking with the client, sending the reply and so forth,</span></span><br><span class="line"><span class="comment"># but just the time needed to actually execute the command (this is the only</span></span><br><span class="line"><span class="comment"># stage of command execution where the thread is blocked and can not serve</span></span><br><span class="line"><span class="comment"># other requests in the meantime).</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># You can configure the slow log with two parameters: one tells Redis</span></span><br><span class="line"><span class="comment"># what is the execution time, in microseconds, to exceed in order for the</span></span><br><span class="line"><span class="comment"># command to get logged, and the other parameter is the length of the</span></span><br><span class="line"><span class="comment"># slow log. When a new command is logged the oldest one is removed from the</span></span><br><span class="line"><span class="comment"># queue of logged commands.</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># The following time is expressed in microseconds, so 1000000 is equivalent</span></span><br><span class="line"><span class="comment"># to one second. Note that a negative number disables the slow log, while</span></span><br><span class="line"><span class="comment"># a value of zero forces the logging of every command.</span></span><br><span class="line">slowlog<span class="literal">-log</span><span class="literal">-slower</span><span class="literal">-than</span> <span class="number">10000</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># There is no limit to this length. Just be aware that it will consume memory.</span></span><br><span class="line"><span class="comment"># You can reclaim memory used by the slow log with SLOWLOG RESET.</span></span><br><span class="line">slowlog<span class="literal">-max</span><span class="literal">-len</span> <span class="number">128</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">############################# Event notification ##############################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Redis can notify Pub/Sub clients about events happening in the key space.</span></span><br><span class="line"><span class="comment"># This feature is documented at http://redis.io/topics/keyspace-events</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># For instance if keyspace events notification is enabled, and a client</span></span><br><span class="line"><span class="comment"># performs a DEL operation on key &quot;foo&quot; stored in the Database 0, two</span></span><br><span class="line"><span class="comment"># messages will be published via Pub/Sub:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># PUBLISH __keyspace@0__:foo del</span></span><br><span class="line"><span class="comment"># PUBLISH __keyevent@0__:del foo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is possible to select the events that Redis will notify among a set</span></span><br><span class="line"><span class="comment"># of classes. Every class is identified by a single character:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  K     Keyspace events, published with __keyspace@&lt;db&gt;__ prefix.</span></span><br><span class="line"><span class="comment">#  E     Keyevent events, published with __keyevent@&lt;db&gt;__ prefix.</span></span><br><span class="line"><span class="comment">#  g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...</span></span><br><span class="line"><span class="comment">#  $     String commands</span></span><br><span class="line"><span class="comment">#  l     List commands</span></span><br><span class="line"><span class="comment">#  s     Set commands</span></span><br><span class="line"><span class="comment">#  h     Hash commands</span></span><br><span class="line"><span class="comment">#  z     Sorted set commands</span></span><br><span class="line"><span class="comment">#  x     Expired events (events generated every time a key expires)</span></span><br><span class="line"><span class="comment">#  e     Evicted events (events generated when a key is evicted for maxmemory)</span></span><br><span class="line"><span class="comment">#  A     Alias for g$lshzxe, so that the &quot;AKE&quot; string means all the events.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  The &quot;notify-keyspace-events&quot; takes as argument a string that is composed</span></span><br><span class="line"><span class="comment">#  by zero or multiple characters. The empty string means that notifications</span></span><br><span class="line"><span class="comment">#  are disabled at all.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Example: to enable list and generic events, from the point of view of the</span></span><br><span class="line"><span class="comment">#           event name, use:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  notify-keyspace-events Elg</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Example 2: to get the stream of the expired keys subscribing to channel</span></span><br><span class="line"><span class="comment">#             name __keyevent@0__:expired use:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  notify-keyspace-events Ex</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  By default all notifications are disabled because most users don&#x27;t need</span></span><br><span class="line"><span class="comment">#  this feature and the feature has some overhead. Note that if you don&#x27;t</span></span><br><span class="line"><span class="comment">#  specify at least one of K or E, no events will be delivered.</span></span><br><span class="line">notify<span class="literal">-keyspace</span><span class="literal">-events</span> <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">############################### ADVANCED CONFIG ###############################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Hashes are encoded using a memory efficient data structure when they have a</span></span><br><span class="line"><span class="comment"># small number of entries, and the biggest entry does not exceed a given</span></span><br><span class="line"><span class="comment"># threshold. These thresholds can be configured using the following directives.</span></span><br><span class="line">hash<span class="literal">-max</span><span class="literal">-ziplist</span><span class="literal">-entries</span> <span class="number">512</span></span><br><span class="line">hash<span class="literal">-max</span><span class="literal">-ziplist</span><span class="literal">-value</span> <span class="number">64</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Similarly to hashes, small lists are also encoded in a special way in order</span></span><br><span class="line"><span class="comment"># to save a lot of space. The special representation is only used when</span></span><br><span class="line"><span class="comment"># you are under the following limits:</span></span><br><span class="line">list<span class="literal">-max</span><span class="literal">-ziplist</span><span class="literal">-entries</span> <span class="number">512</span></span><br><span class="line">list<span class="literal">-max</span><span class="literal">-ziplist</span><span class="literal">-value</span> <span class="number">64</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Sets have a special encoding in just one case: when a set is composed</span></span><br><span class="line"><span class="comment"># of just strings that happens to be integers in radix 10 in the range</span></span><br><span class="line"><span class="comment"># of 64 bit signed integers.</span></span><br><span class="line"><span class="comment"># The following configuration setting sets the limit in the size of the</span></span><br><span class="line"><span class="comment"># set in order to use this special memory saving encoding.</span></span><br><span class="line"><span class="built_in">set-max</span><span class="literal">-intset</span><span class="literal">-entries</span> <span class="number">512</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Similarly to hashes and lists, sorted sets are also specially encoded in</span></span><br><span class="line"><span class="comment"># order to save a lot of space. This encoding is only used when the length and</span></span><br><span class="line"><span class="comment"># elements of a sorted set are below the following limits:</span></span><br><span class="line">z<span class="built_in">set-max</span><span class="literal">-ziplist</span><span class="literal">-entries</span> <span class="number">128</span></span><br><span class="line">z<span class="built_in">set-max</span><span class="literal">-ziplist</span><span class="literal">-value</span> <span class="number">64</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># HyperLogLog sparse representation bytes limit. The limit includes the</span></span><br><span class="line"><span class="comment"># 16 bytes header. When an HyperLogLog using the sparse representation crosses</span></span><br><span class="line"><span class="comment"># this limit, it is converted into the dense representation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># A value greater than 16000 is totally useless, since at that point the</span></span><br><span class="line"><span class="comment"># dense representation is more memory efficient.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># The suggested value is ~ 3000 in order to have the benefits of</span></span><br><span class="line"><span class="comment"># the space efficient encoding without slowing down too much PFADD,</span></span><br><span class="line"><span class="comment"># which is O(N) with the sparse encoding. The value can be raised to</span></span><br><span class="line"><span class="comment"># ~ 10000 when CPU is not a concern, but space is, and the data set is</span></span><br><span class="line"><span class="comment"># composed of many HyperLogLogs with cardinality in the 0 - 15000 range.</span></span><br><span class="line">hll<span class="literal">-sparse</span><span class="literal">-max</span><span class="literal">-bytes</span> <span class="number">3000</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in</span></span><br><span class="line"><span class="comment"># order to help rehashing the main Redis hash table (the one mapping top-level</span></span><br><span class="line"><span class="comment"># keys to values). The hash table implementation Redis uses (see dict.c)</span></span><br><span class="line"><span class="comment"># performs a lazy rehashing: the more operation you run into a hash table</span></span><br><span class="line"><span class="comment"># that is rehashing, the more rehashing &quot;steps&quot; are performed, so if the</span></span><br><span class="line"><span class="comment"># server is idle the rehashing is never complete and some more memory is used</span></span><br><span class="line"><span class="comment"># by the hash table.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># The default is to use this millisecond 10 times every second in order to</span></span><br><span class="line"><span class="comment"># active rehashing the main dictionaries, freeing memory when possible.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If unsure:</span></span><br><span class="line"><span class="comment"># use &quot;activerehashing no&quot; if you have hard latency requirements and it is</span></span><br><span class="line"><span class="comment"># not a good thing in your environment that Redis can reply form time to time</span></span><br><span class="line"><span class="comment"># to queries with 2 milliseconds delay.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># use &quot;activerehashing yes&quot; if you don&#x27;t have such hard requirements but</span></span><br><span class="line"><span class="comment"># want to free memory asap when possible.</span></span><br><span class="line">activerehashing yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># The client output buffer limits can be used to force disconnection of clients</span></span><br><span class="line"><span class="comment"># that are not reading data from the server fast enough for some reason (a</span></span><br><span class="line"><span class="comment"># common reason is that a Pub/Sub client can&#x27;t consume messages as fast as the</span></span><br><span class="line"><span class="comment"># publisher can produce them).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The limit can be set differently for the three different classes of clients:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># normal -&gt; normal clients</span></span><br><span class="line"><span class="comment"># slave  -&gt; slave clients and MONITOR clients</span></span><br><span class="line"><span class="comment"># pubsub -&gt; clients subscribed to at least one pubsub channel or pattern</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The syntax of every client-output-buffer-limit directive is the following:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># A client is immediately disconnected once the hard limit is reached, or if</span></span><br><span class="line"><span class="comment"># the soft limit is reached and remains reached for the specified number of</span></span><br><span class="line"><span class="comment"># seconds (continuously).</span></span><br><span class="line"><span class="comment"># So for instance if the hard limit is 32 megabytes and the soft limit is</span></span><br><span class="line"><span class="comment"># 16 megabytes / 10 seconds, the client will get disconnected immediately</span></span><br><span class="line"><span class="comment"># if the size of the output buffers reach 32 megabytes, but will also get</span></span><br><span class="line"><span class="comment"># disconnected if the client reaches 16 megabytes and continuously overcomes</span></span><br><span class="line"><span class="comment"># the limit for 10 seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default normal clients are not limited because they don&#x27;t receive data</span></span><br><span class="line"><span class="comment"># without asking (in a push way), but just after a request, so only</span></span><br><span class="line"><span class="comment"># asynchronous clients may create a scenario where data is requested faster</span></span><br><span class="line"><span class="comment"># than it can read.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Instead there is a default limit for pubsub and slave clients, since</span></span><br><span class="line"><span class="comment"># subscribers and slaves receive data in a push fashion.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Both the hard or the soft limit can be disabled by setting them to zero.</span></span><br><span class="line">client<span class="literal">-output</span><span class="literal">-buffer</span><span class="literal">-limit</span> normal <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">client<span class="literal">-output</span><span class="literal">-buffer</span><span class="literal">-limit</span> slave <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line">client<span class="literal">-output</span><span class="literal">-buffer</span><span class="literal">-limit</span> pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Redis calls an internal function to perform many background tasks, like</span></span><br><span class="line"><span class="comment"># closing connections of clients in timeout, purging expired keys that are</span></span><br><span class="line"><span class="comment"># never requested, and so forth.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Not all tasks are performed with the same frequency, but Redis checks for</span></span><br><span class="line"><span class="comment"># tasks to perform accordingly to the specified &quot;hz&quot; value.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># By default &quot;hz&quot; is set to 10. Raising the value will use more CPU when</span></span><br><span class="line"><span class="comment"># Redis is idle, but at the same time will make Redis more responsive when</span></span><br><span class="line"><span class="comment"># there are many keys expiring at the same time, and timeouts may be</span></span><br><span class="line"><span class="comment"># handled with more precision.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The range is between 1 and 500, however a value over 100 is usually not</span></span><br><span class="line"><span class="comment"># a good idea. Most users should use the default of 10 and raise this up to</span></span><br><span class="line"><span class="comment"># 100 only in environments where very low latency is required.</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># When a child rewrites the AOF file, if the following option is enabled</span></span><br><span class="line"><span class="comment"># the file will be fsync-ed every 32 MB of data generated. This is useful</span></span><br><span class="line"><span class="comment"># in order to commit the file to the disk more incrementally and avoid</span></span><br><span class="line"><span class="comment"># big latency spikes.</span></span><br><span class="line">aof<span class="literal">-rewrite</span><span class="literal">-incremental</span><span class="literal">-fsync</span> yes</span><br></pre></td></tr></table></figure>

<h4 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h4><h5 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h5><p><img src="/2021/08/10/redis/image-20220323135334468.png" alt="./redis"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.docker 启动redis镜像</span></span><br><span class="line">mkdir <span class="literal">-p</span> /myredis/<span class="keyword">data</span>/</span><br><span class="line">mkdir <span class="literal">-p</span> /myredis/conf/</span><br><span class="line">vim redis.conf <span class="comment"># 写入redis配置文件</span></span><br><span class="line">docker run <span class="literal">-p</span> <span class="number">6379</span>:<span class="number">6379</span> -<span class="literal">-name</span> redis <span class="literal">-v</span> /myredis/<span class="keyword">data</span>:/<span class="keyword">data</span> <span class="literal">-v</span> /myredis/conf/redis.conf:/usr/local/etc/redis/redis.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-server</span> /usr/local/etc/redis/redis.conf </span><br><span class="line">docker exec <span class="literal">-it</span> redis sh</span><br><span class="line">redis<span class="literal">-cli</span></span><br><span class="line">auth Foda2022</span><br><span class="line"><span class="comment">#2.redis.conf 中rdb保存机制</span></span><br><span class="line">save <span class="number">20</span> <span class="number">3</span> <span class="comment"># 20秒之内保证有3个key发生变化就做持久化操作</span></span><br><span class="line"><span class="comment">#3.rdb恢复</span></span><br><span class="line"><span class="comment"># 关闭redis服务</span></span><br><span class="line"><span class="comment"># 备份文件拷贝到工作目录下改名为dump.rdb</span></span><br><span class="line"><span class="comment"># 启动redis，备份数据会直接加载</span></span><br><span class="line"><span class="comment">#4 rdb优势</span></span><br><span class="line">  <span class="comment"># 适合大规模的数据恢复</span></span><br><span class="line">  <span class="comment"># 对数据完整性和一致性要求不高更适合使用</span></span><br><span class="line">  <span class="comment"># 节省磁盘空间</span></span><br><span class="line">  <span class="comment"># 恢复速度更快</span></span><br><span class="line"><span class="comment">#5 rdb劣势</span></span><br><span class="line"> <span class="comment"># fork的时候使用（写时拷贝技术），内存中的数据被克隆了一份，会导致2倍的膨胀，如果数据庞大是比较消耗性能</span></span><br><span class="line"> <span class="comment"># 在备份周期间隔时间内做一次备份，但在服务宕机的时候可能最后一次数据会丢失</span></span><br></pre></td></tr></table></figure>

<h5 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h5><p><img src="/2021/08/10/redis/image-20220323164438938.png" alt="./redis"></p>
<ul>
<li>AOF默认不开启，如果同时开启AOF和RDB，系统默认取AOF数据</li>
<li>AOF的备份机制和性能虽然和RDB不同，但是备份和恢复的操作同RDB一样，都是拷贝备份文件，需要恢复的时候拷贝到工作目录，启动系统加载（config get dir 可查看工作目录）</li>
<li>redis-check-aof –fix appendonly.aof (修复AOF文件)</li>
<li>AOF同步频率设置</li>
<li><img src="/2021/08/10/redis/image-20220323170118182.png" alt="redis"></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">AOF持久化流程</span><br><span class="line"><span class="number">1</span>) 客户端的请求写命令会被append追加到AOF缓存区内</span><br><span class="line"><span class="number">2</span>) AOF缓存区会根据AOF持久化策略【always、everysec、no】将操作sync同步到磁盘的AOF文件中</span><br><span class="line"><span class="number">3</span>) AOF文件大小超过重写策略或手动重写时，会将AOF文件rewrite重写，压缩AOF文件容量</span><br><span class="line"><span class="number">4</span>）redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复目的</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优势</span></span><br><span class="line"><span class="number">1</span>) 备份机制更稳健,丢失数据概率很低</span><br><span class="line"><span class="number">2</span>) 可读的日志文本，通过操作AOF文件，可以处理误操作</span><br><span class="line"><span class="comment"># 劣势</span></span><br><span class="line"><span class="number">1</span>) 比起RDB更占用磁盘空间</span><br><span class="line"><span class="number">2</span>) 恢复速度要慢</span><br><span class="line"><span class="number">3</span>) 每次读写同步的话，有性能压力</span><br></pre></td></tr></table></figure>

<h4 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h4><ul>
<li>读写分离，性能扩展</li>
<li>容灾的快速恢复</li>
</ul>
<p><img src="/2021/08/10/redis/image-20220323171518500.png" alt="redis"></p>
<p><code>过程原理</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 当从库和主库建立MS关系后，会向主数据库发送SYNC命令</span><br><span class="line"><span class="number">2.</span> 主库接收到SYNC命令后会开始在后台保存快照(RDB持久化过程)，并将期间接收到的写命令缓存起来</span><br><span class="line"><span class="number">3.</span> 当快照完成后，主Redis会将快照文件和所有缓存的写命令发送给从Redis</span><br><span class="line"><span class="number">4.</span> 从Redis接收到后，会载入快照文件并且执行收到的缓存的命令</span><br><span class="line"><span class="number">5.</span> 之后，主Redis每当接收到写命令时就会将命令发送从Redis，从而保证数据的一致</span><br></pre></td></tr></table></figure>

<p><code>redis1.conf</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#允许远程连接</span></span><br><span class="line">bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">port <span class="number">6379</span></span><br><span class="line"><span class="comment"># 关闭保护模式</span></span><br><span class="line">protected-mode no</span><br><span class="line"><span class="comment"># 让redis服务后台运行(因为使用docker启动时使用了-d参数，所以需要设置为no, 非docker设置为yes)</span></span><br><span class="line">daemonize no</span><br><span class="line"><span class="comment"># 设定密码(可选，如果这里开启了密码要求，slave的配置里masterauth就要加这个密码)</span></span><br><span class="line">requirepass Foda2022</span><br><span class="line">logfile <span class="string">&quot;/var/tmp/redis.log&quot;</span></span><br><span class="line"><span class="comment"># 从机需要设置该参数 (redis2.conf和redis3.conf需要将masterip设置为#主机的公网或者局域网ip，port)</span></span><br><span class="line"><span class="comment">#replicaof &lt;masterip&gt; &lt;masterport&gt;</span></span><br><span class="line"><span class="comment"># masterauth &lt;master-password&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>redis2.conf</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bind <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">port <span class="number">6380</span></span><br><span class="line">protected<span class="literal">-mode</span> no</span><br><span class="line">daemonize no</span><br><span class="line">requirepass Foda2022</span><br><span class="line">logfile <span class="string">&quot;/var/tmp/redis.log&quot;</span></span><br><span class="line">replicaof <span class="number">192.168</span>.<span class="number">17.6</span> <span class="number">6379</span></span><br><span class="line">masterauth Foda2022</span><br></pre></td></tr></table></figure>

<p><code>redis3.conf</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bind <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">port <span class="number">6381</span></span><br><span class="line">protected<span class="literal">-mode</span> no</span><br><span class="line">daemonize no</span><br><span class="line">requirepass Foda2022</span><br><span class="line">logfile <span class="string">&quot;/var/tmp/redis.log&quot;</span></span><br><span class="line">replicaof <span class="number">192.168</span>.<span class="number">17.6</span> <span class="number">6379</span></span><br><span class="line">masterauth Foda2022</span><br></pre></td></tr></table></figure>

<p><code>启动服务</code></p>
<ul>
<li><p><img src="/2021/08/10/redis/image-20220324113126161.png" alt="redis"></p>
</li>
<li><p>进入redis2容器查看主从复制信息如下</p>
</li>
<li><p><img src="/2021/08/10/redis/image-20220324113222881.png" alt="redis"></p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-p</span> <span class="number">6379</span>:<span class="number">6379</span> -<span class="literal">-name</span> redis1  <span class="literal">-v</span> /myredis/conf/redis1.conf:/usr/local/etc/redis/redis.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-server</span>  /usr/local/etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run <span class="literal">-p</span> <span class="number">6380</span>:<span class="number">6380</span> -<span class="literal">-name</span> redis2  <span class="literal">-v</span> /myredis/conf/redis2.conf:/usr/local/etc/redis/redis.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-server</span>  /usr/local/etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run <span class="literal">-p</span> <span class="number">6381</span>:<span class="number">6381</span> -<span class="literal">-name</span> redis3  <span class="literal">-v</span> /myredis/conf/redis3.conf:/usr/local/etc/redis/redis.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-server</span>  /usr/local/etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="哨兵"><a href="#哨兵" class="headerlink" title="哨兵"></a>哨兵</h4><p><img src="/2021/08/10/redis/007S8ZIlgy1gixi1z4m1uj30nj0j9dps.jpg" alt="redis"></p>
<ul>
<li>集群监控：负责监控 redis master 和 slave 进程是否正常工作。</li>
<li>消息通知：如果某个 redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员</li>
<li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上</li>
<li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。</li>
</ul>
<p><code>配置哨兵</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/redis-stable/sentinel.conf</span><br><span class="line">cp sentinel.conf sentinel1.conf</span><br><span class="line">cp sentinel.conf sentinel2.conf</span><br><span class="line">cp sentinel.conf sentinel3.conf</span><br></pre></td></tr></table></figure>

<p><code>修改配置内容</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主端口为(26379,两个从设置为26380，26381)</span></span><br><span class="line">port <span class="number">26379</span></span><br><span class="line"><span class="comment"># 让sentinel服务后台运行</span></span><br><span class="line">daemonize no </span><br><span class="line">pidfile /var/run/redis<span class="literal">-sentinel</span>.pid</span><br><span class="line"><span class="comment"># 修改日志文件的路径</span></span><br><span class="line">logfile <span class="string">&quot;/var/tmp/sentinel.log&quot;</span></span><br><span class="line"><span class="comment"># 修改监控的主redis服务器</span></span><br><span class="line"><span class="comment"># 最后一个2表示，两台机器判定主被动下线后，就进行failover(故障转移)</span></span><br><span class="line">sentinel monitor mymaster <span class="number">192.168</span>.<span class="number">17.6</span> <span class="number">6379</span> <span class="number">2</span></span><br><span class="line">sentinel auth<span class="literal">-pass</span> mymaster Foda2022</span><br><span class="line"><span class="comment"># Default is 30 seconds.(30秒没连接maste视为宕机)</span></span><br><span class="line">sentinel down<span class="literal">-after</span><span class="literal">-milliseconds</span> mymaster <span class="number">30000</span></span><br><span class="line"><span class="comment">#SENTINEL resolve-hostnames no</span></span><br><span class="line"><span class="comment">#SENTINEL announce-hostnames no</span></span><br></pre></td></tr></table></figure>

<p><code>启动三个哨兵</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -<span class="literal">-name</span> sentinel1  <span class="literal">-v</span> /myredis/conf/sentinel1.conf:/usr/local/etc/redis/sentinel.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-sentinel</span>  /usr/local/etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line">docker run -<span class="literal">-name</span> sentinel2  <span class="literal">-v</span> /myredis/conf/sentinel2.conf:/usr/local/etc/redis/sentinel.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-sentinel</span>  /usr/local/etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line">docker run -<span class="literal">-name</span> sentinel3  <span class="literal">-v</span> /myredis/conf/sentinel3.conf:/usr/local/etc/redis/sentinel.conf <span class="literal">-d</span> redis:<span class="number">6.0</span> redis<span class="literal">-sentinel</span>  /usr/local/etc/redis/sentinel.conf</span><br></pre></td></tr></table></figure>

<p><code>模拟主redis服务宕机</code></p>
<ul>
<li>主服务宕机故障转移，redis3变为主</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker stop redis1</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker exec -it sentinel1 sh</span></span><br><span class="line"><span class="comment"># redis-cli -p 26379</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">26379</span>&gt; info sentinel</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:<span class="number">1</span></span><br><span class="line">sentinel_tilt:<span class="number">0</span></span><br><span class="line">sentinel_running_scripts:<span class="number">0</span></span><br><span class="line">sentinel_scripts_queue_length:<span class="number">0</span></span><br><span class="line">sentinel_simulate_failure_flags:<span class="number">0</span></span><br><span class="line">master0:name=mymaster,status=ok,address=<span class="number">172.17</span>.<span class="number">0.1</span>:<span class="number">6381</span>,slaves=<span class="number">2</span>,sentinels=<span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><code>master redis3详情</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span>&gt; <span class="built_in">set</span> name sentinel</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span>&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:<span class="number">1</span></span><br><span class="line">slave0:ip=<span class="number">172.17</span>.<span class="number">0.1</span>,port=<span class="number">6380</span>,state=online,offset=<span class="number">1348727</span>,lag=<span class="number">1</span></span><br><span class="line">master_replid:<span class="number">2</span>e3cecb5d932bd40113017cdf480fc7cdbd5278f</span><br><span class="line">master_replid2:d7460d1bc769e2622b98f1793c22caa096800803</span><br><span class="line">master_repl_offset:<span class="number">1348997</span></span><br><span class="line">second_repl_offset:<span class="number">98086</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">300422</span></span><br><span class="line">repl_backlog_histlen:<span class="number">1048576</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span>&gt;</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span>&gt;</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span>&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:<span class="number">2</span></span><br><span class="line">slave0:ip=<span class="number">172.17</span>.<span class="number">0.1</span>,port=<span class="number">6380</span>,state=online,offset=<span class="number">1419575</span>,lag=<span class="number">1</span></span><br><span class="line">slave1:ip=<span class="number">172.17</span>.<span class="number">0.1</span>,port=<span class="number">6379</span>,state=online,offset=<span class="number">1419170</span>,lag=<span class="number">1</span></span><br><span class="line">master_replid:<span class="number">2</span>e3cecb5d932bd40113017cdf480fc7cdbd5278f</span><br><span class="line">master_replid2:d7460d1bc769e2622b98f1793c22caa096800803</span><br><span class="line">master_repl_offset:<span class="number">1419575</span></span><br><span class="line">second_repl_offset:<span class="number">98086</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">371000</span></span><br><span class="line">repl_backlog_histlen:<span class="number">1048576</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6381</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>重新启动redis1</code></p>
<ul>
<li>由于之前redis主从设置的有登录认证密码，所以需要在redis1配置文件中打开masterauth </li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># docker exec -it redis1 sh</span></span><br><span class="line"><span class="comment"># redis-cli</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; auth Foda2022</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;k2&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;k1&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;k3&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:<span class="number">172.17</span>.<span class="number">0.1</span></span><br><span class="line">master_port:<span class="number">6381</span></span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:<span class="number">1</span></span><br><span class="line">master_sync_in_progress:<span class="number">0</span></span><br><span class="line">slave_repl_offset:<span class="number">1415902</span></span><br><span class="line">slave_priority:<span class="number">100</span></span><br><span class="line">slave_read_only:<span class="number">1</span></span><br><span class="line">connected_slaves:<span class="number">0</span></span><br><span class="line">master_replid:<span class="number">2</span>e3cecb5d932bd40113017cdf480fc7cdbd5278f</span><br><span class="line">master_replid2:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line">master_repl_offset:<span class="number">1415902</span></span><br><span class="line">second_repl_offset:<span class="literal">-1</span></span><br><span class="line">repl_backlog_active:<span class="number">1</span></span><br><span class="line">repl_backlog_size:<span class="number">1048576</span></span><br><span class="line">repl_backlog_first_byte_offset:<span class="number">1410168</span></span><br><span class="line">repl_backlog_histlen:<span class="number">5735</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><ul>
<li><p><strong>缓存穿透</strong>是指缓存和数据库中都没有的数据，导致所有的请求都落到数据库上，造成数据库短时间内承受大量请求而崩掉</p>
</li>
<li><p><img src="/2021/08/10/redis/image-20220627153455984.png" alt="redis"></p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决方案</span></span><br><span class="line"><span class="number">1.</span> 接口层增加校验，如用户鉴权校验，<span class="built_in">id</span>做基础校验，<span class="built_in">id</span>&lt;=<span class="number">0</span>的直接拦截；</span><br><span class="line"><span class="number">2.</span> 从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如<span class="number">30</span>秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个<span class="built_in">id</span>暴力攻击</span><br><span class="line"><span class="number">3.</span> 采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的 bitmap 中，一个一定不存在的数据会被这个 bitmap 拦截掉，从而避免了对底层存储系统的查询压力</span><br></pre></td></tr></table></figure>

<h4 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h4><ul>
<li><p><strong>缓存击穿</strong>是指缓存中没有但数据库中有的数据（一般是缓存时间到期），这时由于并发用户特别多，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力。和缓存雪崩不同的是，缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库</p>
</li>
<li><p><img src="/2021/08/10/redis/image-20220627154843413.png" alt="redis"></p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决方案</span></span><br><span class="line"><span class="number">1.</span> 设置热点数据永远不过期。</span><br><span class="line"><span class="number">2.</span> 加互斥锁，互斥锁</span><br></pre></td></tr></table></figure>

<h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><ul>
<li><strong>缓存雪崩</strong>是指缓存同一时间大面积的失效，所以，后面的请求都会落到数据库上，造成数据库短时间内承受大量请求而崩掉</li>
<li> <img src="/2021/08/10/redis/image-20220627155212515.png" alt="redis"></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决方案</span></span><br><span class="line"><span class="number">1.</span> 缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。</span><br><span class="line"><span class="number">2.</span> 一般并发量不是特别多的时候，使用最多的解决方案是加锁排队。</span><br><span class="line"><span class="number">3.</span> 给每一个缓存数据增加相应的缓存标记，记录缓存的是否失效，如果缓存标记失效，则更新数据缓存。</span><br></pre></td></tr></table></figure>



<h4 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h4><ul>
<li>redis-py默认在执行每次请求都会创建（连接池申请连接）和断开（归还连接池）一次连接操作，如果想要在一次请求中指定多个命令，则可以使用pipline实现一次请求指定多个命令，并且默认情况下一次pipline 是原子性操作</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">pool = redis.ConnectionPool(host=<span class="string">&#x27;192.168.17.210&#x27;</span>, port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line">r = redis.Redis(connection_pool=pool)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pipe = r.pipeline(transaction=False)</span></span><br><span class="line">pipe = r.pipeline(transaction=<span class="literal">True</span>)</span><br><span class="line">pipe.multi()</span><br><span class="line">pipe.<span class="built_in">set</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line">pipe.<span class="built_in">set</span>(<span class="string">&#x27;role&#x27;</span>, <span class="string">&#x27;sb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pipe.execute()</span><br></pre></td></tr></table></figure>

<h4 id="diango中使用"><a href="#diango中使用" class="headerlink" title="diango中使用"></a>diango中使用</h4><p><strong>utils文件夹下的redis_pool.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">POOL = redis.ConnectionPool(host=<span class="string">&#x27;192.168.17.210&#x27;</span>, port=<span class="number">6379</span>, max_connections=<span class="number">1000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>views.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"><span class="keyword">from</span> utils.redis_pool <span class="keyword">import</span> POOL</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    conn = redis.Redis(connection_pool=POOL)</span><br><span class="line">    conn.hset(<span class="string">&#x27;kkk&#x27;</span>, <span class="string">&#x27;age&#x27;</span>, <span class="number">18</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;设置成功&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span>(<span class="params">request</span>):</span></span><br><span class="line">    conn = redis.Redis(connection_pool=POOL)</span><br><span class="line">    conn.hget(<span class="string">&#x27;kkk&#x27;</span>, <span class="string">&#x27;age&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;获取成功&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>方式二</strong></p>
<ul>
<li>安装django-redis</li>
<li>settings.py配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis配置</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LOCATION&quot;</span>: <span class="string">&quot;redis://127.0.0.1:6379&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CONNECTION_POOL_KWARGS&quot;</span>: &#123;<span class="string">&quot;max_connections&quot;</span>: <span class="number">100</span>&#125;</span><br><span class="line">            <span class="comment"># &quot;PASSWORD&quot;: &quot;123&quot;,</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>views.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">request</span>):</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(conn.hgetall(<span class="string">&#x27;kkk&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;ok&#x27;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/" class="post-title-link" itemprop="url">linux部署mongodb</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-09 16:00:31" itemprop="dateCreated datePublished" datetime="2021-08-09T16:00:31+08:00">2021-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-23 11:34:50" itemprop="dateModified" datetime="2022-08-23T11:34:50+08:00">2022-08-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">打开网站 https://www.mongodb.com/download-center/community查找与Linux版本一致的MongoDB安装包</span><br><span class="line">可用 wget + 下载地址下载</span><br></pre></td></tr></table></figure>

<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- 解压</span><br><span class="line">tar -zxvf mongodb-linux-x86_64-rhel70-<span class="number">4.2</span><span class="number">.3</span>.tgz</span><br><span class="line"></span><br><span class="line">- 将解压后的目录剪切到一个新目录 mongodb</span><br><span class="line">mv mongodb-linux-x86_64-rhel70-<span class="number">4.2</span><span class="number">.3</span> mongodb</span><br></pre></td></tr></table></figure>

<h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- 创建数据库目录</span><br><span class="line">cd mongodb</span><br><span class="line">mkdir -p data/db</span><br><span class="line"></span><br><span class="line">- 创建日志目录</span><br><span class="line">mkdir log</span><br><span class="line"></span><br><span class="line">- 创建配置文件目录</span><br><span class="line">mkdir etc</span><br><span class="line">vim ./etc/mongodb.conf</span><br><span class="line"></span><br><span class="line">- 在新建的mongodb.conf输入下面内容</span><br><span class="line">dbpath=/root/mongodb/data/db  <span class="comment">#数据文件存放目录</span></span><br><span class="line">logpath=/root/mongodb/log/mongodb.log   <span class="comment">#日志文件</span></span><br><span class="line">logappend=true  <span class="comment">#错误日志采用追加模式</span></span><br><span class="line">port=<span class="number">27017</span>   <span class="comment">#端口</span></span><br><span class="line">fork=true    <span class="comment">#以守护程序的方式启用，即在后台运行</span></span><br><span class="line">journal=true  <span class="comment">#启用日志文件，默认启用</span></span><br><span class="line">quiet=true  <span class="comment">#这个选项可以过滤掉一些无用的日志信息，若需要调试使用请设置为false</span></span><br><span class="line"><span class="comment">#auth=true #需要认证。如果放开注释，就必须创建MongoDB的账号，使用账号与密码才可远程访问，第一次安装建议注释</span></span><br><span class="line"><span class="comment">#bind_ip=0.0.0.0 #允许远程访问，或者直接注释，127.0.0.1是只允许本地访问</span></span><br></pre></td></tr></table></figure>

<h4 id="启动MongoDB"><a href="#启动MongoDB" class="headerlink" title="启动MongoDB"></a>启动MongoDB</h4><p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210809155244709.png" alt="linux部署mongodb"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- 在/root/mongodb/<span class="built_in">bin</span>工作目录下执行下面命令开始启动Mongodb</span><br><span class="line">cd <span class="built_in">bin</span></span><br><span class="line">pwd</span><br><span class="line">./mongod --config /root/mongodb/etc/mongodb.conf</span><br><span class="line">netstat -lanp | grep <span class="string">&quot;27017&quot;</span></span><br><span class="line">ps -ef | grep mongo</span><br><span class="line"></span><br><span class="line">- 关闭服务</span><br><span class="line">[root@localhost <span class="built_in">bin</span>]<span class="comment"># ./mongod -f ../etc/mongodb.conf --shutdown</span></span><br></pre></td></tr></table></figure>

<h4 id="创建MongoDB账号"><a href="#创建MongoDB账号" class="headerlink" title="创建MongoDB账号"></a>创建MongoDB账号</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mongodb]<span class="comment"># cd bin</span></span><br><span class="line">[root@localhost <span class="built_in">bin</span>]<span class="comment"># ./mongo   # 启动服务</span></span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   <span class="number">0.000</span>GB</span><br><span class="line">config  <span class="number">0.000</span>GB</span><br><span class="line">local   <span class="number">0.000</span>GB</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line"></span><br><span class="line">&gt; db.createUser(&#123; user: <span class="string">&#x27;root&#x27;</span>, pwd: <span class="string">&#x27;1018&#x27;</span>,roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125;] &#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">&quot;user&quot;</span> : <span class="string">&quot;root&quot;</span>,</span><br><span class="line">	<span class="string">&quot;roles&quot;</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;role&quot;</span> : <span class="string">&quot;root&quot;</span>,</span><br><span class="line">			<span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用auth=true认证(需要在配置文件中添加auth=true，然后停止服务重启服务)</span></span><br><span class="line">&gt; db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;1018&#x27;</span>)</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; show dbs</span><br><span class="line">&gt; db</span><br><span class="line">admin</span><br><span class="line">&gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">&gt; db.firstCollection.save(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lhj&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="string">&quot;25&quot;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nInserted&quot;</span> : <span class="number">1</span> &#125;)</span><br><span class="line">&gt; db.firstCollection.find(&#123;name:<span class="string">&quot;lhj&quot;</span>&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;611223f00e0a6be033a22c84&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;lhj&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="string">&quot;25&quot;</span> &#125;</span><br><span class="line">&gt; </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">- 关闭mongo服务  </span><br><span class="line">&gt; db.shutdownServer()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">&gt; use admin</span><br><span class="line"></span><br><span class="line">db.createUser(</span><br><span class="line">	&#123;</span><br><span class="line">		user:<span class="string">&quot;root&quot;</span>,</span><br><span class="line">		pwd:<span class="string">&quot;1018&quot;</span>,</span><br><span class="line">		roles:[&#123;role:<span class="string">&quot;root&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;]</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改密码</span></span><br><span class="line">方法<span class="number">1</span>：db.changeUserPassword(<span class="string">&quot;usertest&quot;</span>,<span class="string">&quot;changepass&quot;</span>);</span><br><span class="line"></span><br><span class="line">方法<span class="number">2</span>：db.updateUser(<span class="string">&quot;usertest&quot;</span>,&#123;pwd:<span class="string">&quot;changepass1&quot;</span>&#125;)；</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改用户权限</span></span><br><span class="line">db.updateUser(<span class="string">&quot;root&quot;</span>,&#123;roles:[ &#123;role:<span class="string">&quot;root&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125; ]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">db.dropUser(<span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line"></span><br><span class="line">- 这时候MongoDB的admin数据库就有了账号，启用auth=true，重启后，再连接就需要账号密码授权了</span><br><span class="line"></span><br><span class="line">数据库用户角色：read、readWrite;</span><br><span class="line">数据库管理角色：dbAdmin、dbOwner、userAdmin；</span><br><span class="line">集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManager；</span><br><span class="line">备份恢复角色：backup、restore；</span><br><span class="line">所有数据库角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase</span><br><span class="line">超级用户角色：root；这里还有几个角色间接或直接提供了系统超级用户的访问（dbOwner 、userAdmin、userAdminAnyDatabase）</span><br><span class="line">内部角色：__system</span><br><span class="line"></span><br><span class="line">Read：允许用户读取指定数据库</span><br><span class="line">readWrite：允许用户读写指定数据库</span><br><span class="line">dbAdmin：允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile</span><br><span class="line">userAdmin：允许用户向system.users集合写入，可以找指定数据库里创建、删除和管理用户</span><br><span class="line">clusterAdmin：只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限。</span><br><span class="line">readAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读权限</span><br><span class="line">readWriteAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读写权限</span><br><span class="line">userAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的userAdmin权限</span><br><span class="line">dbAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限。</span><br><span class="line">root：只在admin数据库中可用。超级账号，超级权限</span><br><span class="line">dbOwner:代表数据库所有者角色，拥有最高该数据库最高权限</span><br></pre></td></tr></table></figure>

<h4 id="防火墙端口开放"><a href="#防火墙端口开放" class="headerlink" title="防火墙端口开放"></a>防火墙端口开放</h4><ul>
<li><strong>如果外网ip不能访问、也就是客户端无法连接，可能是需要放行防火墙端口</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">systemctl start firewalld  <span class="comment"># 开启防火墙</span></span><br><span class="line"></span><br><span class="line">systemctl status firewalld <span class="comment"># 防火墙状态</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --add-port=<span class="number">27017</span>/tcp --permanent <span class="comment"># 设置防火墙mongo放行端口(–permanent代表永久开启)</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --reload <span class="comment"># 重启防火墙</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --<span class="built_in">list</span>-ports <span class="comment"># 查看防火墙放行端口</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --remove-port=<span class="number">27017</span>/tcp --permanent  <span class="comment"># 关闭防火墙端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启设置防火墙</span></span><br><span class="line">（<span class="number">1</span>）设置开机启用防火墙：systemctl enable firewalld.service</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）设置开机禁用防火墙：systemctl disable firewalld.service</span><br><span class="line"></span><br><span class="line">–zone <span class="comment">#作用域</span></span><br><span class="line">–add-port=<span class="number">9200</span>/tcp <span class="comment">#添加端口，格式为：端口/通讯协议</span></span><br><span class="line">–permanent <span class="comment">#永久生效，没有此参数重启后失效</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加端口后，必须用命令firewall-cmd --reload重新加载一遍才会生效</span></span><br></pre></td></tr></table></figure>



<h4 id="本地配置MongoDB服务"><a href="#本地配置MongoDB服务" class="headerlink" title="本地配置MongoDB服务"></a>本地配置MongoDB服务</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- 本地MongoDB路径：D:\MongoDB\Server\<span class="number">3.4</span></span><br><span class="line">	- 创建data文件夹</span><br><span class="line">    - 创建mongo.config(config文件可以先创建txt保存全部类型后更改为config)</span><br><span class="line">    - 进入data文件夹</span><br><span class="line">    - 创建log -&gt; mongo.log</span><br><span class="line">    - 创建db</span><br><span class="line">    - mongo.config 文件内容如下</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    dbpath=D:\MongoDB\Server\3.4\data\db</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	logpath=D:\MongoDB\Server\3.4\data\log\mongo.log</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    - cmd以管理员身份进入 d:</span><br><span class="line">    - cd D:\MongoDB\Server\<span class="number">3.4</span>\<span class="built_in">bin</span></span><br><span class="line">    - mongod.exe --config D:\MongoDB\Server\<span class="number">3.4</span>\mongo.config --install --serviceName <span class="string">&quot;MongoDB&quot;</span></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="测试本地连接"><a href="#测试本地连接" class="headerlink" title="测试本地连接"></a>测试本地连接</h4><p><strong>新建连接</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.nosqlbooster.com/downloads">https://www.nosqlbooster.com/downloads</a></li>
</ul>
<p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210810151512618.png" alt="linux部署mongodb"></p>
<p><strong>开启认证</strong></p>
<p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210810151601249.png" alt="linux部署mongodb"></p>
<p><strong>默认的库</strong></p>
<p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210810151724375.png" alt="linux部署mongodb"></p>
<p><strong>查看数据</strong></p>
<p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210810152113408.png" alt="linux部署mongodb"></p>
<h4 id="python连接"><a href="#python连接" class="headerlink" title="python连接"></a>python连接</h4><ul>
<li><p>pip3 install pymongo</p>
</li>
<li><p>无密码</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line">client = MongoClient(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">27017</span>)  <span class="comment"># 建立客户端对象</span></span><br><span class="line">db = client.mydb  <span class="comment"># 连接mydb数据库，没有则自动创建</span></span><br><span class="line">collection = db.testset   <span class="comment"># 使用mydb下的testset集合，没有则自动创建</span></span><br><span class="line">collection.insert_one(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lxx&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>&#125;)   <span class="comment"># 插入一条数据，如果没出错那么说明连接成功</span></span><br><span class="line"><span class="comment"># 下面是遍历查询数据</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> collection.find():</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>

<ul>
<li>有密码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接mydb数据库,账号密码认证</span></span><br><span class="line">db = client.admin  </span><br><span class="line">db.authenticate(<span class="string">&quot;root&quot;</span>, <span class="string">&#x27;1018&#x27;</span>, mechanism=<span class="string">&#x27;SCRAM-SHA-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">collection = db.myset  <span class="comment"># admin下的myset，没有则新建</span></span><br><span class="line">collection.insert_one(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;lxx&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> collection.find():</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="pymongo简单使用"><a href="#pymongo简单使用" class="headerlink" title="pymongo简单使用"></a>pymongo简单使用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;192.168.17.210&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line"></span><br><span class="line">db = client.admin</span><br><span class="line">db.authenticate(<span class="string">&quot;root&quot;</span>, <span class="string">&#x27;1018&#x27;</span>, mechanism=<span class="string">&#x27;SCRAM-SHA-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">collection = db[<span class="string">&#x27;test&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>查看全部聚集名称</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(db.collection_names())</span><br><span class="line"><span class="string">&quot;&quot;&quot;[&#x27;system.users&#x27;, &#x27;test&#x27;, &#x27;system.version&#x27;]&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>查看聚集的一条记录</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(collection.find_one())</span><br><span class="line"><span class="built_in">print</span>(collection.find_one(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;xxx&quot;</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;&#123;&#x27;_id&#x27;: ObjectId(&#x27;61138186c729b21c58113dce&#x27;), &#x27;name&#x27;: &#x27;lxx&#x27;, &#x27;age&#x27;: 18&#125;</span></span><br><span class="line"><span class="string">&#123;&#x27;_id&#x27;: ObjectId(&#x27;611383bfc729b207f4c4570d&#x27;), &#x27;name&#x27;: &#x27;xxx&#x27;, &#x27;age&#x27;: 18&#125;&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>查看聚集的多条记录</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> collection.find():</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>

<p><strong>查看聚集的记录统计</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collection.find().count()</span><br></pre></td></tr></table></figure>

<p><strong>聚集查询结果排序</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING) <span class="comment"># 升序</span></span><br><span class="line">collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.DESCENDING) <span class="comment"># 降序</span></span><br><span class="line">collection.find().sort([(<span class="string">&quot;name&quot;</span>,pymongo.ASCENDING),(<span class="string">&quot;age&quot;</span>,pymongo.DESCENDING)]) <span class="comment"># 多列排序</span></span><br></pre></td></tr></table></figure>

<p><strong>添加记录</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加一条数据</span></span><br><span class="line">collection.insert_one(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;)</span><br><span class="line"></span><br><span class="line">data = [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&#x27;test%s&#x27;</span> % i, <span class="string">&#x27;age&#x27;</span>: i&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]  <span class="comment"># 批量插入多条数据</span></span><br><span class="line">res = collection.insert_many(data, ordered=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(res.inserted_ids)</span><br></pre></td></tr></table></figure>

<p><strong>修改记录</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collection.update_one(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lxx&quot;</span>&#125;, &#123;<span class="string">&quot;$set&quot;</span>:&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;lll&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="string">&quot;11&quot;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>删除记录</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除一条数据</span></span><br><span class="line">collection.delete_one(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;lll&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除全部数据</span></span><br><span class="line">ret = collection.delete_many(&#123;&#125;)</span><br><span class="line"><span class="built_in">print</span>(ret.deleted_count, <span class="string">&#x27;个数据已删除&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="mongodb-sql简单使用"><a href="#mongodb-sql简单使用" class="headerlink" title="mongodb sql简单使用"></a>mongodb sql简单使用</h4><p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210811224656467.png" alt="linux部署mongodb"></p>
<p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210811230220996.png" alt="linux部署mongodb"></p>
<h4 id="单机部署mongodb集群"><a href="#单机部署mongodb集群" class="headerlink" title="单机部署mongodb集群"></a>单机部署mongodb集群</h4><ul>
<li>把原有的mongodb安装目录复制到/usr/local/bin/</li>
</ul>
<p><strong>master.conf配置文件（主）</strong></p>
<ul>
<li>配置文件放在/usr/local/bin/mongodb/etc/ 目录下</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> master.conf</span></span><br><span class="line">dbpath=/usr/local/bin/mongodb/data/master</span><br><span class="line">logpath=/usr/local/bin/mongodb/log/master.log</span><br><span class="line">pidfilepath=/usr/local/bin/mongodb/master.pid</span><br><span class="line">directoryperdb=true</span><br><span class="line">logappend=true</span><br><span class="line">replSet=testrs</span><br><span class="line">bind_ip=192.168.17.210</span><br><span class="line">port=27017</span><br><span class="line">oplogSize=10000</span><br><span class="line">fork=true</span><br><span class="line">noprealloc=true</span><br></pre></td></tr></table></figure>

<p><strong>slaver.conf配置文件（副本）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> slaver.conf</span></span><br><span class="line">dbpath=/usr/local/bin/mongodb/data/slaver</span><br><span class="line">logpath=/usr/local/bin/mongodb/log/slaver.log</span><br><span class="line">pidfilepath=/usr/local/bin/mongodb/slaver.pid</span><br><span class="line">directoryperdb=true</span><br><span class="line">logappend=true</span><br><span class="line">replSet=testrs</span><br><span class="line">bind_ip=192.168.17.210</span><br><span class="line">port=27018</span><br><span class="line">oplogSize=10000</span><br><span class="line">fork=true</span><br><span class="line">noprealloc=true</span><br></pre></td></tr></table></figure>

<p><strong>arbiter.conf配置文件（仲裁）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> arbiter.conf</span></span><br><span class="line">dbpath=/usr/local/bin/mongodb/data/arbiter</span><br><span class="line">logpath=/usr/local/bin/mongodb/log/arbiter.log</span><br><span class="line">pidfilepath=/usr/local/bin/mongodb/arbiter.pid</span><br><span class="line">directoryperdb=true</span><br><span class="line">logappend=true</span><br><span class="line">replSet=testrs</span><br><span class="line">bind_ip=192.168.17.210</span><br><span class="line">port=27019</span><br><span class="line">oplogSize=10000</span><br><span class="line">fork=true</span><br><span class="line">noprealloc=true</span><br></pre></td></tr></table></figure>

<p><strong>启动mongodb</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> cd /usr/local/bin/mongodb/bin</span><br><span class="line">./mongod --config /usr/local/bin/mongodb/etc/master.conf </span><br><span class="line">./mongod --config /usr/local/bin/mongodb/etc/slaver.conf </span><br><span class="line">./mongod --config /usr/local/bin/mongodb/etc/arbiter.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接服务</span></span><br><span class="line">./mongo 192.168.17.210:27017</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>配置主备仲裁节点</strong></p>
<p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210812134215452.png" alt="linux部署mongodb"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cfg=&#123;</span><br><span class="line">   _id:&#x27;testrs&#x27;,</span><br><span class="line">   members:[</span><br><span class="line">       &#123;_id:0,host:&#x27;192.168.17.210:27017&#x27;&#125;,</span><br><span class="line">     &#123;_id:1,host:&#x27;192.168.17.210:27018&#x27;&#125;,</span><br><span class="line">        &#123;_id:2,host:&#x27;192.168.17.210:27019&#x27;,arbiterOnly:true&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">rs.initiate(cfg)</span><br></pre></td></tr></table></figure>

<p><strong>查看集群信息rs.status()</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">testrs:SECONDARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">	&quot;set&quot; : &quot;testrs&quot;,</span><br><span class="line">	&quot;date&quot; : ISODate(&quot;2021-08-12T05:43:39.110Z&quot;),</span><br><span class="line">	&quot;myState&quot; : 1,</span><br><span class="line">	&quot;term&quot; : NumberLong(1),</span><br><span class="line">	&quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">	&quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">	&quot;syncSourceId&quot; : -1,</span><br><span class="line">	&quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line">	&quot;optimes&quot; : &#123;</span><br><span class="line">		&quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;appliedOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;durableOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;lastStableCheckpointTimestamp&quot; : Timestamp(1628747005, 1),</span><br><span class="line">	&quot;members&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 0,</span><br><span class="line">			&quot;name&quot; : &quot;192.168.17.210:27017&quot;,</span><br><span class="line">			&quot;health&quot; : 1,</span><br><span class="line">			&quot;state&quot; : 1,</span><br><span class="line">			&quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">			&quot;uptime&quot; : 7702,</span><br><span class="line">			&quot;optime&quot; : &#123;</span><br><span class="line">				&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">				&quot;t&quot; : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;optimeDate&quot; : ISODate(&quot;2021-08-12T05:43:35Z&quot;),</span><br><span class="line">			&quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncSourceId&quot; : -1,</span><br><span class="line">			&quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">			&quot;electionTime&quot; : Timestamp(1628746884, 1),</span><br><span class="line">			&quot;electionDate&quot; : ISODate(&quot;2021-08-12T05:41:24Z&quot;),</span><br><span class="line">			&quot;configVersion&quot; : 1,</span><br><span class="line">			&quot;self&quot; : true,</span><br><span class="line">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 1,</span><br><span class="line">			&quot;name&quot; : &quot;192.168.17.210:27018&quot;,</span><br><span class="line">			&quot;health&quot; : 1,</span><br><span class="line">			&quot;state&quot; : 2,</span><br><span class="line">			&quot;stateStr&quot; : &quot;SECONDARY&quot;,</span><br><span class="line">			&quot;uptime&quot; : 145,</span><br><span class="line">			&quot;optime&quot; : &#123;</span><br><span class="line">				&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">				&quot;t&quot; : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;optimeDurable&quot; : &#123;</span><br><span class="line">				&quot;ts&quot; : Timestamp(1628747015, 1),</span><br><span class="line">				&quot;t&quot; : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;optimeDate&quot; : ISODate(&quot;2021-08-12T05:43:35Z&quot;),</span><br><span class="line">			&quot;optimeDurableDate&quot; : ISODate(&quot;2021-08-12T05:43:35Z&quot;),</span><br><span class="line">			&quot;lastHeartbeat&quot; : ISODate(&quot;2021-08-12T05:43:38.275Z&quot;),</span><br><span class="line">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2021-08-12T05:43:38.477Z&quot;),</span><br><span class="line">			&quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncingTo&quot; : &quot;192.168.17.210:27017&quot;,</span><br><span class="line">			&quot;syncSourceHost&quot; : &quot;192.168.17.210:27017&quot;,</span><br><span class="line">			&quot;syncSourceId&quot; : 0,</span><br><span class="line">			&quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">			&quot;configVersion&quot; : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 2,</span><br><span class="line">			&quot;name&quot; : &quot;192.168.17.210:27019&quot;,</span><br><span class="line">			&quot;health&quot; : 1,</span><br><span class="line">			&quot;state&quot; : 7,</span><br><span class="line">			&quot;stateStr&quot; : &quot;ARBITER&quot;,</span><br><span class="line">			&quot;uptime&quot; : 145,</span><br><span class="line">			&quot;lastHeartbeat&quot; : ISODate(&quot;2021-08-12T05:43:38.275Z&quot;),</span><br><span class="line">			&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2021-08-12T05:43:37.388Z&quot;),</span><br><span class="line">			&quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncSourceId&quot; : -1,</span><br><span class="line">			&quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">			&quot;configVersion&quot; : 1</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1628747015, 1),</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1628747015, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">testrs:PRIMARY&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>主节点新增记录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testrs:PRIMARY&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line"></span><br><span class="line">db.mydb.test.insert(&#123;&#x27;name&#x27;:&#x27;lxx&#x27;,&#x27;age&#x27;:18&#125;)</span><br><span class="line"></span><br><span class="line">db.mydb.test.find(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;6114baf5c6cc6f16d0db38a1&quot;), &quot;name&quot; : &quot;lxx&quot;, &quot;age&quot; : 18 &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>副节点查看</strong></p>
<ul>
<li>当前不能读取集合的数据，当前节点只是一个备份，无非读取数据，需要为其设置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">./mongo 192.168.17.210:27018 # 登录副节点</span><br><span class="line"></span><br><span class="line">testrs:SECONDARY&gt; show dbs  # 查看不到数据库</span><br><span class="line">2021-08-12T14:11:30.161+0800 E QUERY    [js] Error: listDatabases failed:&#123;</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1628748686, 1),</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;,</span><br><span class="line">	&quot;code&quot; : 13435,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1628748686, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; :</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>设置读取操作</strong></p>
<ul>
<li>设置为奴隶节点，允许在从节点上进行读取操作</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rs.secondaryOk() </span><br><span class="line">或</span><br><span class="line">rs.secondaryOk(true)</span><br><span class="line">rs.secondaryOk(false) # 取消读权限 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以查看到数据</span></span><br><span class="line">testrs:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">testrs:SECONDARY&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">test    0.000GB</span><br><span class="line">testrs:SECONDARY&gt; db.mydb.test.find(&#123;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;6114baf5c6cc6f16d0db38a1&quot;), &quot;name&quot; : &quot;lhj&quot;, &quot;age&quot; : 18  </span><br></pre></td></tr></table></figure>

<p><strong>仲裁节点</strong></p>
<ul>
<li>不存放任何业务数据，可以登录查看</li>
<li>只能查看local数据库</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">./mongo 192.168.17.210:27019</span><br><span class="line">rs.slaveOk() </span><br><span class="line"></span><br><span class="line">testrs:ARBITER&gt; show dbs</span><br><span class="line">2021-08-12T14:31:52.134+0800 E QUERY    [js] Error: listDatabases failed:&#123;</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;,</span><br><span class="line">	&quot;code&quot; : 13435,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;</span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:139:1</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:882:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:766:15</span><br><span class="line">@(shellhelp2):1:1</span><br><span class="line">testrs:ARBITER&gt; rs.secondaryOk() </span><br><span class="line">testrs:ARBITER&gt; show dbs</span><br><span class="line">local  0.000GB</span><br><span class="line">testrs:ARBITER&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="多台虚拟机搭建集群"><a href="#多台虚拟机搭建集群" class="headerlink" title="多台虚拟机搭建集群"></a>多台虚拟机搭建集群</h4><p><strong>安装mongodb环境</strong></p>
<ul>
<li>三台虚拟机一样的操作</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install lrzsz -y</span><br><span class="line">tar -xvf mongodb-linux-x86_64-4.1.3.tgz</span><br><span class="line">mv mongodb-linux-x86_64-4.0.13 /usr/local/bin/mongodb</span><br><span class="line">cd mongodb/</span><br><span class="line">mkdir -p data/db</span><br><span class="line">mkdir log</span><br><span class="line">mkdir etc</span><br><span class="line">vim ./etc/mongodb.conf</span><br></pre></td></tr></table></figure>

<p><strong>配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 192.168.17.6 配置文件</span></span><br><span class="line">dbpath=/usr/local/bin/mongodb/data/db  #数据文件存放目录       </span><br><span class="line">logpath=/usr/local/bin/mongodb/log/mongodb.log   #日志文件</span><br><span class="line">logappend=true  #错误日志采用追加模式</span><br><span class="line">port=27017   #端口</span><br><span class="line">fork=true    #以守护程序的方式启用，即在后台运行</span><br><span class="line">journal=true  #启用日志文件，默认启用</span><br><span class="line">quiet=true  #这个选项可以过滤掉一些无用的日志信息，若需要调试使用请设置为false</span><br><span class="line"><span class="meta">#</span><span class="bash">auth=<span class="literal">true</span> <span class="comment">#需要认证。如果放开注释，就必须创建MongoDB的账号，使用账号与密码才可远程访问，第一次安装建议注释</span></span></span><br><span class="line">bind_ip=0.0.0.0 #允许远程访问，或者直接注释，127.0.0.1是只允许本地访问 </span><br><span class="line">replSet=testrs # 集群名称</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 192.168.17.7配置文件</span></span><br><span class="line">dbpath=/usr/local/bin/mongodb/data/db  #数据文件存放目录</span><br><span class="line">logpath=/usr/local/bin/mongodb/log/mongodb.log   #日志文件</span><br><span class="line">logappend=true  #错误日志采用追加模式</span><br><span class="line">port=27017   #端口</span><br><span class="line">fork=true    #以守护程序的方式启用，即在后台运行</span><br><span class="line">journal=true  #启用日志文件，默认启用</span><br><span class="line">quiet=true  #这个选项可以过滤掉一些无用的日志信息，若需要调试使用请设置为false</span><br><span class="line"><span class="meta">#</span><span class="bash">auth=<span class="literal">true</span> <span class="comment">#需要认证。如果放开注释，就必须创建MongoDB的账号，使用账号与密码才可远程访问，第一次安装建议注释</span></span></span><br><span class="line">bind_ip=0.0.0.0 #允许远程访问，或者直接注释，127.0.0.1是只允许本地访问</span><br><span class="line">replSet=testrs  #集群名称</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 192.168.17.210配置文件</span></span><br><span class="line">dbpath=/usr/local/bin/mongodb/data/db  #数据文件存放目录</span><br><span class="line">logpath=/usr/local/bin/mongodb/log/mongodb.log   #日志文件</span><br><span class="line">logappend=true  #错误日志采用追加模式</span><br><span class="line">port=27017   #端口</span><br><span class="line">fork=true    #以守护程序的方式启用，即在后台运行</span><br><span class="line">journal=true  #启用日志文件，默认启用</span><br><span class="line">quiet=true  #这个选项可以过滤掉一些无用的日志信息，若需要调试使用请设置为false</span><br><span class="line"><span class="meta">#</span><span class="bash">auth=<span class="literal">true</span> <span class="comment">#需要认证。如果放开注释，就必须创建MongoDB的账号，使用账号与密码才可远程访问，第一次安装建议注释</span></span></span><br><span class="line">bind_ip=0.0.0.0 #允许远程访问，或者直接注释，127.0.0.1是只允许本地访问</span><br><span class="line">replSet=testrs  #集群名称</span><br></pre></td></tr></table></figure>

<p><strong>启动服务</strong></p>
<ul>
<li>分别启动三台虚拟机mongodb服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./mongod --config ../etc/mongodb.conf</span><br><span class="line"></span><br><span class="line">yum -y install net-tools</span><br><span class="line">netstat -lanp |grep &#x27;27017&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装完之后可以使用killall 命令 快速关闭多个进程</span></span><br><span class="line">yum install -y psmisc</span><br><span class="line">killall mongod</span><br><span class="line">killall mongos</span><br></pre></td></tr></table></figure>

<p><strong>添加集群</strong></p>
<ul>
<li><p>注意：必须使用admin操作</p>
</li>
<li><p>对于仲裁点一定要加上arbiterOnly:true，否则主备模式不生效</p>
</li>
<li><p><img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20210812164615833.png" alt="linux部署mongodb"></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# ./mongo</span><br><span class="line">MongoDB shell version v4.0.13 </span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"></span><br><span class="line">cfg =&#123;&quot;_id&quot;:&quot;testrs&quot;,</span><br><span class="line">&quot;members&quot;:[</span><br><span class="line">&#123;&quot;_id&quot;:1,&quot;host&quot;:&quot;192.168.17.6:27017&quot;,priority:2&#125;,</span><br><span class="line">&#123;&quot;_id&quot;:2,&quot;host&quot;:&quot;192.168.17.7:27017&quot;,priority:1&#125;,</span><br><span class="line">&#123;&quot;_id&quot;:3,&quot;host&quot;:&quot;192.168.17.210:27017&quot;,arbiterOnly:true&#125;]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">rs.initiate(cfg)</span><br><span class="line"></span><br><span class="line">db.printSlaveReplicationInfo() # 查看副本同步状态</span><br></pre></td></tr></table></figure>

<p><strong>测试数据</strong></p>
<ul>
<li>主</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">testrs:PRIMARY&gt; db.cluster.test.insert(&#123;&#x27;name&#x27;:&#x27;cluster&#x27;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">testrs:PRIMARY&gt; db.cluster.test.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;611552a1bc61b02ccd503f79&quot;), &quot;name&quot; : &quot;cluster&quot; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./mongo </span><br><span class="line">rs.secondaryOk() # 添加为从，成功后可以有读权限</span><br><span class="line">testrs:SECONDARY&gt; db.cluster.test.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;611552a1bc61b02ccd503f79&quot;), &quot;name&quot; : &quot;cluster&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;611553dfbc61b02ccd503f7a&quot;), &quot;name&quot; : &quot;test&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;61155f70bc61b02ccd503f7b&quot;), &quot;name&quot; : &quot;xxx&quot; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试主从</strong></p>
<ul>
<li>关闭主服务</li>
<li>从变成主</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./mongod -f ../etc/mongodb.conf --shutdown # 关闭服务</span><br><span class="line">testrs:SECONDARY&gt; rs.status()  # 查看主从节点状态</span><br></pre></td></tr></table></figure>

<p><strong>从库永久设置rs.slaveOk</strong></p>
<ul>
<li>重新连接服务，查询会发现从库没有权限读取。需要永久设置rs.slaveOk</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo find / -name .mongorc.js</span><br><span class="line">/root/.mongorc.js # 查询到的路径</span><br><span class="line">vim /root/.mongorc.js</span><br><span class="line">rs.secondaryOk()  # 增加命令保存</span><br><span class="line">./mongo # 重新启动服务</span><br><span class="line">show dbs # 可以查到数据库</span><br></pre></td></tr></table></figure>

<h4 id="修改主从优先级"><a href="#修改主从优先级" class="headerlink" title="修改主从优先级"></a><strong>修改主从优先级</strong></h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/docs/manual/tutorial/change-hostnames-in-a-replica-set/">https://www.mongodb.com/docs/manual/tutorial/change-hostnames-in-a-replica-set/</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在主节点运行如下命令：</span><br><span class="line"><span class="meta">1)PRIMARY&gt;</span><span class="bash"> rscfg=rs.conf()</span></span><br><span class="line"><span class="meta">2)PRIMARY&gt;</span><span class="bash">rscfg.members[0].priority = 3</span></span><br><span class="line"><span class="meta">3)PRIMARY&gt;</span><span class="bash"> rs.reconfig(rscfg)</span></span><br><span class="line"></span><br><span class="line">修改集群ip</span><br><span class="line">cfg = rs.conf()</span><br><span class="line">cfg.members[1].host = &quot;10.143.16.xx:27017&quot;</span><br><span class="line">rs.reconfig(cfg)</span><br><span class="line"></span><br><span class="line">cfg = rs.conf()</span><br><span class="line">cfg.members[2].host = &quot;10.143.16.xx:27017&quot;</span><br><span class="line">rs.reconfig(cfg)</span><br><span class="line"></span><br><span class="line">初始化集群</span><br><span class="line">rs0:PRIMARY&gt; cfg = &#123;</span><br><span class="line">...  _id: &quot;rs0&quot;,</span><br><span class="line">...  members: [</span><br><span class="line">...    &#123;_id: 0, host: &quot;mongodb-v1-0.mongodb.airport-ai.svc.cluster.local&quot;,priority:5&#125;,</span><br><span class="line">...    &#123;_id: 1, host: &quot;mongodb-v1-1.mongodb.airport-ai.svc.cluster.local&quot;,priority:3&#125;,</span><br><span class="line">... ]</span><br><span class="line">... &#125;</span><br><span class="line"></span><br><span class="line">rs0:PRIMARY&gt; rs.reconfig(cfg)</span><br></pre></td></tr></table></figure>





<p><strong>pymongo测试连接</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient, ReadPreference</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;x.x.x.x:27017&#x27;</span>, replicaSet=<span class="string">&#x27;google&#x27;</span>)  <span class="comment"># 连接副本集</span></span><br><span class="line"><span class="comment"># client = MongoClient(&#x27;mongodb://x.x.x.x, x.x.x.x, x.x.x.x, x.x.x.x&#x27;, replicaSet=&#x27;google&#x27;)  # 连接副本集</span></span><br><span class="line">db = client.get_database(<span class="string">&#x27;tes&#x27;</span>, read_preference=ReadPreference.SECONDARY)  <span class="comment"># 手动切换到SECONDARY备份的数据库</span></span><br><span class="line">collection = db.student  <span class="comment"># db下的student集合</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(client.address)</span></span><br><span class="line"><span class="comment"># print(client.list_database_names())</span></span><br><span class="line"><span class="comment"># serverStatus = db.command(&#x27;serverStatus&#x27;)  # 获取mongodb的serverStatus状态信息</span></span><br><span class="line"><span class="comment"># print(serverStatus)</span></span><br><span class="line"><span class="comment"># print(serverStatus[&#x27;connections&#x27;])  # 连接信息</span></span><br><span class="line"><span class="comment"># print(serverStatus[&#x27;network&#x27;])  # 流量信息</span></span><br><span class="line"><span class="comment"># print(serverStatus[&#x27;opcounters&#x27;])  # 增删改查信息</span></span><br><span class="line"><span class="comment"># print(db.read_preference)</span></span><br><span class="line"></span><br><span class="line">collection.insert_one(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;lxx&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;)  <span class="comment"># 插入一条数据，如果没出错那么说明连接成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data = [&#123;&quot;name&quot;: &#x27;test%s&#x27; % i, &#x27;age&#x27;: i&#125; for i in range(1, 101)]  # 批量插入数据</span></span><br><span class="line"><span class="comment"># res = collection.insert_many(data, ordered=False)</span></span><br><span class="line"><span class="comment"># print(res.inserted_ids)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 删除所有数据</span></span><br><span class="line"><span class="comment"># ret = collection.delete_many(&#123;&#125;)</span></span><br><span class="line"><span class="comment"># print(ret.deleted_count, &#x27;个数据已删除&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 下面是遍历查询数据</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> collection.find():</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="GridFS"><a href="#GridFS" class="headerlink" title="GridFS"></a>GridFS</h4><ul>
<li>GridFS是mongoDB自带的文件系统他用二进制的形式存储文件，大型文件系统的绝大多是特性GridFS全可以完成。GridFS 用于存储和恢复那些超过16M（BSON文件限制）的文件(如：图片、音频、视频等)</li>
</ul>
<p><strong>上传文件</strong></p>
<ul>
<li>cmd终端使用mongodb自带的mongofiles</li>
<li>mongofiles.exe -d  数据库名称 put 文件路径</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\MongoDB\Server\3.4\bin&gt; mongofiles.exe -d gridfs put C:\Users\Desktop\foda\yolov5\weights\yolov5s.pt</span><br></pre></td></tr></table></figure>

<p><strong>查看文件存储状态</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.fs.files.find().pretty()</span></span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;611db8b4c729b23d84aaaf9b&quot;),</span><br><span class="line">        &quot;chunkSize&quot; : 261120,</span><br><span class="line">        &quot;uploadDate&quot; : ISODate(&quot;2021-08-19T01:49:40.682Z&quot;),</span><br><span class="line">        &quot;length&quot; : 14796495,</span><br><span class="line">        &quot;md5&quot; : &quot;aa2199af684193e4e93dd14bf2075893&quot;,</span><br><span class="line">        &quot;filename&quot; : &quot;xxxxx&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">db.fs.chunks.find(&#123;files_id:ObjectId(<span class="string">&quot;611db8b4c729b23d84aaaf9b&quot;</span>)&#125;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>python上传读取</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> gridfs <span class="keyword">import</span> GridFS</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"><span class="keyword">from</span> bson.objectid <span class="keyword">import</span> ObjectId</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoGridFS</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    dbUrl = <span class="string">&#x27;127.0.0.1:27017&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, db, collection</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param db: 数据库名称</span></span><br><span class="line"><span class="string">        :param collection: 集合名称</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.db = db</span><br><span class="line">        self.collection = collection</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        client = MongoClient(self.dbUrl)</span><br><span class="line">        db = client[self.db]</span><br><span class="line">        <span class="comment"># db.authenticate()</span></span><br><span class="line">        collection = db[self.collection]</span><br><span class="line">        <span class="keyword">return</span> db</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>(<span class="params">self, db, filepath</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        上传文件</span></span><br><span class="line"><span class="string">        :param filePath:   文件路径</span></span><br><span class="line"><span class="string">        :return:  返回files_id</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        fs = GridFS(db, collection=self.collection)</span><br><span class="line">        filename = filepath.split(<span class="string">&#x27;\\&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        dic = &#123;<span class="string">&#x27;filename&#x27;</span>: filename, <span class="string">&#x27;url&#x27;</span>: filepath&#125;</span><br><span class="line">        <span class="keyword">if</span> fs.find_one(&#123;<span class="string">&#x27;filename&#x27;</span>: filename&#125;):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;模型已存在&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                data = fp.read()</span><br><span class="line">                files_id = fs.put(data=data, **dic)</span><br><span class="line">            <span class="keyword">return</span> files_id</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_id</span>(<span class="params">self, db, filepath</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         通过filename查询条件获取id</span></span><br><span class="line"><span class="string">        :param filepath: 查询条件</span></span><br><span class="line"><span class="string">        :return: files_id</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            filename = filepath.split(<span class="string">&#x27;\\&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            fs = GridFS(db, collection=self.collection)</span><br><span class="line">            files_id = fs.find_one(&#123;<span class="string">&quot;filename&quot;</span>: filename&#125;)._<span class="built_in">id</span></span><br><span class="line">            <span class="comment"># print(type(files_id))</span></span><br><span class="line">            <span class="keyword">return</span> files_id</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list_file</span>(<span class="params">self,db</span>):</span> <span class="comment">#列出所有文件名</span></span><br><span class="line">        fs = GridFS(db, self.collection)</span><br><span class="line">        gf = fs.<span class="built_in">list</span>()</span><br><span class="line">        <span class="built_in">print</span>(gf)</span><br><span class="line">        <span class="keyword">return</span> gf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getfile</span>(<span class="params">self, db, _id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过id查询获取数据库中模型</span></span><br><span class="line"><span class="string">        :param _id: 文件id</span></span><br><span class="line"><span class="string">        :return: file：二进制数据</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        fs = GridFS(db, collection=self.collection)</span><br><span class="line">        object_id = ObjectId(_<span class="built_in">id</span>)</span><br><span class="line">        gf = fs.get(object_id)</span><br><span class="line">        file = gf.read()</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download_file</span>(<span class="params">self, db, _id, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过文件_id获取文件</span></span><br><span class="line"><span class="string">        :param id:  文件id---&gt; files_id</span></span><br><span class="line"><span class="string">        :return: filename</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            fs = GridFS(db, collection=self.collection)</span><br><span class="line">            object_id = ObjectId(_<span class="built_in">id</span>)</span><br><span class="line">            gf = fs.get(object_id)</span><br><span class="line">            file_data = gf.read()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;./img&#x27;</span>):</span><br><span class="line">                os.mkdir(<span class="string">&#x27;./img&#x27;</span>)</span><br><span class="line">            img_path = <span class="string">&#x27;img/&#x27;</span> + name</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(img_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                fp.write(file_data)</span><br><span class="line">                <span class="built_in">print</span>(gf.filename)</span><br><span class="line">            <span class="keyword">return</span> gf.filename</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_file</span>(<span class="params">self, db, _id</span>):</span></span><br><span class="line">        fs = GridFS(db, collection=self.collection)</span><br><span class="line">        fs.delete(_<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gfs = MongoGridFS(<span class="string">&#x27;fs&#x27;</span>, <span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">db = gfs.connect_db()</span><br></pre></td></tr></table></figure>

<h4 id="Django中使用"><a href="#Django中使用" class="headerlink" title="Django中使用"></a>Django中使用</h4><ul>
<li><p><a target="_blank" rel="noopener" href="http://docs.mongoengine.org/tutorial.html">http://docs.mongoengine.org/tutorial.html</a></p>
</li>
<li><p>pip3 install mongoengine</p>
</li>
</ul>
<p><strong>setting.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rest_framework_mongoengine&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django_filters&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;corsheaders&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># Custom settings</span></span><br><span class="line">DATETIME_FORMAT = <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">DATE_FORMAT = <span class="string">&#x27;%Y-%m-%d&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django Rest Framework settings</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># Use Django&#x27;s standard `django.contrib.auth` permissions,</span></span><br><span class="line">    <span class="comment"># or allow read-only access for unauthenticated users.</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;drf_spectacular.openapi.AutoSchema&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DATETIME_FORMAT&#x27;</span>: DATETIME_FORMAT,</span><br><span class="line">    <span class="string">&#x27;DATETIME_INPUT_FORMATS&#x27;</span>: [DATETIME_FORMAT],</span><br><span class="line">    <span class="string">&#x27;DATE_FORMAT&#x27;</span>: DATE_FORMAT,</span><br><span class="line">    <span class="string">&#x27;DATE_INPUT_FORMATS&#x27;</span>: [DATE_FORMAT],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: [<span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_RENDERER_CLASSES&#x27;: [&#x27;utils.renderers.MyJSONRender&#x27;],</span></span><br><span class="line">    <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;utils.exception_handler.custom_exception_handler&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>models.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mongoengine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mongoengine.connect(<span class="string">&quot;model&quot;</span>, host=<span class="string">&quot;10.21.6.14&quot;</span>, port=<span class="number">30707</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlgorithmModel</span>(<span class="params">mongoengine.Document</span>):</span></span><br><span class="line">    meta = &#123;</span><br><span class="line">        <span class="string">&quot;collection&quot;</span>: <span class="string">&quot;model&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ordering&quot;</span>: [<span class="string">&#x27;-id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BASIC = <span class="string">&#x27;basic&#x27;</span></span><br><span class="line">    CUSTOM = <span class="string">&#x27;custom&#x27;</span></span><br><span class="line">    TYPE_CHOICES = [</span><br><span class="line">        (BASIC, <span class="string">&#x27;基础模型&#x27;</span>),</span><br><span class="line">        (CUSTOM, <span class="string">&#x27;定制化模型&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line">    MSG_CHOICES = [</span><br><span class="line">        (<span class="string">&quot;used&quot;</span>, <span class="string">&quot;已使用&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;unused&quot;</span>, <span class="string">&quot;未使用&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">    <span class="built_in">id</span> = mongoengine.SequenceField(required=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = mongoengine.StringField(max_length=<span class="number">50</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    desc = mongoengine.StringField(max_length=<span class="number">50</span>)</span><br><span class="line">    <span class="built_in">type</span> = mongoengine.StringField(max_length=<span class="number">50</span>, choices=TYPE_CHOICES, default=BASIC)</span><br><span class="line">    model = mongoengine.FileField()</span><br><span class="line">    tag = mongoengine.StringField(choices=MSG_CHOICES, default=<span class="string">&quot;used&quot;</span>)</span><br><span class="line">    uploadDate = mongoengine.DateTimeField()</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlgorithmSliceModel</span>(<span class="params">mongoengine.Document</span>):</span></span><br><span class="line">    meta = &#123;</span><br><span class="line">        <span class="string">&quot;collection&quot;</span>: <span class="string">&quot;demo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ordering&quot;</span>: [<span class="string">&#x27;-id&#x27;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">id</span> = mongoengine.SequenceField(required=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">    algorithm = mongoengine.StringField(required=<span class="literal">True</span>)</span><br><span class="line">    filename = mongoengine.StringField(required=<span class="literal">True</span>)</span><br><span class="line">    event_started = mongoengine.DateTimeField(default=datetime.datetime.utcnow)</span><br><span class="line">    event_started_addr = mongoengine.StringField(required=<span class="literal">True</span>)</span><br><span class="line">    event_addr_type = mongoengine.StringField(required=<span class="literal">True</span>)</span><br><span class="line">    event_name = mongoengine.StringField(required=<span class="literal">True</span>, max_length=<span class="number">50</span>)</span><br><span class="line">    slice_video = mongoengine.FileField(required=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>serializer.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_mongoengine <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> AlgorithmModel, AlgorithmSliceModel</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlgorithmModelSerializer</span>(<span class="params">serializers.DocumentSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = AlgorithmModel</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&gt;&gt;&#x27;</span>, validated_data)</span><br><span class="line">        model_data = validated_data.get(<span class="string">&quot;model&quot;</span>)</span><br><span class="line">        filename = validated_data.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        validated_data.pop(<span class="string">&quot;model&quot;</span>)</span><br><span class="line">        ret = AlgorithmModel(**validated_data, uploadDate=datetime.datetime.utcnow())</span><br><span class="line">        ret.model.put(model_data, **&#123;<span class="string">&quot;filename&quot;</span>: filename&#125;)</span><br><span class="line">        ret.save()</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">AlgorithmSliceModelModelSerializer</span>(<span class="params">serializers.DocumentSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = AlgorithmSliceModel</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        slice_video = validated_data.get(<span class="string">&quot;slice_video&quot;</span>)</span><br><span class="line">        name = validated_data.get(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line">        validated_data.pop(<span class="string">&quot;slice_video&quot;</span>)</span><br><span class="line">        model = AlgorithmSliceModel(**validated_data)</span><br><span class="line">        model.slice_video.put(slice_video, content_type=<span class="string">&#x27;video/mp4&#x27;</span>, filename=name)</span><br><span class="line">        model.save()</span><br><span class="line">        <span class="keyword">return</span> model</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>views.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> AlgorithmModelSerializer,AlgorithmSliceModelModelSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> AlgorithmModel,AlgorithmSliceModel</span><br><span class="line"><span class="keyword">from</span> rest_framework_mongoengine <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlgorithmViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = AlgorithmModel.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = AlgorithmModelSerializer</span><br><span class="line">    my_filter_fields = [<span class="string">&#x27;type&#x27;</span>] <span class="comment"># 定义过滤字段type</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_kwargs_for_filtering</span>(<span class="params">self</span>):</span></span><br><span class="line">        filtering_kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> self.my_filter_fields:</span><br><span class="line">            field_value = self.request.query_params.get(field)</span><br><span class="line">            <span class="built_in">print</span>(field_value)</span><br><span class="line">            <span class="keyword">if</span> field_value:</span><br><span class="line">                filtering_kwargs[field] = field_value</span><br><span class="line">        <span class="keyword">return</span> filtering_kwargs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        queryset = AlgorithmModel.objects.<span class="built_in">all</span>()</span><br><span class="line">        filtering_kwargs = self.get_kwargs_for_filtering()</span><br><span class="line">        <span class="keyword">if</span> filtering_kwargs:</span><br><span class="line">            queryset = AlgorithmModel.objects.<span class="built_in">filter</span>(**filtering_kwargs)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = AlgorithmSliceModel.objects</span><br><span class="line">    serializer_class = VideoSerializer</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_kwargs_for_filtering</span>(<span class="params">self</span>):</span></span><br><span class="line">        filtering_kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> self.my_filter_fields:</span><br><span class="line">            field_value = self.request.query_params.get(field)</span><br><span class="line">            <span class="keyword">if</span> field_value:</span><br><span class="line">                filtering_kwargs[field] = field_value</span><br><span class="line">        <span class="keyword">return</span> filtering_kwargs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        queryset = AlgorithmSliceModel.objects.<span class="built_in">all</span>()</span><br><span class="line">        filtering_kwargs = self.get_kwargs_for_filtering()</span><br><span class="line">        <span class="keyword">if</span> filtering_kwargs:</span><br><span class="line">            queryset = AlgorithmSliceModel.objects.<span class="built_in">filter</span>(**filtering_kwargs)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def get_kwargs_for_filtering(self):</span></span><br><span class="line">    <span class="comment">#     self.algorithm = self.request.query_params.get(&quot;algorithm&quot;)</span></span><br><span class="line">    <span class="comment">#     self.start_time = self.request.query_params.get(&quot;start_time&quot;)</span></span><br><span class="line">    <span class="comment">#     self.end_time = self.request.query_params.get(&quot;end_time&quot;)</span></span><br><span class="line">    <span class="comment">#     self.event_name = self.request.query_params.get(&quot;event_name&quot;)</span></span><br><span class="line">    <span class="comment">#     if self.algorithm and self.start_time and self.end_time and self.event_name:</span></span><br><span class="line">    <span class="comment">#         return True</span></span><br><span class="line">    <span class="comment">#     return False</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># def get_queryset(self):</span></span><br><span class="line">    <span class="comment">#     queryset = AlgorithmSliceModel.objects.all()</span></span><br><span class="line">    <span class="comment">#     filtering = self.get_kwargs_for_filtering()</span></span><br><span class="line">    <span class="comment">#     if filtering:</span></span><br><span class="line">    <span class="comment">#         queryset = AlgorithmSliceModel.objects.filter(event_started__gte=self.start_time,</span></span><br><span class="line">    <span class="comment">#                                                       event_started__lte=self.end_time,</span></span><br><span class="line">    <span class="comment">#                                                       algorithm=self.algorithm, event_name=self.event_name)</span></span><br><span class="line">    <span class="comment">#     return queryset</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;GET&#x27;</span>], detail=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        video = self.get_object()</span><br><span class="line">        file = video.slice_video.read()</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(file, content_type=<span class="string">&#x27;video/mp4&#x27;</span>)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/algorithm/?type=custom">http://127.0.0.1:8000/api/algorithm/?type=custom</a></li>
</ul>
<img src="/2021/08/09/Linux%E9%83%A8%E7%BD%B2mongodb/image-20220117163017436.png" alt="Linux部署mongodb" style="zoom:150%;">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/31/Nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Admin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Admin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/31/Nginx/" class="post-title-link" itemprop="url">Nginx</a>
        </h2>

        <div class="post-meta">
		<!-- 设置置顶标志 -->
			
			  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-31 00:49:31" itemprop="dateCreated datePublished" datetime="2021-07-31T00:49:31+08:00">2021-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-14 10:11:33" itemprop="dateModified" datetime="2021-10-14T10:11:33+08:00">2021-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Linux安装"><a href="#Linux安装" class="headerlink" title="Linux安装"></a>Linux安装</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>下载 </span><br><span class="line">cd /usr/local/ </span><br><span class="line">mkdir nginx</span><br><span class="line">yum -y install gcc pcre-devel zlib-devel openssl openssl-devel</span><br><span class="line">wget http://nginx.org/download/nginx-<span class="number">1.18</span><span class="number">.0</span>.tar.gz</span><br><span class="line">    tar xf nginx-<span class="number">1.18</span><span class="number">.0</span>.tar.gz</span><br><span class="line">    cd nginx-<span class="number">1.18</span><span class="number">.0</span></span><br><span class="line">    ./configure	 --<span class="built_in">help</span></span><br><span class="line">    ./configure --prefix=/usr/local/nginx --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_stub_status_module</span><br><span class="line">    make &amp;&amp; make install <span class="comment"># 编译安装</span></span><br></pre></td></tr></table></figure>

<h4 id="放行防火墙端口"><a href="#放行防火墙端口" class="headerlink" title="放行防火墙端口"></a>放行防火墙端口</h4><ul>
<li>本地浏览器访问</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --query-port=80/tcp  # 查询</span><br><span class="line">firewall-cmd --add-port=80/tcp --permanent # permanent永久生效</span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure>

<h4 id="配置开机自启动"><a href="#配置开机自启动" class="headerlink" title="配置开机自启动"></a>配置开机自启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rc.d/rc.local</span><br><span class="line">/usr/local/nginx/sbin/nginx  # 开机自启动</span><br></pre></td></tr></table></figure>

<h4 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h4><p><img src="/2021/07/31/Nginx/image-20211011171238176.png" alt="Nginx"></p>
<p><strong>创建文件目录</strong></p>
<ul>
<li><p>conf 和conf.d分别用于保存配置文件</p>
</li>
<li><p>html用于放置静态文件</p>
</li>
<li><p>logs用于保存日志</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /nginx/conf/conf.d</span><br><span class="line">mkdir -p /nginx/html</span><br><span class="line">mkdir -p /nginx/logs</span><br></pre></td></tr></table></figure>

<p><strong>拷贝默认配置</strong></p>
<ul>
<li>1.启动nginx镜像获取容器id</li>
<li>2.拷贝容器中默认的配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run --name my-nginx -p 80:80 -d nginx</span><br><span class="line">docker cp 5e0199f88769:/etc/nginx/nginx.conf /nginx/conf/nginx.conf</span><br><span class="line">docker cp 5e0199f88769:/etc/nginx/conf.d /nginx/conf</span><br><span class="line">docker cp 5e0199f88769:/usr/share/nginx/html /nginx/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝完之后停止删除容器</span></span><br><span class="line">docker stop nginx</span><br><span class="line">docker rm 5e0199f88769</span><br></pre></td></tr></table></figure>

<p><strong>用数据卷启动nginx</strong></p>
<ul>
<li>-p 端口映射</li>
<li>–name 启动容器的名字</li>
<li>-v 宿主机与容器的映射关系</li>
<li>-d 以守护进程后台运行</li>
<li>–restart=always 一直保持运行，自动启动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 80:80 --name nginx -v /nginx/conf/nginx.conf:/etc/nginx/nginx.conf -v /nginx/conf/conf.d:/etc/nginx/conf.d -v /nginx/html:/usr/share/nginx/html -v /nginx/logs/:/var/log/nginx  -d nginx</span><br></pre></td></tr></table></figure>

<p><strong>进入容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 容器id /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 容器重启重新加载</span></span><br><span class="line">docker exec -t 容器id nginx -t</span><br><span class="line">docker exec -t 容器id nginx -s reload</span><br></pre></td></tr></table></figure>

<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx]<span class="comment"># ls</span></span><br><span class="line">conf  配置文件</span><br><span class="line">html  存放静态文件 <span class="comment"># index.html是默认的静态文件</span></span><br><span class="line">logs  日志目录</span><br><span class="line">sbin  二进制文件</span><br><span class="line">启动以后会生成一个配置文件，根据配置文件的选项生成子进程（工作进程），主进程不负责处理用户的请求，用来转发用户的请求，真正负责处理用户请求的是子进程</span><br></pre></td></tr></table></figure>

<h4 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx]<span class="comment">#  ./sbin/nginx -h</span></span><br><span class="line">nginx version: nginx/<span class="number">1.18</span><span class="number">.0</span></span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this <span class="built_in">help</span></span><br><span class="line">  -v            : show version <span class="keyword">and</span> exit</span><br><span class="line">  -V            : show version <span class="keyword">and</span> configure options then exit <span class="comment"># 显示版本加编译时选项</span></span><br><span class="line">  -t            : test configuration <span class="keyword">and</span> exit  <span class="comment"># 测试配置文件</span></span><br><span class="line">  -T            : test configuration, dump it <span class="keyword">and</span> exit</span><br><span class="line">  -q            : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload  <span class="comment"># </span></span><br><span class="line">  -p prefix     : <span class="built_in">set</span> prefix path (default: /opt/nginx/)</span><br><span class="line">  -c filename   : <span class="built_in">set</span> configuration file (default: conf/nginx.conf)</span><br><span class="line">  -g directives : <span class="built_in">set</span> <span class="keyword">global</span> directives out of configuration file</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx]<span class="comment"># vim ./conf/nginx.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#user  nobody;  # 使用哪个用户启动子进程</span></span><br><span class="line">worker_processes  <span class="number">1</span>; <span class="comment"># 工作进程的个数（一般配置cpu的核心数-1或2）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    <span class="comment"># worker_processes * worker_connections 理论上是nginx的并发</span></span><br><span class="line">    <span class="comment"># use[epoll|select|poll] </span></span><br><span class="line">    worker_connections  <span class="number">1024</span>;  <span class="comment"># 每一个子进程可以处理的连接数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;  <span class="comment"># 导入</span></span><br><span class="line">    default_type  application/octet-stream; <span class="comment"># 默认的请求方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用来定义日志并定义日志格式     </span></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>; <span class="comment"># 保持长链接的超时时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;  <span class="comment"># 监听端口</span></span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html; <span class="comment"># 指定静态文件地址</span></span><br><span class="line">            index  index.html index.htm; <span class="comment"># 指定默认的index页面</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 错误页面，客户端</span></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment"># 错误页面 服务端错误</span></span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    root           html;</span></span><br><span class="line">        <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">        <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">        <span class="comment">#    deny  all;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       8000;</span></span><br><span class="line">    <span class="comment">#    listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#    server_name  somename  alias  another.alias;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#    server_name  localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_certificate      cert.pem;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate_key  cert.key;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#    ssl_session_timeout  5m;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#    ssl_prefer_server_ciphers  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h4 id="404页面"><a href="#404页面" class="headerlink" title="404页面"></a>404页面</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#error_page  404              /404.html; # 配置文件解开即可</span></span><br></pre></td></tr></table></figure>

<h4 id="root和alias的区别"><a href="#root和alias的区别" class="headerlink" title="root和alias的区别"></a>root和alias的区别</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /img&#123;</span><br><span class="line">	root /data/img;</span><br><span class="line">&#125;</span><br><span class="line">root /data/img 里面必须有/img</span><br><span class="line"></span><br><span class="line">location /img&#123;</span><br><span class="line">	alias /data/img;</span><br><span class="line">&#125;</span><br><span class="line">root /data/img 里面不需要有/img</span><br></pre></td></tr></table></figure>

<h4 id="nginx多域名"><a href="#nginx多域名" class="headerlink" title="nginx多域名"></a>nginx多域名</h4><ul>
<li>基于ip地址</li>
<li>基于端口</li>
<li>基于域名</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">配置文件中： server_name  localhost;</span><br><span class="line">需要在本地： C:\Windows\System32\drivers\etc\hosts 中把ip 改为域名</span><br><span class="line">    <span class="number">192.168</span><span class="number">.17</span><span class="number">.6</span>  <span class="number">1995.</span>haojie.com <span class="number">19951018.</span>yuhang.com</span><br><span class="line">	<span class="number">192.168</span><span class="number">.17</span><span class="number">.6</span>   www.taobao.com taobao.com</span><br><span class="line">	<span class="number">192.168</span><span class="number">.17</span><span class="number">.6</span>   www.jd.com  jd.com</span><br><span class="line">[root@localhost nginx]<span class="comment"># vim conf/nginx.conf </span></span><br><span class="line">        server  &#123;</span><br><span class="line"></span><br><span class="line">            listen <span class="number">80</span>;</span><br><span class="line">            server_name www.taobao.com taobao.com;</span><br><span class="line"></span><br><span class="line">            location /  &#123;</span><br><span class="line">                    root /data/taobao;</span><br><span class="line">                    index index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        server  &#123;</span><br><span class="line"></span><br><span class="line">            listen <span class="number">80</span>;</span><br><span class="line">            server_name www.jd.com jd.com;</span><br><span class="line"></span><br><span class="line">            location /  &#123;</span><br><span class="line">                    root /data/jd;</span><br><span class="line">                    index index.html;</span><br><span class="line">        &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">配置文件中解开注释</span><br><span class="line">    </span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    </span><br><span class="line">[root@localhost nginx]# tail -f logs/access.log  # 查看日志信息</span><br><span class="line"></span><br><span class="line">192.168.17.1 - - [10/Mar/2021:10:56:56 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36 Edg/89.0.774.48&quot;</span><br><span class="line">remote_addr:访问ip地址</span><br><span class="line">remote_user：访问的用户</span><br><span class="line"><span class="meta">$</span><span class="bash">time_local：本地时间</span></span><br><span class="line"><span class="meta">$</span><span class="bash">request：包括请求方式、请求地址、请求协议版本号</span></span><br><span class="line"><span class="meta">$</span><span class="bash">status：状态码</span></span><br><span class="line"><span class="meta">$</span><span class="bash">body_bytes_sent：发送大小</span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_user_agent：</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="禁止访问"><a href="#禁止访问" class="headerlink" title="禁止访问"></a>禁止访问</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost nginx]<span class="comment"># vim conf/nginx.conf </span></span><br><span class="line">        server  &#123;</span><br><span class="line"></span><br><span class="line">            listen <span class="number">80</span>;</span><br><span class="line">            server_name www.taobao.com taobao.com;</span><br><span class="line"></span><br><span class="line">            location /  &#123;</span><br><span class="line">                    deny <span class="number">192.168</span><span class="number">.17</span><span class="number">.6</span>; <span class="comment"># 禁止这个ip访问 </span></span><br><span class="line">                	deny <span class="number">192.168</span><span class="number">.17</span><span class="number">.0</span>/<span class="number">24</span>; <span class="comment"># 禁止这个网段访问</span></span><br><span class="line">                	allow <span class="number">192.168</span><span class="number">.17</span><span class="number">.11</span>; <span class="comment"># 运行这个ip访问</span></span><br><span class="line">                    root /data/taobao;</span><br><span class="line">                    index index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h4><ul>
<li>在客户端（浏览器）配置代理服务器，通过代理服务器进行互联网访问</li>
</ul>
<p><img src="/2021/07/31/Nginx/image-20211011154257645.png" alt="Nginx"></p>
<h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><ul>
<li><img src="/2021/07/31/Nginx/image-20211011154830984.png" alt="Nginx"></li>
</ul>
<p><strong>作用</strong></p>
<ul>
<li>起到保护网站安全的作用</li>
<li>可以缓存静态文件</li>
<li>实现负载均衡 F5 A10 lvs haproxy nginx</li>
</ul>
<p><img src="/2021/07/31/Nginx/image-20210310155903794.png" alt="Nginx"></p>
<p><img src="/2021/07/31/Nginx/image-20210310160247202.png" alt="Nginx"></p>
<ul>
<li>先代理到21.128 –》 刷新访问自己的21.131 实现轮询</li>
</ul>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><ul>
<li>单个服务器解决不了高并发，增加服务器的数量，将请求分发到不同的服务器上，将负载分发到不同的服务器上就是负载均衡</li>
</ul>
<p><img src="/2021/07/31/Nginx/image-20211011155418804.png" alt="Nginx"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nginx.conf</span></span><br><span class="line">upstream server &#123;</span><br><span class="line">	server 192.168.17.6:8001;</span><br><span class="line">	server 192.168.17.6:8002;</span><br><span class="line">	server 192.168.17.6:8003;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 9001;</span><br><span class="line">	server_name 192.168.17.6;</span><br><span class="line">	</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://server;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 即访问192.168.17.6:9001 可把请求负载均衡到上面三个server</span></span><br></pre></td></tr></table></figure>



<h4 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h4><ul>
<li>weight代表权重，默认为1，权重越高被分配的客户端越多</li>
</ul>
<p><img src="/2021/07/31/Nginx/image-20210310160636067.png" alt="Nginx"></p>
<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h4><p><img src="/2021/07/31/Nginx/image-20210310160916702.png" alt="Nginx"></p>
<h4 id="buckup"><a href="#buckup" class="headerlink" title="buckup"></a>buckup</h4><p><img src="/2021/07/31/Nginx/image-20210310161423167.png" alt="Nginx"></p>
<h4 id="nginx-location匹配规则"><a href="#nginx-location匹配规则" class="headerlink" title="nginx location匹配规则"></a>nginx location匹配规则</h4><p><img src="/2021/07/31/Nginx/image-20210310162604231.png" alt="Nginx"></p>
<p><img src="/2021/07/31/Nginx/image-20210310162614587.png" alt="Nginx"></p>
<h4 id="location分离"><a href="#location分离" class="headerlink" title="location分离"></a>location分离</h4><p><img src="/2021/07/31/Nginx/image-20210310162959728.png" alt="Nginx"></p>
<h4 id="status分类"><a href="#status分类" class="headerlink" title="status分类"></a>status分类</h4><p><img src="/2021/07/31/Nginx/image-20210310164409622.png" alt="Nginx"></p>
<h4 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h4><p><img src="/2021/07/31/Nginx/image-20210310164900812.png" alt="Nginx"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-*</span><br><span class="line">yum install -y python3 python3-pip python3-devel</span><br><span class="line">pip3 install uwsgi -i https://pypi.douban.com/simple</span><br><span class="line">pip3 install django==<span class="number">1.11</span> -i https://pypi.douban.com/simple</span><br><span class="line">cd /data/</span><br><span class="line">django-admin startproject site</span><br><span class="line">django-admin startproject mysite</span><br><span class="line">cd mysite/</span><br><span class="line">python3 manage.py runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8080</span></span><br><span class="line"></span><br><span class="line">   [root@localhost mysite]<span class="comment"># ls</span></span><br><span class="line">	db.sqlite3  manage.py  mysite</span><br><span class="line">[root@localhost mysite]<span class="comment"># uwsgi --http :8080 --module mysite.wsgi  # 用uwsgi启动django项目中 的wsgi.py文件</span></span><br><span class="line">       </span><br></pre></td></tr></table></figure>

<h4 id="uwsgi配置文件启动"><a href="#uwsgi配置文件启动" class="headerlink" title="uwsgi配置文件启动"></a>uwsgi配置文件启动</h4><p><img src="/2021/07/31/Nginx/image-20210310194134328.png" alt="Nginx"></p>
<p><img src="/2021/07/31/Nginx/image-20210310193403278.png" alt="Nginx"></p>
<p><img src="/2021/07/31/Nginx/image-20210310210920660.png" alt="Nginx"></p>
<p><img src="/2021/07/31/Nginx/image-20210310211206218.png" alt="Nginx"> </p>
<p><img src="/2021/07/31/Nginx/image-20210310210241468.png" alt="Nginx"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在django项目的settings 开启</span><br><span class="line">STATIC_ROOT= os.path.join(BASE_DIR,<span class="string">&#x27;static/&#x27;</span>)</span><br><span class="line">执行命令</span><br><span class="line">python3 manage.py collectstatic <span class="comment"># 用来收集静态文件</span></span><br></pre></td></tr></table></figure>

<h4 id="使用问题"><a href="#使用问题" class="headerlink" title="使用问题"></a>使用问题</h4><p><img src="/2021/07/31/Nginx/image-20210310211329270.png" alt="Nginx"></p>
<h4 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h4><ul>
<li>因为uwsgi不能收集静态文件，所以需要用到nginx做动静分离</li>
</ul>
<p><img src="/2021/07/31/Nginx/image-20210310210026285.png" alt="Nginx"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Admin"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Admin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021-07 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Admin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>







    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共151.4k字</span>
</div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
